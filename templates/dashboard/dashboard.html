{% extends 'base.html' %}

{% block title %}BlinkR Loan Dashboard{% endblock %}

{% block content %}
<script>
// Prevent back button access to dashboard without proper authentication
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        // Page was loaded from cache, check if user is still authenticated
        fetch('/api/kpi-data/', {
            method: 'GET',
            credentials: 'same-origin'
        })
        .then(response => {
            if (response.status === 302 || response.redirected) {
                // User is not authenticated, redirect to login
                window.location.href = '/login/';
            }
        })
        .catch(() => {
            // Error occurred, redirect to login
            window.location.href = '/login/';
        });
    }
});

// Clear session storage on page unload to prevent back button issues
window.addEventListener('beforeunload', function() {
    // Clear any sensitive data from session storage
    sessionStorage.clear();
});

// Clear login check flag when user actively logs out
document.addEventListener('DOMContentLoaded', function() {
    const logoutLinks = document.querySelectorAll('a[href*="logout"]');
    logoutLinks.forEach(link => {
        link.addEventListener('click', function() {
            sessionStorage.removeItem('loginCheckDone');
        });
    });
});

// Prevent direct access via URL manipulation
if (window.history.replaceState) {
    window.history.replaceState(null, null, window.location.href);
}
</script>
<div class="min-h-screen p-3 sm:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Mobile Responsive Header with Logo -->
        <div class="mb-6 sm:mb-8">
            <!-- Mobile Layout -->
            <div class="block sm:hidden">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <img src="/static/images/blinkr-logo.svg" alt="BlinkR Logo" class="h-8 w-auto">
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-xs text-gray-400">
                            {{ user.username }}
                        </div>
                        <a href="{% url 'dashboard:logout' %}" class="p-2 text-gray-300 hover:text-white bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 rounded-lg transition-colors">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                        </a>
                    </div>
                </div>
                <div class="text-center">
                    <div class="flex items-center justify-center gap-2 mb-1">
                        <div class="p-1.5 rounded-lg bg-blue-500/10 border border-blue-500/20">
                            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <h1 class="text-lg font-semibold text-white">Analytics Dashboard</h1>
                    </div>
                    <p class="text-xs text-gray-400">Performance insights</p>
                    <div class="text-xs text-gray-400 mt-1">
                        Updated: {{ last_updated }}
                    </div>
                </div>
            </div>
            
            <!-- Desktop Layout -->
            <div class="hidden sm:block">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <img src="/static/images/blinkr-logo.svg" alt="BlinkR Logo" class="h-12 w-auto">
                </div>
                <div class="text-center">
                    <div class="flex items-center justify-center gap-3 mb-1">
                        <div class="p-2 rounded-lg bg-blue-500/10 border border-blue-500/20">
                            <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <h1 class="text-2xl font-semibold text-white">Analytics Dashboard</h1>
                    </div>
                    <p class="text-sm text-gray-400">Advanced performance insights and data visualization</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-sm text-gray-400">
                        Last Updated: {{ last_updated }}
                    </div>
                    <!-- User Info and Logout -->
                    <div class="flex items-center gap-3">
                        <div class="text-sm text-gray-300">
                            Welcome, <span class="font-medium text-white">{{ user.username }}</span>
                        </div>
                        <a href="{% url 'dashboard:logout' %}" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-300 hover:text-white bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 hover:border-gray-500/30 rounded-lg transition-colors">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Logout
                        </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Responsive Tab Navigation -->
        <div class="mb-6 sm:mb-8">
            <div class="flex space-x-1 bg-gray-600/20 p-1 rounded-lg border border-gray-500/20">
                <button id="disbursalTab" onclick="switchTab('disbursal')" class="flex-1 px-1 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium rounded-md transition-colors tab-button active">
                    <div class="flex items-center justify-center gap-1 sm:gap-2">
                        <svg class="h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                        <span class="hidden sm:inline">Disbursal Summary</span>
                        <span class="sm:hidden">Disbursal</span>
                    </div>
                </button>
                <button id="collectionTab" onclick="switchTab('collection')" class="flex-1 px-1 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium rounded-md transition-colors tab-button">
                    <div class="flex items-center justify-center gap-1 sm:gap-2">
                        <svg class="h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="hidden sm:inline">Collection Without Fraud</span>
                        <span class="sm:hidden">Without Fraud</span>
                    </div>
                </button>
                <button id="fraudTab" onclick="switchTab('fraud')" class="flex-1 px-1 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium rounded-md transition-colors tab-button">
                    <div class="flex items-center justify-center gap-1 sm:gap-2">
                        <svg class="h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <span class="hidden sm:inline">Collection With Fraud</span>
                        <span class="sm:hidden">With Fraud</span>
                    </div>
                </button>
                <button id="loanCountTab" onclick="switchTab('loanCount')" class="flex-1 px-1 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium rounded-md transition-colors tab-button">
                    <div class="flex items-center justify-center gap-1 sm:gap-2">
                        <svg class="h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span class="hidden sm:inline">Loan Count Wise</span>
                        <span class="sm:hidden">Loan Count</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <!-- Disbursal Summary Tab -->
        <div id="disbursalContent" class="tab-content hidden">
            <div class="text-center py-12">
                <div class="p-4 rounded-lg bg-blue-500/10 border border-blue-500/20 inline-block mb-4">
                    <svg class="h-12 w-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Disbursal Summary</h2>
                <p class="text-gray-400 mb-6">Comprehensive disbursal analytics and loan distribution insights</p>
                <div class="text-sm text-gray-500">Coming Soon - Advanced disbursal tracking and analysis</div>
            </div>
        </div>

        <!-- Collection Without Fraud Tab -->
        <div id="collectionContent" class="tab-content">
        <!-- Collapsible Filters -->
        <div class="card mb-8">
            <div class="p-6 cursor-pointer" onclick="toggleFilters()">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-medium text-white">Filters</h2>
                    <svg id="filterToggleIcon" class="h-5 w-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
            
            <div id="filterContent" class="px-6 pb-6 hidden">
                <form method="GET" id="filterForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                <!-- Date Range -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Date Range
                        <span class="text-xs text-muted-foreground">(Both dates required)</span>
                    </label>
                    <div class="space-y-2">
                        <select name="date_type" class="w-full input-field filter-input">
                            <option value="repayment_date" {% if filters.date_type == 'repayment_date' or not filters.date_type %}selected{% endif %}>Repayment Date</option>
                            <option value="disbursal_date" {% if filters.date_type == 'disbursal_date' %}selected{% endif %}>Disbursal Date</option>
                        </select>
                    <div class="flex gap-3">
                        <input type="date" name="date_from" value="{{ filters.date_from|default:'' }}" class="flex-1 input-field filter-input" placeholder="From Date">
                        <input type="date" name="date_to" value="{{ filters.date_to|default:'' }}" class="flex-1 input-field filter-input" placeholder="To Date">
                        </div>
                    </div>
                </div>

                <!-- Closing Status -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Closing Status
                    </label>
                        <select name="closing_status" class="w-full input-field filter-input">
                            <option value="">All Status</option>
                            {% for status in unique_closed_statuses %}
                            <option value="{{ status }}" {% if filters.closing_status == status %}selected{% endif %}>{{ status }}</option>
                            {% endfor %}
                        </select>
                </div>

                <!-- DPD Bucket -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        DPD Bucket
                    </label>
                        <select name="dpd" class="w-full input-field filter-input">
                            <option value="">All DPD</option>
                            {% for bucket in unique_dpd_buckets %}
                            <option value="{{ bucket }}" {% if filters.dpd == bucket %}selected{% endif %}>{{ bucket }}</option>
                            {% endfor %}
                        </select>
                </div>

                <!-- State -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        State
                    </label>
                    <select name="state" class="w-full input-field filter-input">
                        <option value="">All States</option>
                        {% for state in unique_states %}
                        <option value="{{ state }}" {% if filters.state == state %}selected{% endif %}>{{ state }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- City -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        City
                    </label>
                    <select name="city" class="w-full input-field filter-input">
                        <option value="">All Cities</option>
                        {% for city in unique_cities %}
                        <option value="{{ city }}" {% if filters.city == city %}selected{% endif %}>{{ city }}</option>
                        {% endfor %}
                    </select>
                </div>

            </form>
            </div>
        </div>

        <!-- Mobile Responsive KPI Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
            <div class="kpi-card cursor-pointer hover:bg-secondary/20 transition-colors" onclick="openTotalApplicationsModal()">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-blue-500/10 border border-blue-500/20">
                        <svg class="h-4 w-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div class="text-xs sm:text-sm text-gray-400">Total Applications</div>
                </div>
                <div class="text-xl sm:text-2xl font-semibold text-white" id="totalApplications">{{ kpis.total_applications|floatformat:0 }}</div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshCases">{{ kpis.fresh_cases|default:0 }}</span>
                            <span class="text-gray-400 ml-1">(<span id="freshPercentage">{{ kpis.fresh_percentage|default:0|floatformat:1 }}</span>%)</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanCases">{{ kpis.reloan_cases|default:0 }}</span>
                            <span class="text-gray-400 ml-1">(<span id="reloanPercentage">{{ kpis.reloan_percentage|default:0|floatformat:1 }}</span>%)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-green-500/10 border border-green-500/20">
                        <svg class="h-4 w-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Sanction Amount</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="sanctionAmount" data-amount="{{ kpis.sanction_amount }}"></div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshSanctionAmount" data-amount="{{ kpis.fresh_sanction_amount|default:0 }}"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanSanctionAmount" data-amount="{{ kpis.reloan_sanction_amount|default:0 }}"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-purple-500/10 border border-purple-500/20">
                        <svg class="h-4 w-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Net Disbursed</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="disbursedAmount" data-amount="{{ kpis.net_disbursal }}"></div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshDisbursedAmount" data-amount="{{ kpis.fresh_disbursed_amount|default:0 }}"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanDisbursedAmount" data-amount="{{ kpis.reloan_disbursed_amount|default:0 }}"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-orange-500/10 border border-orange-500/20">
                        <svg class="h-4 w-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Repayment Amount</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="repaymentAmount" data-amount="{{ kpis.repayment_amount }}"></div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshRepaymentAmount" data-amount="{{ kpis.fresh_repayment_amount|default:0 }}"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanRepaymentAmount" data-amount="{{ kpis.reloan_repayment_amount|default:0 }}"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Mobile Responsive Collection Status and Principal Outstanding -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6 mb-6 sm:mb-8">
            <!-- Collected Amount Card -->
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-emerald-500/10 border border-emerald-500/20">
                        <svg class="h-4 w-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-emerald-400">Collected Amount</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-emerald-400" id="collectedAmount" data-amount="{{ kpis.collected_amount }}"></div>
                    <div class="text-sm text-emerald-300" id="collectedPercentage">{{ kpis.collected_percentage|floatformat:1 }}% of Repayment</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshCollectedAmount" data-amount="{{ kpis.fresh_collected_amount|default:0 }}"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanCollectedAmount" data-amount="{{ kpis.reloan_collected_amount|default:0 }}"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Collection Card -->
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-red-500/10 border border-red-500/20">
                        <svg class="h-4 w-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-red-400">Pending Collection</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-red-400" id="pendingAmount" data-amount="{{ kpis.pending_collection }}"></div>
                    <div class="text-sm text-red-300" id="pendingPercentage">{{ kpis.pending_percentage|floatformat:1 }}% of Repayment</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshPendingAmount" data-amount="{{ kpis.fresh_pending_amount|default:0 }}"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanPendingAmount" data-amount="{{ kpis.reloan_pending_amount|default:0 }}"></span>
                        </div>
                    </div>
            </div>
        </div>

            <!-- Principal Outstanding Card -->
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-yellow-500/10 border border-yellow-500/20">
                        <svg class="h-4 w-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-yellow-400">Principal Outstanding</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-yellow-400" id="principalOutstandingAmount" data-amount="{{ kpis.principal_outstanding|default:0 }}"></div>
                    <div class="text-sm text-yellow-300">No Collections Yet</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshPrincipalOutstanding" data-amount="{{ kpis.fresh_principal_outstanding|default:0 }}"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanPrincipalOutstanding" data-amount="{{ kpis.reloan_principal_outstanding|default:0 }}"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Responsive Enhanced Analytics Charts -->
        <div class="mb-6 sm:mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
            <!-- Enhanced State Repayment Chart -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-info/20 to-primary/20 border border-info/30 shadow-lg">
                            <svg class="h-6 w-6 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Received Amount by State</h3>
                            <p class="text-sm text-muted-foreground font-medium">Geographic distribution of collections</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('stateChart', 'Received Amount by State', 'Geographic distribution of collections')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div class="h-80">
                    <canvas id="stateChart"></canvas>
                </div>
            </div>

            <!-- Enhanced Time Series Chart -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-success/20 to-info/20 border border-success/30 shadow-lg">
                            <svg class="h-6 w-6 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Amount Received Over Time</h3>
                            <p class="text-sm text-muted-foreground font-medium">Collection trends and performance</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('timeSeriesChart', 'Amount Received Over Time', 'Collection trends and performance')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div class="h-80">
                    <canvas id="timeSeriesChart"></canvas>
                </div>
                
            </div>
        </div>

        <!-- DPD Bucket Distribution - Single Vertical Column -->
        <div class="chart-container rounded-2xl p-8 shadow-2xl">
            <!-- Header Block -->
            <div class="flex items-center gap-4 mb-8">
                <div class="p-3 rounded-2xl bg-gradient-to-br from-destructive/20 to-warning/20 border border-destructive/30 shadow-lg">
                    <svg class="h-6 w-6 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-foreground">DPD Bucket Distribution</h3>
                    <p class="text-sm text-muted-foreground font-medium">Days Past Due analysis and risk assessment</p>
                </div>
            </div>
            
            <!-- Full-width Table -->
            <div class="w-full overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-border">
                            <th class="text-left py-3 px-4 font-medium text-muted-foreground">DPD Bucket</th>
                            <th class="text-right py-3 px-4 font-medium text-muted-foreground">Loans (#)</th>
                        </tr>
                    </thead>
                    <tbody id="dpdTableBody">
                        <!-- DPD data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mobile Responsive City-wise Analysis Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8 mt-6 sm:mt-8">
            <!-- Top 10 Cities by Collected Amount -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-lg bg-emerald-500/10">
                            <svg class="h-6 w-6 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-white">Top 10 Cities - Collection Rate</h2>
                            <p class="text-gray-400 text-sm">Cities with highest collection percentage (%)</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('cityCollectedChart', 'Top 10 Cities - Collection Rate', 'Cities with highest collection percentage (%)')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div class="h-80">
                    <canvas id="cityCollectedChart"></canvas>
                </div>
            </div>

            <!-- Top 10 Cities with Uncollected Amount -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-lg bg-red-500/10">
                            <svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-white">Top 10 Cities - Lowest Collection Rate</h2>
                            <p class="text-gray-400 text-sm">Cities with lowest collection percentage (%)</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('cityUncollectedChart', 'Top 10 Cities - Lowest Collection Rate', 'Cities with lowest collection percentage (%)')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div class="h-80">
                    <canvas id="cityUncollectedChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- DPD Details Modal -->
    <div id="dpdDetailsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-card border border-border rounded-lg shadow-xl w-full max-w-7xl max-h-[90vh] flex flex-col">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-6 border-b border-border">
                    <div>
                        <h2 id="dpdModalTitle" class="text-xl font-semibold text-foreground">DPD Details</h2>
                        <p id="dpdModalSubtitle" class="text-sm text-muted-foreground mt-1">Loading...</p>
                    </div>
                    <button onclick="closeDPDDetailsModal()" class="text-muted-foreground hover:text-foreground transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div class="flex-1 overflow-hidden flex flex-col">
                    <!-- Search and Controls -->
                    <div class="p-6 border-b border-border">
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <input 
                                    type="text" 
                                    id="dpdSearchInput" 
                                    placeholder="Search by Loan No or PAN..." 
                                    class="w-full px-4 py-2 bg-background border border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                                >
                            </div>
                            <button 
                                id="dpdExportBtn" 
                                onclick="exportDPDDetails()" 
                                class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors"
                            >
                                Export CSV
                            </button>
                        </div>
                    </div>
                    
                    <!-- Table Container -->
                    <div class="flex-1 overflow-auto">
                        <div class="p-6">
                            <!-- Loading State -->
                            <div id="dpdLoadingState" class="hidden">
                                <div class="flex items-center justify-center py-12">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                                    <span class="ml-3 text-muted-foreground">Loading details...</span>
                                </div>
                            </div>
                            
                            <!-- Empty State -->
                            <div id="dpdEmptyState" class="hidden text-center py-12">
                                <svg class="w-12 h-12 text-muted-foreground mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="text-muted-foreground">No loans found in this DPD bucket</p>
                            </div>
                            
                            <!-- Table -->
                            <div id="dpdTableContainer" class="hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="sticky top-0 bg-card">
                                            <tr class="border-b border-border">
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('loan_no')">
                                                    Loan No <span id="sort-loan_no" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('pan')">
                                                    PAN <span id="sort-pan" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('disbursal_date')">
                                                    Disbursal Date <span id="sort-disbursal_date" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('net_disbursal')">
                                                    Net Disbursal <span id="sort-net_disbursal" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('repayment_date')">
                                                    Repayment Date <span id="sort-repayment_date" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('repayment_amount')">
                                                    Repayment Amount <span id="sort-repayment_amount" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('overdue_days')">
                                                    Overdue Days <span id="sort-overdue_days" class="text-xs">↓</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('dpd_bucket')">
                                                    DPD Bucket <span id="sort-dpd_bucket" class="text-xs">↕</span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="dpdDetailsTableBody">
                                            <!-- Data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <div id="dpdPagination" class="flex items-center justify-between mt-6">
                                    <div class="text-sm text-muted-foreground">
                                        Showing <span id="dpdPaginationInfo"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="dpdPrevBtn" onclick="changeDPDPage(-1)" class="px-3 py-1 bg-secondary text-secondary-foreground rounded hover:bg-secondary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                            Previous
                                        </button>
                                        <span id="dpdPageInfo" class="px-3 py-1 text-sm text-muted-foreground"></span>
                                        <button id="dpdNextBtn" onclick="changeDPDPage(1)" class="px-3 py-1 bg-secondary text-secondary-foreground rounded hover:bg-secondary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                            Next
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Totals Footer -->
                                <div id="dpdTotalsFooter" class="mt-6 pt-4 border-t border-border">
                                    <div class="flex justify-end gap-8 text-sm">
                                        <div>
                                            <span class="text-muted-foreground">Total Net Disbursal:</span>
                                            <span id="dpdTotalNetDisbursal" class="ml-2 font-semibold text-foreground"></span>
                                        </div>
                                        <div>
                                            <span class="text-muted-foreground">Total Repayment Amount:</span>
                                            <span id="dpdTotalRepaymentAmount" class="ml-2 font-semibold text-foreground"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Responsive Total Applications Modal -->
    <div id="totalApplicationsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
            <div class="bg-card border border-border rounded-lg shadow-xl w-full max-w-7xl max-h-[95vh] sm:max-h-[90vh] flex flex-col">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-6 border-b border-border">
                    <div>
                        <h2 id="totalAppsModalTitle" class="text-xl font-semibold text-foreground">Total Applications</h2>
                        <p id="totalAppsModalSubtitle" class="text-sm text-muted-foreground mt-1">Loading...</p>
                    </div>
                    <button onclick="closeTotalApplicationsModal()" class="text-muted-foreground hover:text-foreground transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div class="flex-1 overflow-hidden flex flex-col">
                    <!-- Search and Controls -->
                    <div class="p-6 border-b border-border">
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <input 
                                    type="text" 
                                    id="totalAppsSearchInput" 
                                    placeholder="Search by Loan No or PAN..." 
                                    class="w-full px-4 py-2 bg-background border border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                                >
                            </div>
                            <button 
                                id="totalAppsExportBtn" 
                                onclick="exportTotalApplications()" 
                                class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors"
                            >
                                Export CSV
                            </button>
                        </div>
                    </div>
                    
                    <!-- Table Container -->
                    <div class="flex-1 overflow-auto">
                        <div class="p-6">
                            <!-- Loading State -->
                            <div id="totalAppsLoadingState" class="hidden">
                                <div class="flex items-center justify-center py-12">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                                    <span class="ml-3 text-muted-foreground">Loading applications...</span>
                                </div>
                            </div>
                            
                            <!-- Empty State -->
                            <div id="totalAppsEmptyState" class="hidden text-center py-12">
                                <svg class="w-12 h-12 text-muted-foreground mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="text-muted-foreground">No applications found</p>
                            </div>
                            
                            <!-- Table -->
                            <div id="totalAppsTableContainer" class="hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="sticky top-0 bg-card">
                                            <tr class="border-b border-border">
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('loan_no')">
                                                    Loan No <span id="sort-loan_no" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('pan')">
                                                    PAN <span id="sort-pan" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('disbursal_date')">
                                                    Disbursal Date <span id="sort-disbursal_date" class="text-xs">↓</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('loan_amount')">
                                                    Loan Amount <span id="sort-loan_amount" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('net_disbursal')">
                                                    Net Disbursal <span id="sort-net_disbursal" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('tenure')">
                                                    Tenure <span id="sort-tenure" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('repayment_date')">
                                                    Repayment Date <span id="sort-repayment_date" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('repayment_amount')">
                                                    Repayment Amount <span id="sort-repayment_amount" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('processing_fee')">
                                                    Processing Fee <span id="sort-processing_fee" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('interest_amount')">
                                                    Interest Amount <span id="sort-interest_amount" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('last_received_date')">
                                                    Last Received Date <span id="sort-last_received_date" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('total_received')">
                                                    Total Received <span id="sort-total_received" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('closed_status')">
                                                    Closed Status <span id="sort-closed_status" class="text-xs">↕</span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="totalAppsDetailsTableBody">
                                            <!-- Data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <div id="totalAppsPagination" class="flex items-center justify-between mt-6">
                                    <div class="text-sm text-muted-foreground">
                                        Showing <span id="totalAppsPaginationInfo"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="totalAppsPrevBtn" onclick="changeTotalAppsPage(-1)" class="px-3 py-1 bg-secondary text-secondary-foreground rounded hover:bg-secondary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                            Previous
                                        </button>
                                        <span id="totalAppsPageInfo" class="px-3 py-1 text-sm text-muted-foreground"></span>
                                        <button id="totalAppsNextBtn" onclick="changeTotalAppsPage(1)" class="px-3 py-1 bg-secondary text-secondary-foreground rounded hover:bg-secondary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                            Next
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Totals Footer -->
                                <div id="totalAppsTotalsFooter" class="mt-6 pt-4 border-t border-border">
                                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-sm">
                                        <div>
                                            <span class="text-muted-foreground">Total Loan Amount:</span>
                                            <div id="totalAppsTotalLoanAmount" class="font-semibold text-foreground"></div>
                                        </div>
                                        <div>
                                            <span class="text-muted-foreground">Total Net Disbursal:</span>
                                            <div id="totalAppsTotalNetDisbursal" class="font-semibold text-foreground"></div>
                                        </div>
                                        <div>
                                            <span class="text-muted-foreground">Total Repayment Amount:</span>
                                            <div id="totalAppsTotalRepaymentAmount" class="font-semibold text-foreground"></div>
                                        </div>
                                        <div>
                                            <span class="text-muted-foreground">Total Processing Fee:</span>
                                            <div id="totalAppsTotalProcessingFee" class="font-semibold text-foreground"></div>
                                        </div>
                                        <div>
                                            <span class="text-muted-foreground">Total Interest Amount:</span>
                                            <div id="totalAppsTotalInterestAmount" class="font-semibold text-foreground"></div>
                                        </div>
                                        <div>
                                            <span class="text-muted-foreground">Total Received:</span>
                                            <div id="totalAppsTotalReceived" class="font-semibold text-foreground"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Toggle filters visibility
    function toggleFilters() {
        const filterContent = document.getElementById('filterContent');
        const toggleIcon = document.getElementById('filterToggleIcon');
        
        if (filterContent.classList.contains('hidden')) {
            filterContent.classList.remove('hidden');
            toggleIcon.style.transform = 'rotate(180deg)';
        } else {
            filterContent.classList.add('hidden');
            toggleIcon.style.transform = 'rotate(0deg)';
        }
    }
    
    // Toggle fraud filters visibility 
    // just for git push 3
    function toggleFraudFilters() {
        const filterContent = document.getElementById('fraudFilterContent');
        const toggleIcon = document.getElementById('fraudFilterToggleIcon');
        
        if (filterContent.classList.contains('hidden')) {
            filterContent.classList.remove('hidden');
            toggleIcon.style.transform = 'rotate(180deg)';
        } else {
            filterContent.classList.add('hidden');
            toggleIcon.style.transform = 'rotate(0deg)';
        }
    }

    // Open chart in fullscreen (generic function)
    function openFullscreenChart(chartId, title, subtitle) {
        // Create fullscreen modal
        const modal = document.createElement('div');
        modal.id = 'fullscreenChartModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-gray-900 rounded-lg p-6 w-full h-full max-w-7xl max-h-full flex flex-col">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-lg bg-blue-500/10">
                            <svg class="h-6 w-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18V11H3V4z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-white">${title}</h2>
                            <p class="text-gray-400">${subtitle} - Fullscreen View</p>
                        </div>
                    </div>
                    <button onclick="closeFullscreenChart()" class="p-2 rounded-lg bg-red-600/20 hover:bg-red-600/30 border border-red-500/20 transition-colors" title="Close Fullscreen">
                        <svg class="h-6 w-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex-1 min-h-0">
                    <canvas id="fullscreenChart"></canvas>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Create fullscreen chart based on the original chart
        setTimeout(() => {
            const ctx = document.getElementById('fullscreenChart').getContext('2d');
            const originalChart = getChartInstance(chartId);
            
            if (!originalChart) {
                console.error(`Cannot open fullscreen for ${chartId}: Chart not found or not loaded yet`);
                // Show error message in the chart container
                const chartContainer = document.getElementById('fullscreenChart').parentElement;
                chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-red-500">Chart not loaded yet. Please try again.</div>';
                return;
            }
            
            if (originalChart && originalChart.data) {
                const originalData = originalChart.data;
                
                // Create new chart instance for fullscreen with enhanced options
                window.fullscreenChartInstance = new Chart(ctx, {
                    type: originalChart.config.type,
                    data: {
                        labels: originalData.labels,
                        datasets: originalData.datasets.map(dataset => {
                            const enhancedDataset = { ...dataset };
                            
                            // Enhance different chart types appropriately
                            if (originalChart.config.type === 'line') {
                                enhancedDataset.pointRadius = dataset.pointRadius ? dataset.pointRadius * 1.5 : 6;
                                enhancedDataset.pointHoverRadius = dataset.pointHoverRadius ? dataset.pointHoverRadius * 1.5 : 8;
                                enhancedDataset.borderWidth = dataset.borderWidth ? dataset.borderWidth * 1.5 : 3;
                            } else if (originalChart.config.type === 'bar') {
                                enhancedDataset.borderWidth = dataset.borderWidth ? dataset.borderWidth * 1.5 : 2;
                                enhancedDataset.borderRadius = dataset.borderRadius ? dataset.borderRadius * 1.5 : 6;
                            }
                            
                            return enhancedDataset;
                        })
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#94a3b8',
                                    font: {
                                        size: 16
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#f8fafc',
                                bodyColor: '#f8fafc',
                                borderColor: '#334155',
                                borderWidth: 1,
                                titleFont: {
                                    size: 16
                                },
                                bodyFont: {
                                    size: 14
                                },
                                callbacks: originalChart.options.plugins.tooltip.callbacks
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: '#334155'
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            y: {
                                grid: {
                                    color: '#334155'
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    font: {
                                        size: 14
                                    },
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }
        }, 100);
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }

    // Get chart instance by ID
    function getChartInstance(chartId) {
        const chartInstances = {
            'timeSeriesChart': window.timeSeriesChartInstance,
            'stateChart': window.stateChartInstance,
            'cityCollectedChart': window.cityCollectedChartInstance,
            'cityUncollectedChart': window.cityUncollectedChartInstance,
            'fraudStateChart': window.fraudStateChartInstance,
            'fraudTimeSeriesChart': window.fraudTimeSeriesChartInstance,
            'fraudCityCollectedChart': window.fraudCityCollectedChartInstance,
            'fraudCityUncollectedChart': window.fraudCityUncollectedChartInstance
        };
        const chart = chartInstances[chartId];
        
        if (!chart) {
            console.warn(`Chart instance not found for ${chartId}. Available charts:`, Object.keys(chartInstances));
            return null;
        }
        
        return chart;
    }

    // Open table in fullscreen
    function openFullscreenTable(tableId, title, subtitle) {
        // Create fullscreen modal
        const modal = document.createElement('div');
        modal.id = 'fullscreenTableModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4';
        
        const tableElement = document.getElementById(tableId);
        const tableHTML = tableElement.outerHTML;
        
        modal.innerHTML = `
            <div class="bg-gray-900 rounded-lg p-6 w-full h-full max-w-7xl max-h-full flex flex-col">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-lg bg-blue-500/10">
                            <svg class="h-6 w-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-white">${title}</h2>
                            <p class="text-gray-400">${subtitle} - Fullscreen View</p>
                        </div>
                    </div>
                    <button onclick="closeFullscreenChart()" class="p-2 rounded-lg bg-red-600/20 hover:bg-red-600/30 border border-red-500/20 transition-colors" title="Close Fullscreen">
                        <svg class="h-6 w-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex-1 min-h-0 overflow-auto">
                    <div class="bg-gray-800 rounded-lg p-4">
                        ${tableHTML}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }

    // Close fullscreen chart
    function closeFullscreenChart() {
        const chartModal = document.getElementById('fullscreenChartModal');
        const tableModal = document.getElementById('fullscreenTableModal');
        
        if (chartModal) {
            chartModal.remove();
        }
        
        if (tableModal) {
            tableModal.remove();
        }
        
        // Destroy fullscreen chart instance
        if (window.fullscreenChartInstance) {
            window.fullscreenChartInstance.destroy();
            window.fullscreenChartInstance = null;
        }
        
        // Restore body scroll
        document.body.style.overflow = 'auto';
    }

    // Test function to check fullscreen functionality
    function testFullscreen() {
        console.log('Testing fullscreen functionality...');
        console.log('Available chart instances:', {
            timeSeriesChart: !!window.timeSeriesChartInstance,
            stateChart: !!window.stateChartInstance,
            cityCollectedChart: !!window.cityCollectedChartInstance,
            cityUncollectedChart: !!window.cityUncollectedChartInstance
        });
    }

    // Test state chart fullscreen specifically
    function testStateChartFullscreen() {
        console.log('Testing state chart fullscreen...');
        console.log('State chart instance:', window.stateChartInstance);
        
        if (window.stateChartInstance) {
            console.log('State chart data:', window.stateChartInstance.data);
            console.log('State chart config:', window.stateChartInstance.config);
            openFullscreenChart('stateChart', 'Received Amount by State', 'Geographic distribution of collections');
        } else {
            console.error('State chart instance not found!');
        }
    }

// Load city collected chart
async function loadCityCollectedChart() {
    try {
        const params = new URLSearchParams(window.location.search);
        const response = await fetch(`/api/city-collected/?${params}`);
        const data = await response.json();
        
        console.log('City collected data loaded:', data.data.length, 'cities');
        
        const ctx = document.getElementById('cityCollectedChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.cityCollectedChartInstance) {
            window.cityCollectedChartInstance.destroy();
        }
        
        // Create horizontal bar chart
        window.cityCollectedChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.data.map(item => item.city),
                datasets: [{
                    label: 'Collection Rate (%)',
                    data: data.data.map(item => item.collection_percentage),
                    backgroundColor: '#10b981',
                    borderColor: '#059669',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        labels: {
                            color: '#94a3b8'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#f8fafc',
                        bodyColor: '#f8fafc',
                        borderColor: '#334155',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const city = data.data[context.dataIndex];
                                return [
                                    'City: ' + city.city,
                                    'Collection Rate: ' + city.collection_percentage.toFixed(1) + '%',
                                    'Collected Amount: ' + formatCurrency(city.collected_amount),
                                    'Repayment Amount: ' + formatCurrency(city.repayment_amount),
                                    'Applications: ' + city.total_applications
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: '#334155'
                        },
                        ticks: {
                            color: '#94a3b8',
                            callback: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    y: {
                        grid: {
                            color: '#334155'
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    }
                }
            }
        });
        
        console.log('City collected chart created successfully');
    } catch (error) {
        console.error('Error loading city collected chart:', error);
    }
}

// Load city uncollected chart
async function loadCityUncollectedChart() {
    try {
        const params = new URLSearchParams(window.location.search);
        const response = await fetch(`/api/city-uncollected/?${params}`);
        const data = await response.json();
        
        console.log('City uncollected data loaded:', data.data.length, 'cities');
        
        const ctx = document.getElementById('cityUncollectedChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.cityUncollectedChartInstance) {
            window.cityUncollectedChartInstance.destroy();
        }
        
        // Create horizontal bar chart
        window.cityUncollectedChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.data.map(item => item.city),
                datasets: [{
                    label: 'Collection Rate (%)',
                    data: data.data.map(item => Math.max(item.collection_percentage, 0.1)), // Minimum 0.1% for visibility
                    backgroundColor: '#ef4444',
                    borderColor: '#dc2626',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        labels: {
                            color: '#94a3b8'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#f8fafc',
                        bodyColor: '#f8fafc',
                        borderColor: '#334155',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const city = data.data[context.dataIndex];
                                return [
                                    'City: ' + city.city,
                                    'Collection Rate: ' + city.collection_percentage.toFixed(1) + '%',
                                    'Uncollected Amount: ' + formatCurrency(city.uncollected_amount),
                                    'Collected Amount: ' + formatCurrency(city.collected_amount),
                                    'Repayment Amount: ' + formatCurrency(city.repayment_amount),
                                    'Applications: ' + city.total_applications,
                                    'Note: Bar shows minimum height for 0% values'
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 2, // Set a small max to make 0% values visible
                        grid: {
                            color: '#334155'
                        },
                        ticks: {
                            color: '#94a3b8',
                            callback: function(value) {
                                if (value === 0.1) return '0.0%'; // Show 0.0% for minimum bars
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    y: {
                        grid: {
                            color: '#334155'
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    }
                }
            }
        });
        
        console.log('City uncollected chart created successfully');
    } catch (error) {
        console.error('Error loading city uncollected chart:', error);
    }
}

// DPD Details Modal Functions
let currentDPDBucket = null;
let currentDPDPage = 1;
let currentDPDSort = 'overdue_days';
let currentDPDSortOrder = 'desc';
let currentDPDSearch = '';
let dpdDetailsData = null;

function openDPDDetailsModal(dpdBucket, loanCount) {
    currentDPDBucket = dpdBucket;
    currentDPDPage = 1;
    currentDPDSearch = '';
    
    // Update modal title
    document.getElementById('dpdModalTitle').textContent = `DPD Details – ${dpdBucket} days`;
    document.getElementById('dpdModalSubtitle').textContent = `${loanCount} loans`;
    
    // Clear search input
    document.getElementById('dpdSearchInput').value = '';
    
    // Show modal
    document.getElementById('dpdDetailsModal').classList.remove('hidden');
    
    // Load data
    loadDPDDetails();
}

function closeDPDDetailsModal() {
    document.getElementById('dpdDetailsModal').classList.add('hidden');
    currentDPDBucket = null;
    dpdDetailsData = null;
}

async function loadDPDDetails() {
    if (!currentDPDBucket) return;
    
    // Show loading state
    document.getElementById('dpdLoadingState').classList.remove('hidden');
    document.getElementById('dpdEmptyState').classList.add('hidden');
    document.getElementById('dpdTableContainer').classList.add('hidden');
    
    try {
        // Get current filter values from the form
        const filterForm = document.getElementById('filterForm');
        const formData = new FormData(filterForm);
        
        const params = new URLSearchParams({
            dpd_bucket: currentDPDBucket,
            page: currentDPDPage,
            per_page: 20,
            sort_by: currentDPDSort,
            sort_order: currentDPDSortOrder,
            search: currentDPDSearch
        });
        
        // Add current filter values
        for (const [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        const response = await fetch(`/api/dpd-bucket-details/?${params}`);
        const data = await response.json();
        
        dpdDetailsData = data;
        
        // Hide loading state
        document.getElementById('dpdLoadingState').classList.add('hidden');
        
        if (data.records.length === 0) {
            // Show empty state
            document.getElementById('dpdEmptyState').classList.remove('hidden');
        } else {
            // Show table and populate data
            document.getElementById('dpdTableContainer').classList.remove('hidden');
            populateDPDDetailsTable(data);
            updateDPDPagination(data.pagination);
            updateDPDTotals(data.totals);
        }
        
    } catch (error) {
        console.error('Error loading DPD details:', error);
        document.getElementById('dpdLoadingState').classList.add('hidden');
        document.getElementById('dpdEmptyState').classList.remove('hidden');
    }
}

function populateDPDDetailsTable(data) {
    const tbody = document.getElementById('dpdDetailsTableBody');
    tbody.innerHTML = '';
    
    data.records.forEach(record => {
        const row = document.createElement('tr');
        row.className = 'border-b border-border/50 hover:bg-secondary/50 transition-colors';
        
        row.innerHTML = `
            <td class="py-3 px-4 font-mono text-sm">${record.loan_no || '—'}</td>
            <td class="py-3 px-4 font-mono text-sm">${record.pan || '—'}</td>
            <td class="py-3 px-4 text-sm">${record.disbursal_date}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.net_disbursal)}</td>
            <td class="py-3 px-4 text-sm">${record.repayment_date}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.repayment_amount)}</td>
            <td class="py-3 px-4 text-right text-sm">${record.overdue_days || '—'}</td>
            <td class="py-3 px-4 text-sm">${record.dpd_bucket} days</td>
        `;
        
        tbody.appendChild(row);
    });
}

function updateDPDPagination(pagination) {
    const startRecord = (pagination.current_page - 1) * pagination.per_page + 1;
    const endRecord = Math.min(startRecord + pagination.per_page - 1, pagination.total_records);
    
    document.getElementById('dpdPaginationInfo').textContent = 
        `${startRecord}-${endRecord} of ${pagination.total_records}`;
    document.getElementById('dpdPageInfo').textContent = 
        `Page ${pagination.current_page} of ${pagination.total_pages}`;
    
    document.getElementById('dpdPrevBtn').disabled = !pagination.has_previous;
    document.getElementById('dpdNextBtn').disabled = !pagination.has_next;
}

function updateDPDTotals(totals) {
    document.getElementById('dpdTotalNetDisbursal').textContent = formatCurrency(totals.total_net_disbursal);
    document.getElementById('dpdTotalRepaymentAmount').textContent = formatCurrency(totals.total_repayment_amount);
}

function changeDPDPage(direction) {
    if (!dpdDetailsData) return;
    
    const newPage = currentDPDPage + direction;
    const maxPage = dpdDetailsData.pagination.total_pages;
    
    if (newPage >= 1 && newPage <= maxPage) {
        currentDPDPage = newPage;
        loadDPDDetails();
    }
}

function sortDPDTable(column) {
    if (currentDPDSort === column) {
        currentDPDSortOrder = currentDPDSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        currentDPDSort = column;
        currentDPDSortOrder = 'desc';
    }
    
    // Update sort indicators
    document.querySelectorAll('[id^="sort-"]').forEach(el => {
        el.textContent = '↕';
    });
    
    const sortIndicator = document.getElementById(`sort-${column}`);
    if (sortIndicator) {
        sortIndicator.textContent = currentDPDSortOrder === 'asc' ? '↑' : '↓';
    }
    
    currentDPDPage = 1;
    loadDPDDetails();
}

async function exportDPDDetails() {
    if (!currentDPDBucket) return;
    
    try {
        // Get current filter values from the form
        const filterForm = document.getElementById('filterForm');
        const formData = new FormData(filterForm);
        
        const params = new URLSearchParams({
            dpd_bucket: currentDPDBucket,
            per_page: 10000, // Large number to get all records
            sort_by: currentDPDSort,
            sort_order: currentDPDSortOrder,
            search: currentDPDSearch
        });
        
        // Add current filter values
        for (const [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        const response = await fetch(`/api/dpd-bucket-details/?${params}`);
        const data = await response.json();
        
        if (!data.records || data.records.length === 0) {
            alert('No data to export');
            return;
        }
        
        const headers = ['Loan No', 'PAN', 'Disbursal Date', 'Net Disbursal', 'Repayment Date', 'Repayment Amount', 'Overdue Days', 'DPD Bucket'];
        const csvContent = [
            headers.join(','),
            ...data.records.map(record => [
                record.loan_no || '',
                record.pan || '',
                record.disbursal_date,
                record.net_disbursal,
                record.repayment_date,
                record.repayment_amount,
                record.overdue_days || '',
                record.dpd_bucket
            ].join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dpd-details-${currentDPDBucket}-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
    } catch (error) {
        console.error('Error exporting DPD details:', error);
        alert('Error exporting data. Please try again.');
    }
}

// Helper function to get the currently active tab
function getCurrentActiveTab() {
    const mainTab = document.getElementById('mainTab');
    const fraudTab = document.getElementById('fraudTab');
    const loanCountTab = document.getElementById('loanCountTab');
    
    if (mainTab && mainTab.classList.contains('active')) {
        return 'main';
    } else if (fraudTab && fraudTab.classList.contains('active')) {
        return 'fraud';
    } else if (loanCountTab && loanCountTab.classList.contains('active')) {
        return 'loanCount';
    }
    
    // Default to main tab if none are clearly active
    return 'main';
}

// Total Applications Modal Functions
let currentTotalAppsPage = 1;
let currentTotalAppsSort = 'disbursal_date';
let currentTotalAppsSortOrder = 'desc';
let currentTotalAppsSearch = '';
let totalAppsDetailsData = null;

function openTotalApplicationsModal(totalCount) {
    currentTotalAppsPage = 1;
    currentTotalAppsSearch = '';
    
    // Update modal title with filtered count (will be updated after data loads)
    document.getElementById('totalAppsModalTitle').textContent = `Total Applications (Loading...)`;
    document.getElementById('totalAppsModalSubtitle').textContent = `Loading applications...`;
    
    // Clear search input
    document.getElementById('totalAppsSearchInput').value = '';
    
    // Show modal
    document.getElementById('totalApplicationsModal').classList.remove('hidden');
    
    // Load data
    loadTotalApplicationsDetails();
}

function closeTotalApplicationsModal() {
    document.getElementById('totalApplicationsModal').classList.add('hidden');
    totalAppsDetailsData = null;
}

async function loadTotalApplicationsDetails() {
    // Show loading state
    document.getElementById('totalAppsLoadingState').classList.remove('hidden');
    document.getElementById('totalAppsEmptyState').classList.add('hidden');
    document.getElementById('totalAppsTableContainer').classList.add('hidden');
    
    try {
        // Determine which tab is active and get the appropriate form and API endpoint
        const activeTab = getCurrentActiveTab();
        console.log('Active tab detected:', activeTab);
        
        let filterForm, apiEndpoint;
        
        if (activeTab === 'fraud') {
            filterForm = document.getElementById('fraudFilterForm');
            apiEndpoint = '/api/fraud/total-applications-details/';
            console.log('Using fraud form and endpoint');
        } else {
            filterForm = document.getElementById('filterForm');
            apiEndpoint = '/api/total-applications-details/';
            console.log('Using main form and endpoint');
        }
        
        const formData = new FormData(filterForm);
        
        const params = new URLSearchParams({
            page: currentTotalAppsPage,
            per_page: 20,
            sort_by: currentTotalAppsSort,
            sort_order: currentTotalAppsSortOrder,
            search: currentTotalAppsSearch
        });
        
        // Add current filter values
        for (const [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        // Add cache-busting parameter
        params.append('_t', Date.now());
        const response = await fetch(`${apiEndpoint}?${params}`);
        const data = await response.json();
        
        totalAppsDetailsData = data;
        
        // Hide loading state
        document.getElementById('totalAppsLoadingState').classList.add('hidden');
        
        if (data.records.length === 0) {
            // Show empty state
            document.getElementById('totalAppsEmptyState').classList.remove('hidden');
            
            // Update modal title for empty state
            document.getElementById('totalAppsModalTitle').textContent = `Total Applications (0)`;
            document.getElementById('totalAppsModalSubtitle').textContent = `No applications found with current filters`;
        } else {
            // Show table and populate data
            document.getElementById('totalAppsTableContainer').classList.remove('hidden');
            
            // Update modal title with filtered count
            const filteredCount = data.pagination.total_records;
            document.getElementById('totalAppsModalTitle').textContent = `Total Applications (${filteredCount})`;
            document.getElementById('totalAppsModalSubtitle').textContent = `${filteredCount} applications`;
            
            populateTotalAppsDetailsTable(data);
            updateTotalAppsPagination(data.pagination);
            updateTotalAppsTotals(data.totals);
        }
        
    } catch (error) {
        console.error('Error loading total applications details:', error);
        document.getElementById('totalAppsLoadingState').classList.add('hidden');
        document.getElementById('totalAppsEmptyState').classList.remove('hidden');
    }
}

function populateTotalAppsDetailsTable(data) {
    const tbody = document.getElementById('totalAppsDetailsTableBody');
    tbody.innerHTML = '';
    
    data.records.forEach(record => {
        const row = document.createElement('tr');
        row.className = 'border-b border-border/50 hover:bg-secondary/50 transition-colors';
        
        // Format closed status as badge
        const closedStatus = record.closed_status || '—';
        let statusBadge = '';
        
        if (closedStatus === 'Closed') {
            statusBadge = '<span class="px-2 py-1 text-xs bg-green-500/20 text-green-400 rounded-full">Closed</span>';
        } else if (closedStatus === 'On-Time') {
            statusBadge = '<span class="px-2 py-1 text-xs bg-blue-500/20 text-blue-400 rounded-full">On-Time</span>';
        } else if (closedStatus === 'Pre-Close') {
            statusBadge = '<span class="px-2 py-1 text-xs bg-yellow-500/20 text-yellow-400 rounded-full">Pre-Close</span>';
        } else if (closedStatus === 'Post-Close') {
            statusBadge = '<span class="px-2 py-1 text-xs bg-orange-500/20 text-orange-400 rounded-full">Post-Close</span>';
        } else if (closedStatus === 'Not Closed') {
            statusBadge = '<span class="px-2 py-1 text-xs bg-red-500/20 text-red-400 rounded-full">Not Closed</span>';
        } else {
            statusBadge = `<span class="px-2 py-1 text-xs bg-gray-500/20 text-gray-400 rounded-full">${closedStatus}</span>`;
        }
        
        row.innerHTML = `
            <td class="py-3 px-4 font-mono text-sm">${record.loan_no || '—'}</td>
            <td class="py-3 px-4 font-mono text-sm">${record.pan || '—'}</td>
            <td class="py-3 px-4 text-sm">${record.disbursal_date}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.loan_amount)}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.net_disbursal)}</td>
            <td class="py-3 px-4 text-right text-sm">${record.tenure || '—'}</td>
            <td class="py-3 px-4 text-sm">${record.repayment_date}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.repayment_amount)}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.processing_fee)}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.interest_amount)}</td>
            <td class="py-3 px-4 text-sm">${record.last_received_date}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.total_received)}</td>
            <td class="py-3 px-4 text-sm">${statusBadge}</td>
        `;
        
        tbody.appendChild(row);
    });
}

function updateTotalAppsPagination(pagination) {
    const startRecord = (pagination.current_page - 1) * pagination.per_page + 1;
    const endRecord = Math.min(startRecord + pagination.per_page - 1, pagination.total_records);
    
    document.getElementById('totalAppsPaginationInfo').textContent = 
        `${startRecord}-${endRecord} of ${pagination.total_records}`;
    document.getElementById('totalAppsPageInfo').textContent = 
        `Page ${pagination.current_page} of ${pagination.total_pages}`;
    
    document.getElementById('totalAppsPrevBtn').disabled = !pagination.has_previous;
    document.getElementById('totalAppsNextBtn').disabled = !pagination.has_next;
}

function updateTotalAppsTotals(totals) {
    document.getElementById('totalAppsTotalLoanAmount').textContent = formatCurrency(totals.total_loan_amount);
    document.getElementById('totalAppsTotalNetDisbursal').textContent = formatCurrency(totals.total_net_disbursal);
    document.getElementById('totalAppsTotalRepaymentAmount').textContent = formatCurrency(totals.total_repayment_amount);
    document.getElementById('totalAppsTotalProcessingFee').textContent = formatCurrency(totals.total_processing_fee);
    document.getElementById('totalAppsTotalInterestAmount').textContent = formatCurrency(totals.total_interest_amount);
    document.getElementById('totalAppsTotalReceived').textContent = formatCurrency(totals.total_received);
}

function changeTotalAppsPage(direction) {
    if (!totalAppsDetailsData) return;
    
    const newPage = currentTotalAppsPage + direction;
    const maxPage = totalAppsDetailsData.pagination.total_pages;
    
    if (newPage >= 1 && newPage <= maxPage) {
        currentTotalAppsPage = newPage;
        loadTotalApplicationsDetails();
    }
}

function sortTotalAppsTable(column) {
    if (currentTotalAppsSort === column) {
        currentTotalAppsSortOrder = currentTotalAppsSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        currentTotalAppsSort = column;
        currentTotalAppsSortOrder = 'desc';
    }
    
    // Update sort indicators
    document.querySelectorAll('[id^="sort-"]').forEach(el => {
        el.textContent = '↕';
    });
    
    const sortIndicator = document.getElementById(`sort-${column}`);
    if (sortIndicator) {
        sortIndicator.textContent = currentTotalAppsSortOrder === 'asc' ? '↑' : '↓';
    }
    
    currentTotalAppsPage = 1;
    loadTotalApplicationsDetails();
}

async function exportTotalApplications() {
    try {
        // Determine which tab is active and get the appropriate form and API endpoint
        const activeTab = getCurrentActiveTab();
        let filterForm, apiEndpoint;
        
        if (activeTab === 'fraud') {
            filterForm = document.getElementById('fraudFilterForm');
            apiEndpoint = '/api/fraud/total-applications-details/';
        } else {
            filterForm = document.getElementById('filterForm');
            apiEndpoint = '/api/total-applications-details/';
        }
        
        const formData = new FormData(filterForm);
        
        const params = new URLSearchParams({
            per_page: 10000, // Large number to get all records
            sort_by: currentTotalAppsSort,
            sort_order: currentTotalAppsSortOrder,
            search: currentTotalAppsSearch
        });
        
        // Add current filter values
        for (const [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        // Add cache-busting parameter
        params.append('_t', Date.now());
        const response = await fetch(`${apiEndpoint}?${params}`);
        const data = await response.json();
        
        if (!data.records || data.records.length === 0) {
            alert('No data to export');
            return;
        }
        
        const headers = ['Loan No', 'PAN', 'Disbursal Date', 'Loan Amount', 'Net Disbursal', 'Tenure', 'Repayment Date', 'Repayment Amount', 'Processing Fee', 'Interest Amount', 'Last Received Date', 'Total Received', 'Closed Status'];
        const csvContent = [
            headers.join(','),
            ...data.records.map(record => [
                record.loan_no || '',
                record.pan || '',
                record.disbursal_date,
                record.loan_amount,
                record.net_disbursal,
                record.tenure || '',
                record.repayment_date,
                record.repayment_amount,
                record.processing_fee,
                record.interest_amount,
                record.last_received_date,
                record.total_received,
                record.closed_status || ''
            ].join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `total-applications-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
    } catch (error) {
        console.error('Error exporting total applications:', error);
        alert('Error exporting data. Please try again.');
    }
}

// Load charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Format all currency values
    formatAllCurrencyValues();
    
    // Restore main dashboard filters from localStorage FIRST
    restoreMainFilters();
    
    // Setup auto-filter functionality AFTER restoring filters
    setupAutoFilters();
    
    setupAutoRefresh(); // Enable auto-refresh every 10 seconds
    
    // Setup DPD search functionality
    const searchInput = document.getElementById('dpdSearchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentDPDSearch = this.value;
                currentDPDPage = 1;
                loadDPDDetails();
            }, 300);
        });
    }
    
    // Setup Total Applications search functionality
    const totalAppsSearchInput = document.getElementById('totalAppsSearchInput');
    if (totalAppsSearchInput) {
        let totalAppsSearchTimeout;
        totalAppsSearchInput.addEventListener('input', function() {
            clearTimeout(totalAppsSearchTimeout);
            totalAppsSearchTimeout = setTimeout(() => {
                currentTotalAppsSearch = this.value;
                currentTotalAppsPage = 1;
                loadTotalApplicationsDetails();
            }, 300);
        });
    }
    
    loadDPDBucketData();
    loadStateRepaymentChart();
    loadTimeSeriesChart();
    loadCityCollectedChart();
    loadCityUncollectedChart();
});

// Debug function to test URL parameter preservation
function testUrlPreservation() {
    const currentUrl = new URL(window.location);
    const currentParams = currentUrl.searchParams;
    
    console.log('=== URL Parameter Test ===');
    console.log('Current URL:', window.location.href);
    console.log('Current Parameters:', Object.fromEntries(currentParams.entries()));
    
    const newUrl = new URL(window.location.origin + window.location.pathname);
    for (const [key, value] of currentParams.entries()) {
        if (value) {
            newUrl.searchParams.set(key, value);
        }
    }
    
    console.log('New URL would be:', newUrl.toString());
    console.log('Parameters preserved:', Object.fromEntries(newUrl.searchParams.entries()));
    console.log('========================');
}

// Make test function available globally
window.testUrlPreservation = testUrlPreservation;

// Utility Functions
function formatCurrency(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) {
        return '₹0';
    }
    
    // Convert to number if it's a string
    const numAmount = parseFloat(amount);
    
    // Format with Indian number system (lakhs, crores)
    if (numAmount >= 10000000) { // 1 crore
        return '₹' + (numAmount / 10000000).toFixed(1) + ' Cr';
    } else if (numAmount >= 100000) { // 1 lakh
        return '₹' + (numAmount / 100000).toFixed(1) + ' L';
    } else if (numAmount >= 1000) { // 1 thousand
        return '₹' + (numAmount / 1000).toFixed(1) + ' K';
    } else {
        return '₹' + numAmount.toLocaleString('en-IN');
    }
}

function formatNumber(number) {
    if (number === null || number === undefined || isNaN(number)) {
        return '0';
    }
    
    const num = parseFloat(number);
    
    if (num >= 10000000) { // 1 crore
        return (num / 10000000).toFixed(1) + ' Cr';
    } else if (num >= 100000) { // 1 lakh
        return (num / 100000).toFixed(1) + ' L';
    } else if (num >= 1000) { // 1 thousand
        return (num / 1000).toFixed(1) + ' K';
    } else {
        return num.toLocaleString('en-IN');
    }
}

// Format all currency values on the page
function formatAllCurrencyValues() {
    const elements = document.querySelectorAll('[data-amount]');
    elements.forEach(element => {
        const amount = parseFloat(element.getAttribute('data-amount'));
        if (!isNaN(amount)) {
            element.textContent = formatCurrency(amount);
        }
    });
}

// Auto-apply filters when any filter changes
function setupAutoFilters() {
    const filterInputs = document.querySelectorAll('.filter-input');
    
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            // Handle state change for dynamic city filtering
            if (input.name === 'state') {
                updateCityOptions(input.value, input.closest('form'));
            }
            
            // Determine which form this input belongs to
            const form = input.closest('form');
            const formId = form ? form.id : 'filterForm';
            
            // For date inputs, update filter options when any date changes
            if (input.type === 'date') {
                const dateFrom = form.querySelector('input[name="date_from"]').value;
                const dateTo = form.querySelector('input[name="date_to"]').value;
                
                // Update filter options whenever any date is changed
                if (formId === 'fraudFilterForm') {
                    // For fraud tab, use the fraud-specific filter update function
                    updateFraudFilterOptions(form).then(() => {
                        // Only submit if both dates are provided or both are empty
                        if ((dateFrom && dateTo) || (!dateFrom && !dateTo)) {
                            // Handle fraud tab filters - reload fraud data
                            applyFraudFilters();
                        }
                    });
                } else {
                    // For main dashboard, use the regular filter update function
                    updateFilterOptions(form).then(() => {
                        // Only submit if both dates are provided or both are empty
                        if ((dateFrom && dateTo) || (!dateFrom && !dateTo)) {
                            // Save main filters before submitting
                            saveMainFilters();
                        document.getElementById('filterForm').submit();
                        }
                    });
                }
            } else {
                // For dropdowns, apply immediately
                if (formId === 'fraudFilterForm') {
                    // Handle fraud tab filters - reload fraud data
                    applyFraudFilters();
                } else {
                    // Save main filters before submitting
                    saveMainFilters();
                document.getElementById('filterForm').submit();
                }
            }
        });
    });
}

// Function to update all filter options based on current filters
async function updateFilterOptions(form) {
    try {
        console.log('Updating filter options...');
        
        // Get current filter values from the form
        const dateFrom = form.querySelector('input[name="date_from"]')?.value;
        const dateTo = form.querySelector('input[name="date_to"]')?.value;
        const dateType = form.querySelector('select[name="date_type"]')?.value;
        const closingStatus = form.querySelector('select[name="closing_status"]')?.value;
        const dpd = form.querySelector('select[name="dpd"]')?.value;
        
        console.log('Current filters:', { dateFrom, dateTo, dateType, closingStatus, dpd });
        
        // Build URL with current filters
        const params = new URLSearchParams();
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (dateType) params.append('date_type', dateType);
        if (closingStatus) params.append('closing_status', closingStatus);
        if (dpd) params.append('dpd', dpd);
        
        console.log('Fetching filter options with params:', params.toString());
        const response = await fetch(`/api/kpi-data/?${params.toString()}`);
        const data = await response.json();
        
        console.log('Received filter options:', data.filter_options);
        
        if (data && data.filter_options) {
            const options = data.filter_options;
            
            // Update states dropdown
            const stateSelect = form.querySelector('select[name="state"]');
            if (stateSelect) {
                const currentState = stateSelect.value;
                stateSelect.innerHTML = '<option value="">All States</option>';
                options.states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    if (state === currentState) option.selected = true;
                    stateSelect.appendChild(option);
                });
            }
            
            // Update cities dropdown
            const citySelect = form.querySelector('select[name="city"]');
            if (citySelect) {
                const currentCity = citySelect.value;
                citySelect.innerHTML = '<option value="">All Cities</option>';
                
                // If a state is selected, update cities for that state
                const selectedState = stateSelect?.value;
                if (selectedState) {
                    try {
                        const cityParams = new URLSearchParams(params);
                        cityParams.append('state', selectedState);
                        const cityResponse = await fetch(`/api/cities-by-state/?${cityParams.toString()}`);
                        const cityData = await cityResponse.json();
                        
                        cityData.cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city;
                            option.textContent = city;
                            if (city === currentCity) option.selected = true;
                            citySelect.appendChild(option);
                        });
                    } catch (error) {
                        console.error('Error fetching cities for state:', error);
                    }
                }
            }
            
            // Update closing status dropdown
            const closingStatusSelect = form.querySelector('select[name="closing_status"]');
            if (closingStatusSelect) {
                const currentStatus = closingStatusSelect.value;
                closingStatusSelect.innerHTML = '<option value="">All Status</option>';
                options.closing_statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === currentStatus) option.selected = true;
                    closingStatusSelect.appendChild(option);
                });
            }
            
            // Update DPD buckets dropdown
            const dpdSelect = form.querySelector('select[name="dpd"]');
            if (dpdSelect) {
                const currentDpd = dpdSelect.value;
                dpdSelect.innerHTML = '<option value="">All DPD</option>';
                options.dpd_buckets.forEach(bucket => {
                    const option = document.createElement('option');
                    option.value = bucket;
                    option.textContent = bucket;
                    if (bucket === currentDpd) option.selected = true;
                    dpdSelect.appendChild(option);
                });
            }
            
            console.log('Updated filter options with current filters:', {
                states: options.states.length,
                cities: citySelect?.options.length || 0,
                closing_statuses: options.closing_statuses.length,
                dpd_buckets: options.dpd_buckets.length
            });
        }
    } catch (error) {
        console.error('Error updating filter options:', error);
    }
}

// Function to update city options based on selected state
async function updateCityOptions(selectedState, form) {
    const citySelect = form.querySelector('select[name="city"]');
    if (!citySelect) return;
    
    // Clear current options except "All Cities"
    citySelect.innerHTML = '<option value="">All Cities</option>';
    
    if (!selectedState) {
        return; // No state selected, keep only "All Cities"
    }
    
    try {
        // Get current filter values from the form
        const dateFrom = form.querySelector('input[name="date_from"]')?.value;
        const dateTo = form.querySelector('input[name="date_to"]')?.value;
        const dateType = form.querySelector('select[name="date_type"]')?.value;
        const closingStatus = form.querySelector('select[name="closing_status"]')?.value;
        const dpd = form.querySelector('select[name="dpd"]')?.value;
        
        // Build URL with current filters
        const params = new URLSearchParams();
        params.append('state', selectedState);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (dateType) params.append('date_type', dateType);
        if (closingStatus) params.append('closing_status', closingStatus);
        if (dpd) params.append('dpd', dpd);
        
        const response = await fetch(`/api/cities-by-state/?${params.toString()}`);
        const data = await response.json();
        
        // Add cities to the dropdown
        data.cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            citySelect.appendChild(option);
        });
        
        console.log(`Updated city options for state "${selectedState}" with current filters:`, data.cities.length, 'cities');
    } catch (error) {
        console.error('Error fetching cities for state:', error);
    }
}

// Save main dashboard filter values to localStorage
function saveMainFilters() {
    const form = document.getElementById('filterForm');
    if (!form) {
        console.log('Main filter form not found for saving');
        return;
    }
    
    const dateTypeSelect = form.querySelector('select[name="date_type"]');
    if (!dateTypeSelect) {
        console.log('date_type select element not found for saving');
        return;
    }
    
    const filters = {
        date_from: form.querySelector('input[name="date_from"]').value,
        date_to: form.querySelector('input[name="date_to"]').value,
        date_type: dateTypeSelect.value,
        closing_status: form.querySelector('select[name="closing_status"]').value,
        dpd: form.querySelector('select[name="dpd"]').value,
        state: form.querySelector('select[name="state"]').value,
        city: form.querySelector('select[name="city"]').value
    };
    
    localStorage.setItem('mainFilters', JSON.stringify(filters));
    console.log('Main filters saved:', filters);
    console.log('date_type value saved:', filters.date_type);
}

// Restore main dashboard filter values from localStorage
function restoreMainFilters() {
    const form = document.getElementById('filterForm');
    if (!form) {
        console.log('Main filter form not found');
        return;
    }
    
    const savedFilters = localStorage.getItem('mainFilters');
    if (!savedFilters) {
        console.log('No saved main filters found in localStorage');
        return;
    }
    
    try {
        const filters = JSON.parse(savedFilters);
        console.log('Restoring main filters:', filters);
        
        // Restore form values
        if (filters.date_from) {
            const dateFromInput = form.querySelector('input[name="date_from"]');
            if (dateFromInput) dateFromInput.value = filters.date_from;
        }
        if (filters.date_to) {
            const dateToInput = form.querySelector('input[name="date_to"]');
            if (dateToInput) dateToInput.value = filters.date_to;
        }
        if (filters.date_type) {
            const dateTypeSelect = form.querySelector('select[name="date_type"]');
            if (dateTypeSelect) {
                dateTypeSelect.value = filters.date_type;
                console.log('Set date_type to:', filters.date_type);
            } else {
                console.log('date_type select element not found');
            }
        }
        if (filters.closing_status) {
            const closingStatusSelect = form.querySelector('select[name="closing_status"]');
            if (closingStatusSelect) closingStatusSelect.value = filters.closing_status;
        }
        if (filters.dpd) {
            const dpdSelect = form.querySelector('select[name="dpd"]');
            if (dpdSelect) dpdSelect.value = filters.dpd;
        }
        if (filters.state) {
            const stateSelect = form.querySelector('select[name="state"]');
            if (stateSelect) {
                stateSelect.value = filters.state;
                // Update city options for the restored state
                updateCityOptions(filters.state, form).then(() => {
                    // Set city value after cities are loaded
                    if (filters.city) {
                        const citySelect = form.querySelector('select[name="city"]');
                        if (citySelect) citySelect.value = filters.city;
                    }
                });
            }
        } else if (filters.city) {
            // If no state but city is selected, just set the city
            const citySelect = form.querySelector('select[name="city"]');
            if (citySelect) citySelect.value = filters.city;
        }
        
        console.log('Main filters restored successfully');
        
    } catch (error) {
        console.error('Error restoring main filters:', error);
    }
}

// Save fraud filter values to localStorage
function saveFraudFilters() {
    const form = document.getElementById('fraudFilterForm');
    if (!form) return;
    
    const filters = {
        date_from: form.querySelector('input[name="date_from"]').value,
        date_to: form.querySelector('input[name="date_to"]').value,
        date_type: form.querySelector('select[name="date_type"]').value,
        closing_status: form.querySelector('select[name="closing_status"]').value,
        dpd: form.querySelector('select[name="dpd"]').value,
        state: form.querySelector('select[name="state"]').value,
        city: form.querySelector('select[name="city"]').value
    };
    
    localStorage.setItem('fraudFilters', JSON.stringify(filters));
    console.log('Fraud filters saved:', filters);
}

// Restore fraud filter values from localStorage
function restoreFraudFilters() {
    const form = document.getElementById('fraudFilterForm');
    if (!form) return;
    
    const savedFilters = localStorage.getItem('fraudFilters');
    if (!savedFilters) return;
    
    try {
        const filters = JSON.parse(savedFilters);
        console.log('Restoring fraud filters:', filters);
        
        // Restore form values
        if (filters.date_from) form.querySelector('input[name="date_from"]').value = filters.date_from;
        if (filters.date_to) form.querySelector('input[name="date_to"]').value = filters.date_to;
        if (filters.date_type) form.querySelector('select[name="date_type"]').value = filters.date_type;
        if (filters.closing_status) form.querySelector('select[name="closing_status"]').value = filters.closing_status;
        if (filters.dpd) form.querySelector('select[name="dpd"]').value = filters.dpd;
        if (filters.state) form.querySelector('select[name="state"]').value = filters.state;
        if (filters.city) form.querySelector('select[name="city"]').value = filters.city;
        
    } catch (error) {
        console.error('Error restoring fraud filters:', error);
    }
}

// Clear fraud filter values
function clearFraudFilters() {
    const form = document.getElementById('fraudFilterForm');
    if (!form) return;
    
    // Clear all form fields
    form.querySelector('input[name="date_from"]').value = '';
    form.querySelector('input[name="date_to"]').value = '';
    form.querySelector('select[name="date_type"]').value = 'repayment_date';
    form.querySelector('select[name="closing_status"]').value = '';
    form.querySelector('select[name="dpd"]').value = '';
    form.querySelector('select[name="state"]').value = '';
    form.querySelector('select[name="city"]').value = '';
    
    // Clear saved filters
    localStorage.removeItem('fraudFilters');
    
    console.log('Fraud filters cleared');
    
    // Reload data without filters
    applyFraudFilters();
}

// Apply fraud filters and reload data
function applyFraudFilters() {
    console.log('Applying fraud filters...');
    
    // Save current filter values
    saveFraudFilters();
    
    // Get filter values from the fraud form
    const form = document.getElementById('fraudFilterForm');
    const filters = {};
    
    // Date filters
    const dateFrom = form.querySelector('input[name="date_from"]').value;
    const dateTo = form.querySelector('input[name="date_to"]').value;
    const dateType = form.querySelector('select[name="date_type"]').value;
    if (dateFrom) filters.date_from = dateFrom;
    if (dateTo) filters.date_to = dateTo;
    if (dateType) filters.date_type = dateType;
    
    // Other filters
    const closingStatus = form.querySelector('select[name="closing_status"]').value;
    const dpd = form.querySelector('select[name="dpd"]').value;
    const state = form.querySelector('select[name="state"]').value;
    const city = form.querySelector('select[name="city"]').value;
    
    if (closingStatus) filters.closing_status = closingStatus;
    if (dpd) filters.dpd = dpd;
    if (state) filters.state = state;
    if (city) filters.city = city;
    
    console.log('Fraud filters:', filters);
    
    // Reload all fraud data with the new filters
    loadFraudKpiData(filters);
    loadFraudDpdTable(filters);
    loadFraudStateChart(filters);
    loadFraudTimeSeriesChart(filters);
    loadFraudCityCollectedChart(filters);
    loadFraudCityUncollectedChart(filters);
}

// Auto-refresh dashboard data every 10 seconds via API
function setupAutoRefresh() {
    let refreshInterval;
    let isUserInteracting = false;
    let userInteractionTimeout;
    
    // Disable auto-refresh when user is interacting
    function pauseAutoRefresh() {
        isUserInteracting = true;
        clearTimeout(userInteractionTimeout);
        userInteractionTimeout = setTimeout(() => {
            isUserInteracting = false;
        }, 30000); // Resume after 30 seconds of no interaction
    }
    
    // Listen for user interactions
    document.addEventListener('change', pauseAutoRefresh);
    document.addEventListener('click', pauseAutoRefresh);
    document.addEventListener('keydown', pauseAutoRefresh);
    
    async function refreshDashboardData() {
        if (isUserInteracting || window.autoRefreshPaused) {
            console.log('Auto-refresh paused - user is interacting or manually paused');
            return;
        }
        
        console.log('Refreshing dashboard data via API...');
        
        try {
            // Get current filter parameters
            const currentUrl = new URL(window.location);
            const currentParams = currentUrl.searchParams;
            const params = new URLSearchParams();
            
            // Preserve all current filter parameters
            for (const [key, value] of currentParams.entries()) {
                if (value) {
                    params.set(key, value);
                }
            }
            
            // Refresh all dashboard components with preserved parameters
            const filterParams = Object.fromEntries(params.entries());
            const paramsString = params.toString();
            await Promise.all([
                refreshKPIData(paramsString),
                loadDPDBucketData(filterParams),
                loadStateRepaymentChart(filterParams),
                loadTimeSeriesChart(filterParams),
                loadCityCollectedChart(filterParams),
                loadCityUncollectedChart(filterParams)
            ]);
            
            console.log('Dashboard data refreshed successfully');
        } catch (error) {
            console.error('Error refreshing dashboard data:', error);
        }
    }
    
    // Start auto-refresh
    refreshInterval = setInterval(refreshDashboardData, 10000);
    
    // Show refresh indicator
    showRefreshIndicator();
    
    // Return function to stop auto-refresh if needed
    return function stopAutoRefresh() {
        clearInterval(refreshInterval);
        clearTimeout(userInteractionTimeout);
    };
}

// Refresh KPI data via API
async function refreshKPIData(params) {
    try {
        const response = await fetch(`/api/kpi-data/?${params}`);
        const data = await response.json();
        
        if (data.data) {
            const kpis = data.data;
            
            // Update Total Applications
            const totalAppsElement = document.getElementById('totalApplications');
            if (totalAppsElement) {
                totalAppsElement.textContent = kpis.total_applications.toLocaleString();
            }
            
            // Update Fresh Cases
            const freshCasesElement = document.getElementById('freshCases');
            if (freshCasesElement) {
                freshCasesElement.textContent = kpis.fresh_cases.toLocaleString();
            }
            
            // Update Fresh Percentage
            const freshPercentageElement = document.getElementById('freshPercentage');
            if (freshPercentageElement) {
                freshPercentageElement.textContent = kpis.fresh_percentage.toFixed(1);
            }
            
            // Update Reloan Cases
            const reloanCasesElement = document.getElementById('reloanCases');
            if (reloanCasesElement) {
                reloanCasesElement.textContent = kpis.reloan_cases.toLocaleString();
            }
            
            // Update Reloan Percentage
            const reloanPercentageElement = document.getElementById('reloanPercentage');
            if (reloanPercentageElement) {
                reloanPercentageElement.textContent = kpis.reloan_percentage.toFixed(1);
            }
            
            // Update Sanction Amount
            const sanctionElement = document.getElementById('sanctionAmount');
            if (sanctionElement) {
                sanctionElement.textContent = formatCurrency(kpis.sanction_amount);
            }
            
            // Update Fresh Sanction Amount
            const freshSanctionElement = document.getElementById('freshSanctionAmount');
            if (freshSanctionElement) {
                freshSanctionElement.textContent = formatCurrency(kpis.fresh_sanction_amount);
            }
            
            // Update Reloan Sanction Amount
            const reloanSanctionElement = document.getElementById('reloanSanctionAmount');
            if (reloanSanctionElement) {
                reloanSanctionElement.textContent = formatCurrency(kpis.reloan_sanction_amount);
            }
            
            // Update Disbursed Amount
            const disbursedElement = document.getElementById('disbursedAmount');
            if (disbursedElement) {
                disbursedElement.textContent = formatCurrency(kpis.net_disbursal);
            }
            
            // Update Fresh Disbursed Amount
            const freshDisbursedElement = document.getElementById('freshDisbursedAmount');
            if (freshDisbursedElement) {
                freshDisbursedElement.textContent = formatCurrency(kpis.fresh_disbursed_amount);
            }
            
            // Update Reloan Disbursed Amount
            const reloanDisbursedElement = document.getElementById('reloanDisbursedAmount');
            if (reloanDisbursedElement) {
                reloanDisbursedElement.textContent = formatCurrency(kpis.reloan_disbursed_amount);
            }
            
            // Update Repayment Amount
            const repaymentElement = document.getElementById('repaymentAmount');
            if (repaymentElement) {
                repaymentElement.textContent = formatCurrency(kpis.repayment_amount);
            }
            
            // Update Fresh Repayment Amount
            const freshRepaymentElement = document.getElementById('freshRepaymentAmount');
            if (freshRepaymentElement) {
                freshRepaymentElement.textContent = formatCurrency(kpis.fresh_repayment_amount);
            }
            
            // Update Reloan Repayment Amount
            const reloanRepaymentElement = document.getElementById('reloanRepaymentAmount');
            if (reloanRepaymentElement) {
                reloanRepaymentElement.textContent = formatCurrency(kpis.reloan_repayment_amount);
            }
            
            
            // Update Collected Amount
            const collectedElement = document.getElementById('collectedAmount');
            if (collectedElement) {
                collectedElement.textContent = formatCurrency(kpis.collected_amount);
            }
            
            // Update Collected Percentage
            const collectedPercentageElement = document.getElementById('collectedPercentage');
            if (collectedPercentageElement) {
                collectedPercentageElement.textContent = kpis.collected_percentage.toFixed(1) + '% of Repayment';
            }
            
            // Update Fresh Collected Amount
            const freshCollectedElement = document.getElementById('freshCollectedAmount');
            if (freshCollectedElement) {
                freshCollectedElement.textContent = formatCurrency(kpis.fresh_collected_amount);
            }
            
            // Update Reloan Collected Amount
            const reloanCollectedElement = document.getElementById('reloanCollectedAmount');
            if (reloanCollectedElement) {
                reloanCollectedElement.textContent = formatCurrency(kpis.reloan_collected_amount);
            }
            
            // Update Pending Amount
            const pendingElement = document.getElementById('pendingAmount');
            if (pendingElement) {
                pendingElement.textContent = formatCurrency(kpis.pending_collection);
            }
            
            // Update Pending Percentage
            const pendingPercentageElement = document.getElementById('pendingPercentage');
            if (pendingPercentageElement) {
                pendingPercentageElement.textContent = kpis.pending_percentage.toFixed(1) + '% of Repayment';
            }
            
            // Update Fresh Pending Amount
            const freshPendingElement = document.getElementById('freshPendingAmount');
            if (freshPendingElement) {
                freshPendingElement.textContent = formatCurrency(kpis.fresh_pending_amount);
            }
            
            // Update Reloan Pending Amount
            const reloanPendingElement = document.getElementById('reloanPendingAmount');
            if (reloanPendingElement) {
                reloanPendingElement.textContent = formatCurrency(kpis.reloan_pending_amount);
            }
            
            // Update Principal Outstanding Amount
            const principalOutstandingElement = document.getElementById('principalOutstandingAmount');
            if (principalOutstandingElement) {
                principalOutstandingElement.textContent = formatCurrency(kpis.principal_outstanding);
            }
            
            // Update Fresh Principal Outstanding Amount
            const freshPrincipalOutstandingElement = document.getElementById('freshPrincipalOutstanding');
            if (freshPrincipalOutstandingElement) {
                freshPrincipalOutstandingElement.textContent = formatCurrency(kpis.fresh_principal_outstanding);
            }
            
            // Update Reloan Principal Outstanding Amount
            const reloanPrincipalOutstandingElement = document.getElementById('reloanPrincipalOutstanding');
            if (reloanPrincipalOutstandingElement) {
                reloanPrincipalOutstandingElement.textContent = formatCurrency(kpis.reloan_principal_outstanding);
            }
        }
        
        console.log('KPI data refreshed successfully');
    } catch (error) {
        console.error('Error refreshing KPI data:', error);
    }
}

// Show refresh indicator
function showRefreshIndicator() {
    // Create refresh indicator
    const indicator = document.createElement('div');
    indicator.id = 'refresh-indicator';
    indicator.innerHTML = `
        <div class="fixed top-4 right-4 bg-blue-500/90 text-white px-4 py-2 rounded-xl shadow-lg z-50 flex items-center gap-2">
            <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
            <span class="text-sm font-medium">Data refresh: 10s</span>
            <button id="toggle-refresh" class="ml-2 text-xs bg-white/20 px-2 py-1 rounded hover:bg-white/30 transition-colors">
                Pause
            </button>
        </div>
    `;
    document.body.appendChild(indicator);
    
    // Add toggle functionality
    const toggleButton = indicator.querySelector('#toggle-refresh');
    let isPaused = false;
    
    toggleButton.addEventListener('click', function() {
        isPaused = !isPaused;
        toggleButton.textContent = isPaused ? 'Resume' : 'Pause';
        indicator.querySelector('.animate-pulse').style.animationPlayState = isPaused ? 'paused' : 'running';
        
        // Store pause state
        window.autoRefreshPaused = isPaused;
    });
    
    // Update countdown every second
    let countdown = 10;
    const countdownInterval = setInterval(() => {
        if (!window.autoRefreshPaused) {
            countdown--;
            if (countdown <= 0) {
                countdown = 10;
            }
        }
        indicator.querySelector('span').textContent = `Data refresh: ${countdown}s`;
    }, 1000);
}

// Load DPD Bucket Data
async function loadDPDBucketData() {
    try {
        const params = new URLSearchParams(window.location.search);
        const response = await fetch(`/api/dpd-buckets/?${params}`);
        const data = await response.json();
        
        const tbody = document.getElementById('dpdTableBody');
        tbody.innerHTML = '';
        
        let totalCount = 0;
        data.data.forEach(item => totalCount += item.count);
        
        data.data.forEach((item, index) => {
            const percentage = totalCount > 0 ? (item.count / totalCount) * 100 : 0;
            const row = document.createElement('tr');
            
            // Add highlighting for selected DPD bucket and make clickable
            if (item.is_selected) {
                row.className = 'border-b border-border/50 bg-blue-500/10 border-l-4 border-l-blue-500 transition-colors cursor-pointer hover:bg-blue-500/20';
            } else {
                row.className = 'border-b border-border/50 hover:bg-secondary/50 transition-colors cursor-pointer';
            }
            
            // Add click handler
            row.onclick = () => openDPDDetailsModal(item.dpd_bucket, item.count);
            
            const bucketColor = getBucketColor(item.dpd_bucket);
            
            row.innerHTML = `
                <td class="py-3 px-4 font-medium ${item.is_selected ? 'text-blue-400' : ''}">${item.dpd_bucket} days</td>
                <td class="py-3 px-4 text-right ${item.is_selected ? 'text-blue-400 font-semibold' : ''}">${formatNumber(item.count)}</td>
            `;
            
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading DPD bucket data:', error);
    }
}

function getBucketColor(bucket) {
    if (bucket === '0-30') return 'bg-green-500';
    if (bucket === '31-60') return 'bg-yellow-500';
    if (bucket === '61-90') return 'bg-orange-500';
    return 'bg-red-500';
}

// Load State Repayment Chart
async function loadStateRepaymentChart() {
    try {
        const params = new URLSearchParams(window.location.search);
        const response = await fetch(`/api/state-repayment/?${params}`);
        const data = await response.json();
        
        const ctx = document.getElementById('stateChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.stateChartInstance) {
            window.stateChartInstance.destroy();
        }
        
        window.stateChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.data.map(item => item.state),
                datasets: [{
                    label: 'Repayment Amount',
                    data: data.data.map(item => item.repayment_amount),
                    backgroundColor: '#10b981',
                    borderColor: '#10b981',
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Amount: ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
        
        console.log('State chart created successfully');
    } catch (error) {
        console.error('Error loading state chart:', error);
    }
}

// Load Time Series Chart
async function loadTimeSeriesChart() {
    try {
        const params = new URLSearchParams(window.location.search);
        const response = await fetch(`/api/time-series/?${params}`);
        const data = await response.json();
        
        console.log('Time series data loaded:', data.data.length, 'points');
        
        // Store data globally for fullscreen chart
        window.timeSeriesData = data;
        
        // Calculate summary values
        const totalRepayment = data.data.reduce((sum, item) => sum + item.repayment_amount, 0);
        const totalCollected = data.data.reduce((sum, item) => sum + item.collected_amount, 0);
        const averageCollectionRate = data.data.length > 0 ? 
            data.data.reduce((sum, item) => sum + item.collection_percentage, 0) / data.data.length : 0;
        
        const ctx = document.getElementById('timeSeriesChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.timeSeriesChartInstance) {
            window.timeSeriesChartInstance.destroy();
        }
        
        // Create the actual time series chart with real data
        const chartLabels = data.data.map(item => new Date(item.date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
        const repaymentData = data.data.map(item => item.repayment_amount);
        const collectedData = data.data.map(item => item.collected_amount);
        
        window.timeSeriesChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [
                    {
                        label: 'Repayment Amount',
                        data: repaymentData,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: 'Collected Amount',
                        data: collectedData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.1,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        titleColor: '#f8fafc',
                        bodyColor: '#f8fafc',
                        borderColor: '#334155',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                return new Date(data.data[context[0].dataIndex].date).toLocaleDateString('en-IN', { 
                                    weekday: 'short', 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric' 
                                });
                            },
                            label: function(context) {
                                // Only show data for the first dataset to avoid duplication
                                if (context.datasetIndex === 0) {
                                    const dataIndex = context.dataIndex;
                                    const repaymentAmount = data.data[dataIndex].repayment_amount;
                                    const collectedAmount = data.data[dataIndex].collected_amount;
                                    const collectionPercentage = data.data[dataIndex].collection_percentage;
                                    
                                    return [
                                        'Repayment Amount: ' + formatCurrency(repaymentAmount),
                                        'Collected Amount: ' + formatCurrency(collectedAmount),
                                        'Collection Rate: ' + collectionPercentage.toFixed(1) + '%'
                                    ];
                                }
                                return null; // Don't show label for second dataset
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    }
                }
            }
        });
        
        console.log('Time series chart created successfully');
    } catch (error) {
        console.error('Error loading time series chart:', error);
        // Show error message in the chart container
        const chartContainer = document.getElementById('timeSeriesChart').parentElement;
        chartContainer.innerHTML = '<div class="flex items-center justify-center h-80 text-red-500">Error loading chart: ' + error.message + '</div>';
    }
}

// Tab Management
function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + 'Content').classList.remove('hidden');
    
    // Add active class to selected tab
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // Initialize fraud tab if it's being switched to
    if (tabName === 'fraud') {
        console.log('Switching to fraud tab, initializing...');
        initializeFraudTab();
    }
    
}

// Update fraud filter options when filters change
async function updateFraudFilterOptions(form) {
    try {
        console.log('Updating fraud filter options...');
        
        // Get current filter values from the fraud form
        const dateFrom = form.querySelector('input[name="date_from"]')?.value;
        const dateTo = form.querySelector('input[name="date_to"]')?.value;
        const dateType = form.querySelector('select[name="date_type"]')?.value;
        const closingStatus = form.querySelector('select[name="closing_status"]')?.value;
        const dpd = form.querySelector('select[name="dpd"]')?.value;
        
        console.log('Current fraud filters:', { dateFrom, dateTo, dateType, closingStatus, dpd });
        
        // Build URL with current filters
        const params = new URLSearchParams();
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (dateType) params.append('date_type', dateType);
        if (closingStatus) params.append('closing_status', closingStatus);
        if (dpd) params.append('dpd', dpd);
        
        console.log('Fetching fraud filter options with params:', params.toString());
        const response = await fetch(`/api/kpi-data/?${params.toString()}`);
        const data = await response.json();
        
        console.log('Received fraud filter options:', data.filter_options);
        
        if (data && data.filter_options) {
            const options = data.filter_options;
            
            // Update fraud states dropdown
            const fraudStateSelect = document.getElementById('fraudState');
            if (fraudStateSelect) {
                const currentState = fraudStateSelect.value;
                fraudStateSelect.innerHTML = '<option value="">All States</option>';
                options.states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    if (state === currentState) option.selected = true;
                    fraudStateSelect.appendChild(option);
                });
            }
            
            // Update fraud cities dropdown
            const fraudCitySelect = document.getElementById('fraudCity');
            if (fraudCitySelect) {
                const currentCity = fraudCitySelect.value;
                fraudCitySelect.innerHTML = '<option value="">All Cities</option>';
                
                // If a state is selected, update cities for that state
                const selectedState = fraudStateSelect?.value;
                if (selectedState) {
                    try {
                        const cityParams = new URLSearchParams(params);
                        cityParams.append('state', selectedState);
                        const cityResponse = await fetch(`/api/cities-by-state/?${cityParams.toString()}`);
                        const cityData = await cityResponse.json();
                        
                        cityData.cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city;
                            option.textContent = city;
                            if (city === currentCity) option.selected = true;
                            fraudCitySelect.appendChild(option);
                        });
                    } catch (error) {
                        console.error('Error fetching cities for state:', error);
                    }
                }
            }
            
            // Update fraud closing status dropdown
            const fraudClosingStatusSelect = document.getElementById('fraudClosingStatus');
            if (fraudClosingStatusSelect) {
                const currentStatus = fraudClosingStatusSelect.value;
                fraudClosingStatusSelect.innerHTML = '<option value="">All Status</option>';
                options.closing_statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === currentStatus) option.selected = true;
                    fraudClosingStatusSelect.appendChild(option);
                });
            }
            
            // Update fraud DPD buckets dropdown
            const fraudDpdBucketSelect = document.getElementById('fraudDpdBucket');
            if (fraudDpdBucketSelect) {
                const currentDpd = fraudDpdBucketSelect.value;
                fraudDpdBucketSelect.innerHTML = '<option value="">All DPD</option>';
                options.dpd_buckets.forEach(bucket => {
                    const option = document.createElement('option');
                    option.value = bucket;
                    option.textContent = bucket;
                    if (bucket === currentDpd) option.selected = true;
                    fraudDpdBucketSelect.appendChild(option);
                });
            }
            
            console.log('Updated fraud filter options with current filters:', {
                states: options.states.length,
                cities: fraudCitySelect?.options.length || 0,
                closing_statuses: options.closing_statuses.length,
                dpd_buckets: options.dpd_buckets.length
            });
        }
    } catch (error) {
        console.error('Error updating fraud filter options:', error);
    }
}

// Populate fraud filter dropdowns with data (initial load)
async function populateFraudFilterDropdowns() {
    try {
        // Get current filter values from the fraud form
        const form = document.getElementById('fraudFilterForm');
        if (!form) return;
        
        const dateFrom = form.querySelector('input[name="date_from"]')?.value;
        const dateTo = form.querySelector('input[name="date_to"]')?.value;
        const dateType = form.querySelector('select[name="date_type"]')?.value;
        const closingStatus = form.querySelector('select[name="closing_status"]')?.value;
        const dpd = form.querySelector('select[name="dpd"]')?.value;
        
        // Build URL with current filters
        const params = new URLSearchParams();
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (dateType) params.append('date_type', dateType);
        if (closingStatus) params.append('closing_status', closingStatus);
        if (dpd) params.append('dpd', dpd);
        
        // Fetch filter options from the main API with current filters
        const response = await fetch(`/api/kpi-data/?${params.toString()}`);
        const data = await response.json();
        
        if (data && data.filter_options) {
            const options = data.filter_options;
            
            // Populate states dropdown
            const fraudStateSelect = document.getElementById('fraudState');
            if (fraudStateSelect && options.states) {
                const currentState = fraudStateSelect.value;
                fraudStateSelect.innerHTML = '<option value="">All States</option>';
                options.states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    if (state === currentState) option.selected = true;
                    fraudStateSelect.appendChild(option);
                });
            }
            
            // Populate cities dropdown (will be updated based on selected state)
            const fraudCitySelect = document.getElementById('fraudCity');
            if (fraudCitySelect) {
                const currentCity = fraudCitySelect.value;
                fraudCitySelect.innerHTML = '<option value="">All Cities</option>';
                
                // If a state is selected, update cities for that state
                const selectedState = fraudStateSelect?.value;
                if (selectedState) {
                    try {
                        const cityParams = new URLSearchParams(params);
                        cityParams.append('state', selectedState);
                        const cityResponse = await fetch(`/api/cities-by-state/?${cityParams.toString()}`);
                        const cityData = await cityResponse.json();
                        
                        cityData.cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city;
                            option.textContent = city;
                            if (city === currentCity) option.selected = true;
                            fraudCitySelect.appendChild(option);
                        });
                    } catch (error) {
                        console.error('Error fetching cities for state:', error);
                    }
                }
            }
            
            // Populate closing status dropdown
            const fraudClosingStatusSelect = document.getElementById('fraudClosingStatus');
            if (fraudClosingStatusSelect && options.closing_statuses) {
                const currentStatus = fraudClosingStatusSelect.value;
                fraudClosingStatusSelect.innerHTML = '<option value="">All Status</option>';
                options.closing_statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === currentStatus) option.selected = true;
                    fraudClosingStatusSelect.appendChild(option);
                });
            }
            
            // Populate DPD buckets dropdown
            const fraudDpdBucketSelect = document.getElementById('fraudDpdBucket');
            if (fraudDpdBucketSelect && options.dpd_buckets) {
                const currentDpd = fraudDpdBucketSelect.value;
                fraudDpdBucketSelect.innerHTML = '<option value="">All DPD</option>';
                options.dpd_buckets.forEach(bucket => {
                    const option = document.createElement('option');
                    option.value = bucket;
                    option.textContent = bucket;
                    if (bucket === currentDpd) option.selected = true;
                    fraudDpdBucketSelect.appendChild(option);
                });
            }
            
            console.log('Fraud filter dropdowns populated successfully with filtered data:', {
                states: options.states.length,
                cities: fraudCitySelect?.options.length || 0,
                closing_statuses: options.closing_statuses.length,
                dpd_buckets: options.dpd_buckets.length
            });
        }
    } catch (error) {
        console.error('Error populating fraud filter dropdowns:', error);
    }
}

// Initialize fraud tab when it becomes active
function initializeFraudTab() {
    console.log('Initializing fraud tab...');
    
    // Populate filter dropdowns first
    populateFraudFilterDropdowns();
    
    // Restore saved filter values after populating dropdowns
    restoreFraudFilters();
    
    // Get current filter values from the fraud form
    const form = document.getElementById('fraudFilterForm');
    const filters = {};
    
    if (form) {
        // Date filters
        const dateFrom = form.querySelector('input[name="date_from"]').value;
        const dateTo = form.querySelector('input[name="date_to"]').value;
        const dateType = form.querySelector('select[name="date_type"]').value;
        if (dateFrom) filters.date_from = dateFrom;
        if (dateTo) filters.date_to = dateTo;
        if (dateType) filters.date_type = dateType;
        
        // Other filters
        const closingStatus = form.querySelector('select[name="closing_status"]').value;
        const dpd = form.querySelector('select[name="dpd"]').value;
        const state = form.querySelector('select[name="state"]').value;
        const city = form.querySelector('select[name="city"]').value;
        
        if (closingStatus) filters.closing_status = closingStatus;
        if (dpd) filters.dpd = dpd;
        if (state) filters.state = state;
        if (city) filters.city = city;
    }
    
    console.log('Initializing fraud tab with filters:', filters);
    
    // Load initial data with current filters
    loadFraudKpiData(filters);
    loadFraudDpdTable(filters);
    loadFraudStateChart(filters);
    loadFraudTimeSeriesChart(filters);
    loadFraudCityCollectedChart(filters);
    loadFraudCityUncollectedChart(filters);
    console.log('Fraud tab initialization completed');
}

// Fraud-specific data loading functions (using fraud API endpoints)
function loadFraudKpiData(filters = {}) {
    console.log('Loading fraud KPI data...');
    const params = new URLSearchParams(filters);
    // Add cache-busting parameter
    params.append('_t', Date.now());
    fetch(`/api/fraud/kpi-data/?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Fraud KPI data received:', data);
            // Update KPI cards
            document.getElementById('fraudTotalApplications').textContent = data.total_applications?.toLocaleString() || '0';
            
            // Update fresh and reloan cases
            document.getElementById('fraudFreshCases').textContent = data.fresh_cases?.toLocaleString() || '0';
            document.getElementById('fraudFreshPercentage').textContent = data.fresh_percentage?.toFixed(1) || '0.0';
            document.getElementById('fraudReloanCases').textContent = data.reloan_cases?.toLocaleString() || '0';
            document.getElementById('fraudReloanPercentage').textContent = data.reloan_percentage?.toFixed(1) || '0.0';
            
            // Format currency amounts
            const sanctionAmount = formatCurrency(data.sanction_amount || 0);
            const disbursedAmount = formatCurrency(data.disbursed_amount || 0);
            const repaymentAmount = formatCurrency(data.repayment_amount || 0);
            const collectedAmount = formatCurrency(data.collected_amount || 0);
            const pendingCollection = formatCurrency(data.pending_collection || 0);
            const principalOutstandingAmount = formatCurrency(data.principal_outstanding || 0);
            
            document.getElementById('fraudSanctionAmount').textContent = sanctionAmount;
            document.getElementById('fraudDisbursedAmount').textContent = disbursedAmount;
            document.getElementById('fraudRepaymentAmount').textContent = repaymentAmount;
            document.getElementById('fraudCollectedAmount').textContent = collectedAmount;
            document.getElementById('fraudPendingCollection').textContent = pendingCollection;
            document.getElementById('fraudPrincipalOutstandingAmount').textContent = principalOutstandingAmount;
            
            // Update fresh and reloan amounts
            document.getElementById('fraudFreshSanctionAmount').textContent = formatCurrency(data.fresh_sanction_amount || 0);
            document.getElementById('fraudReloanSanctionAmount').textContent = formatCurrency(data.reloan_sanction_amount || 0);
            document.getElementById('fraudFreshDisbursedAmount').textContent = formatCurrency(data.fresh_disbursed_amount || 0);
            document.getElementById('fraudReloanDisbursedAmount').textContent = formatCurrency(data.reloan_disbursed_amount || 0);
            document.getElementById('fraudFreshRepaymentAmount').textContent = formatCurrency(data.fresh_repayment_amount || 0);
            document.getElementById('fraudReloanRepaymentAmount').textContent = formatCurrency(data.reloan_repayment_amount || 0);
            document.getElementById('fraudFreshCollectedAmount').textContent = formatCurrency(data.fresh_collected_amount || 0);
            document.getElementById('fraudReloanCollectedAmount').textContent = formatCurrency(data.reloan_collected_amount || 0);
            document.getElementById('fraudFreshPendingAmount').textContent = formatCurrency(data.fresh_pending_amount || 0);
            document.getElementById('fraudReloanPendingAmount').textContent = formatCurrency(data.reloan_pending_amount || 0);
            document.getElementById('fraudFreshPrincipalOutstanding').textContent = formatCurrency(data.fresh_principal_outstanding || 0);
            document.getElementById('fraudReloanPrincipalOutstanding').textContent = formatCurrency(data.reloan_principal_outstanding || 0);
            
            // Update percentages
            const collectionRate = data.collection_rate || 0;
            const pendingRate = 100 - collectionRate;
            document.getElementById('fraudCollectedPercentage').textContent = `${collectionRate.toFixed(1)}% of Repayment`;
            document.getElementById('fraudPendingPercentage').textContent = `${pendingRate.toFixed(1)}% of Repayment`;
        })
        .catch(error => {
            console.error('Error loading fraud KPI data:', error);
        });
}

function loadFraudDpdTable(filters = {}) {
    const params = new URLSearchParams(filters);
    fetch(`/api/fraud/dpd-buckets/?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Fraud DPD data received:', data);
            const buckets = data.buckets || [];
            
            const tbody = document.getElementById('fraudDpdTableBody');
            tbody.innerHTML = '';
            
            let totalCount = 0;
            buckets.forEach(item => totalCount += item.count);
            
            buckets.forEach((item, index) => {
                const percentage = totalCount > 0 ? (item.count / totalCount) * 100 : 0;
                const row = document.createElement('tr');
                
                // Add styling for table rows with click functionality
                row.className = 'border-b border-border/50 hover:bg-secondary/50 transition-colors cursor-pointer';
                
                // Add click handler to open DPD details modal
                row.onclick = () => openDPDDetailsModal(item.bucket, item.count);
                
                // Format bucket name
                const bucketName = item.bucket === '0' ? '0 days' : 
                                 item.bucket === 'No DPD' ? 'No DPD' : 
                                 `${item.bucket} days`;
                
                row.innerHTML = `
                    <td class="py-3 px-4 font-medium">${bucketName}</td>
                    <td class="py-3 px-4 text-right">${formatNumber(item.count)}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            console.log('Fraud DPD table populated successfully');
        })
        .catch(error => {
            console.error('Error loading fraud DPD data:', error);
            // Show error message in the table container
            const tableContainer = document.getElementById('fraudDpdTableBody').parentElement.parentElement;
            tableContainer.innerHTML = '<div class="flex items-center justify-center h-80 text-red-500">Error loading table: ' + error.message + '</div>';
        });
}

function loadFraudStateChart(filters = {}) {
    const params = new URLSearchParams(filters);
    fetch(`/api/fraud/state-repayment/?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Fraud state data received:', data);
            const states = data.states || [];
            
            // Create canvas element if it doesn't exist
            const container = document.getElementById('fraudStateChart');
            let canvas = container.querySelector('canvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                container.appendChild(canvas);
            }
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.fraudStateChartInstance) {
                window.fraudStateChartInstance.destroy();
            }
            
            window.fraudStateChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: states.slice(0, 10).map(state => state.state),
                    datasets: [{
                        label: 'Repayment Amount',
                        data: states.slice(0, 10).map(state => state.repayment_amount),
                        backgroundColor: '#10b981',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return '₹' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
            
            console.log('Fraud state chart created successfully');
        })
        .catch(error => {
            console.error('Error loading fraud state data:', error);
            // Show error message in the chart container
            const chartContainer = document.getElementById('fraudStateChart').parentElement;
            chartContainer.innerHTML = '<div class="flex items-center justify-center h-80 text-red-500">Error loading chart: ' + error.message + '</div>';
        });
}

function loadFraudTimeSeriesChart(filters = {}) {
    const params = new URLSearchParams(filters);
    fetch(`/api/fraud/time-series/?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Fraud time series data received:', data);
            const timeData = data.data || [];
            
            // Create canvas element if it doesn't exist
            const container = document.getElementById('fraudTimeSeriesChart');
            let canvas = container.querySelector('canvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                container.appendChild(canvas);
            }
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.fraudTimeSeriesChartInstance) {
                window.fraudTimeSeriesChartInstance.destroy();
            }
            
            // Create the actual time series chart with real data
            const chartLabels = timeData.map(item => new Date(item.date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
            const repaymentData = timeData.map(item => item.repayment_amount);
            const collectedData = timeData.map(item => item.collected_amount);
            
            window.fraudTimeSeriesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'Repayment Amount',
                            data: repaymentData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Collected Amount',
                            data: collectedData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f8fafc',
                            bodyColor: '#f8fafc',
                            borderColor: '#334155',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return new Date(timeData[context[0].dataIndex].date).toLocaleDateString('en-IN', { 
                                        weekday: 'short', 
                                        year: 'numeric', 
                                        month: 'short', 
                                        day: 'numeric' 
                                    });
                                },
                                label: function(context) {
                                    // Only show data for the first dataset to avoid duplication
                                    if (context.datasetIndex === 0) {
                                        const dataIndex = context.dataIndex;
                                        const repaymentAmount = timeData[dataIndex].repayment_amount;
                                        const collectedAmount = timeData[dataIndex].collected_amount;
                                        const collectionPercentage = timeData[dataIndex].collection_rate;
                                        
                                        return [
                                            'Repayment Amount: ' + formatCurrency(repaymentAmount),
                                            'Collected Amount: ' + formatCurrency(collectedAmount),
                                            'Collection Rate: ' + collectionPercentage.toFixed(1) + '%'
                                        ];
                                    }
                                    return null; // Don't show label for second dataset
                                }
                            }
                        },
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return '₹' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
            
            console.log('Fraud time series chart created successfully');
        })
        .catch(error => {
            console.error('Error loading fraud time series data:', error);
            // Show error message in the chart container
            const chartContainer = document.getElementById('fraudTimeSeriesChart').parentElement;
            chartContainer.innerHTML = '<div class="flex items-center justify-center h-80 text-red-500">Error loading chart: ' + error.message + '</div>';
        });
}

function loadFraudCityCollectedChart(filters = {}) {
    const params = new URLSearchParams(filters);
    fetch(`/api/fraud/city-collected/?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Fraud city collected data received:', data);
            const cities = data.cities || [];
            
            // Create canvas element if it doesn't exist
            const container = document.getElementById('fraudCityCollectedChart');
            let canvas = container.querySelector('canvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                container.appendChild(canvas);
            }
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.fraudCityCollectedChartInstance) {
                window.fraudCityCollectedChartInstance.destroy();
            }
            
            // Create horizontal bar chart
            window.fraudCityCollectedChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cities.slice(0, 10).map(city => city.city),
                    datasets: [{
                        label: 'Collection Rate (%)',
                        data: cities.slice(0, 10).map(city => city.collection_percentage),
                        backgroundColor: '#10b981',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            callbacks: {
                                label: function(context) {
                                    const city = cities[context.dataIndex];
                                    return [
                                        'City: ' + city.city,
                                        'Collection Rate: ' + city.collection_percentage.toFixed(1) + '%',
                                        'Collected Amount: ' + formatCurrency(city.collected_amount),
                                        'Repayment Amount: ' + formatCurrency(city.repayment_amount),
                                        'Applications: ' + city.total_applications
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
            
            console.log('Fraud city collected chart created successfully');
        })
        .catch(error => {
            console.error('Error loading fraud city collected data:', error);
            // Show error message in the chart container
            const chartContainer = document.getElementById('fraudCityCollectedChart').parentElement;
            chartContainer.innerHTML = '<div class="flex items-center justify-center h-80 text-red-500">Error loading chart: ' + error.message + '</div>';
        });
}

function loadFraudCityUncollectedChart(filters = {}) {
    const params = new URLSearchParams(filters);
    fetch(`/api/fraud/city-uncollected/?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Fraud city uncollected data received:', data);
            const cities = data.cities || [];
            
            // Create canvas element if it doesn't exist
            const container = document.getElementById('fraudCityUncollectedChart');
            let canvas = container.querySelector('canvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                container.appendChild(canvas);
            }
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.fraudCityUncollectedChartInstance) {
                window.fraudCityUncollectedChartInstance.destroy();
            }
            
            // Create horizontal bar chart
            window.fraudCityUncollectedChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cities.slice(0, 10).map(city => city.city),
                    datasets: [{
                        label: 'Collection Rate (%)',
                        data: cities.slice(0, 10).map(city => city.collection_percentage),
                        backgroundColor: '#ef4444',
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            callbacks: {
                                label: function(context) {
                                    const city = cities[context.dataIndex];
                                    return [
                                        'City: ' + city.city,
                                        'Collection Rate: ' + city.collection_percentage.toFixed(1) + '%',
                                        'Uncollected Amount: ' + formatCurrency(city.uncollected_amount),
                                        'Collected Amount: ' + formatCurrency(city.collected_amount),
                                        'Repayment Amount: ' + formatCurrency(city.repayment_amount),
                                        'Applications: ' + city.total_applications
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
            
            console.log('Fraud city uncollected chart created successfully');
        })
        .catch(error => {
            console.error('Error loading fraud city uncollected data:', error);
            // Show error message in the chart container
            const chartContainer = document.getElementById('fraudCityUncollectedChart').parentElement;
            chartContainer.innerHTML = '<div class="flex items-center justify-center h-80 text-red-500">Error loading chart: ' + error.message + '</div>';
        });
}

// Initialize tab styles
document.addEventListener('DOMContentLoaded', function() {
    // Add CSS for tab styling
    const style = document.createElement('style');
    style.textContent = `
        .tab-button {
            color: #9ca3af;
            background: transparent;
        }
        .tab-button:hover {
            color: #f3f4f6;
            background: rgba(75, 85, 99, 0.2);
        }
        .tab-button.active {
            color: #ffffff;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .tab-content {
            display: block
        }
        .tab-content.hidden {
            display: none;
        }
    `;
    document.head.appendChild(style);
});
</script>

        </div> <!-- End Collection Without Fraud Tab -->

        <!-- Collection With Fraud Tab -->
        <div id="fraudContent" class="tab-content hidden" style="margin-left: 3.5rem; margin-right: 3.5rem; margin-top: 2rem; margin-bottom: 2rem;">
        <!-- Collapsible Filters -->
        <div class="card mb-8">
            <div class="p-6 cursor-pointer" onclick="toggleFraudFilters()">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-medium text-white">Filters</h2>
                    <svg id="fraudFilterToggleIcon" class="h-5 w-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
            
            <div id="fraudFilterContent" class="px-6 pb-6 hidden">
                <form method="GET" id="fraudFilterForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                <!-- Date Range -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Date Range
                        <span class="text-xs text-muted-foreground">(Both dates required)</span>
                    </label>
                    <div class="space-y-2">
                        <select name="date_type" id="fraudDateType" class="w-full input-field filter-input">
                            <option value="repayment_date">Repayment Date</option>
                            <option value="disbursal_date">Disbursal Date</option>
                        </select>
                    <div class="flex gap-3">
                        <input type="date" name="date_from" id="fraudDateFrom" class="flex-1 input-field filter-input" placeholder="From Date">
                        <input type="date" name="date_to" id="fraudDateTo" class="flex-1 input-field filter-input" placeholder="To Date">
                        </div>
                    </div>
                </div>

                <!-- Closing Status -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Closing Status
                    </label>
                        <select name="closing_status" id="fraudClosingStatus" class="w-full input-field filter-input">
                            <option value="">All Status</option>
                        </select>
                </div>

                <!-- DPD Bucket -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        DPD Bucket
                    </label>
                        <select name="dpd" id="fraudDpdBucket" class="w-full input-field filter-input">
                            <option value="">All DPD</option>
                        </select>
                </div>

                <!-- State -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        State
                    </label>
                    <select name="state" id="fraudState" class="w-full input-field filter-input">
                        <option value="">All States</option>
                    </select>
                </div>

                <!-- City -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        City
                    </label>
                    <select name="city" id="fraudCity" class="w-full input-field filter-input">
                        <option value="">All Cities</option>
                    </select>
                </div>

            </form>
            </div>
        </div>

        <!-- Minimal KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="kpi-card cursor-pointer hover:bg-secondary/20 transition-colors" onclick="openTotalApplicationsModal(0)">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-blue-500/10 border border-blue-500/20">
                        <svg class="h-4 w-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Total Applications</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="fraudTotalApplications">-</div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshCases">-</span>
                            <span class="text-gray-400 ml-1">(<span id="fraudFreshPercentage">-</span>%)</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanCases">-</span>
                            <span class="text-gray-400 ml-1">(<span id="fraudReloanPercentage">-</span>%)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-green-500/10 border border-green-500/20">
                        <svg class="h-4 w-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Sanction Amount</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="fraudSanctionAmount" data-amount="0">-</div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshSanctionAmount" data-amount="0">-</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanSanctionAmount" data-amount="0">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-purple-500/10 border border-purple-500/20">
                        <svg class="h-4 w-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Net Disbursed</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="fraudDisbursedAmount" data-amount="0">-</div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshDisbursedAmount" data-amount="0">-</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanDisbursedAmount" data-amount="0">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-orange-500/10 border border-orange-500/20">
                        <svg class="h-4 w-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Repayment Amount</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="fraudRepaymentAmount" data-amount="0">-</div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshRepaymentAmount" data-amount="0">-</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanRepaymentAmount" data-amount="0">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Mobile Responsive Collection Status and Principal Outstanding -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6 mb-6 sm:mb-8">
            <!-- Collected Amount Card -->
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-emerald-500/10 border border-emerald-500/20">
                        <svg class="h-4 w-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-emerald-400">Collected Amount</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-emerald-400" id="fraudCollectedAmount" data-amount="0">-</div>
                    <div class="text-sm text-emerald-300" id="fraudCollectedPercentage">-</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshCollectedAmount" data-amount="0">-</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanCollectedAmount" data-amount="0">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Collection Card -->
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-red-500/10 border border-red-500/20">
                        <svg class="h-4 w-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-red-400">Pending Collection</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-red-400" id="fraudPendingCollection" data-amount="0">-</div>
                    <div class="text-sm text-red-300" id="fraudPendingPercentage">-</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshPendingAmount" data-amount="0">-</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanPendingAmount" data-amount="0">-</span>
                        </div>
                    </div>
            </div>
        </div>

            <!-- Principal Outstanding Card -->
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-yellow-500/10 border border-yellow-500/20">
                        <svg class="h-4 w-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-yellow-400">Principal Outstanding</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-yellow-400" id="fraudPrincipalOutstandingAmount" data-amount="0">-</div>
                    <div class="text-sm text-yellow-300">No Collections Yet</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshPrincipalOutstanding" data-amount="0">-</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanPrincipalOutstanding" data-amount="0">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Responsive Enhanced Analytics Charts -->
        <div class="mb-6 sm:mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
            <!-- Enhanced State Repayment Chart -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-info/20 to-primary/20 border border-info/30 shadow-lg">
                            <svg class="h-6 w-6 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Received Amount by State</h3>
                            <p class="text-sm text-muted-foreground font-medium">Geographic distribution of collections</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('fraudStateChart', 'Received Amount by State', 'Geographic distribution of collections')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div id="fraudStateChart" class="h-80"></div>
            </div>

            <!-- Enhanced DPD Buckets Chart -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-warning/20 to-orange-500/20 border border-warning/30 shadow-lg">
                            <svg class="h-6 w-6 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">DPD Buckets Distribution</h3>
                            <p class="text-sm text-muted-foreground font-medium">Days Past Due analysis</p>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="border-b border-border/50">
                            <tr>
                                <th class="text-left py-3 px-4 font-medium text-muted-foreground">DPD Bucket</th>
                                <th class="text-right py-3 px-4 font-medium text-muted-foreground">Loans (#)</th>
                            </tr>
                        </thead>
                        <tbody id="fraudDpdTableBody">
                            <!-- Fraud DPD data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>

        <!-- Time Series Chart -->
        <div class="mb-8">
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-success/20 to-emerald-500/20 border border-success/30 shadow-lg">
                            <svg class="h-6 w-6 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Collection Trend Over Time</h3>
                            <p class="text-sm text-muted-foreground font-medium">Historical collection performance</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('fraudTimeSeriesChart', 'Collection Trend Over Time', 'Historical collection performance')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div id="fraudTimeSeriesChart" class="h-80"></div>
            </div>
        </div>

        <!-- City Analysis Charts -->
        <div class="mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Top Cities by Collection -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-green-500/20 border border-emerald-500/30 shadow-lg">
                            <svg class="h-6 w-6 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Top Cities by Collection Rate</h3>
                            <p class="text-sm text-muted-foreground font-medium">Cities with highest collection percentage (%)</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('fraudCityCollectedChart', 'Top Cities by Collection Rate', 'Cities with highest collection percentage (%)')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div id="fraudCityCollectedChart" class="h-80"></div>
            </div>

            <!-- Cities with Uncollected Amount -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-red-500/20 to-rose-500/20 border border-red-500/30 shadow-lg">
                            <svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Cities with Lowest Collection Rate</h3>
                            <p class="text-sm text-muted-foreground font-medium">Cities with lowest collection percentage (%)</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('fraudCityUncollectedChart', 'Cities with Lowest Collection Rate', 'Cities with lowest collection percentage (%)')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div id="fraudCityUncollectedChart" class="h-80"></div>
            </div>
            </div>
        </div>

        </div> <!-- End Collection With Fraud Tab -->

        <!-- Loan Count Wise Tab -->
        <div id="loanCountContent" class="tab-content hidden" style="margin-left: 3.5rem; margin-right: 3.5rem; margin-top: 2rem; margin-bottom: 2rem;">
            <div class="card">
                <div class="p-6 text-center">
                    <h2 class="text-xl font-semibold text-white mb-4">Loan Count Wise</h2>
                    <p class="text-gray-400 mb-6">Comprehensive loan count analysis and insights</p>
                    <div class="text-sm text-gray-500">Coming Soon - Advanced loan count tracking and analysis</div>
                </div>
            </div>
        </div> <!-- End Loan Count Wise Tab -->

    </div>
</div>
{% endblock %}

<script>
// Dashboard initialization is handled in the main DOMContentLoaded event listener above

// Debug function to test localStorage functionality
window.debugLocalStorage = function() {
    console.log('=== LocalStorage Debug ===');
    
    const mainFilters = localStorage.getItem('mainFilters');
    const fraudFilters = localStorage.getItem('fraudFilters');
    
    console.log('mainFilters:', mainFilters ? JSON.parse(mainFilters) : 'Not set');
    console.log('fraudFilters:', fraudFilters ? JSON.parse(fraudFilters) : 'Not set');
    
    const form = document.getElementById('filterForm');
    if (form) {
        const dateTypeSelect = form.querySelector('select[name="date_type"]');
        console.log('Current date_type value in form:', dateTypeSelect ? dateTypeSelect.value : 'Not found');
    }
    
    console.log('=== End Debug ===');
};

// Debug function to manually save test filters
window.saveTestFilters = function() {
    const testFilters = {
        date_from: '2025-10-01',
        date_to: '2025-10-02',
        date_type: 'disbursal_date',
        closing_status: '',
        dpd: '',
        state: '',
        city: ''
    };
    
    localStorage.setItem('mainFilters', JSON.stringify(testFilters));
    console.log('Test filters saved:', testFilters);
};

// Debug function to manually restore filters
window.restoreTestFilters = function() {
    restoreMainFilters();
};






</script>
