{% extends 'base.html' %}

{% block title %}BlinkR Loan Dashboard{% endblock %}

{% block content %}
<script>
// Prevent back button access to dashboard without proper authentication
window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        // Page was loaded from cache, check if user is still authenticated
        fetch('/api/kpi-data/', {
            method: 'GET',
            credentials: 'same-origin'
        })
        .then(response => {
            if (response.status === 302 || response.redirected) {
                // User is not authenticated, redirect to login
                window.location.href = '/login/';
            }
        })
        .catch(() => {
            // Error occurred, redirect to login
            window.location.href = '/login/';
        });
    }
});

// Clear session storage on page unload to prevent back button issues
window.addEventListener('beforeunload', function() {
    // Clear any sensitive data from session storage
    sessionStorage.clear();
});

// Clear login check flag when user actively logs out
document.addEventListener('DOMContentLoaded', function() {
    const logoutLinks = document.querySelectorAll('a[href*="logout"]');
    logoutLinks.forEach(link => {
        link.addEventListener('click', function() {
            sessionStorage.removeItem('loginCheckDone');
        });
    });
});

// Prevent direct access via URL manipulation
if (window.history.replaceState) {
    window.history.replaceState(null, null, window.location.href);
}
</script>
<div class="min-h-screen p-3 sm:p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Mobile Responsive Header with Logo -->
        <div class="mb-6 sm:mb-8">
            <!-- Mobile Layout -->
            <div class="block sm:hidden">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <img src="/static/images/blinkr-logo.svg" alt="BlinkR Logo" class="h-8 w-auto">
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-xs text-gray-400">
                            {{ user.username }}
                        </div>
                        <a href="{% url 'dashboard:logout' %}" class="p-2 text-gray-300 hover:text-white bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 rounded-lg transition-colors">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                        </a>
                    </div>
                </div>
                <div class="text-center">
                    <div class="flex items-center justify-center gap-2 mb-1">
                        <div class="p-1.5 rounded-lg bg-blue-500/10 border border-blue-500/20">
                            <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <h1 class="text-lg font-semibold text-white">Analytics Dashboard</h1>
                    </div>
                    <p class="text-xs text-gray-400">Performance insights</p>
                    <div class="text-xs text-gray-400 mt-1">
                        Updated: {{ last_updated }}
                    </div>
                </div>
            </div>
            
            <!-- Desktop Layout -->
            <div class="hidden sm:block">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <img src="/static/images/blinkr-logo.svg" alt="BlinkR Logo" class="h-12 w-auto">
                </div>
                <div class="text-center">
                    <div class="flex items-center justify-center gap-3 mb-1">
                        <div class="p-2 rounded-lg bg-blue-500/10 border border-blue-500/20">
                            <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div class="flex items-center gap-3">
                        <h1 class="text-2xl font-semibold text-white">Analytics Dashboard</h1>
                            <div id="refresh-indicator-inline" class="flex items-center"></div>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400">Advanced performance insights and data visualization</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-sm text-gray-400">
                        Last Updated: {{ last_updated }}
                    </div>
                    <!-- User Info and Logout -->
                    <div class="flex items-center gap-3">
                        <div class="text-sm text-gray-300">
                            Welcome, <span class="font-medium text-white">{{ user.username }}</span>
                        </div>
                        <a href="{% url 'dashboard:logout' %}" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-300 hover:text-white bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 hover:border-gray-500/30 rounded-lg transition-colors">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Logout
                        </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Responsive Tab Navigation -->
        <div class="mb-6 sm:mb-8">
            <div class="flex space-x-1 bg-gray-600/20 p-1 rounded-lg border border-gray-500/20">
                <button id="disbursalTab" onclick="switchTab('disbursal')" class="flex-1 px-1 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium rounded-md transition-colors tab-button">
                    <div class="flex items-center justify-center gap-1 sm:gap-2">
                        <svg class="h-3 w-3 sm:h-4 sm:w-4" viewBox="0 0 24 24" fill="currentColor">
                            <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="16" font-weight="bold">₹</text>
                        </svg>
                        <span class="hidden sm:inline">Disbursal Summary</span>
                        <span class="sm:hidden">Disbursal</span>
                    </div>
                </button>
                <button id="collectionTab" onclick="switchTab('collection')" class="flex-1 px-1 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium rounded-md transition-colors tab-button">
                    <div class="flex items-center justify-center gap-1 sm:gap-2">
                        <svg class="h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="hidden sm:inline">Collection Without Fraud</span>
                        <span class="sm:hidden">Without Fraud</span>
                    </div>
                </button>
                <button id="fraudTab" onclick="switchTab('fraud')" class="flex-1 px-1 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium rounded-md transition-colors tab-button">
                    <div class="flex items-center justify-center gap-1 sm:gap-2">
                        <svg class="h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <span class="hidden sm:inline">Collection With Fraud</span>
                        <span class="sm:hidden">With Fraud</span>
                    </div>
                </button>
                <button id="loanCountTab" onclick="switchTab('loanCount')" class="flex-1 px-1 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium rounded-md transition-colors tab-button">
                    <div class="flex items-center justify-center gap-1 sm:gap-2">
                        <svg class="h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span class="hidden sm:inline">Loan Count Wise</span>
                        <span class="sm:hidden">Loan Count</span>
                    </div>
                </button>
                <button id="dailyPerformanceTab" onclick="switchTab('dailyPerformance')" class="flex-1 px-1 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium rounded-md transition-colors tab-button">
                    <div class="flex items-center justify-center gap-1 sm:gap-2">
                        <svg class="h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span class="hidden sm:inline">Daily Performance Metrics</span>
                        <span class="sm:hidden">Daily Perf</span>
                    </div>
                </button>
                <button id="creditPersonTab" onclick="switchTab('creditPerson')" class="flex-1 px-1 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium rounded-md transition-colors tab-button">
                    <div class="flex items-center justify-center gap-1 sm:gap-2">
                        <svg class="h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0zm6 1a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="hidden sm:inline">Credit Person Wise</span>
                        <span class="sm:hidden">Credit</span>
                    </div>
                </button>
                <button id="aumReportTab" onclick="switchTab('aumReport')" class="flex-1 px-1 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium rounded-md transition-colors tab-button">
                    <div class="flex items-center justify-center gap-1 sm:gap-2">
                        <svg class="h-3 w-3 sm:h-4 sm:w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span class="hidden sm:inline">AUM Report</span>
                        <span class="sm:hidden">AUM</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <!-- Disbursal Summary Tab -->
        <div id="disbursalContent" class="tab-content hidden">
            <!-- Filter Section -->
            <div class="card mb-6 border border-gray-700/30 shadow-lg">
                <div class="p-4">
                    <!-- Collapsible Header -->
                    <div class="flex items-center justify-between mb-3 cursor-pointer group" onclick="toggleDisbursalFilters()">
                        <div class="flex items-center gap-2">
                            <svg class="h-4 w-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                            <h3 class="text-base font-semibold text-white group-hover:text-blue-400 transition-colors">Filters</h3>
                </div>
                        <button type="button" class="p-1.5 hover:bg-gray-700/50 rounded transition-colors" id="disbursalFiltersToggle">
                            <svg id="disbursalFiltersToggleIcon" class="h-4 w-4 text-gray-400 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Collapsible Content -->
                    <div id="disbursalFiltersContent" class="hidden transition-all duration-300 ease-in-out overflow-hidden">
                        <!-- Date Range Section -->
                        <div class="mb-4 pb-4 border-b border-gray-700/30">
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                                <div class="flex-1 min-w-[160px]">
                                    <label class="block text-xs font-medium text-gray-400 mb-1.5">Start Date</label>
                                    <input type="date" id="disbursalStartDate" class="input-field w-full text-sm px-3 py-2 rounded-md border border-gray-600/50 bg-gray-800/30 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500/30 transition-all" onchange="handleDisbursalDateChange()">
                                </div>
                                <div class="flex-1 min-w-[160px]">
                                    <label class="block text-xs font-medium text-gray-400 mb-1.5">End Date</label>
                                    <input type="date" id="disbursalEndDate" class="input-field w-full text-sm px-3 py-2 rounded-md border border-gray-600/50 bg-gray-800/30 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500/30 transition-all" onchange="handleDisbursalDateChange()">
                                </div>
                                <div class="flex gap-2 sm:mt-6">
                                    <button onclick="applyDisbursalFilters()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-md transition-all shadow-md hover:shadow-lg flex items-center gap-1.5 whitespace-nowrap">
                                        <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                        Apply
                                    </button>
                                    <button onclick="resetDisbursalFilters()" class="px-3 py-2 bg-gray-700/50 hover:bg-gray-600/50 border border-gray-600/50 text-white text-xs font-medium rounded-md transition-all flex items-center justify-center whitespace-nowrap" title="Reset Filters">
                                        <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Filters Section -->
                        <div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1.5">State</label>
                                    <select id="disbursalStateFilter" class="input-field w-full text-sm px-3 py-2 rounded-md border border-gray-600/50 bg-gray-800/30 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500/30 transition-all cursor-pointer" onchange="handleDisbursalStateChange()">
                                        <option value="">All States</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1.5">City</label>
                                    <select id="disbursalCityFilter" class="input-field w-full text-sm px-3 py-2 rounded-md border border-gray-600/50 bg-gray-800/30 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500/30 transition-all cursor-pointer">
                                        <option value="">All Cities</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1.5">Reloan</label>
                                    <select id="disbursalReloanFilter" class="input-field w-full text-sm px-3 py-2 rounded-md border border-gray-600/50 bg-gray-800/30 text-white focus:border-blue-500 focus:ring-1 focus:ring-blue-500/30 transition-all cursor-pointer">
                                        <option value="">All</option>
                                        <option value="true">Reloan</option>
                                        <option value="false">Fresh</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-400 mb-1.5">Tenure</label>
                                    <input type="text" id="disbursalTenureFilter" placeholder="e.g., 30 or 30-60" class="input-field w-full text-sm px-3 py-2 rounded-md border border-gray-600/50 bg-gray-800/30 text-white placeholder-gray-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500/30 transition-all">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="disbursalLoading" class="hidden">
                <div class="card p-12">
                    <div class="flex flex-col items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
                        <p class="text-gray-400">Loading disbursal data...</p>
                    </div>
                </div>
            </div>

            <!-- Error State -->
            <div id="disbursalError" class="hidden">
                <div class="card p-6">
                    <div class="flex items-center gap-3 text-red-400">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="disbursalErrorMessage">Failed to load data. Please try again.</span>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div id="disbursalSummaryCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-6 hidden">
                <div class="card">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-400">Total Records</span>
                            <div class="p-2 bg-blue-500/10 rounded-lg">
                                <svg class="h-5 w-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2" id="disbursalTotalRecords">0</h3>
                        <div class="flex flex-col gap-1.5 text-xs">
                            <span class="text-gray-400">Fresh: <span id="disbursalFreshRecords" class="text-white font-medium">0</span></span>
                            <span class="text-gray-400">Reloan: <span id="disbursalReloanRecords" class="text-white font-medium">0</span></span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-400">Total Loan Amount</span>
                            <div class="p-2 bg-green-500/10 rounded-lg">
                                <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2" id="disbursalTotalLoanAmount">₹0</h3>
                        <div class="flex flex-col gap-1.5 text-xs">
                            <span class="text-gray-400">Fresh: <span id="disbursalFreshLoanAmount" class="text-white font-medium">₹0</span></span>
                            <span class="text-gray-400">Reloan: <span id="disbursalReloanLoanAmount" class="text-white font-medium">₹0</span></span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-400">Total Disbursal Amount</span>
                            <div class="p-2 bg-purple-500/10 rounded-lg">
                                <svg class="h-5 w-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2" id="disbursalTotalDisbursalAmount">₹0</h3>
                        <div class="flex flex-col gap-1.5 text-xs">
                            <span class="text-gray-400">Fresh: <span id="disbursalFreshDisbursalAmount" class="text-white font-medium">₹0</span></span>
                            <span class="text-gray-400">Reloan: <span id="disbursalReloanDisbursalAmount" class="text-white font-medium">₹0</span></span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-400">Processing Fee</span>
                            <div class="p-2 bg-yellow-500/10 rounded-lg">
                                <svg class="h-5 w-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2" id="disbursalProcessingFee">₹0</h3>
                        <div class="flex flex-col gap-1.5 text-xs">
                            <span class="text-gray-400">Fresh: <span id="disbursalFreshProcessingFee" class="text-white font-medium">₹0</span></span>
                            <span class="text-gray-400">Reloan: <span id="disbursalReloanProcessingFee" class="text-white font-medium">₹0</span></span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-400">Interest Amount</span>
                            <div class="p-2 bg-orange-500/10 rounded-lg">
                                <svg class="h-5 w-5 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2" id="disbursalInterestAmount">₹0</h3>
                        <div class="flex flex-col gap-1.5 text-xs">
                            <span class="text-gray-400">Fresh: <span id="disbursalFreshInterestAmount" class="text-white font-medium">₹0</span></span>
                            <span class="text-gray-400">Reloan: <span id="disbursalReloanInterestAmount" class="text-white font-medium">₹0</span></span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm text-gray-400">Repayment Amount</span>
                            <div class="p-2 bg-green-500/10 rounded-lg">
                                <svg class="h-5 w-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold text-white mb-2" id="disbursalRepaymentAmount">₹0</h3>
                        <div class="flex flex-col gap-1.5 text-xs">
                            <span class="text-gray-400">Fresh: <span id="disbursalFreshRepaymentAmount" class="text-white font-medium">₹0</span></span>
                            <span class="text-gray-400">Reloan: <span id="disbursalReloanRepaymentAmount" class="text-white font-medium">₹0</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pie Charts -->
            <div id="disbursalCharts" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 hidden">
                <!-- State Pie Chart -->
                <div class="card">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">Disbursal by State</h3>
                            <button onclick="openFullScreenChart('state')" class="p-2 hover:bg-gray-700 rounded-lg transition-colors" title="View Full Screen">
                                <svg class="h-5 w-5 text-gray-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="h-80">
                            <canvas id="disbursalStateChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- City Pie Chart -->
                <div class="card">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">
                                <span id="disbursalCityChartTitle">Disbursal by City</span>
                                <span id="disbursalCityChartStateFilter" class="text-sm text-gray-400 font-normal"></span>
                            </h3>
                            <button onclick="openFullScreenChart('city')" class="p-2 hover:bg-gray-700 rounded-lg transition-colors" title="View Full Screen">
                                <svg class="h-5 w-5 text-gray-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="h-80">
                            <canvas id="disbursalCityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Full Screen Chart Modal -->
            <div id="fullScreenChartModal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-90 flex items-center justify-center">
                <div class="relative w-full h-full p-8">
                    <button onclick="closeFullScreenChart()" class="absolute top-4 right-4 p-3 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors z-10">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <div class="w-full h-full flex flex-col items-center justify-center">
                        <h3 id="fullScreenChartTitle" class="text-2xl font-bold text-white mb-8"></h3>
                        <div class="w-full max-w-4xl h-full max-h-[80vh] flex items-center justify-center">
                            <canvas id="fullScreenChartCanvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Table -->
            <div id="disbursalTableWrapper" class="card hidden">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-white">Disbursal Records</h3>
                        <div class="text-sm text-gray-400">
                            Showing <span id="disbursalRecordCount">0</span> records
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-600">
                                    <th class="text-left py-3 px-4 text-gray-300 font-semibold">Full Name</th>
                                    <th class="text-left py-3 px-4 text-gray-300 font-semibold">PAN</th>
                                    <th class="text-left py-3 px-4 text-gray-300 font-semibold">City</th>
                                    <th class="text-left py-3 px-4 text-gray-300 font-semibold">State</th>
                                    <th class="text-right py-3 px-4 text-gray-300 font-semibold">Loan Amount</th>
                                    <th class="text-right py-3 px-4 text-gray-300 font-semibold">Disbursal Amount</th>
                                    <th class="text-right py-3 px-4 text-gray-300 font-semibold">Repayment Amount</th>
                                    <th class="text-left py-3 px-4 text-gray-300 font-semibold">Disbursal Date</th>
                                    <th class="text-left py-3 px-4 text-gray-300 font-semibold">Repayment Date</th>
                                </tr>
                            </thead>
                            <tbody id="disbursalTableBody">
                                <tr>
                                    <td colspan="9" class="py-8 text-center text-gray-400">Select date range and click Apply to load data</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Pagination Controls -->
                    <div id="disbursalPagination" class="hidden mt-4 flex items-center justify-between">
                        <div class="text-sm text-gray-400">
                            Showing <span id="disbursalPageInfo">0-0</span> of <span id="disbursalTotalRecords">0</span> records
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="disbursalPrevBtn" onclick="changeDisbursalPage(-1)" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                                Previous
                            </button>
                            <span class="text-sm text-gray-300">
                                Page <span id="disbursalCurrentPage">1</span> of <span id="disbursalTotalPages">1</span>
                            </span>
                            <button id="disbursalNextBtn" onclick="changeDisbursalPage(1)" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                                Next
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Data State -->
            <div id="disbursalNoData" class="hidden">
                <div class="card p-12">
                    <div class="flex flex-col items-center justify-center">
                        <svg class="h-16 w-16 text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-white mb-2">No Data Found</h3>
                        <p class="text-gray-400 text-center">No disbursal data available for the selected date range.<br>Please try adjusting your filters.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collection Without Fraud Tab -->
        <div id="collectionContent" class="tab-content hidden">
        <!-- Collapsible Filters -->
        <div class="card mb-8">
            <div class="p-6 cursor-pointer" onclick="toggleFilters()">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-medium text-white">Filters</h2>
                    <svg id="filterToggleIcon" class="h-5 w-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
            
            <div id="filterContent" class="px-6 pb-6 hidden">
                <form method="GET" id="filterForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                <!-- Date Range -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Date Range
                        <span class="text-xs text-muted-foreground">(Both dates required)</span>
                    </label>
                    <div class="space-y-2">
                        <select name="date_type" class="w-full input-field filter-input">
                            <option value="repayment_date" {% if filters.date_type == 'repayment_date' or not filters.date_type %}selected{% endif %}>Repayment Date</option>
                            <option value="disbursal_date" {% if filters.date_type == 'disbursal_date' %}selected{% endif %}>Disbursal Date</option>
                        </select>
                    <div class="flex gap-3">
                        <input type="date" name="date_from" value="{{ filters.date_from|default:'' }}" class="flex-1 input-field filter-input" placeholder="From Date">
                        <input type="date" name="date_to" value="{{ filters.date_to|default:'' }}" class="flex-1 input-field filter-input" placeholder="To Date">
                        </div>
                    </div>
                </div>

                <!-- Closing Status -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Closing Status
                    </label>
                        <select name="closing_status" class="w-full input-field filter-input">
                            <option value="">All Status</option>
                            {% for status in unique_closed_statuses %}
                            <option value="{{ status }}" {% if filters.closing_status == status %}selected{% endif %}>{{ status }}</option>
                            {% endfor %}
                        </select>
                </div>

                <!-- DPD Bucket -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        DPD Bucket
                    </label>
                        <select name="dpd" class="w-full input-field filter-input">
                            <option value="">All DPD</option>
                            {% for bucket in unique_dpd_buckets %}
                            <option value="{{ bucket }}" {% if filters.dpd == bucket %}selected{% endif %}>{{ bucket }}</option>
                            {% endfor %}
                        </select>
                </div>

                <!-- State -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        State
                    </label>
                    <select name="state" class="w-full input-field filter-input">
                        <option value="">All States</option>
                        {% for state in unique_states %}
                        <option value="{{ state }}" {% if filters.state == state %}selected{% endif %}>{{ state }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- City -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        City
                    </label>
                    <select name="city" class="w-full input-field filter-input">
                        <option value="">All Cities</option>
                        {% for city in unique_cities %}
                        <option value="{{ city }}" {% if filters.city == city %}selected{% endif %}>{{ city }}</option>
                        {% endfor %}
                    </select>
                </div>

            </form>
            </div>
        </div>

        <!-- Mobile Responsive KPI Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-blue-500/10 border border-blue-500/20">
                        <svg class="h-4 w-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div class="text-xs sm:text-sm text-gray-400">Total Applications</div>
                </div>
                <div class="text-xl sm:text-2xl font-semibold text-white" id="totalApplications">{{ kpis.total_applications|floatformat:0 }}</div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshCases">{{ kpis.fresh_cases|default:0 }}</span>
                            <span class="text-gray-400 ml-1">(<span id="freshPercentage">{{ kpis.fresh_percentage|default:0|floatformat:1 }}</span>%)</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanCases">{{ kpis.reloan_cases|default:0 }}</span>
                            <span class="text-gray-400 ml-1">(<span id="reloanPercentage">{{ kpis.reloan_percentage|default:0|floatformat:1 }}</span>%)</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-green-500/10 border border-green-500/20">
                        <svg class="h-4 w-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Sanction Amount</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="sanctionAmount" data-amount="{{ kpis.sanction_amount }}"></div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshSanctionAmount" data-amount="{{ kpis.fresh_sanction_amount|default:0 }}"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanSanctionAmount" data-amount="{{ kpis.reloan_sanction_amount|default:0 }}"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-purple-500/10 border border-purple-500/20">
                        <svg class="h-4 w-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Net Disbursed</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="disbursedAmount" data-amount="{{ kpis.net_disbursal }}"></div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshDisbursedAmount" data-amount="{{ kpis.fresh_disbursed_amount|default:0 }}"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanDisbursedAmount" data-amount="{{ kpis.reloan_disbursed_amount|default:0 }}"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-orange-500/10 border border-orange-500/20">
                        <svg class="h-4 w-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Repayment Amount</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="repaymentAmount" data-amount="{{ kpis.repayment_amount }}"></div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshRepaymentAmount" data-amount="{{ kpis.fresh_repayment_amount|default:0 }}"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanRepaymentAmount" data-amount="{{ kpis.reloan_repayment_amount|default:0 }}"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Mobile Responsive Collection Status and Principal Outstanding -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6 mb-6 sm:mb-8">
            <!-- Collected Amount Card -->
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-emerald-500/10 border border-emerald-500/20">
                        <svg class="h-4 w-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-emerald-400">Collected Amount</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-emerald-400" id="collectedAmount" data-amount="{{ kpis.collected_amount }}"></div>
                    <div class="text-sm text-emerald-300" id="collectedPercentage">{{ kpis.collected_percentage|floatformat:2 }}% of Repayment</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshCollectedAmount" data-amount="{{ kpis.fresh_collected_amount|default:0 }}"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanCollectedAmount" data-amount="{{ kpis.reloan_collected_amount|default:0 }}"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Collection Card -->
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-red-500/10 border border-red-500/20">
                        <svg class="h-4 w-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-red-400">Pending Collection</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-red-400" id="pendingAmount" data-amount="{{ kpis.pending_collection }}"></div>
                    <div class="text-sm text-red-300" id="pendingPercentage">{{ kpis.pending_percentage|floatformat:2 }}% of Repayment</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshPendingAmount" data-amount="{{ kpis.fresh_pending_amount|default:0 }}"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanPendingAmount" data-amount="{{ kpis.reloan_pending_amount|default:0 }}"></span>
                        </div>
                    </div>
            </div>
        </div>

            <!-- Principal Outstanding Card -->
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-yellow-500/10 border border-yellow-500/20">
                        <svg class="h-4 w-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-yellow-400">Principal Outstanding</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-yellow-400" id="principalOutstandingAmount" data-amount="{{ kpis.principal_outstanding|default:0 }}"></div>
                    <div class="text-sm text-yellow-300">No Collections Yet</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshPrincipalOutstanding" data-amount="{{ kpis.fresh_principal_outstanding|default:0 }}"></span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanPrincipalOutstanding" data-amount="{{ kpis.reloan_principal_outstanding|default:0 }}"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Principal Outstanding Excluding 120+ Days DPD (Recovery %) Card -->
            <div class="kpi-card relative group">
                <!-- Hover Tooltip -->
          <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 -translate-y-full bg-gray-900 text-white text-xs rounded-lg px-3 py-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-10 shadow-xl border border-gray-700">
              Excludes long overdue (90+ DPD) accounts. Indicates near-term recovery health.
                    <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                        <div class="border-4 border-transparent border-t-gray-900"></div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-blue-500/10 border border-blue-500/20">
                        <svg class="h-4 w-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-blue-400">Principal Collection Excl. 90+ DPD</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-blue-400" id="recoverableAmountExcl90" data-amount="{{ kpis.recoverable_amount_excl_90|default:0 }}"></div>
                    <div class="text-sm text-blue-300"><span id="recoveryPercentageExcl90">{{ kpis.recovery_percentage_excl_90|default:0|floatformat:2 }}</span>% Recovery</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="freshRecoverableExcl90" data-amount="{{ kpis.fresh_recoverable_excl_90|default:0 }}"></span>
                            <span class="text-xs text-gray-400 ml-2">(<span id="freshRecoveryPercentageExcl90">{{ kpis.fresh_recovery_percentage_excl_90|default:0|floatformat:2 }}</span>% Recovery)</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="reloanRecoverableExcl90" data-amount="{{ kpis.reloan_recoverable_excl_90|default:0 }}"></span>
                            <span class="text-xs text-gray-400 ml-2">(<span id="reloanRecoveryPercentageExcl90">{{ kpis.reloan_recovery_percentage_excl_90|default:0|floatformat:2 }}</span>% Recovery)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Responsive Enhanced Analytics Charts -->
        <div class="mb-6 sm:mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
            <!-- Enhanced State Repayment Chart -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-info/20 to-primary/20 border border-info/30 shadow-lg">
                            <svg class="h-6 w-6 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Received Amount by State</h3>
                            <p class="text-sm text-muted-foreground font-medium">Geographic distribution of collections</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('stateChart', 'Received Amount by State', 'Geographic distribution of collections')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div class="h-80 mb-6">
                    <canvas id="stateChart"></canvas>
                </div>
                
                
            </div>

            <!-- Pending Amount by State -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-red-500/20 to-orange-500/20 border border-red-500/30 shadow-lg">
                            <svg class="h-6 w-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Pending Amount by State</h3>
                            <p class="text-sm text-muted-foreground font-medium">Geographic distribution of pending amount</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('statePendingChart', 'Pending Amount by State', 'Geographic distribution of pending amount')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div class="h-80 mb-6">
                    <canvas id="statePendingChart"></canvas>
                </div>
            </div>
            </div>
        </div>

        <!-- Enhanced Time Series Chart -->
        <div class="mb-6 sm:mb-8">
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl w-full">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-success/20 to-info/20 border border-success/30 shadow-lg">
                            <svg class="h-6 w-6 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Amount Received Over Time</h3>
                            <p class="text-sm text-muted-foreground font-medium">Collection trends and performance</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('timeSeriesChart', 'Amount Received Over Time', 'Collection trends and performance')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="h-80 mb-6">
                    <canvas id="timeSeriesChart"></canvas>
                </div>
                
                <!-- KPI Cards Section (Below Time Series Chart) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 items-stretch mt-6">
                    <!-- Total Applications -->
                    <div class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-4 flex flex-col justify-between min-h-[120px]">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                            <span class="text-xs text-blue-400 font-medium">Total Applications</span>
                        </div>
                        <div class="text-2xl font-bold text-blue-400" id="timeseriesTotalApplications">0</div>
                    </div>
                    
                    <!-- Repayment Amount -->
                    <div class="bg-orange-500/10 border border-orange-500/20 rounded-lg p-4 flex flex-col justify-between min-h-[120px]">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                            <span class="text-xs text-orange-400 font-medium">Repayment Amount</span>
                        </div>
                        <div class="text-2xl font-bold text-orange-400" id="timeseriesRepaymentAmount">₹0</div>
                        <div class="text-xs opacity-0">-</div>
                    </div>
                    
                    <!-- Collected Amount -->
                    <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-4 flex flex-col justify-between min-h-[120px]">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            <span class="text-xs text-green-400 font-medium">Collected Amount</span>
                        </div>
                        <div class="text-2xl font-bold text-green-400" id="timeseriesCollectedAmount">₹0</div>
                        <div class="text-xs opacity-0">-</div>
                    </div>
                    
                    <!-- Collected Cases -->
                    <div class="bg-green-500/10 border border-green-500/20 rounded-lg p-4 flex flex-col justify-between min-h-[120px]">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-2 h-2 rounded-full bg-green-500"></div>
                            <span class="text-xs text-green-400 font-medium">Collected Cases</span>
                        </div>
                        <div class="text-2xl font-bold text-green-400" id="timeseriesCollectedCases">0</div>
                        <div class="text-xs text-green-300 mt-1" id="timeseriesCollectedCasesPercent">-</div>
                    </div>
                    
                    <!-- Pending Amount -->
                    <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-4 flex flex-col justify-between min-h-[120px]">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-2 h-2 rounded-full bg-red-500"></div>
                            <span class="text-xs text-red-400 font-medium">Pending Amount</span>
                        </div>
                        <div class="text-2xl font-bold text-red-400" id="timeseriesPendingAmount">₹0</div>
                        <div class="text-xs opacity-0">-</div>
                    </div>
                    
                    <!-- Pending Cases -->
                    <div class="bg-red-500/10 border border-red-500/20 rounded-lg p-4 flex flex-col justify-between min-h-[120px]">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="w-2 h-2 rounded-full bg-red-500"></div>
                            <span class="text-xs text-red-400 font-medium">Pending Cases</span>
                        </div>
                        <div class="text-2xl font-bold text-red-400" id="timeseriesPendingCases">0</div>
                        <div class="text-xs text-red-300 mt-1" id="timeseriesPendingCasesPercent">-</div>
                    </div>
                </div>
            </div>
        </div>
                
        <!-- Collection % over Time Table -->
        <div class="chart-container rounded-2xl p-8 shadow-2xl">
            <!-- Header Block -->
            <div class="flex items-center gap-4 mb-8">
                <div class="p-3 rounded-2xl bg-gradient-to-br from-blue-500/20 to-purple-500/20 border border-blue-500/30 shadow-lg">
                    <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-foreground">Collection % over Time</h3>
                    <p class="text-sm text-muted-foreground font-medium">Detailed collection analysis by date</p>
                </div>
            </div>
            
            <!-- Table -->
            <div class="w-full overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-border">
                            <th class="text-left py-3 px-4 font-medium text-muted-foreground">Date</th>
                            <th class="text-right py-3 px-4 font-medium text-muted-foreground">Repayment Amount</th>
                            <th class="text-right py-3 px-4 font-medium text-muted-foreground">Collected Amount</th>
                            <th class="text-right py-3 px-4 font-medium text-muted-foreground">Pending Amount</th>
                            <th class="text-right py-3 px-4 font-medium text-muted-foreground">Total Cases</th>
                            <th class="text-right py-3 px-4 font-medium text-muted-foreground">Collected Cases</th>
                            <th class="text-right py-3 px-4 font-medium text-muted-foreground">Pending Cases</th>
                            <th class="text-right py-3 px-4 font-medium text-muted-foreground">Collection %</th>
                            <th class="text-right py-3 px-4 font-medium text-muted-foreground">Pending %</th>
                        </tr>
                    </thead>
                    <tbody id="collectionOverTimeTableBody">
                        <tr>
                            <td colspan="9" class="text-center py-8 text-gray-500">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- DPD Bucket Distribution - Single Vertical Column -->
        <div class="chart-container rounded-2xl p-8 shadow-2xl">
            <!-- Header Block -->
            <div class="flex items-center gap-4 mb-8">
                <div class="p-3 rounded-2xl bg-gradient-to-br from-destructive/20 to-warning/20 border border-destructive/30 shadow-lg">
                    <svg class="h-6 w-6 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-foreground">DPD Bucket Distribution</h3>
                    <p class="text-sm text-muted-foreground font-medium">Days Past Due analysis and risk assessment</p>
                </div>
            </div>
            
            <!-- Full-width Table -->
            <div class="w-full overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-border">
                            <th class="text-left py-3 px-4 font-medium text-muted-foreground">DPD Bucket</th>
                            <th class="text-right py-3 px-4 font-medium text-muted-foreground">Loans (#)</th>
                        </tr>
                    </thead>
                    <tbody id="dpdTableBody">
                        <!-- DPD data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mobile Responsive City-wise Analysis Charts -->
        <!-- Top Cities - Collection Rate Chart -->
        <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl mt-6 sm:mt-8">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                    <div class="p-3 rounded-2xl bg-gradient-to-br from-blue-500/20 to-purple-500/20 border border-blue-500/30 shadow-lg">
                        <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <div>
                        <h3 class="text-xl font-bold text-foreground">Top Cities – Collection Rate (%)</h3>
                        <p class="text-sm text-muted-foreground font-medium">Color coded by performance bracket</p>
                        </div>
                    </div>
                <button onclick="openFullscreenChart('topCitiesCollectionChart', 'Top Cities – Collection Rate (%)', 'Color coded by performance bracket')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
            <div class="h-96">
                <canvas id="topCitiesCollectionChart"></canvas>
                </div>
            </div>

        <!-- Pending Cases by Amount Bucket Chart -->
        <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl mt-6 sm:mt-8">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                    <div class="p-3 rounded-2xl bg-gradient-to-br from-orange-500/20 to-amber-500/20 border border-orange-500/30 shadow-lg">
                        <svg class="h-6 w-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                            </svg>
                        </div>
                        <div>
                        <h3 class="text-xl font-bold text-foreground">Pending Cases by Amount Bucket</h3>
                        <p class="text-sm text-muted-foreground font-medium">Pending cases grouped by repayment amount</p>
                        </div>
                    </div>
                <button onclick="openFullscreenChart('pendingCasesByAmountChart', 'Pending Cases by Amount Bucket', 'Pending cases grouped by repayment amount')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
            <div class="h-96">
                <canvas id="pendingCasesByAmountChart"></canvas>
    </div>
    </div>

    <!-- DPD Details Modal -->
    <div id="dpdDetailsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-card border border-border rounded-lg shadow-xl w-full max-w-7xl max-h-[90vh] flex flex-col">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-6 border-b border-border">
                    <div>
                        <h2 id="dpdModalTitle" class="text-xl font-semibold text-foreground">DPD Details</h2>
                        <p id="dpdModalSubtitle" class="text-sm text-muted-foreground mt-1">Loading...</p>
                    </div>
                    <button onclick="closeDPDDetailsModal()" class="text-muted-foreground hover:text-foreground transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div class="flex-1 overflow-hidden flex flex-col">
                    <!-- Search and Controls -->
                    <div class="p-6 border-b border-border">
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <input 
                                    type="text" 
                                    id="dpdSearchInput" 
                                    placeholder="Search by Loan No or PAN..." 
                                    class="w-full px-4 py-2 bg-background border border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                                >
                            </div>
                            <button 
                                id="dpdExportBtn" 
                                onclick="exportDPDDetails()" 
                                class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors"
                            >
                                Export CSV
                            </button>
                        </div>
                    </div>
                    
                    <!-- Table Container -->
                    <div class="flex-1 overflow-auto">
                        <div class="p-6">
                            <!-- Loading State -->
                            <div id="dpdLoadingState" class="hidden">
                                <div class="flex items-center justify-center py-12">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                                    <span class="ml-3 text-muted-foreground">Loading details...</span>
                                </div>
                            </div>
                            
                            <!-- Empty State -->
                            <div id="dpdEmptyState" class="hidden text-center py-12">
                                <svg class="w-12 h-12 text-muted-foreground mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="text-muted-foreground">No loans found in this DPD bucket</p>
                            </div>
                            
                            <!-- Table -->
                            <div id="dpdTableContainer" class="hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="sticky top-0 bg-card">
                                            <tr class="border-b border-border">
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('loan_no')">
                                                    Loan No <span id="sort-loan_no" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('pan')">
                                                    PAN <span id="sort-pan" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('disbursal_date')">
                                                    Disbursal Date <span id="sort-disbursal_date" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('net_disbursal')">
                                                    Net Disbursal <span id="sort-net_disbursal" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('repayment_date')">
                                                    Repayment Date <span id="sort-repayment_date" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('repayment_amount')">
                                                    Repayment Amount <span id="sort-repayment_amount" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('overdue_days')">
                                                    Overdue Days <span id="sort-overdue_days" class="text-xs">↓</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortDPDTable('dpd_bucket')">
                                                    DPD Bucket <span id="sort-dpd_bucket" class="text-xs">↕</span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="dpdDetailsTableBody">
                                            <!-- Data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <div id="dpdPagination" class="flex items-center justify-between mt-6">
                                    <div class="text-sm text-muted-foreground">
                                        Showing <span id="dpdPaginationInfo"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="dpdPrevBtn" onclick="changeDPDPage(-1)" class="px-3 py-1 bg-secondary text-secondary-foreground rounded hover:bg-secondary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                            Previous
                                        </button>
                                        <span id="dpdPageInfo" class="px-3 py-1 text-sm text-muted-foreground"></span>
                                        <button id="dpdNextBtn" onclick="changeDPDPage(1)" class="px-3 py-1 bg-secondary text-secondary-foreground rounded hover:bg-secondary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                            Next
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Totals Footer -->
                                <div id="dpdTotalsFooter" class="mt-6 pt-4 border-t border-border">
                                    <div class="flex justify-end gap-8 text-sm">
                                        <div>
                                            <span class="text-muted-foreground">Total Net Disbursal:</span>
                                            <span id="dpdTotalNetDisbursal" class="ml-2 font-semibold text-foreground"></span>
                                        </div>
                                        <div>
                                            <span class="text-muted-foreground">Total Repayment Amount:</span>
                                            <span id="dpdTotalRepaymentAmount" class="ml-2 font-semibold text-foreground"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Mobile Responsive Total Applications Modal -->
    <div id="totalApplicationsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-2 sm:p-4">
            <div class="bg-card border border-border rounded-lg shadow-xl w-full max-w-7xl max-h-[95vh] sm:max-h-[90vh] flex flex-col">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-6 border-b border-border">
                    <div>
                        <h2 id="totalAppsModalTitle" class="text-xl font-semibold text-foreground">Total Applications</h2>
                        <p id="totalAppsModalSubtitle" class="text-sm text-muted-foreground mt-1">Loading...</p>
                    </div>
                    <button onclick="closeTotalApplicationsModal()" class="text-muted-foreground hover:text-foreground transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <!-- Modal Content -->
                <div class="flex-1 overflow-hidden flex flex-col">
                    <!-- Search and Controls -->
                    <div class="p-6 border-b border-border">
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <input 
                                    type="text" 
                                    id="totalAppsSearchInput" 
                                    placeholder="Search by Loan No or PAN..." 
                                    class="w-full px-4 py-2 bg-background border border-border rounded-lg text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary"
                                >
                            </div>
                            <button 
                                id="totalAppsExportBtn" 
                                onclick="exportTotalApplications()" 
                                class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors"
                            >
                                Export CSV
                            </button>
                        </div>
                    </div>
                    
                    <!-- Table Container -->
                    <div class="flex-1 overflow-auto">
                        <div class="p-6">
                            <!-- Loading State -->
                            <div id="totalAppsLoadingState" class="hidden">
                                <div class="flex items-center justify-center py-12">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                                    <span class="ml-3 text-muted-foreground">Loading applications...</span>
                                </div>
                            </div>
                            
                            <!-- Empty State -->
                            <div id="totalAppsEmptyState" class="hidden text-center py-12">
                                <svg class="w-12 h-12 text-muted-foreground mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="text-muted-foreground">No applications found</p>
                            </div>
                            
                            <!-- Table -->
                            <div id="totalAppsTableContainer" class="hidden">
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="sticky top-0 bg-card">
                                            <tr class="border-b border-border">
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('loan_no')">
                                                    Loan No <span id="sort-loan_no" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('pan')">
                                                    PAN <span id="sort-pan" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('disbursal_date')">
                                                    Disbursal Date <span id="sort-disbursal_date" class="text-xs">↓</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('loan_amount')">
                                                    Loan Amount <span id="sort-loan_amount" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('net_disbursal')">
                                                    Net Disbursal <span id="sort-net_disbursal" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('tenure')">
                                                    Tenure <span id="sort-tenure" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('repayment_date')">
                                                    Repayment Date <span id="sort-repayment_date" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('repayment_amount')">
                                                    Repayment Amount <span id="sort-repayment_amount" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('processing_fee')">
                                                    Processing Fee <span id="sort-processing_fee" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('interest_amount')">
                                                    Interest Amount <span id="sort-interest_amount" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('last_received_date')">
                                                    Last Received Date <span id="sort-last_received_date" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-right py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('total_received')">
                                                    Total Received <span id="sort-total_received" class="text-xs">↕</span>
                                                </th>
                                                <th class="text-left py-3 px-4 font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTotalAppsTable('closed_status')">
                                                    Closed Status <span id="sort-closed_status" class="text-xs">↕</span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="totalAppsDetailsTableBody">
                                            <!-- Data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Pagination -->
                                <div id="totalAppsPagination" class="flex items-center justify-between mt-6">
                                    <div class="text-sm text-muted-foreground">
                                        Showing <span id="totalAppsPaginationInfo"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button id="totalAppsPrevBtn" onclick="changeTotalAppsPage(-1)" class="px-3 py-1 bg-secondary text-secondary-foreground rounded hover:bg-secondary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                            Previous
                                        </button>
                                        <span id="totalAppsPageInfo" class="px-3 py-1 text-sm text-muted-foreground"></span>
                                        <button id="totalAppsNextBtn" onclick="changeTotalAppsPage(1)" class="px-3 py-1 bg-secondary text-secondary-foreground rounded hover:bg-secondary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                            Next
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Totals Footer -->
                                <div id="totalAppsTotalsFooter" class="mt-6 pt-4 border-t border-border">
                                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-sm">
                                        <div>
                                            <span class="text-muted-foreground">Total Loan Amount:</span>
                                            <div id="totalAppsTotalLoanAmount" class="font-semibold text-foreground"></div>
                                        </div>
                                        <div>
                                            <span class="text-muted-foreground">Total Net Disbursal:</span>
                                            <div id="totalAppsTotalNetDisbursal" class="font-semibold text-foreground"></div>
                                        </div>
                                        <div>
                                            <span class="text-muted-foreground">Total Repayment Amount:</span>
                                            <div id="totalAppsTotalRepaymentAmount" class="font-semibold text-foreground"></div>
                                        </div>
                                        <div>
                                            <span class="text-muted-foreground">Total Processing Fee:</span>
                                            <div id="totalAppsTotalProcessingFee" class="font-semibold text-foreground"></div>
                                        </div>
                                        <div>
                                            <span class="text-muted-foreground">Total Interest Amount:</span>
                                            <div id="totalAppsTotalInterestAmount" class="font-semibold text-foreground"></div>
                                        </div>
                                        <div>
                                            <span class="text-muted-foreground">Total Received:</span>
                                            <div id="totalAppsTotalReceived" class="font-semibold text-foreground"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Toggle filters visibility
    function toggleFilters() {
        const filterContent = document.getElementById('filterContent');
        const toggleIcon = document.getElementById('filterToggleIcon');
        
        if (filterContent.classList.contains('hidden')) {
            filterContent.classList.remove('hidden');
            toggleIcon.style.transform = 'rotate(180deg)';
            localStorage.setItem('mainFiltersExpanded', 'true');
        } else {
            filterContent.classList.add('hidden');
            toggleIcon.style.transform = 'rotate(0deg)';
            localStorage.setItem('mainFiltersExpanded', 'false');
        }
    }
    
    // Toggle fraud filters visibility
    // just for git push 3
    function toggleFraudFilters() {
        const filterContent = document.getElementById('fraudFilterContent');
        const toggleIcon = document.getElementById('fraudFilterToggleIcon');
        
        if (filterContent.classList.contains('hidden')) {
            filterContent.classList.remove('hidden');
            toggleIcon.style.transform = 'rotate(180deg)';
        } else {
            filterContent.classList.add('hidden');
            toggleIcon.style.transform = 'rotate(0deg)';
        }
    }

    // Open chart in fullscreen (generic function)
    function openFullscreenChart(chartId, title, subtitle) {
        // Create fullscreen modal
        const modal = document.createElement('div');
        modal.id = 'fullscreenChartModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-gray-900 rounded-lg p-6 w-full h-full max-w-7xl max-h-full flex flex-col">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-lg bg-blue-500/10">
                            <svg class="h-6 w-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18V11H3V4z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-white">${title}</h2>
                            <p class="text-gray-400">${subtitle} - Fullscreen View</p>
                        </div>
                    </div>
                    <button onclick="closeFullscreenChart()" class="p-2 rounded-lg bg-red-600/20 hover:bg-red-600/30 border border-red-500/20 transition-colors" title="Close Fullscreen">
                        <svg class="h-6 w-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex-1 min-h-0">
                    <canvas id="fullscreenChart"></canvas>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Create fullscreen chart based on the original chart
        setTimeout(() => {
            const ctx = document.getElementById('fullscreenChart').getContext('2d');
            const originalChart = getChartInstance(chartId);
            
            if (!originalChart) {
                console.error(`Cannot open fullscreen for ${chartId}: Chart not found or not loaded yet`);
                // Show error message in the chart container
                const chartContainer = document.getElementById('fullscreenChart').parentElement;
                chartContainer.innerHTML = '<div class="flex items-center justify-center h-full text-red-500">Chart not loaded yet. Please try again.</div>';
                return;
            }
            
            if (originalChart && originalChart.data) {
                const originalData = originalChart.data;
                
                // Create new chart instance for fullscreen with enhanced options
                window.fullscreenChartInstance = new Chart(ctx, {
                    type: originalChart.config.type,
                    data: {
                        labels: originalData.labels,
                        datasets: originalData.datasets.map(dataset => {
                            const enhancedDataset = { ...dataset };
                            
                            // Enhance different chart types appropriately
                            if (originalChart.config.type === 'line') {
                                enhancedDataset.pointRadius = dataset.pointRadius ? dataset.pointRadius * 1.5 : 6;
                                enhancedDataset.pointHoverRadius = dataset.pointHoverRadius ? dataset.pointHoverRadius * 1.5 : 8;
                                enhancedDataset.borderWidth = dataset.borderWidth ? dataset.borderWidth * 1.5 : 3;
                            } else if (originalChart.config.type === 'bar') {
                                enhancedDataset.borderWidth = dataset.borderWidth ? dataset.borderWidth * 1.5 : 2;
                                enhancedDataset.borderRadius = dataset.borderRadius ? dataset.borderRadius * 1.5 : 6;
                            }
                            
                            return enhancedDataset;
                        })
                    },
                    plugins: originalChart.config.plugins,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#94a3b8',
                                    font: {
                                        size: 16
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#f8fafc',
                                bodyColor: '#f8fafc',
                                borderColor: '#334155',
                                borderWidth: 1,
                                titleFont: {
                                    size: 16
                                },
                                bodyFont: {
                                    size: 14
                                },
                                callbacks: originalChart.options.plugins.tooltip.callbacks
                            },
                            datalabels: {
                                display: function(context) {
                                    // Show datalabels if the original chart had them enabled
                                    const originalDatalabels = originalChart.options?.plugins?.datalabels;
                                    if (originalDatalabels) {
                                        if (typeof originalDatalabels.display === 'function') {
                                            return originalDatalabels.display(context);
                                        }
                                        return originalDatalabels.display !== false;
                                    }
                                    return false;
                                },
                                color: '#ffffff',
                                anchor: function(context) {
                                    const originalDatalabels = originalChart.options?.plugins?.datalabels;
                                    return originalDatalabels?.anchor || 'end';
                                },
                                align: function(context) {
                                    const originalDatalabels = originalChart.options?.plugins?.datalabels;
                                    return originalDatalabels?.align || 'right';
                                },
                                offset: function(context) {
                                    const originalDatalabels = originalChart.options?.plugins?.datalabels;
                                    return (originalDatalabels?.offset || 10) * 1.5;
                                },
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                },
                                formatter: function(value, context) {
                                    // Use the original chart's formatter if available
                                    const originalDatalabels = originalChart.options?.plugins?.datalabels;
                                    if (originalDatalabels && originalDatalabels.formatter) {
                                        return originalDatalabels.formatter(value, context);
                                    }
                                    
                                    // Fallback: get the actual data value
                                    let dataValue = value;
                                    
                                    // If value is not a number, try to get it from the dataset
                                    if (typeof value !== 'number' && context.datasetIndex !== undefined && context.dataIndex !== undefined) {
                                        const dataset = originalData.datasets[context.datasetIndex];
                                        if (dataset && dataset.data && dataset.data[context.dataIndex] !== undefined) {
                                            dataValue = dataset.data[context.dataIndex];
                                        }
                                    }
                                    
                                    // Format based on dataset label - don't add % for case counts
                                    const datasetLabel = originalData.datasets[context.datasetIndex]?.label || '';
                                    if (datasetLabel.toLowerCase().includes('case')) {
                                        // For case counts, show whole numbers
                                        return typeof dataValue === 'number' ? Math.round(dataValue).toLocaleString('en-IN') : dataValue;
                                    } else if (datasetLabel.toLowerCase().includes('amount') || datasetLabel.toLowerCase().includes('₹')) {
                                        // For amounts, show currency format
                                        return typeof dataValue === 'number' ? '₹' + dataValue.toLocaleString('en-IN', {maximumFractionDigits: 0}) : dataValue;
                                    } else {
                                        // Default: show as number with 2 decimal places (for percentages)
                                        return typeof dataValue === 'number' ? dataValue.toFixed(2) + '%' : String(dataValue);
                                    }
                                }
                            }
                        },
                        scales: originalChart.options.scales ? {
                            ...originalChart.options.scales,
                            x: {
                                ...originalChart.options.scales.x,
                                grid: {
                                    color: '#334155'
                                },
                                ticks: {
                                    ...originalChart.options.scales.x?.ticks,
                                    color: '#94a3b8',
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            y: originalChart.options.scales.y ? {
                                ...originalChart.options.scales.y,
                                grid: {
                                    color: '#334155'
                                },
                                ticks: {
                                    ...originalChart.options.scales.y.ticks,
                                    color: '#94a3b8',
                                    font: {
                                        size: 14
                                    }
                                }
                            } : {
                                grid: {
                                    color: '#334155'
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    font: {
                                        size: 14
                                    },
                                    callback: function(value) {
                                        return Math.round(value).toLocaleString('en-IN');
                                    }
                                }
                            },
                            y1: originalChart.options.scales.y1 ? {
                                ...originalChart.options.scales.y1,
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    ...originalChart.options.scales.y1.ticks,
                                    color: '#60a5fa',
                                    font: {
                                        size: 14
                                    }
                                }
                            } : undefined
                        } : {
                            x: {
                                grid: {
                                    color: '#334155'
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            y: {
                                grid: {
                                    color: '#334155'
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    font: {
                                        size: 14
                                    },
                                    callback: function(value) {
                                        return Math.round(value).toLocaleString('en-IN');
                                    }
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
            }
        }, 100);
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }

    // Get chart instance by ID
    function getChartInstance(chartId) {
        const chartInstances = {
            'timeSeriesChart': window.timeSeriesChartInstance,
            'stateChart': window.stateChartInstance,
            'statePendingChart': window.statePendingChartInstance,
            'topCitiesCollectionChart': window.topCitiesCollectionChartInstance,
            'pendingCasesByAmountChart': window.pendingCasesByAmountChartInstance,
            'fraudStateChart': window.fraudStateChartInstance,
            'fraudTimeSeriesChart': window.fraudTimeSeriesChartInstance,
            'fraudCityCollectedChart': window.fraudCityCollectedChartInstance,
            'fraudCityUncollectedChart': window.fraudCityUncollectedChartInstance
        };
        const chart = chartInstances[chartId];
        
        if (!chart) {
            console.warn(`Chart instance not found for ${chartId}. Available charts:`, Object.keys(chartInstances));
            return null;
        }
        
        return chart;
    }

    // Open table in fullscreen
    function openFullscreenTable(tableId, title, subtitle) {
        // Create fullscreen modal
        const modal = document.createElement('div');
        modal.id = 'fullscreenTableModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4';
        
        const tableElement = document.getElementById(tableId);
        const tableHTML = tableElement.outerHTML;
        
        modal.innerHTML = `
            <div class="bg-gray-900 rounded-lg p-6 w-full h-full max-w-7xl max-h-full flex flex-col">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-lg bg-blue-500/10">
                            <svg class="h-6 w-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-white">${title}</h2>
                            <p class="text-gray-400">${subtitle} - Fullscreen View</p>
                        </div>
                    </div>
                    <button onclick="closeFullscreenChart()" class="p-2 rounded-lg bg-red-600/20 hover:bg-red-600/30 border border-red-500/20 transition-colors" title="Close Fullscreen">
                        <svg class="h-6 w-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="flex-1 min-h-0 overflow-auto">
                    <div class="bg-gray-800 rounded-lg p-4">
                        ${tableHTML}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }

    // Close fullscreen chart
    function closeFullscreenChart() {
        const chartModal = document.getElementById('fullscreenChartModal');
        const tableModal = document.getElementById('fullscreenTableModal');
        
        if (chartModal) {
            chartModal.remove();
        }
        
        if (tableModal) {
            tableModal.remove();
        }
        
        // Destroy fullscreen chart instance
        if (window.fullscreenChartInstance) {
            window.fullscreenChartInstance.destroy();
            window.fullscreenChartInstance = null;
        }
        
        // Restore body scroll
        document.body.style.overflow = 'auto';
    }

    // Test function to check fullscreen functionality
    function testFullscreen() {
        console.log('Testing fullscreen functionality...');
        console.log('Available chart instances:', {
            timeSeriesChart: !!window.timeSeriesChartInstance,
            stateChart: !!window.stateChartInstance,
            cityCollectedChart: !!window.cityCollectedChartInstance,
            cityUncollectedChart: !!window.cityUncollectedChartInstance
        });
    }
    // Test state chart fullscreen specifically
    function testStateChartFullscreen() {
        console.log('Testing state chart fullscreen...');
        console.log('State chart instance:', window.stateChartInstance);
        
        if (window.stateChartInstance) {
            console.log('State chart data:', window.stateChartInstance.data);
            console.log('State chart config:', window.stateChartInstance.config);
            openFullscreenChart('stateChart', 'Received Amount by State', 'Geographic distribution of collections');
        } else {
            console.error('State chart instance not found!');
        }
    }

// Load top cities collection rate chart (combined)
async function loadTopCitiesCollectionChart(filterParams = null) {
    try {
        let params;
        if (filterParams) {
            params = new URLSearchParams(filterParams);
        } else {
            params = new URLSearchParams(window.location.search);
        }
        
        // Fetch both collected and uncollected data
        const [collectedResponse, uncollectedResponse] = await Promise.all([
            fetch(`/api/city-collected/?${params}`),
            fetch(`/api/city-uncollected/?${params}`)
        ]);
        
        const collectedData = await collectedResponse.json();
        const uncollectedData = await uncollectedResponse.json();
        
        console.log('City collected data loaded:', collectedData.data.length, 'cities');
        console.log('City uncollected data loaded:', uncollectedData.data.length, 'cities');
        
        // Combine all cities with their collection rates, avoiding duplicates
        const cityMap = new Map();
        
        // Add collected cities
        collectedData.data.forEach(item => {
            cityMap.set(item.city, {
                city: item.city,
                collection_rate: item.collection_percentage
            });
        });
        
        // Add uncollected cities (only if not already present or if the rate is higher)
        uncollectedData.data.forEach(item => {
            const existingCity = cityMap.get(item.city);
            if (!existingCity || item.collection_percentage > existingCity.collection_rate) {
                cityMap.set(item.city, {
                    city: item.city,
                    collection_rate: item.collection_percentage
                });
            }
        });
        
        // Convert map to array and sort by collection rate descending
        const allCities = Array.from(cityMap.values());
        allCities.sort((a, b) => b.collection_rate - a.collection_rate);
        
        // Take top 20 cities
        const topCities = allCities.slice(0, 20);
        
        // Color coding function based on thresholds
        function getColorForRate(rate) {
            if (rate >= 94) return '#06402B';           //Dark Green
            if (rate >= 90) return '#1DB954';           // Green
            if (rate >= 87) return '#FFDD00';           // Orange
            if (rate >= 85) return '#FFA500';           // Dark Orange
            if (rate >= 82) return '#FF8C00';           // Red
            if (rate >= 80) return '#FF4C4C';           // Dark Red
            return '#C62828';                           // Maroon Red (<80%)
        }
        
        const ctx = document.getElementById('topCitiesCollectionChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.topCitiesCollectionChartInstance) {
            window.topCitiesCollectionChartInstance.destroy();
        }
        
        // Create horizontal bar chart
        window.topCitiesCollectionChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: topCities.map(item => item.city),
                datasets: [{
                    label: 'Collection Rate (%)',
                    data: topCities.map(item => item.collection_rate),
                    backgroundColor: topCities.map(item => getColorForRate(item.collection_rate)),
                    borderColor: topCities.map(item => getColorForRate(item.collection_rate)),
                    borderWidth: 1,
                    borderRadius: 8,
                    borderSkipped: false,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#374151',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const city = topCities[context.dataIndex];
                                return `${city.city}: ${city.collection_rate.toFixed(1)}%`;
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: '#ffffff',
                        anchor: 'end',
                        align: 'right',
                        offset: 10,
                        font: {
                            size: 11,
                            weight: 'bold'
                        },
                        formatter: function(value, context) {
                            return value.toFixed(2) + '%';
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: '#374151',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#9ca3af',
                            font: {
                                family: 'Inter, sans-serif',
                                weight: '600'
                            },
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            color: '#ffffff',
                            font: {
                                family: 'Inter, sans-serif',
                                size: 12,
                                weight: '600'
                            }
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
        
    } catch (error) {
        console.error('Error loading top cities collection chart:', error);
    }
}

// Load pending cases by amount bucket chart
async function loadPendingCasesByAmountChart(filterParams = null) {
    try {
        let params;
        if (filterParams) {
            params = new URLSearchParams(filterParams);
        } else {
            params = new URLSearchParams(window.location.search);
        }
        
        const response = await fetch(`/api/fraud/pending-cases-by-amount/?${params}`);
        const data = await response.json();
        
        if (data.error) {
            console.error('Error fetching pending cases by amount:', data.error);
            return;
        }
        
        const buckets = data.buckets || [];
        const overallTotalPendingAmount = data.overall_total_pending_amount || 0;
        console.log('Pending cases by amount data loaded:', buckets.length, 'buckets');
        
        const canvasElement = document.getElementById('pendingCasesByAmountChart');
        if (!canvasElement) {
            console.warn('Pending cases by amount chart canvas not found');
            return;
        }
        
        const ctx = canvasElement.getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.pendingCasesByAmountChartInstance) {
            window.pendingCasesByAmountChartInstance.destroy();
        }
        
        // Prepare data for chart
        const labels = buckets.map(item => item.bucket);
        const counts = buckets.map(item => item.count);
        const amounts = buckets.map(item => item.total_pending_amount);
        
        // Store full bucket data for tooltip
        const bucketDataMap = {};
        buckets.forEach(item => {
            bucketDataMap[item.bucket] = item;
        });
        
        // Create bar chart
        window.pendingCasesByAmountChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Number of Cases',
                        data: counts,
                        backgroundColor: 'rgba(251, 146, 60, 0.8)',
                        borderColor: 'rgba(251, 146, 60, 1)',
                        borderWidth: 2,
                        yAxisID: 'y',
                        order: 2,
                        maxBarThickness: 50,
                        categoryPercentage: 0.6,
                        barPercentage: 0.8
                    },
                    {
                        label: 'Total Pending Amount (₹)',
                        data: amounts,
                        type: 'line',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y1',
                        order: 1,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: 20,
                        bottom: 10,
                        left: 10,
                        right: 10
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#ffffff',
                            font: {
                                family: 'Inter, sans-serif',
                                size: 12,
                                weight: '600'
                            },
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#374151',
                        borderWidth: 1,
                        padding: 12,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                // Return empty for individual dataset labels to avoid duplication
                                return '';
                            },
                            afterBody: function(context) {
                                // Show all metrics only once in afterBody
                                const bucket = context[0].label;
                                const bucketData = bucketDataMap[bucket];
                                
                                if (!bucketData) {
                                    return [];
                                }
                                
                                // Return all metrics for the bucket
                                const labels = [];
                                
                                // Total Repayment Amount
                                labels.push('Total Repayment Amount (₹): ₹' + 
                                    bucketData.total_repayment_amount.toLocaleString('en-IN', {maximumFractionDigits: 0}));
                                
                                // Collected Amount
                                labels.push('Collected Amount (₹): ₹' + 
                                    bucketData.total_collected_amount.toLocaleString('en-IN', {maximumFractionDigits: 0}));
                                
                                // Total Pending Amount
                                labels.push('Total Pending Amount (₹): ₹' + 
                                    bucketData.total_pending_amount.toLocaleString('en-IN', {maximumFractionDigits: 0}));
                                
                                // Percentage of Total Pending Amount
                                if (overallTotalPendingAmount > 0) {
                                    const percentage = (bucketData.total_pending_amount / overallTotalPendingAmount) * 100;
                                    labels.push('Percentage of Total Pending: ' + 
                                        percentage.toFixed(2) + '%');
                                }
                                
                                const totalCases = bucketData.total_count ?? 0;
                                const pendingCases = bucketData.pending_count ?? bucketData.count ?? 0;
                                const pendingPctCount = Number(bucketData.pending_percentage_count ?? 0);
                                const pendingPctAmount = Number(bucketData.pending_percentage_amount ?? 0);
                                
                                // Total and Pending Cases
                                labels.push('Total Cases: ' + totalCases.toLocaleString('en-IN') + ' cases');
                                labels.push('Pending Cases: ' + pendingCases.toLocaleString('en-IN') + ' cases');
                                
                                // Portfolio Contribution Metrics
                                labels.push('Pending % (Count): ' + pendingPctCount.toFixed(2) + '%');
                                labels.push('Pending % (Amount): ' + pendingPctAmount.toFixed(2) + '%');
                                
                                return labels;
                            }
                        }
                    },
                    datalabels: {
                        display: true,
                        color: '#ffffff',
                        anchor: 'end',
                        align: 'top',
                        offset: 5,
                        font: {
                            size: 10,
                            weight: 'bold'
                        },
                        formatter: function(value, context) {
                            if (context.datasetIndex === 0) {
                                // Show case count as whole number, not percentage
                                return value > 0 ? Math.round(value).toLocaleString('en-IN') : '';
                            }
                            return '';
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: '#374151',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#9ca3af',
                            font: {
                                family: 'Inter, sans-serif',
                                size: 11,
                                weight: '600'
                            },
                            maxRotation: 45,
                            minRotation: 0
                        },
                        offset: true
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        beginAtZero: true,
                        grid: {
                            color: '#374151',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#9ca3af',
                            font: {
                                family: 'Inter, sans-serif',
                                size: 11,
                                weight: '600'
                            },
                            callback: function(value) {
                                // Ensure we show numbers, not percentages
                                return Math.round(value).toLocaleString('en-IN');
                            },
                            stepSize: 1,  // Ensure whole numbers for case counts
                            maxTicksLimit: 10
                        },
                        afterFit: function(scale) {
                            scale.paddingTop = 10;
                            scale.paddingBottom = 10;
                        },
                        title: {
                            display: true,
                            text: 'Number of Cases',
                            color: '#ffffff',
                            font: {
                                family: 'Inter, sans-serif',
                                size: 12,
                                weight: '600'
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        beginAtZero: true,
                        grid: {
                            drawOnChartArea: false,
                        },
                        ticks: {
                            color: '#60a5fa',
                            font: {
                                family: 'Inter, sans-serif',
                                size: 11,
                                weight: '600'
                            },
                            callback: function(value) {
                                return '₹' + (value / 1000).toFixed(0) + 'k';
                            },
                            maxTicksLimit: 10
                        },
                        afterFit: function(scale) {
                            scale.paddingTop = 10;
                            scale.paddingBottom = 10;
                        },
                        title: {
                            display: true,
                            text: 'Pending Amount (₹)',
                            color: '#60a5fa',
                            font: {
                                family: 'Inter, sans-serif',
                                size: 12,
                                weight: '600'
                            }
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
        
    } catch (error) {
        console.error('Error loading pending cases by amount chart:', error);
    }
}


// DPD Details Modal Functions
let currentDPDBucket = null;
let currentDPDPage = 1;
let currentDPDSort = 'overdue_days';
let currentDPDSortOrder = 'desc';
let currentDPDSearch = '';
let dpdDetailsData = null;

function openDPDDetailsModal(dpdBucket, loanCount) {
    currentDPDBucket = dpdBucket;
    currentDPDPage = 1;
    currentDPDSearch = '';
    
    // Update modal title
    document.getElementById('dpdModalTitle').textContent = `DPD Details – ${dpdBucket} days`;
    document.getElementById('dpdModalSubtitle').textContent = `${loanCount} loans`;
    
    // Clear search input
    document.getElementById('dpdSearchInput').value = '';
    
    // Show modal
    document.getElementById('dpdDetailsModal').classList.remove('hidden');
    
    // Load data
    loadDPDDetails();
}

function closeDPDDetailsModal() {
    document.getElementById('dpdDetailsModal').classList.add('hidden');
    currentDPDBucket = null;
    dpdDetailsData = null;
}
async function loadDPDDetails() {
    if (!currentDPDBucket) return;
    
    // Show loading state
    document.getElementById('dpdLoadingState').classList.remove('hidden');
    document.getElementById('dpdEmptyState').classList.add('hidden');
    document.getElementById('dpdTableContainer').classList.add('hidden');
    
    try {
        // Get current filter values from the form
        const filterForm = document.getElementById('filterForm');
        const formData = new FormData(filterForm);
        
        const params = new URLSearchParams({
            dpd_bucket: currentDPDBucket,
            page: currentDPDPage,
            per_page: 20,
            sort_by: currentDPDSort,
            sort_order: currentDPDSortOrder,
            search: currentDPDSearch
        });
        
        // Add current filter values
        for (const [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        const response = await fetch(`/api/dpd-bucket-details/?${params}`);
        const data = await response.json();
        
        dpdDetailsData = data;
        
        // Hide loading state
        document.getElementById('dpdLoadingState').classList.add('hidden');
        
        if (data.records.length === 0) {
            // Show empty state
            document.getElementById('dpdEmptyState').classList.remove('hidden');
        } else {
            // Show table and populate data
            document.getElementById('dpdTableContainer').classList.remove('hidden');
            populateDPDDetailsTable(data);
            updateDPDPagination(data.pagination);
            updateDPDTotals(data.totals);
        }
        
    } catch (error) {
        console.error('Error loading DPD details:', error);
        document.getElementById('dpdLoadingState').classList.add('hidden');
        document.getElementById('dpdEmptyState').classList.remove('hidden');
    }
}

function populateDPDDetailsTable(data) {
    const tbody = document.getElementById('dpdDetailsTableBody');
    tbody.innerHTML = '';
    
    data.records.forEach(record => {
        const row = document.createElement('tr');
        row.className = 'border-b border-border/50 hover:bg-secondary/50 transition-colors';
        
        row.innerHTML = `
            <td class="py-3 px-4 font-mono text-sm">${record.loan_no || '—'}</td>
            <td class="py-3 px-4 font-mono text-sm">${record.pan || '—'}</td>
            <td class="py-3 px-4 text-sm">${record.disbursal_date}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.net_disbursal)}</td>
            <td class="py-3 px-4 text-sm">${record.repayment_date}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.repayment_amount)}</td>
            <td class="py-3 px-4 text-right text-sm">${record.overdue_days || '—'}</td>
            <td class="py-3 px-4 text-sm">${record.dpd_bucket} days</td>
        `;
        
        tbody.appendChild(row);
    });
}

function updateDPDPagination(pagination) {
    const startRecord = (pagination.current_page - 1) * pagination.per_page + 1;
    const endRecord = Math.min(startRecord + pagination.per_page - 1, pagination.total_records);
    
    document.getElementById('dpdPaginationInfo').textContent = 
        `${startRecord}-${endRecord} of ${pagination.total_records}`;
    document.getElementById('dpdPageInfo').textContent = 
        `Page ${pagination.current_page} of ${pagination.total_pages}`;
    
    document.getElementById('dpdPrevBtn').disabled = !pagination.has_previous;
    document.getElementById('dpdNextBtn').disabled = !pagination.has_next;
}

function updateDPDTotals(totals) {
    document.getElementById('dpdTotalNetDisbursal').textContent = formatCurrency(totals.total_net_disbursal);
    document.getElementById('dpdTotalRepaymentAmount').textContent = formatCurrency(totals.total_repayment_amount);
}

function changeDPDPage(direction) {
    if (!dpdDetailsData) return;
    
    const newPage = currentDPDPage + direction;
    const maxPage = dpdDetailsData.pagination.total_pages;
    
    if (newPage >= 1 && newPage <= maxPage) {
        currentDPDPage = newPage;
        loadDPDDetails();
    }
}

function sortDPDTable(column) {
    if (currentDPDSort === column) {
        currentDPDSortOrder = currentDPDSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        currentDPDSort = column;
        currentDPDSortOrder = 'desc';
    }
    
    // Update sort indicators
    document.querySelectorAll('[id^="sort-"]').forEach(el => {
        el.textContent = '↕';
    });
    
    const sortIndicator = document.getElementById(`sort-${column}`);
    if (sortIndicator) {
        sortIndicator.textContent = currentDPDSortOrder === 'asc' ? '↑' : '↓';
    }
    
    currentDPDPage = 1;
    loadDPDDetails();
}

async function exportDPDDetails() {
    if (!currentDPDBucket) return;
    
    try {
        // Get current filter values from the form
        const filterForm = document.getElementById('filterForm');
        const formData = new FormData(filterForm);
        
        const params = new URLSearchParams({
            dpd_bucket: currentDPDBucket,
            per_page: 10000, // Large number to get all records
            sort_by: currentDPDSort,
            sort_order: currentDPDSortOrder,
            search: currentDPDSearch
        });
        
        // Add current filter values
        for (const [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        const response = await fetch(`/api/dpd-bucket-details/?${params}`);
        const data = await response.json();
        
        if (!data.records || data.records.length === 0) {
            alert('No data to export');
            return;
        }
        
        const headers = ['Loan No', 'PAN', 'Disbursal Date', 'Net Disbursal', 'Repayment Date', 'Repayment Amount', 'Overdue Days', 'DPD Bucket'];
        const csvContent = [
            headers.join(','),
            ...data.records.map(record => [
                record.loan_no || '',
                record.pan || '',
                record.disbursal_date,
                record.net_disbursal,
                record.repayment_date,
                record.repayment_amount,
                record.overdue_days || '',
                record.dpd_bucket
            ].join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `dpd-details-${currentDPDBucket}-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
    } catch (error) {
        console.error('Error exporting DPD details:', error);
        alert('Error exporting data. Please try again.');
    }
}

// Helper function to get the currently active tab
function getCurrentActiveTab() {
    const mainTab = document.getElementById('mainTab');
    const fraudTab = document.getElementById('fraudTab');
    const loanCountTab = document.getElementById('loanCountTab');
    
    if (mainTab && mainTab.classList.contains('active')) {
        return 'main';
    } else if (fraudTab && fraudTab.classList.contains('active')) {
        return 'fraud';
    } else if (loanCountTab && loanCountTab.classList.contains('active')) {
        return 'loanCount';
    }
    
    // Default to main tab if none are clearly active
    return 'main';
}

// Total Applications Modal Functions
let currentTotalAppsPage = 1;
let currentTotalAppsSort = 'disbursal_date';
let currentTotalAppsSortOrder = 'desc';
let currentTotalAppsSearch = '';
let totalAppsDetailsData = null;

function openTotalApplicationsModal(totalCount) {
    currentTotalAppsPage = 1;
    currentTotalAppsSearch = '';
    
    // Update modal title with filtered count (will be updated after data loads)
    document.getElementById('totalAppsModalTitle').textContent = `Total Applications (Loading...)`;
    document.getElementById('totalAppsModalSubtitle').textContent = `Loading applications...`;
    
    // Clear search input
    document.getElementById('totalAppsSearchInput').value = '';
    
    // Show modal
    document.getElementById('totalApplicationsModal').classList.remove('hidden');
    
    // Load data
    loadTotalApplicationsDetails();
}

function closeTotalApplicationsModal() {
    document.getElementById('totalApplicationsModal').classList.add('hidden');
    totalAppsDetailsData = null;
}
async function loadTotalApplicationsDetails() {
    // Show loading state
    document.getElementById('totalAppsLoadingState').classList.remove('hidden');
    document.getElementById('totalAppsEmptyState').classList.add('hidden');
    document.getElementById('totalAppsTableContainer').classList.add('hidden');
    
    try {
        // Determine which tab is active and get the appropriate form and API endpoint
        const activeTab = getCurrentActiveTab();
        console.log('Active tab detected:', activeTab);
        
        let filterForm, apiEndpoint;
        
        if (activeTab === 'fraud') {
            filterForm = document.getElementById('fraudFilterForm');
            apiEndpoint = '/api/fraud/total-applications-details/';
            console.log('Using fraud form and endpoint');
        } else {
            filterForm = document.getElementById('filterForm');
            apiEndpoint = '/api/total-applications-details/';
            console.log('Using main form and endpoint');
        }
        
        const formData = new FormData(filterForm);
        
        const params = new URLSearchParams({
            page: currentTotalAppsPage,
            per_page: 20,
            sort_by: currentTotalAppsSort,
            sort_order: currentTotalAppsSortOrder,
            search: currentTotalAppsSearch
        });
        
        // Add current filter values
        for (const [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        // Add cache-busting parameter
        params.append('_t', Date.now());
        const response = await fetch(`${apiEndpoint}?${params}`);
        const data = await response.json();
        
        totalAppsDetailsData = data;
        
        // Hide loading state
        document.getElementById('totalAppsLoadingState').classList.add('hidden');
        
        if (data.records.length === 0) {
            // Show empty state
            document.getElementById('totalAppsEmptyState').classList.remove('hidden');
            
            // Update modal title for empty state
            document.getElementById('totalAppsModalTitle').textContent = `Total Applications (0)`;
            document.getElementById('totalAppsModalSubtitle').textContent = `No applications found with current filters`;
        } else {
            // Show table and populate data
            document.getElementById('totalAppsTableContainer').classList.remove('hidden');
            
            // Update modal title with filtered count
            const filteredCount = data.pagination.total_records;
            document.getElementById('totalAppsModalTitle').textContent = `Total Applications (${filteredCount})`;
            document.getElementById('totalAppsModalSubtitle').textContent = `${filteredCount} applications`;
            
            populateTotalAppsDetailsTable(data);
            updateTotalAppsPagination(data.pagination);
            updateTotalAppsTotals(data.totals);
        }
        
    } catch (error) {
        console.error('Error loading total applications details:', error);
        document.getElementById('totalAppsLoadingState').classList.add('hidden');
        document.getElementById('totalAppsEmptyState').classList.remove('hidden');
    }
}
function populateTotalAppsDetailsTable(data) {
    const tbody = document.getElementById('totalAppsDetailsTableBody');
    tbody.innerHTML = '';
    
    data.records.forEach(record => {
        const row = document.createElement('tr');
        row.className = 'border-b border-border/50 hover:bg-secondary/50 transition-colors';
        
        // Format closed status as badge
        const closedStatus = record.closed_status || '—';
        let statusBadge = '';
        
        if (closedStatus === 'Closed') {
            statusBadge = '<span class="px-2 py-1 text-xs bg-green-500/20 text-green-400 rounded-full">Closed</span>';
        } else if (closedStatus === 'On-Time') {
            statusBadge = '<span class="px-2 py-1 text-xs bg-blue-500/20 text-blue-400 rounded-full">On-Time</span>';
        } else if (closedStatus === 'Pre-Close') {
            statusBadge = '<span class="px-2 py-1 text-xs bg-yellow-500/20 text-yellow-400 rounded-full">Pre-Close</span>';
        } else if (closedStatus === 'Post-Close') {
            statusBadge = '<span class="px-2 py-1 text-xs bg-orange-500/20 text-orange-400 rounded-full">Post-Close</span>';
        } else if (closedStatus === 'Not Closed') {
            statusBadge = '<span class="px-2 py-1 text-xs bg-red-500/20 text-red-400 rounded-full">Not Closed</span>';
        } else {
            statusBadge = `<span class="px-2 py-1 text-xs bg-gray-500/20 text-gray-400 rounded-full">${closedStatus}</span>`;
        }
        
        row.innerHTML = `
            <td class="py-3 px-4 font-mono text-sm">${record.loan_no || '—'}</td>
            <td class="py-3 px-4 font-mono text-sm">${record.pan || '—'}</td>
            <td class="py-3 px-4 text-sm">${record.disbursal_date}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.loan_amount)}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.net_disbursal)}</td>
            <td class="py-3 px-4 text-right text-sm">${record.tenure || '—'}</td>
            <td class="py-3 px-4 text-sm">${record.repayment_date}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.repayment_amount)}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.processing_fee)}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.interest_amount)}</td>
            <td class="py-3 px-4 text-sm">${record.last_received_date}</td>
            <td class="py-3 px-4 text-right text-sm">${formatCurrency(record.total_received)}</td>
            <td class="py-3 px-4 text-sm">${statusBadge}</td>
        `;
        
        tbody.appendChild(row);
    });
}

function updateTotalAppsPagination(pagination) {
    const startRecord = (pagination.current_page - 1) * pagination.per_page + 1;
    const endRecord = Math.min(startRecord + pagination.per_page - 1, pagination.total_records);
    
    document.getElementById('totalAppsPaginationInfo').textContent = 
        `${startRecord}-${endRecord} of ${pagination.total_records}`;
    document.getElementById('totalAppsPageInfo').textContent = 
        `Page ${pagination.current_page} of ${pagination.total_pages}`;
    
    document.getElementById('totalAppsPrevBtn').disabled = !pagination.has_previous;
    document.getElementById('totalAppsNextBtn').disabled = !pagination.has_next;
}

function updateTotalAppsTotals(totals) {
    document.getElementById('totalAppsTotalLoanAmount').textContent = formatCurrency(totals.total_loan_amount);
    document.getElementById('totalAppsTotalNetDisbursal').textContent = formatCurrency(totals.total_net_disbursal);
    document.getElementById('totalAppsTotalRepaymentAmount').textContent = formatCurrency(totals.total_repayment_amount);
    document.getElementById('totalAppsTotalProcessingFee').textContent = formatCurrency(totals.total_processing_fee);
    document.getElementById('totalAppsTotalInterestAmount').textContent = formatCurrency(totals.total_interest_amount);
    document.getElementById('totalAppsTotalReceived').textContent = formatCurrency(totals.total_received);
}

function changeTotalAppsPage(direction) {
    if (!totalAppsDetailsData) return;
    
    const newPage = currentTotalAppsPage + direction;
    const maxPage = totalAppsDetailsData.pagination.total_pages;
    
    if (newPage >= 1 && newPage <= maxPage) {
        currentTotalAppsPage = newPage;
        loadTotalApplicationsDetails();
    }
}

function sortTotalAppsTable(column) {
    if (currentTotalAppsSort === column) {
        currentTotalAppsSortOrder = currentTotalAppsSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        currentTotalAppsSort = column;
        currentTotalAppsSortOrder = 'desc';
    }
    
    // Update sort indicators
    document.querySelectorAll('[id^="sort-"]').forEach(el => {
        el.textContent = '↕';
    });
    
    const sortIndicator = document.getElementById(`sort-${column}`);
    if (sortIndicator) {
        sortIndicator.textContent = currentTotalAppsSortOrder === 'asc' ? '↑' : '↓';
    }
    
    currentTotalAppsPage = 1;
    loadTotalApplicationsDetails();
}

async function exportTotalApplications() {
    try {
        // Determine which tab is active and get the appropriate form and API endpoint
        const activeTab = getCurrentActiveTab();
        let filterForm, apiEndpoint;
        
        if (activeTab === 'fraud') {
            filterForm = document.getElementById('fraudFilterForm');
            apiEndpoint = '/api/fraud/total-applications-details/';
        } else {
            filterForm = document.getElementById('filterForm');
            apiEndpoint = '/api/total-applications-details/';
        }
        
        const formData = new FormData(filterForm);
        
        const params = new URLSearchParams({
            per_page: 10000, // Large number to get all records
            sort_by: currentTotalAppsSort,
            sort_order: currentTotalAppsSortOrder,
            search: currentTotalAppsSearch
        });
        
        // Add current filter values
        for (const [key, value] of formData.entries()) {
            if (value && value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        // Add cache-busting parameter
        params.append('_t', Date.now());
        const response = await fetch(`${apiEndpoint}?${params}`);
        const data = await response.json();
        
        if (!data.records || data.records.length === 0) {
            alert('No data to export');
            return;
        }
        
        const headers = ['Loan No', 'PAN', 'Disbursal Date', 'Loan Amount', 'Net Disbursal', 'Tenure', 'Repayment Date', 'Repayment Amount', 'Processing Fee', 'Interest Amount', 'Last Received Date', 'Total Received', 'Closed Status'];
        const csvContent = [
            headers.join(','),
            ...data.records.map(record => [
                record.loan_no || '',
                record.pan || '',
                record.disbursal_date,
                record.loan_amount,
                record.net_disbursal,
                record.tenure || '',
                record.repayment_date,
                record.repayment_amount,
                record.processing_fee,
                record.interest_amount,
                record.last_received_date,
                record.total_received,
                record.closed_status || ''
            ].join(','))
        ].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `total-applications-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
    } catch (error) {
        console.error('Error exporting total applications:', error);
        alert('Error exporting data. Please try again.');
    }
}

// Restore filter section state from localStorage
function restoreFilterSectionState() {
    const isExpanded = localStorage.getItem('mainFiltersExpanded');
    const filterContent = document.getElementById('filterContent');
    const toggleIcon = document.getElementById('filterToggleIcon');
    
    if (filterContent && toggleIcon) {
        // Default to expanded if not set, or if explicitly set to true
        if (isExpanded === null || isExpanded === 'true') {
            filterContent.classList.remove('hidden');
            toggleIcon.style.transform = 'rotate(180deg)';
        } else {
            filterContent.classList.add('hidden');
            toggleIcon.style.transform = 'rotate(0deg)';
        }
    }
}

// Restore previously active tab from localStorage
function restoreActiveTab() {
    const savedTab = localStorage.getItem('activeTab');
    console.log('Restoring active tab from localStorage:', savedTab);
    
    if (savedTab) {
        // Check if the tab element exists
        const tabButton = document.getElementById(savedTab + 'Tab');
        const tabContent = document.getElementById(savedTab + 'Content');
        
        if (tabButton && tabContent) {
            // Switch to the saved tab
            switchTab(savedTab);
            console.log('Successfully restored tab:', savedTab);
        } else {
            console.log('Tab elements not found for:', savedTab, '- Using default tab');
            // Fall back to default tab (collection - which is the main dashboard)
            switchTab('collection');
        }
    } else {
        console.log('No saved tab found - Using default tab (collection)');
        // Default to collection tab (main dashboard)
        switchTab('collection');
    }
}

// Load charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Format all currency values
    formatAllCurrencyValues();
    
    // Restore filter section expanded/collapsed state
    restoreFilterSectionState();
    
    // Restore main dashboard filters from localStorage FIRST
    restoreMainFilters();
    
    // Setup auto-filter functionality AFTER restoring filters
    setupAutoFilters();
    
    // Ensure credit person tab has default date range
    setDefaultCreditPersonDates();
    
    // Ensure disbursal tab has default dates set to today
    // Use setTimeout to ensure DOM is fully loaded
    setTimeout(() => {
        // Initialize filter section as collapsed
        initializeDisbursalFilters();
        
        const todayStr = setDefaultDisbursalDates();
        // If disbursal tab is active, load data
        const activeTab = localStorage.getItem('activeTab') || 'collection';
        if (activeTab === 'disbursal') {
            setTimeout(() => {
                const startDateInput = document.getElementById('disbursalStartDate');
                const endDateInput = document.getElementById('disbursalEndDate');
                
                if (startDateInput && endDateInput) {
                    // Ensure dates are set
                    if (!startDateInput.value) {
                        startDateInput.value = todayStr;
                    }
                    if (!endDateInput.value) {
                        endDateInput.value = todayStr;
                    }
                    
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    if (startDate && endDate) {
                        loadDisbursalData();
                    }
                }
            }, 100);
        }
    }, 200);
    
    setupAutoRefresh(); // Enable auto-refresh every 10 seconds
    
    // Setup DPD search functionality
    const searchInput = document.getElementById('dpdSearchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentDPDSearch = this.value;
                currentDPDPage = 1;
                loadDPDDetails();
            }, 300);
        });
    }
    
    // Setup Total Applications search functionality
    const totalAppsSearchInput = document.getElementById('totalAppsSearchInput');
    if (totalAppsSearchInput) {
        let totalAppsSearchTimeout;
        totalAppsSearchInput.addEventListener('input', function() {
            clearTimeout(totalAppsSearchTimeout);
            totalAppsSearchTimeout = setTimeout(() => {
                currentTotalAppsSearch = this.value;
                currentTotalAppsPage = 1;
                loadTotalApplicationsDetails();
            }, 300);
        });
    }
    
    // Restore previously active tab from localStorage
    restoreActiveTab();
    
    // Get the active tab after restoration
    const activeTab = localStorage.getItem('activeTab') || 'collection';
    
    loadDPDBucketData();
    loadStateRepaymentChart();
    loadStatePendingChart();
    loadTimeSeriesChart();
    loadTopCitiesCollectionChart();
    
    // Only load pending cases chart if collection tab is active
    if (activeTab === 'collection') {
        loadPendingCasesByAmountChart();
    }
});

// Debug function to test URL parameter preservation
function testUrlPreservation() {
    const currentUrl = new URL(window.location);
    const currentParams = currentUrl.searchParams;
    
    console.log('=== URL Parameter Test ===');
    console.log('Current URL:', window.location.href);
    console.log('Current Parameters:', Object.fromEntries(currentParams.entries()));
    
    const newUrl = new URL(window.location.origin + window.location.pathname);
    for (const [key, value] of currentParams.entries()) {
        if (value) {
            newUrl.searchParams.set(key, value);
        }
    }
    
    console.log('New URL would be:', newUrl.toString());
    console.log('Parameters preserved:', Object.fromEntries(newUrl.searchParams.entries()));
    console.log('========================');
}

// Make test function available globally
window.testUrlPreservation = testUrlPreservation;

// Utility Functions
function formatCurrency(amount) {
    if (amount === null || amount === undefined || isNaN(amount)) {
        return '₹0';
    }
    
    // Convert to number if it's a string
    const numAmount = parseFloat(amount);
    
    // Format with Indian number system (lakhs, crores)
    if (numAmount >= 10000000) { // 1 crore
        return '₹' + (numAmount / 10000000).toFixed(1) + ' Cr';
    } else if (numAmount >= 100000) { // 1 lakh
        return '₹' + (numAmount / 100000).toFixed(1) + ' L';
    } else if (numAmount >= 1000) { // 1 thousand
        return '₹' + (numAmount / 1000).toFixed(1) + ' K';
    } else {
        return '₹' + numAmount.toLocaleString('en-IN');
    }
}

// Function to format number with commas (Indian numbering system)
// Indian numbering: last 3 digits, then groups of 2 digits
// Example: 120000000 -> 12,00,00,000
function formatNumberWithCommas(num) {
    if (!num && num !== 0) return '';
    const numStr = num.toString().replace(/,/g, '');
    const parts = numStr.split('.');
    let integerPart = parts[0];
    
    // Indian numbering system: last 3 digits, then groups of 2 digits
    if (integerPart.length <= 3) {
        return integerPart;
    }
    
    // Reverse to work from right to left
    const reversed = integerPart.split('').reverse().join('');
    
    // Take first 3 digits (last 3 in original)
    const lastThree = reversed.substring(0, 3);
    
    // Take remaining and group in pairs of 2
    const remaining = reversed.substring(3);
    const groups = [];
    for (let i = 0; i < remaining.length; i += 2) {
        const group = remaining.substring(i, Math.min(i + 2, remaining.length));
        if (group) groups.push(group);
    }
    
    // Reverse the groups array (to get correct order) and reverse each group's digits
    const reversedGroups = groups.reverse().map(g => g.split('').reverse().join(''));
    
    // Combine: reversed groups + comma + last three (reversed)
    const formattedRemaining = reversedGroups.join(',');
    const reversedLastThree = lastThree.split('').reverse().join('');
    
    parts[0] = formattedRemaining + (formattedRemaining ? ',' : '') + reversedLastThree;
    
    return parts.join('.');
}

// Function to remove commas and convert to number
function removeCommas(str) {
    return str.toString().replace(/,/g, '');
}

// ===============================
// DAILY PERFORMANCE METRICS TAB FUNCTIONALITY
// ===============================

async function loadDailyPerformanceData(silentRefresh = false) {
    try {
        console.log('Loading daily performance metrics data...');
        
        // Show loading state only on initial load, not during auto-refresh
        const loadingEl = document.getElementById('dailyPerformanceLoading');
        const mainContentEl = document.getElementById('dailyPerformanceMainContent');
        if (!silentRefresh) {
            if (loadingEl) loadingEl.classList.remove('hidden');
            if (mainContentEl) mainContentEl.classList.add('hidden');
        }
        
        // Fetch data from API
        const response = await fetch('/api/daily-performance-metrics/');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Store data globally for Excel export
        window.dailyPerformanceData = data;
        
        console.log('Daily performance data received:', data);
        
        // Hide loading state and show main content (only if we showed it)
        if (!silentRefresh) {
            if (loadingEl) loadingEl.classList.add('hidden');
            if (mainContentEl) mainContentEl.classList.remove('hidden');
        }
        
        // Update position date
        if (data.position_as_on) {
            document.getElementById('positionDate').textContent = data.position_as_on;
        }
        
        // Update Sanction Performance section
        if (data.sanction_performance) {
            const sp = data.sanction_performance;
            console.log('Sanction Performance Data:', sp);
            
            const monthlyTargetInput = document.getElementById('monthlyTargetInput');
            if (monthlyTargetInput) {
                // Format with commas for display (default to 12,00,00,000 if no value)
                const targetValue = sp.monthly_target || 120000000;
                const formattedValue = formatNumberWithCommas(targetValue);
                monthlyTargetInput.value = formattedValue;
            }
            
            // Update Today's Disbursement
            const todayDisbursementValue = sp.today_disbursement || 0;
            console.log('Today\'s Disbursement Value:', todayDisbursementValue);
            const todayDisbursementEl = document.getElementById('todayDisbursement');
            if (todayDisbursementEl) {
                todayDisbursementEl.textContent = formatCurrency(todayDisbursementValue);
            } else {
                console.error('todayDisbursement element not found');
            }
            document.getElementById('totalAchieved').textContent = formatCurrency(sp.total_achieved || 0);
            document.getElementById('achievementPercentage').textContent = (sp.achievement_percentage || 0).toFixed(2);
            document.getElementById('yetToAchieve').textContent = formatCurrency(sp.yet_to_achieve || 0);
            document.getElementById('yetToAchievePercentage').textContent = (sp.yet_to_achieve_percentage || 0).toFixed(2);
            document.getElementById('daysCompleted').textContent = sp.days_completed || 0;
            document.getElementById('remainingDays').textContent = sp.remaining_days || 0;
            document.getElementById('currentDailyPerformance').textContent = formatCurrency(sp.current_daily_performance || 0);
            document.getElementById('requiredDailyPerformance').textContent = formatCurrency(sp.required_daily_performance || 0);
        }
        
        // Update Collection Efficiency section
        if (data.collection_efficiency) {
            const ce = data.collection_efficiency;
            const efficiencyElement = document.getElementById('currentCollectionEfficiency');
            if (efficiencyElement) {
                efficiencyElement.textContent = (ce.current_month_efficiency || 0).toFixed(2) + '%';
                // Color code based on performance
                const efficiency = ce.current_month_efficiency || 0;
                efficiencyElement.className = 'text-white font-semibold px-3 py-1 rounded ' + 
                    (efficiency >= ce.benchmark_efficiency ? 'bg-green-600' : 
                     efficiency >= ce.benchmark_efficiency * 0.8 ? 'bg-yellow-600' : 'bg-red-600');
            }
            document.getElementById('benchmarkEfficiency').textContent = (ce.benchmark_efficiency || 0).toFixed(0);
        }
        
        // Update Historical Collection Efficiency table
        if (data.historical_collection_efficiency && Array.isArray(data.historical_collection_efficiency)) {
            const tbody = document.getElementById('historicalDataTable');
            if (tbody) {
                tbody.innerHTML = '';
                
                data.historical_collection_efficiency.forEach(item => {
                    const actual = item.actual || 0;
                    const benchmark = item.benchmark || 0;
                    
                    // Color code based on performance (same logic as current month)
                    // Green: actual >= benchmark
                    // Yellow: actual >= benchmark * 0.8 (near benchmark)
                    // Red: actual < benchmark * 0.8
                    let actualColorClass = '';
                    if (actual >= benchmark) {
                        actualColorClass = 'bg-green-600';
                    } else if (actual >= benchmark * 0.8) {
                        actualColorClass = 'bg-yellow-600';
                    } else {
                        actualColorClass = 'bg-red-600';
                    }
                    
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700';
                    row.innerHTML = `
                        <td class="py-3 px-4 text-gray-300">${item.month || '--'}</td>
                        <td class="py-3 px-4 text-right">
                            <span class="text-white font-semibold px-3 py-1 rounded ${actualColorClass}">${actual.toFixed(2)}%</span>
                        </td>
                        <td class="py-3 px-4 text-right text-gray-300">${benchmark.toFixed(0)}%</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
        
        console.log('Daily performance metrics data loaded successfully');
        
        // Store data globally for export
        window.dailyPerformanceData = data;
        
    } catch (error) {
        console.error('Error loading daily performance data:', error);
        const loadingEl = document.getElementById('dailyPerformanceLoading');
        const mainContentEl = document.getElementById('dailyPerformanceMainContent');
        if (loadingEl) loadingEl.classList.add('hidden');
        if (mainContentEl) mainContentEl.classList.remove('hidden');
        // Show error message
        alert('Failed to load daily performance metrics. Please try again.');
    }
}

// Function to export Performance Report to Excel with styling
async function exportPerformanceReport() {
    try {
        // Check if ExcelJS is loaded, if not load it
        if (typeof ExcelJS === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js';
            script.onload = () => exportPerformanceReport();
            document.head.appendChild(script);
            return;
        }
        
        // Get current data from stored global variable or fetch fresh
        let data = window.dailyPerformanceData;
        if (!data) {
            const response = await fetch('/api/daily-performance-metrics/');
            if (!response.ok) throw new Error('Failed to fetch data');
            data = await response.json();
        }
        
        // Get current date for report
        const today = new Date();
        const reportDate = today.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        // Position as on should be today's date
        const positionDate = today.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        
        // Create workbook
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Performance Report');
        
        // Define border style for all cells
        const borderStyle = {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } }
        };
        
        let rowIndex = 1;
        
        // Helper function to apply borders to a cell
        function applyBorders(cell) {
            cell.border = borderStyle;
            return cell;
        }
        
        // Helper function to get cell with borders
        function getCell(row, col) {
            return applyBorders(worksheet.getCell(row, col));
        }
        
        // Report Header - Bold, larger font, merged cells (A, B, C)
        worksheet.mergeCells(rowIndex, 1, rowIndex, 3);
        const titleCell = worksheet.getCell(rowIndex, 1);
        titleCell.value = 'Performance Report - BlinkR Loan';
        titleCell.font = { bold: true, size: 14 };
        titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
        titleCell.border = borderStyle;
        rowIndex += 2;
        
        // Empty row with borders (rowIndex - 1)
        const emptyTitleRow = rowIndex - 1;
        applyBorders(worksheet.getCell(emptyTitleRow, 1));
        applyBorders(worksheet.getCell(emptyTitleRow, 2));
        applyBorders(worksheet.getCell(emptyTitleRow, 3));
        
        // Report Date
        const dateLabelCell = getCell(rowIndex, 1);
        dateLabelCell.value = 'Report Date:';
        dateLabelCell.font = { bold: false };
        dateLabelCell.alignment = { horizontal: 'left', vertical: 'middle' };
        
        const dateValueCell = getCell(rowIndex, 2);
        dateValueCell.value = reportDate;
        dateValueCell.font = { bold: false };
        dateValueCell.alignment = { horizontal: 'center', vertical: 'middle' };
        rowIndex++;
        
        // Position as on
        const posLabelCell = getCell(rowIndex, 1);
        posLabelCell.value = 'Position as on:';
        posLabelCell.font = { bold: false };
        posLabelCell.alignment = { horizontal: 'left', vertical: 'middle' };
        
        const posValueCell = getCell(rowIndex, 2);
        posValueCell.value = positionDate;
        posValueCell.font = { bold: false };
        posValueCell.alignment = { horizontal: 'center', vertical: 'middle' };
        rowIndex += 2;
        
        // Empty row with borders (rowIndex - 1)
        const emptyRow1 = rowIndex - 1;
        applyBorders(worksheet.getCell(emptyRow1, 1));
        applyBorders(worksheet.getCell(emptyRow1, 2));
        
        // Sanction Performance Section Header - Bold with light green background, merged A-C
        worksheet.mergeCells(rowIndex, 1, rowIndex, 3);
        const spHeader = worksheet.getCell(rowIndex, 1);
        spHeader.value = 'Sanction Performance';
        spHeader.font = { bold: true, size: 12 };
        spHeader.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE8F5E9' } // Light green
        };
        spHeader.alignment = { horizontal: 'center', vertical: 'middle' };
        spHeader.border = borderStyle;
        rowIndex += 2;
        
        // Empty row with borders (rowIndex - 1)
        const emptySPRow = rowIndex - 1;
        applyBorders(worksheet.getCell(emptySPRow, 1));
        applyBorders(worksheet.getCell(emptySPRow, 2));
        applyBorders(worksheet.getCell(emptySPRow, 3));
        
        // Sanction Performance Metrics
        if (data.sanction_performance) {
            const sp = data.sanction_performance;
            const metrics = [
                ['Target of Sanction for the current Month:', '₹ ' + formatCurrencyForExcel(sp.monthly_target || 0), null],
                ['Today\'s Disbursement:', '₹ ' + formatCurrencyForExcel(sp.today_disbursement || 0), null],
                ['Figures Achieved (till today):', '₹ ' + formatCurrencyForExcel(sp.total_achieved || 0), null],
                ['Achievement %:', (sp.achievement_percentage || 0).toFixed(0) + '%', null],
                ['Yet to be Achieved:', '₹ ' + formatCurrencyForExcel(sp.yet_to_achieve || 0), 'green'], // Green highlight
                ['Yet to be Achieved %:', (sp.yet_to_achieve_percentage || 0).toFixed(0) + '%', null],
                ['Days Completed:', sp.days_completed || 0, null],
                ['Remaining Days:', sp.remaining_days || 0, null],
                ['Current Daily Performance:', '₹ ' + formatCurrencyForExcel(Math.round(sp.current_daily_performance || 0)), 'red'], // Red highlight - rounded to whole number
                ['Required Daily Performance:', '₹ ' + formatCurrencyForExcel(Math.round(sp.required_daily_performance || 0)), 'red'] // Red highlight - rounded to whole number
            ];
            
            metrics.forEach(([label, value, color]) => {
                const labelCell = getCell(rowIndex, 1);
                labelCell.value = label;
                labelCell.alignment = { horizontal: 'left', vertical: 'middle' };
                labelCell.font = { bold: false };
                
                const valueCell = getCell(rowIndex, 2);
                valueCell.value = value;
                valueCell.alignment = { horizontal: 'center', vertical: 'middle' };
                valueCell.font = { bold: false };
                
                if (color === 'green') {
                    valueCell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFC8E6C9' } // Light green
                    };
                } else if (color === 'red') {
                    valueCell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFFFCDD2' } // Light red
                    };
                }
                
                rowIndex++;
            });
            rowIndex += 1;
            
            // Empty row with borders (rowIndex - 1)
            const emptySPDataRow = rowIndex - 1;
            applyBorders(worksheet.getCell(emptySPDataRow, 1));
            applyBorders(worksheet.getCell(emptySPDataRow, 2));
        }
        
        // Collection Efficiency Section Header - Bold with light green background, merged A-C
        worksheet.mergeCells(rowIndex, 1, rowIndex, 3);
        const ceHeader = worksheet.getCell(rowIndex, 1);
        ceHeader.value = 'Collection Efficiency';
        ceHeader.font = { bold: true, size: 12 };
        ceHeader.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE8F5E9' } // Light green
        };
        ceHeader.alignment = { horizontal: 'center', vertical: 'middle' };
        ceHeader.border = borderStyle;
        rowIndex += 2;
        
        // Empty row with borders (rowIndex - 1)
        const emptyCERow = rowIndex - 1;
        applyBorders(worksheet.getCell(emptyCERow, 1));
        applyBorders(worksheet.getCell(emptyCERow, 2));
        applyBorders(worksheet.getCell(emptyCERow, 3));
        
        // Collection Efficiency Metrics
        if (data.collection_efficiency) {
            const ce = data.collection_efficiency;
            const efficiency = ce.current_month_efficiency || 0;
            const benchmark = ce.benchmark_efficiency || 0;
            
            const effLabelCell = getCell(rowIndex, 1);
            effLabelCell.value = 'Collection Efficiency (Current Month):';
            effLabelCell.alignment = { horizontal: 'left', vertical: 'middle' };
            effLabelCell.font = { bold: false };
            
            const efficiencyCell = getCell(rowIndex, 2);
            efficiencyCell.value = efficiency.toFixed(0) + '%'; // Show as integer like in screenshot
            efficiencyCell.alignment = { horizontal: 'center', vertical: 'middle' };
            efficiencyCell.font = { bold: false };
            // Red if below benchmark
            efficiencyCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: efficiency < benchmark ? 'FFFFCDD2' : 'FFC8E6C9' }
            };
            rowIndex++;
            
            const benchLabelCell = getCell(rowIndex, 1);
            benchLabelCell.value = 'Benchmark Collection Efficiency (till 25th of month):';
            benchLabelCell.alignment = { horizontal: 'left', vertical: 'middle' };
            benchLabelCell.font = { bold: false };
            
            const benchmarkCell = getCell(rowIndex, 2);
            benchmarkCell.value = benchmark.toFixed(0) + '%';
            benchmarkCell.alignment = { horizontal: 'center', vertical: 'middle' };
            benchmarkCell.font = { bold: false };
            rowIndex += 2;
            
            // Empty row with borders (rowIndex - 1)
            const emptyCEDataRow = rowIndex - 1;
            applyBorders(worksheet.getCell(emptyCEDataRow, 1));
            applyBorders(worksheet.getCell(emptyCEDataRow, 2));
        }
        
        // Historical Collection Efficiency Section Header - Bold with light green background, merged A-C
        worksheet.mergeCells(rowIndex, 1, rowIndex, 3);
        const histHeader = worksheet.getCell(rowIndex, 1);
        histHeader.value = 'Historical Collection Efficiency';
        histHeader.font = { bold: true, size: 12 };
        histHeader.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE8F5E9' } // Light green
        };
        histHeader.alignment = { horizontal: 'center', vertical: 'middle' };
        histHeader.border = borderStyle;
        rowIndex += 2;
        
        // Empty row with borders (rowIndex - 1)
        const emptyHistRow = rowIndex - 1;
        applyBorders(worksheet.getCell(emptyHistRow, 1));
        applyBorders(worksheet.getCell(emptyHistRow, 2));
        applyBorders(worksheet.getCell(emptyHistRow, 3));
        
        // Historical Collection Efficiency Table Headers - Bold with light green background
        const headerFill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFE8F5E9' }
        };
        
        const monthHeader = getCell(rowIndex, 1);
        monthHeader.value = 'Month';
        monthHeader.font = { bold: true };
        monthHeader.fill = headerFill;
        monthHeader.alignment = { horizontal: 'left', vertical: 'middle' };
        
        const actualHeader = getCell(rowIndex, 2);
        actualHeader.value = 'Actual';
        actualHeader.font = { bold: true };
        actualHeader.fill = headerFill;
        actualHeader.alignment = { horizontal: 'center', vertical: 'middle' };
        
        const benchmarkHeader = getCell(rowIndex, 3);
        benchmarkHeader.value = 'Benchmark';
        benchmarkHeader.font = { bold: true };
        benchmarkHeader.fill = headerFill;
        benchmarkHeader.alignment = { horizontal: 'center', vertical: 'middle' };
        rowIndex++;
        
        // Historical Collection Efficiency Data
        if (data.historical_collection_efficiency && Array.isArray(data.historical_collection_efficiency)) {
            data.historical_collection_efficiency.forEach(item => {
                const actual = item.actual || 0;
                const benchmark = item.benchmark || 0;
                
                const monthCell = getCell(rowIndex, 1);
                monthCell.value = item.month || '--';
                monthCell.alignment = { horizontal: 'left', vertical: 'middle' };
                monthCell.font = { bold: false };
                
                const actualCell = getCell(rowIndex, 2);
                actualCell.value = actual.toFixed(0) + '%'; // Show as integer like in screenshot
                actualCell.alignment = { horizontal: 'center', vertical: 'middle' };
                actualCell.font = { bold: false };
                
                // Green if actual >= benchmark, yellow if 80-100%, red if below 80%
                let bgColor = 'FFC8E6C9'; // Green
                if (actual < benchmark * 0.8) {
                    bgColor = 'FFFFCDD2'; // Red
                } else if (actual < benchmark) {
                    bgColor = 'FFFFF9C4'; // Yellow
                }
                
                actualCell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: bgColor }
                };
                
                const benchmarkCell = getCell(rowIndex, 3);
                benchmarkCell.value = benchmark.toFixed(0) + '%';
                benchmarkCell.alignment = { horizontal: 'center', vertical: 'middle' };
                benchmarkCell.font = { bold: false };
                
                rowIndex++;
            });
        }
        
        // Merge columns B and C for rows 2 to 23 and center align values
        for (let row = 2; row <= 23; row++) {
            try {
                worksheet.mergeCells(row, 2, row, 3);
                // Apply borders and center alignment to merged cell
                const mergedCell = worksheet.getCell(row, 2);
                mergedCell.border = borderStyle;
                // Ensure center alignment for merged cells
                if (mergedCell.value !== null && mergedCell.value !== undefined && mergedCell.value !== '') {
                    mergedCell.alignment = { horizontal: 'center', vertical: 'middle' };
                }
            } catch (e) {
                // If merge fails (cell already merged), skip
                console.log(`Row ${row} merge skipped:`, e.message);
            }
        }
        
        // Set column widths
        worksheet.getColumn(1).width = 45;
        worksheet.getColumn(2).width = 30;
        worksheet.getColumn(3).width = 15;
        
        // Set row heights for better appearance
        worksheet.getRow(1).height = 25;
        
        // Generate filename with current date
        const filename = `Performance_Report_BlinkR_Loan_${today.toISOString().split('T')[0]}.xlsx`;
        
        // Write file
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        console.log('Performance Report exported successfully');
        
    } catch (error) {
        console.error('Error exporting performance report:', error);
        alert('Failed to export performance report. Please try again.');
    }
}

// Helper function to format currency for Excel (with ₹ symbol and commas)
function formatCurrencyForExcel(amount) {
    if (!amount && amount !== 0) return '0';
    const numStr = amount.toString().replace(/,/g, '');
    const num = parseFloat(numStr);
    return formatNumberWithCommas(num);
}

// Function to export AUM Report to Excel with styling matching the image format
async function exportAumReport() {
    try {
        console.log('Export AUM Report function called');
        
        // Check if ExcelJS is loaded, if not load it
        if (typeof ExcelJS === 'undefined') {
            console.log('ExcelJS not loaded, loading it now...');
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js';
            script.onload = () => {
                console.log('ExcelJS loaded, retrying export...');
                exportAumReport();
            };
            script.onerror = () => {
                console.error('Failed to load ExcelJS');
                alert('Failed to load Excel library. Please check your internet connection.');
            };
            document.head.appendChild(script);
            return;
        }
        
        console.log('ExcelJS is available');
        
        // Get current data from stored global variable or fetch fresh
        let data = window.aumReportData;
        console.log('Current AUM data:', data);
        
        if (!data || !data.monthly_data || data.monthly_data.length === 0) {
            console.log('No data in memory, fetching from API...');
            const response = await fetch('/api/aum-report/');
            if (!response.ok) {
                throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
            }
            const responseData = await response.json();
            console.log('Fetched data:', responseData);
            data = {
                monthly_data: responseData.monthly_data || [],
                total_data: responseData.total_data || null
            };
        }
        
        if (!data.monthly_data || data.monthly_data.length === 0) {
            alert('No data to export');
            return;
        }
        
        console.log('Starting Excel generation with', data.monthly_data.length, 'months of data');
        
        // Create workbook
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('AUM Report');
        
        // Helper function to format month label
        function getMonthLabel(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const month = date.toLocaleDateString('en-US', { month: 'short' });
            const year = date.getFullYear().toString().slice(-2);
            return `${month}-${year}`;
        }
        
        // Helper function to format numbers
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(parseFloat(num))) return '';
            const floatNum = parseFloat(num);
            if (floatNum === 0) return '0';
            return floatNum.toLocaleString('en-IN', { maximumFractionDigits: 0 });
        }
        
        // Helper function to format percentages
        function formatPercent(value) {
            if (value === null || value === undefined || isNaN(parseFloat(value))) return '';
            return parseFloat(value).toFixed(2) + '%';
        }
        
        // Define colors
        const headerBlue = { argb: 'FF1E3A5F' }; // Dark blue for headers
        const yellowBg = { argb: 'FFFFFFD4' }; // Yellow background
        const yellowText = { argb: 'FF856404' }; // Dark yellow text
        const whiteBg = { argb: 'FFFFFFFF' }; // White background
        const darkText = { argb: 'FF000000' }; // Black text
        const lightGrayBg = { argb: 'FFF5F5F5' }; // Light gray for alternating columns
        
        // Set column widths
        worksheet.getColumn(1).width = 35; // Category column
        
        // Create header row with "Aum Report" title
        const titleRow = worksheet.addRow(['Aum Report']);
        titleRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FFFFFFFF' } };
        titleRow.getCell(1).fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: headerBlue
        };
        titleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
        worksheet.mergeCells(1, 1, 1, 1 + (data.monthly_data.length * 2));
        titleRow.height = 30;
        
        // Add empty row
        worksheet.addRow([]);
        
        // Create main header row with months
        const headerRow = worksheet.addRow(['']);
        headerRow.getCell(1).value = '';
        headerRow.getCell(1).fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: headerBlue
        };
        headerRow.getCell(1).font = { bold: true, size: 11, color: { argb: 'FFFFFFFF' } };
        headerRow.getCell(1).alignment = { horizontal: 'left', vertical: 'middle' };
        headerRow.getCell(1).border = {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } }
        };
        
        let colIndex = 2;
        data.monthly_data.forEach((item, index) => {
            const monthLabel = getMonthLabel(item.month);
            const isLast = index === data.monthly_data.length - 1;
            
            // Merge cells for month header
            worksheet.mergeCells(3, colIndex, 3, colIndex + 1);
            const monthCell = headerRow.getCell(colIndex);
            monthCell.value = monthLabel;
            monthCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: headerBlue
            };
            monthCell.font = { bold: true, size: 11, color: { argb: 'FFFFFFFF' } };
            monthCell.alignment = { horizontal: 'center', vertical: 'middle' };
            monthCell.border = {
                top: { style: 'thin', color: { argb: 'FF000000' } },
                bottom: { style: 'thin', color: { argb: 'FF000000' } },
                left: { style: 'thin', color: { argb: 'FF000000' } },
                right: { style: isLast ? 'thin' : 'none', color: { argb: 'FF000000' } }
            };
            
            colIndex += 2;
        });
        
        headerRow.height = 25;
        
        // Create sub-header row for Units/Sum
        const subHeaderRow = worksheet.addRow(['']);
        subHeaderRow.getCell(1).value = '';
        subHeaderRow.getCell(1).fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FF4A5568' }
        };
        subHeaderRow.getCell(1).font = { bold: true, size: 10, color: { argb: 'FFE2E8F0' } };
        subHeaderRow.getCell(1).alignment = { horizontal: 'left', vertical: 'middle' };
        subHeaderRow.getCell(1).border = {
            top: { style: 'thin', color: { argb: 'FF000000' } },
            bottom: { style: 'thin', color: { argb: 'FF000000' } },
            left: { style: 'thin', color: { argb: 'FF000000' } },
            right: { style: 'thin', color: { argb: 'FF000000' } }
        };
        
        colIndex = 2;
        data.monthly_data.forEach((item, index) => {
            const isLast = index === data.monthly_data.length - 1;
            const colBg = index % 2 === 0 ? { argb: 'FF4A5568' } : { argb: 'FF2D3748' };
            
            // Units column
            const unitsCell = subHeaderRow.getCell(colIndex);
            unitsCell.value = 'Units';
            unitsCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: colBg
            };
            unitsCell.font = { bold: true, size: 10, color: { argb: 'FFE2E8F0' } };
            unitsCell.alignment = { horizontal: 'center', vertical: 'middle' };
            unitsCell.border = {
                top: { style: 'thin', color: { argb: 'FF000000' } },
                bottom: { style: 'thin', color: { argb: 'FF000000' } },
                left: { style: 'thin', color: { argb: 'FF000000' } },
                right: { style: 'thin', color: { argb: 'FF000000' } }
            };
            
            // Sum column
            const sumCell = subHeaderRow.getCell(colIndex + 1);
            sumCell.value = 'Sum';
            sumCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: colBg
            };
            sumCell.font = { bold: true, size: 10, color: { argb: 'FFE2E8F0' } };
            sumCell.alignment = { horizontal: 'center', vertical: 'middle' };
            sumCell.border = {
                top: { style: 'thin', color: { argb: 'FF000000' } },
                bottom: { style: 'thin', color: { argb: 'FF000000' } },
                left: { style: 'thin', color: { argb: 'FF000000' } },
                right: { style: isLast ? 'thin' : 'none', color: { argb: 'FF000000' } }
            };
            
            colIndex += 2;
        });
        
        subHeaderRow.height = 20;
        
        // Helper function to create a data row
        function addDataRow(categoryLabel, isBold = false, isIndented = false, isYellow = false, isTotal = false) {
            const row = worksheet.addRow(['']);
            const categoryCell = row.getCell(1);
            categoryCell.value = categoryLabel;
            categoryCell.font = {
                bold: isBold,
                size: isTotal ? 12 : 11,
                color: isYellow ? yellowText : darkText
            };
            categoryCell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: isYellow ? yellowBg : whiteBg
            };
            categoryCell.alignment = { 
                horizontal: isIndented ? 'left' : 'left', 
                vertical: 'middle',
                indent: isIndented ? 1 : 0
            };
            categoryCell.border = {
                top: { style: 'thin', color: { argb: 'FF000000' } },
                bottom: { style: 'thin', color: { argb: 'FF000000' } },
                left: { style: 'thin', color: { argb: 'FF000000' } },
                right: { style: 'thin', color: { argb: 'FF000000' } }
            };
            
            return row;
        }
        
        // Helper function to add data cells
        function addDataCells(row, getValue, isYellow = false, isTotal = false, formatter = formatNumber) {
            let colIndex = 2;
            data.monthly_data.forEach((item, index) => {
                const isLast = index === data.monthly_data.length - 1;
                const colBg = index % 2 === 0 ? whiteBg : lightGrayBg;
                const cellBg = isYellow ? yellowBg : colBg;
                
                const value = getValue(item);
                if (Array.isArray(value)) {
                    // Two values (Units and Sum)
                    const unitsCell = row.getCell(colIndex);
                    unitsCell.value = formatter(value[0]);
                    unitsCell.font = {
                        bold: isTotal,
                        size: isTotal ? 12 : 11,
                        color: isYellow ? yellowText : darkText
                    };
                    unitsCell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: cellBg
                    };
                    unitsCell.alignment = { horizontal: 'center', vertical: 'middle' };
                    unitsCell.border = {
                        top: { style: 'thin', color: { argb: 'FF000000' } },
                        bottom: { style: 'thin', color: { argb: 'FF000000' } },
                        left: { style: 'thin', color: { argb: 'FF000000' } },
                        right: { style: 'thin', color: { argb: 'FF000000' } }
                    };
                    
                    const sumCell = row.getCell(colIndex + 1);
                    sumCell.value = formatter(value[1]);
                    sumCell.font = {
                        bold: isTotal,
                        size: isTotal ? 12 : 11,
                        color: isYellow ? yellowText : darkText
                    };
                    sumCell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: cellBg
                    };
                    sumCell.alignment = { horizontal: 'center', vertical: 'middle' };
                    sumCell.border = {
                        top: { style: 'thin', color: { argb: 'FF000000' } },
                        bottom: { style: 'thin', color: { argb: 'FF000000' } },
                        left: { style: 'thin', color: { argb: 'FF000000' } },
                        right: { style: isLast ? 'thin' : 'none', color: { argb: 'FF000000' } }
                    };
                } else {
                    // Single value (spans two columns)
                    worksheet.mergeCells(row.number, colIndex, row.number, colIndex + 1);
                    const cell = row.getCell(colIndex);
                    cell.value = formatter(value);
                    cell.font = {
                        bold: isTotal,
                        size: isTotal ? 12 : 11,
                        color: isYellow ? yellowText : darkText
                    };
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: cellBg
                    };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FF000000' } },
                        bottom: { style: 'thin', color: { argb: 'FF000000' } },
                        left: { style: 'thin', color: { argb: 'FF000000' } },
                        right: { style: isLast ? 'thin' : 'none', color: { argb: 'FF000000' } }
                    };
                }
                
                colIndex += 2;
            });
        }
        
        // STPL (SHORT TERM PERSONAL LOAN) - Loan Disbursed - NEW
        let row = addDataRow('STPL (SHORT TERM PERSONAL LOAN)', true, false, false, false);
        addDataCells(row, (item) => [item.new_units || 0, item.new_sum || 0]);
        
        // STPL (SHORT TERM PERSONAL LOAN) - Loan Disbursed - REPEAT
        row = addDataRow('Loan Disbursed - REPEAT', false, true, false, false);
        addDataCells(row, (item) => [item.repeat_units || 0, item.repeat_sum || 0]);
        
        // STPL (SHORT TERM PERSONAL LOAN) - Loan Disbursed - Total
        row = addDataRow('Loan Disbursed - Total', true, true, false, false);
        addDataCells(row, (item) => [item.total_units || 0, item.total_sum || 0]);
        
        // ATS
        row = addDataRow('ATS', true, false, false, false);
        addDataCells(row, (item) => item.ats || 0, false, false, formatNumber);
        
        // Running Cases (main category for overdue cases)
        row = addDataRow('Running Cases', true, false, false, false);
        addDataCells(row, (item) => [item.running_units || 0, item.running_sum || 0]);
        
        // Over Due +1-30 Day
        row = addDataRow('Over Due +1-30 Day', false, true, false, false);
        addDataCells(row, (item) => [item.od_1_30_units || 0, item.od_1_30_sum || 0]);
        
        // Over Due +31-90 Day
        row = addDataRow('Over Due +31-90 Day', false, true, false, false);
        addDataCells(row, (item) => [item.od_31_90_units || 0, item.od_31_90_sum || 0]);
        
        // Over Due 90+ Day
        row = addDataRow('Over Due 90+ Day', false, true, false, false);
        addDataCells(row, (item) => [item.od_90p_units || 0, item.od_90p_sum || 0]);
        
        // Loan Book(AUM) - Yellow highlighted
        row = addDataRow('Loan Book(AUM)', true, false, true, false);
        addDataCells(row, (item) => {
            const aumUnits = item.running_units || 0;
            const aumSum = item.aum_sum || item.running_sum || 0;
            return [aumUnits, aumSum];
        }, true);
        
        // 1+DPD% (main category for DPD Percentages)
        row = addDataRow('1+DPD%', true, false, false, false);
        addDataCells(row, (item) => item.dpd_1_30_count_percent || 0, false, false, formatPercent);
        
        // 30+DPD%
        row = addDataRow('30+DPD%', false, true, false, false);
        addDataCells(row, (item) => item.dpd_31_90_count_percent || 0, false, false, formatPercent);
        
        // 90+DPD%
        row = addDataRow('90+DPD%', false, true, false, false);
        addDataCells(row, (item) => item.dpd_90p_count_percent || 0, false, false, formatPercent);
        
        // Income/Financials - PF Income (Incl. GST)
        row = addDataRow('PF Income (Incl. GST)', true, false, false, false);
        addDataCells(row, (item) => item.total_pf || 0, false, false, formatNumber);
        
        // Interest Income
        row = addDataRow('Interest Income', false, true, false, false);
        addDataCells(row, (item) => item.interest_amount || 0, false, false, formatNumber);
        
        // Avg PF (Incl. GST)
        row = addDataRow('Avg PF (Incl. GST)', false, true, false, false);
        addDataCells(row, (item) => item.avg_pf || 0, false, false, formatNumber);
        
        // Avg ROI
        row = addDataRow('Avg ROI', false, true, false, false);
        addDataCells(row, (item) => item.avg_roi || 0, false, false, formatPercent);
        
        // Avg Tenure
        row = addDataRow('Avg Tenure', false, true, false, false);
        addDataCells(row, (item) => item.avg_tenure || 0, false, false, formatNumber);
        
        // Total Loan Book Aum - Yellow highlighted (spans all columns)
        if (data.total_data) {
            // Check for aum_sum first, then running_sum as fallback
            const totalValue = data.total_data.aum_sum || data.total_data.running_sum || null;
            if (totalValue !== null && totalValue !== undefined) {
                row = worksheet.addRow(['']);
                const categoryCell = row.getCell(1);
                categoryCell.value = 'Total Loan Book Aum';
                categoryCell.font = { bold: true, size: 12, color: yellowText };
                categoryCell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: yellowBg
                };
                categoryCell.alignment = { horizontal: 'left', vertical: 'middle' };
                categoryCell.border = {
                    top: { style: 'thin', color: { argb: 'FF000000' } },
                    bottom: { style: 'thin', color: { argb: 'FF000000' } },
                    left: { style: 'thin', color: { argb: 'FF000000' } },
                    right: { style: 'thin', color: { argb: 'FF000000' } }
                };
                
                // Merge remaining cells for the total value
                worksheet.mergeCells(row.number, 2, row.number, 1 + (data.monthly_data.length * 2));
                const totalCell = row.getCell(2);
                totalCell.value = formatNumber(totalValue);
                totalCell.font = { bold: true, size: 12, color: yellowText };
                totalCell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: yellowBg
                };
                totalCell.alignment = { horizontal: 'center', vertical: 'middle' };
                totalCell.border = {
                    top: { style: 'thin', color: { argb: 'FF000000' } },
                    bottom: { style: 'thin', color: { argb: 'FF000000' } },
                    left: { style: 'thin', color: { argb: 'FF000000' } },
                    right: { style: 'thin', color: { argb: 'FF000000' } }
                };
            }
        }
        
        // Generate Excel file
        console.log('Generating Excel buffer...');
        const buffer = await workbook.xlsx.writeBuffer();
        console.log('Excel buffer generated, size:', buffer.byteLength);
        
        // Determine the date for filename based on active button
        let reportDate = new Date().toISOString().split('T')[0]; // Default to today
        
        const tillDateBtn = document.getElementById('aumTillDateBtn');
        const tillPrevDateBtn = document.getElementById('aumTillPrevDateBtn');
        const tillPrevMonthBtn = document.getElementById('aumTillPrevMonthBtn');
        
        // Check which button is active
        const isTillDateActive = tillDateBtn && tillDateBtn.classList.contains('ring-2');
        const isTillPrevDateActive = tillPrevDateBtn && tillPrevDateBtn.classList.contains('ring-2');
        const isTillPrevMonthActive = tillPrevMonthBtn && tillPrevMonthBtn.classList.contains('ring-2');
        
        if (isTillPrevDateActive) {
            // Use previous date (yesterday)
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            reportDate = yesterday.toISOString().split('T')[0];
        } else if (isTillPrevMonthActive) {
            // Use last day of previous month
            const today = new Date();
            // Get the last day of the previous month by using day 0 of current month
            // new Date(year, month, 0) gives the last day of the previous month
            const prevMonth = new Date(today.getFullYear(), today.getMonth(), 0);
            // Format date manually to avoid timezone issues
            const year = prevMonth.getFullYear();
            const month = String(prevMonth.getMonth() + 1).padStart(2, '0');
            const day = String(prevMonth.getDate()).padStart(2, '0');
            reportDate = `${year}-${month}-${day}`;
        }
        // If tillDate is active or no button is active, use today's date (default)
        
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `AUM_Report_${reportDate}.xlsx`;
        document.body.appendChild(a);
        console.log('Triggering download...');
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 100);
        
        console.log('AUM Report exported successfully');
    } catch (error) {
        console.error('Error exporting AUM report:', error);
        console.error('Error stack:', error.stack);
        alert('Failed to export AUM report: ' + error.message + '\n\nPlease check the browser console for more details.');
    }
}

// Function to save monthly target
async function saveMonthlyTarget() {
    try {
        const input = document.getElementById('monthlyTargetInput');
        const saveBtn = document.getElementById('saveMonthlyTargetBtn');
        
        if (!input) return;
        
        const value = removeCommas(input.value.trim());
        
        if (!value || isNaN(value) || parseFloat(value) <= 0) {
            alert('Please enter a valid target amount');
            return;
        }
        
        // Disable button during save
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
        }
        
        // Send POST request to save monthly target
        const response = await fetch('/api/daily-performance-metrics/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                monthly_target: value
            })
        });
        
        let result;
        try {
            result = await response.json();
        } catch (e) {
            throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }
        
        if (!response.ok) {
            throw new Error(result.message || result.error || `Failed to save: ${response.status}`);
        }
        
        if (result.success) {
            // Reload the data to reflect the updated target
            await loadDailyPerformanceData();
            
            // Show success feedback
            if (saveBtn) {
                saveBtn.textContent = 'Saved!';
                saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                saveBtn.classList.add('bg-green-600');
                setTimeout(() => {
                    saveBtn.textContent = 'Save';
                    saveBtn.classList.remove('bg-green-600');
                    saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);
            }
        } else {
            throw new Error(result.message || 'Failed to save monthly target');
        }
        
    } catch (error) {
        console.error('Error saving monthly target:', error);
        const errorMessage = error.message || 'Failed to save monthly target. Please try again.';
        alert(errorMessage);
    } finally {
        const saveBtn = document.getElementById('saveMonthlyTargetBtn');
        if (saveBtn) {
            saveBtn.disabled = false;
            if (saveBtn.textContent === 'Saving...') {
                saveBtn.textContent = 'Save';
            }
        }
    }
}

function formatNumber(number) {
    if (number === null || number === undefined || isNaN(number)) {
        return '0';
    }
    
    const num = parseFloat(number);
    
    if (num >= 10000000) { // 1 crore
        return (num / 10000000).toFixed(1) + ' Cr';
    } else if (num >= 100000) { // 1 lakh
        return (num / 100000).toFixed(1) + ' L';
    } else if (num >= 1000) { // 1 thousand
        return (num / 1000).toFixed(1) + ' K';
    } else {
        return num.toLocaleString('en-IN');
    }
}

// Format all currency values on the page
function formatAllCurrencyValues() {
    const elements = document.querySelectorAll('[data-amount]');
    elements.forEach(element => {
        const amount = parseFloat(element.getAttribute('data-amount'));
        if (!isNaN(amount)) {
            element.textContent = formatCurrency(amount);
        }
    });
}
// Auto-apply filters when any filter changes
function setupAutoFilters() {
    const filterInputs = document.querySelectorAll('.filter-input');
    
    filterInputs.forEach(input => {
        input.addEventListener('change', function() {
            // Handle state change for dynamic city filtering
            if (input.name === 'state') {
                updateCityOptions(input.value, input.closest('form'));
            }
            
            // Determine which form this input belongs to
            const form = input.closest('form');
            const formId = form ? form.id : 'filterForm';
            
            // For date inputs, update filter options when any date changes
            if (input.type === 'date') {
                const dateFrom = form.querySelector('input[name="date_from"]').value;
                const dateTo = form.querySelector('input[name="date_to"]').value;
                
                // Update filter options whenever any date is changed
                if (formId === 'fraudFilterForm') {
                    // For fraud tab, use the fraud-specific filter update function
                    updateFraudFilterOptions(form).then(() => {
                // Only submit if both dates are provided or both are empty
                if ((dateFrom && dateTo) || (!dateFrom && !dateTo)) {
                        // Handle fraud tab filters - reload fraud data
                        applyFraudFilters();
                        }
                    });
                    } else {
                    // For main dashboard, use the regular filter update function
                    updateFilterOptions(form).then(() => {
                        // Only submit if both dates are provided or both are empty
                        if ((dateFrom && dateTo) || (!dateFrom && !dateTo)) {
                        // Save main filters before submitting
                        saveMainFilters();
                    document.getElementById('filterForm').submit();
                    }
                    });
                }
            } else {
                // For dropdowns, apply immediately
                if (formId === 'fraudFilterForm') {
                    // Handle fraud tab filters - reload fraud data
                    applyFraudFilters();
                } else {
                    // Save main filters before submitting
                    saveMainFilters();
                document.getElementById('filterForm').submit();
                }
            }
        });
    });
}
// Function to update all filter options based on current filters
async function updateFilterOptions(form) {
    try {
        console.log('Updating filter options...');
        
        // Get current filter values from the form
        const dateFrom = form.querySelector('input[name="date_from"]')?.value;
        const dateTo = form.querySelector('input[name="date_to"]')?.value;
        const dateType = form.querySelector('select[name="date_type"]')?.value;
        const closingStatus = form.querySelector('select[name="closing_status"]')?.value;
        const dpd = form.querySelector('select[name="dpd"]')?.value;
        
        console.log('Current filters:', { dateFrom, dateTo, dateType, closingStatus, dpd });
        
        // Build URL with current filters
        const params = new URLSearchParams();
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (dateType) params.append('date_type', dateType);
        if (closingStatus) params.append('closing_status', closingStatus);
        if (dpd) params.append('dpd', dpd);
        
        console.log('Fetching filter options with params:', params.toString());
        const response = await fetch(`/api/kpi-data/?${params.toString()}`);
        const data = await response.json();
        
        console.log('Received filter options:', data.filter_options);
        
        if (data && data.filter_options) {
            const options = data.filter_options;
            
            // Update states dropdown
            const stateSelect = form.querySelector('select[name="state"]');
            if (stateSelect) {
                const currentState = stateSelect.value;
                stateSelect.innerHTML = '<option value="">All States</option>';
                options.states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    if (state === currentState) option.selected = true;
                    stateSelect.appendChild(option);
                });
            }
            
            // Update cities dropdown
            const citySelect = form.querySelector('select[name="city"]');
            if (citySelect) {
                const currentCity = citySelect.value;
                citySelect.innerHTML = '<option value="">All Cities</option>';
                
                // If a state is selected, update cities for that state
                const selectedState = stateSelect?.value;
                if (selectedState) {
                    try {
                        const cityParams = new URLSearchParams(params);
                        cityParams.append('state', selectedState);
                        const cityResponse = await fetch(`/api/cities-by-state/?${cityParams.toString()}`);
                        const cityData = await cityResponse.json();
                        
                        cityData.cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city;
                            option.textContent = city;
                            if (city === currentCity) option.selected = true;
                            citySelect.appendChild(option);
                        });
                    } catch (error) {
                        console.error('Error fetching cities for state:', error);
                    }
                }
            }
            
            // Update closing status dropdown
            const closingStatusSelect = form.querySelector('select[name="closing_status"]');
            if (closingStatusSelect) {
                const currentStatus = closingStatusSelect.value;
                closingStatusSelect.innerHTML = '<option value="">All Status</option>';
                options.closing_statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === currentStatus) option.selected = true;
                    closingStatusSelect.appendChild(option);
                });
            }
            
            // Update DPD buckets dropdown
            const dpdSelect = form.querySelector('select[name="dpd"]');
            if (dpdSelect) {
                const currentDpd = dpdSelect.value;
                dpdSelect.innerHTML = '<option value="">All DPD</option>';
                options.dpd_buckets.forEach(bucket => {
                    const option = document.createElement('option');
                    option.value = bucket;
                    option.textContent = bucket;
                    if (bucket === currentDpd) option.selected = true;
                    dpdSelect.appendChild(option);
                });
            }
            
            console.log('Updated filter options with current filters:', {
                states: options.states.length,
                cities: citySelect?.options.length || 0,
                closing_statuses: options.closing_statuses.length,
                dpd_buckets: options.dpd_buckets.length
            });
        }
    } catch (error) {
        console.error('Error updating filter options:', error);
    }
}

// Function to update city options based on selected state
async function updateCityOptions(selectedState, form) {
    const citySelect = form.querySelector('select[name="city"]');
    if (!citySelect) return;
    
    // Clear current options except "All Cities"
    citySelect.innerHTML = '<option value="">All Cities</option>';
    
    if (!selectedState) {
        return; // No state selected, keep only "All Cities"
    }
    
    try {
        // Get current filter values from the form
        const dateFrom = form.querySelector('input[name="date_from"]')?.value;
        const dateTo = form.querySelector('input[name="date_to"]')?.value;
        const dateType = form.querySelector('select[name="date_type"]')?.value;
        const closingStatus = form.querySelector('select[name="closing_status"]')?.value;
        const dpd = form.querySelector('select[name="dpd"]')?.value;
        
        // Build URL with current filters
        const params = new URLSearchParams();
        params.append('state', selectedState);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (dateType) params.append('date_type', dateType);
        if (closingStatus) params.append('closing_status', closingStatus);
        if (dpd) params.append('dpd', dpd);
        
        const response = await fetch(`/api/cities-by-state/?${params.toString()}`);
        const data = await response.json();
        
        // Add cities to the dropdown
        data.cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            citySelect.appendChild(option);
        });
        
        console.log(`Updated city options for state "${selectedState}" with current filters:`, data.cities.length, 'cities');
    } catch (error) {
        console.error('Error fetching cities for state:', error);
    }
}

// Save main dashboard filter values to localStorage
function saveMainFilters() {
    const form = document.getElementById('filterForm');
    if (!form) {
        console.log('Main filter form not found for saving');
        return;
    }
    
    const dateTypeSelect = form.querySelector('select[name="date_type"]');
    if (!dateTypeSelect) {
        console.log('date_type select element not found for saving');
        return;
    }
    
    const filters = {
        date_from: form.querySelector('input[name="date_from"]').value,
        date_to: form.querySelector('input[name="date_to"]').value,
        date_type: dateTypeSelect.value,
        closing_status: form.querySelector('select[name="closing_status"]').value,
        dpd: form.querySelector('select[name="dpd"]').value,
        state: form.querySelector('select[name="state"]').value,
        city: form.querySelector('select[name="city"]').value
    };
    
    localStorage.setItem('mainFilters', JSON.stringify(filters));
    console.log('Main filters saved:', filters);
    console.log('date_type value saved:', filters.date_type);
}

// Restore main dashboard filter values from localStorage
function restoreMainFilters() {
    const form = document.getElementById('filterForm');
    if (!form) {
        console.log('Main filter form not found');
        return;
    }
    
    const savedFilters = localStorage.getItem('mainFilters');
    if (!savedFilters) {
        console.log('No saved main filters found in localStorage');
        return;
    }
    
    try {
        const filters = JSON.parse(savedFilters);
        console.log('Restoring main filters:', filters);
        
        // Restore form values
        if (filters.date_from) {
            const dateFromInput = form.querySelector('input[name="date_from"]');
            if (dateFromInput) dateFromInput.value = filters.date_from;
        }
        if (filters.date_to) {
            const dateToInput = form.querySelector('input[name="date_to"]');
            if (dateToInput) dateToInput.value = filters.date_to;
        }
        if (filters.date_type) {
            const dateTypeSelect = form.querySelector('select[name="date_type"]');
            if (dateTypeSelect) {
                dateTypeSelect.value = filters.date_type;
                console.log('Set date_type to:', filters.date_type);
            } else {
                console.log('date_type select element not found');
            }
        }
        if (filters.closing_status) {
            const closingStatusSelect = form.querySelector('select[name="closing_status"]');
            if (closingStatusSelect) closingStatusSelect.value = filters.closing_status;
        }
        if (filters.dpd) {
            const dpdSelect = form.querySelector('select[name="dpd"]');
            if (dpdSelect) dpdSelect.value = filters.dpd;
        }
        if (filters.state) {
            const stateSelect = form.querySelector('select[name="state"]');
            if (stateSelect) {
                stateSelect.value = filters.state;
                // Update city options for the restored state
                updateCityOptions(filters.state, form).then(() => {
                    // Set city value after cities are loaded
        if (filters.city) {
                        const citySelect = form.querySelector('select[name="city"]');
                        if (citySelect) citySelect.value = filters.city;
                    }
                });
            }
        } else if (filters.city) {
            // If no state but city is selected, just set the city
            const citySelect = form.querySelector('select[name="city"]');
            if (citySelect) citySelect.value = filters.city;
        }
        
        console.log('Main filters restored successfully');
        
    } catch (error) {
        console.error('Error restoring main filters:', error);
    }
}

// Save fraud filter values to localStorage
function saveFraudFilters() {
    const form = document.getElementById('fraudFilterForm');
    if (!form) return;
    
    const filters = {
        date_from: form.querySelector('input[name="date_from"]').value,
        date_to: form.querySelector('input[name="date_to"]').value,
        date_type: form.querySelector('select[name="date_type"]').value,
        closing_status: form.querySelector('select[name="closing_status"]').value,
        dpd: form.querySelector('select[name="dpd"]').value,
        state: form.querySelector('select[name="state"]').value,
        city: form.querySelector('select[name="city"]').value
    };
    
    localStorage.setItem('fraudFilters', JSON.stringify(filters));
    console.log('Fraud filters saved:', filters);
}
// Restore fraud filter values from localStorage
function restoreFraudFilters() {
    const form = document.getElementById('fraudFilterForm');
    if (!form) return;
    
    const savedFilters = localStorage.getItem('fraudFilters');
    if (!savedFilters) return;
    
    try {
        const filters = JSON.parse(savedFilters);
        console.log('Restoring fraud filters:', filters);
        
        // Restore form values
        if (filters.date_from) form.querySelector('input[name="date_from"]').value = filters.date_from;
        if (filters.date_to) form.querySelector('input[name="date_to"]').value = filters.date_to;
        if (filters.date_type) form.querySelector('select[name="date_type"]').value = filters.date_type;
        if (filters.closing_status) form.querySelector('select[name="closing_status"]').value = filters.closing_status;
        if (filters.dpd) form.querySelector('select[name="dpd"]').value = filters.dpd;
        if (filters.state) form.querySelector('select[name="state"]').value = filters.state;
        if (filters.city) form.querySelector('select[name="city"]').value = filters.city;
        
    } catch (error) {
        console.error('Error restoring fraud filters:', error);
    }
}

// Clear fraud filter values
function clearFraudFilters() {
    const form = document.getElementById('fraudFilterForm');
    if (!form) return;
    
    // Clear all form fields
    form.querySelector('input[name="date_from"]').value = '';
    form.querySelector('input[name="date_to"]').value = '';
    form.querySelector('select[name="date_type"]').value = 'repayment_date';
    form.querySelector('select[name="closing_status"]').value = '';
    form.querySelector('select[name="dpd"]').value = '';
    form.querySelector('select[name="state"]').value = '';
    form.querySelector('select[name="city"]').value = '';
    
    // Clear saved filters
    localStorage.removeItem('fraudFilters');
    
    console.log('Fraud filters cleared');
    
    // Reload data without filters
    applyFraudFilters();
}

// Apply fraud filters and reload data
function applyFraudFilters() {
    console.log('Applying fraud filters...');
    
    // Save current filter values
    saveFraudFilters();
    
    // Get filter values from the fraud form
    const form = document.getElementById('fraudFilterForm');
    const filters = {};
    
    // Date filters
    const dateFrom = form.querySelector('input[name="date_from"]').value;
    const dateTo = form.querySelector('input[name="date_to"]').value;
    const dateType = form.querySelector('select[name="date_type"]').value;
    if (dateFrom) filters.date_from = dateFrom;
    if (dateTo) filters.date_to = dateTo;
    if (dateType) filters.date_type = dateType;
    
    // Other filters
    const closingStatus = form.querySelector('select[name="closing_status"]').value;
    const dpd = form.querySelector('select[name="dpd"]').value;
    const state = form.querySelector('select[name="state"]').value;
    const city = form.querySelector('select[name="city"]').value;
    
    if (closingStatus) filters.closing_status = closingStatus;
    if (dpd) filters.dpd = dpd;
    if (state) filters.state = state;
    if (city) filters.city = city;
    
    console.log('Fraud filters:', filters);
    
    // Reload all fraud data with the new filters
    loadFraudKpiData(filters);
    loadFraudDpdTable(filters);
    loadFraudStateChart(filters);
    loadFraudTimeSeriesChart(filters);
    loadFraudCityCollectedChart(filters);
    loadFraudCityUncollectedChart(filters);
}

// Auto-refresh dashboard data every 10 seconds via API
function setupAutoRefresh() {
    let refreshInterval;
    let isUserInteracting = false;
    let userInteractionTimeout;
    
    // Disable auto-refresh when user is interacting
    function pauseAutoRefresh() {
        isUserInteracting = true;
        clearTimeout(userInteractionTimeout);
        userInteractionTimeout = setTimeout(() => {
            isUserInteracting = false;
        }, 30000); // Resume after 30 seconds of no interaction
    }
    
    // Listen for user interactions
    document.addEventListener('change', pauseAutoRefresh);
    document.addEventListener('click', pauseAutoRefresh);
    document.addEventListener('keydown', pauseAutoRefresh);
    
    async function refreshDashboardData() {
        if (isUserInteracting || window.autoRefreshPaused) {
            console.log('Auto-refresh paused - user is interacting or manually paused');
            return;
        }
        
        // Get the currently active tab
        const activeTab = localStorage.getItem('activeTab') || 'collection';
        console.log(`Refreshing ${activeTab} tab data via API...`);
        
        try {
            // Refresh based on active tab
            if (activeTab === 'collection') {
                // Refresh Collection WITH Fraud tab
            const currentUrl = new URL(window.location);
            const currentParams = currentUrl.searchParams;
            const params = new URLSearchParams();
            
            // Preserve all current filter parameters
            for (const [key, value] of currentParams.entries()) {
                if (value) {
                    params.set(key, value);
                }
            }
            
            const filterParams = Object.fromEntries(params.entries());
            const paramsString = params.toString();
            await Promise.all([
                refreshKPIData(paramsString),
                loadDPDBucketData(filterParams),
                loadStateRepaymentChart(filterParams),
                loadStatePendingChart(filterParams),
                loadTimeSeriesChart(filterParams),
                loadTopCitiesCollectionChart(filterParams),
                loadPendingCasesByAmountChart(filterParams)
            ]);
            
                console.log('Collection without Fraud tab data refreshed successfully');
                
            } else if (activeTab === 'fraud') {
                // Refresh Collection WITH Fraud tab
                const form = document.getElementById('fraudFilterForm');
                const filters = {};
                
                if (form) {
                    const dateFrom = form.querySelector('input[name="date_from"]')?.value;
                    const dateTo = form.querySelector('input[name="date_to"]')?.value;
                    const dateType = form.querySelector('select[name="date_type"]')?.value;
                    const closingStatus = form.querySelector('select[name="closing_status"]')?.value;
                    const dpd = form.querySelector('select[name="dpd"]')?.value;
                    const state = form.querySelector('select[name="state"]')?.value;
                    const city = form.querySelector('select[name="city"]')?.value;
                    
                    if (dateFrom) filters.date_from = dateFrom;
                    if (dateTo) filters.date_to = dateTo;
                    if (dateType) filters.date_type = dateType;
                    if (closingStatus) filters.closing_status = closingStatus;
                    if (dpd) filters.dpd = dpd;
                    if (state) filters.state = state;
                    if (city) filters.city = city;
                }
                
                await Promise.all([
                    loadFraudKpiData(filters),
                    loadFraudDpdTable(filters),
                    loadFraudStateChart(filters),
                    loadFraudTimeSeriesChart(filters),
                    loadFraudCityCollectedChart(filters),
                    loadFraudCityUncollectedChart(filters)
                ]);
                
                console.log('Collection with Fraud tab data refreshed successfully');
                
            } else if (activeTab === 'dailyPerformance') {
                // Refresh Daily Performance tab (silent refresh - no loading screen)
                await loadDailyPerformanceData(true);
                console.log('Daily Performance tab data refreshed successfully');
                
            } else if (activeTab === 'loanCount') {
                // Refresh Loan Count Wise tab
                await loadLoanCountData();
                console.log('Loan Count Wise tab data refreshed successfully');
            } else if (activeTab === 'creditPerson') {
                await loadCreditPersonData();
                console.log('Credit Person Wise tab data refreshed successfully');
            } else if (activeTab === 'aumReport') {
                // Refresh AUM Report tab (silent refresh - no loading screen)
                // Get current active button state to maintain filter
                const tillDate = getAumCurrentTillDate();
                await loadAumData(true, tillDate);
                console.log('AUM Report tab data refreshed successfully');
            }
            
        } catch (error) {
            console.error('Error refreshing dashboard data:', error);
        }
    }
    
    // Start auto-refresh
    refreshInterval = setInterval(refreshDashboardData, 10000);
    
    // Show refresh indicator
    showRefreshIndicator();
    
    // Return function to stop auto-refresh if needed
    return function stopAutoRefresh() {
        clearInterval(refreshInterval);
        clearTimeout(userInteractionTimeout);
    };
}
// Refresh KPI data via API
async function refreshKPIData(params) {
    try {
        const response = await fetch(`/api/kpi-data/?${params}`);
        const data = await response.json();
        
        if (data.data) {
            const kpis = data.data;
            
            // Update Total Applications
            const totalAppsElement = document.getElementById('totalApplications');
            if (totalAppsElement) {
                totalAppsElement.textContent = kpis.total_applications.toLocaleString();
            }
            
            // Update Fresh Cases
            const freshCasesElement = document.getElementById('freshCases');
            if (freshCasesElement) {
                freshCasesElement.textContent = kpis.fresh_cases.toLocaleString();
            }
            
            // Update Fresh Percentage
            const freshPercentageElement = document.getElementById('freshPercentage');
            if (freshPercentageElement) {
                freshPercentageElement.textContent = kpis.fresh_percentage.toFixed(1);
            }
            
            // Update Reloan Cases
            const reloanCasesElement = document.getElementById('reloanCases');
            if (reloanCasesElement) {
                reloanCasesElement.textContent = kpis.reloan_cases.toLocaleString();
            }
            
            // Update Reloan Percentage
            const reloanPercentageElement = document.getElementById('reloanPercentage');
            if (reloanPercentageElement) {
                reloanPercentageElement.textContent = kpis.reloan_percentage.toFixed(1);
            }
            
            // Update Sanction Amount
            const sanctionElement = document.getElementById('sanctionAmount');
            if (sanctionElement) {
                sanctionElement.textContent = formatCurrency(kpis.sanction_amount);
            }
            
            // Update Fresh Sanction Amount
            const freshSanctionElement = document.getElementById('freshSanctionAmount');
            if (freshSanctionElement) {
                freshSanctionElement.textContent = formatCurrency(kpis.fresh_sanction_amount);
            }
            
            // Update Reloan Sanction Amount
            const reloanSanctionElement = document.getElementById('reloanSanctionAmount');
            if (reloanSanctionElement) {
                reloanSanctionElement.textContent = formatCurrency(kpis.reloan_sanction_amount);
            }
            
            // Update Disbursed Amount
            const disbursedElement = document.getElementById('disbursedAmount');
            if (disbursedElement) {
                disbursedElement.textContent = formatCurrency(kpis.net_disbursal);
            }
            
            // Update Fresh Disbursed Amount
            const freshDisbursedElement = document.getElementById('freshDisbursedAmount');
            if (freshDisbursedElement) {
                freshDisbursedElement.textContent = formatCurrency(kpis.fresh_disbursed_amount);
            }
            
            // Update Reloan Disbursed Amount
            const reloanDisbursedElement = document.getElementById('reloanDisbursedAmount');
            if (reloanDisbursedElement) {
                reloanDisbursedElement.textContent = formatCurrency(kpis.reloan_disbursed_amount);
            }
            
            // Update Repayment Amount
            const repaymentElement = document.getElementById('repaymentAmount');
            if (repaymentElement) {
                repaymentElement.textContent = formatCurrency(kpis.repayment_amount);
            }
            
            // Update Fresh Repayment Amount
            const freshRepaymentElement = document.getElementById('freshRepaymentAmount');
            if (freshRepaymentElement) {
                freshRepaymentElement.textContent = formatCurrency(kpis.fresh_repayment_amount);
            }
            
            // Update Reloan Repayment Amount
            const reloanRepaymentElement = document.getElementById('reloanRepaymentAmount');
            if (reloanRepaymentElement) {
                reloanRepaymentElement.textContent = formatCurrency(kpis.reloan_repayment_amount);
            }
            
            
            // Update Collected Amount
            const collectedElement = document.getElementById('collectedAmount');
            if (collectedElement) {
                collectedElement.textContent = formatCurrency(kpis.collected_amount);
            }
            
            // Update Collected Percentage
            const collectedPercentageElement = document.getElementById('collectedPercentage');
            if (collectedPercentageElement) {
                const collectedPct = kpis.collected_percentage;
                if (collectedPct !== undefined && collectedPct !== null && !isNaN(collectedPct)) {
                    collectedPercentageElement.textContent = collectedPct.toFixed(2) + '% of Repayment';
                } else {
                    collectedPercentageElement.textContent = '0.00% of Repayment';
                }
            }
            
            // Update Fresh Collected Amount
            const freshCollectedElement = document.getElementById('freshCollectedAmount');
            if (freshCollectedElement) {
                freshCollectedElement.textContent = formatCurrency(kpis.fresh_collected_amount);
            }
            
            // Update Reloan Collected Amount
            const reloanCollectedElement = document.getElementById('reloanCollectedAmount');
            if (reloanCollectedElement) {
                reloanCollectedElement.textContent = formatCurrency(kpis.reloan_collected_amount);
            }
            
            // Update Pending Amount
            const pendingElement = document.getElementById('pendingAmount');
            if (pendingElement) {
                pendingElement.textContent = formatCurrency(kpis.pending_collection);
            }
            
            // Update Pending Percentage
            const pendingPercentageElement = document.getElementById('pendingPercentage');
            if (pendingPercentageElement) {
                pendingPercentageElement.textContent = kpis.pending_percentage.toFixed(2) + '% of Repayment';
            }
            
            // Update Fresh Pending Amount
            const freshPendingElement = document.getElementById('freshPendingAmount');
            if (freshPendingElement) {
                freshPendingElement.textContent = formatCurrency(kpis.fresh_pending_amount);
            }
            
            // Update Reloan Pending Amount
            const reloanPendingElement = document.getElementById('reloanPendingAmount');
            if (reloanPendingElement) {
                reloanPendingElement.textContent = formatCurrency(kpis.reloan_pending_amount);
            }
            // Update Principal Outstanding Amount
            const principalOutstandingElement = document.getElementById('principalOutstandingAmount');
            if (principalOutstandingElement) {
                principalOutstandingElement.textContent = formatCurrency(kpis.principal_outstanding);
            }
            
            // Update Fresh Principal Outstanding Amount
            const freshPrincipalOutstandingElement = document.getElementById('freshPrincipalOutstanding');
            if (freshPrincipalOutstandingElement) {
                freshPrincipalOutstandingElement.textContent = formatCurrency(kpis.fresh_principal_outstanding);
            }
            
            // Update Reloan Principal Outstanding Amount
            const reloanPrincipalOutstandingElement = document.getElementById('reloanPrincipalOutstanding');
            if (reloanPrincipalOutstandingElement) {
                reloanPrincipalOutstandingElement.textContent = formatCurrency(kpis.reloan_principal_outstanding);
            }
            
            // Update Principal Outstanding Excluding 90+ DPD (Recovery %)
            const recoverableAmountExcl90Element = document.getElementById('recoverableAmountExcl90');
            if (recoverableAmountExcl90Element) {
                recoverableAmountExcl90Element.textContent = formatCurrency(kpis.recoverable_amount_excl_90);
            }
            
            const recoveryPercentageExcl90Element = document.getElementById('recoveryPercentageExcl90');
            if (recoveryPercentageExcl90Element) {
                recoveryPercentageExcl90Element.textContent = kpis.recovery_percentage_excl_90.toFixed(2);
            }
            
            // Update Fresh Recoverable Amount Excl. 90+ DPD
            const freshRecoverableExcl90Element = document.getElementById('freshRecoverableExcl90');
            if (freshRecoverableExcl90Element) {
                freshRecoverableExcl90Element.textContent = formatCurrency(kpis.fresh_recoverable_excl_90);
            }
            
            const freshRecoveryPercentageExcl90Element = document.getElementById('freshRecoveryPercentageExcl90');
            if (freshRecoveryPercentageExcl90Element) {
                freshRecoveryPercentageExcl90Element.textContent = kpis.fresh_recovery_percentage_excl_90.toFixed(2);
            }
            
            // Update Reloan Recoverable Amount Excl. 90+ DPD
            const reloanRecoverableExcl90Element = document.getElementById('reloanRecoverableExcl90');
            if (reloanRecoverableExcl90Element) {
                reloanRecoverableExcl90Element.textContent = formatCurrency(kpis.reloan_recoverable_excl_90);
            }
            
            const reloanRecoveryPercentageExcl90Element = document.getElementById('reloanRecoveryPercentageExcl90');
            if (reloanRecoveryPercentageExcl90Element) {
                reloanRecoveryPercentageExcl90Element.textContent = kpis.reloan_recovery_percentage_excl_90.toFixed(2);
            }
        }
        
        console.log('KPI data refreshed successfully');
    } catch (error) {
        console.error('Error refreshing KPI data:', error);
    }
}

// Show refresh indicator
function showRefreshIndicator() {
    // Use inline refresh indicator container
    const indicatorContainer = document.getElementById('refresh-indicator-inline');
    if (!indicatorContainer) return;
    
    // Create refresh indicator
    indicatorContainer.innerHTML = `
        <div class="bg-blue-500/90 text-white px-2.5 py-1 rounded-lg shadow-md flex items-center gap-1.5">
            <div class="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></div>
            <span class="text-xs font-medium">Data refresh: 10s</span>
            <button id="toggle-refresh" class="text-xs bg-white/20 px-1.5 py-0.5 rounded hover:bg-white/30 transition-colors">
                Pause
            </button>
        </div>
    `;
    
    // Add toggle functionality
    const toggleButton = indicatorContainer.querySelector('#toggle-refresh');
    const countdownSpan = indicatorContainer.querySelector('span');
    const pulseDot = indicatorContainer.querySelector('.animate-pulse');
    let isPaused = false;
    
    toggleButton.addEventListener('click', function() {
        isPaused = !isPaused;
        toggleButton.textContent = isPaused ? 'Resume' : 'Pause';
        if (pulseDot) {
            pulseDot.style.animationPlayState = isPaused ? 'paused' : 'running';
        }
        
        // Store pause state
        window.autoRefreshPaused = isPaused;
    });
    
    // Update countdown every second
    let countdown = 10;
    const countdownInterval = setInterval(() => {
        if (!window.autoRefreshPaused) {
            countdown--;
            if (countdown <= 0) {
                countdown = 10;
            }
        }
        if (countdownSpan) {
            countdownSpan.textContent = `Data refresh: ${countdown}s`;
        }
    }, 1000);
}

// Load DPD Bucket Data
async function loadDPDBucketData(filterParams = null) {
    try {
        let params;
        if (filterParams) {
            params = new URLSearchParams(filterParams);
        } else {
            params = new URLSearchParams(window.location.search);
        }
        const response = await fetch(`/api/dpd-buckets/?${params}`);
        const data = await response.json();
        
        const tbody = document.getElementById('dpdTableBody');
        tbody.innerHTML = '';
        
        let totalCount = 0;
        data.data.forEach(item => totalCount += item.count);
        
        data.data.forEach((item, index) => {
            const percentage = totalCount > 0 ? (item.count / totalCount) * 100 : 0;
            const row = document.createElement('tr');
            
            // Add highlighting for selected DPD bucket and make clickable
            if (item.is_selected) {
                row.className = 'border-b border-border/50 bg-blue-500/10 border-l-4 border-l-blue-500 transition-colors cursor-pointer hover:bg-blue-500/20';
            } else {
                row.className = 'border-b border-border/50 hover:bg-secondary/50 transition-colors cursor-pointer';
            }
            
            // Add click handler
            row.onclick = () => openDPDDetailsModal(item.dpd_bucket, item.count);
            
            const bucketColor = getBucketColor(item.dpd_bucket);
            
            row.innerHTML = `
                <td class="py-3 px-4 font-medium ${item.is_selected ? 'text-blue-400' : ''}">${item.dpd_bucket} days</td>
                <td class="py-3 px-4 text-right ${item.is_selected ? 'text-blue-400 font-semibold' : ''}">${formatNumber(item.count)}</td>
            `;
            
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading DPD bucket data:', error);
    }
}

function getBucketColor(bucket) {
    if (bucket === '0-30') return 'bg-green-500';
    if (bucket === '31-60') return 'bg-yellow-500';
    if (bucket === '61-90') return 'bg-orange-500';
    return 'bg-red-500';
}

// Load State Repayment Chart
async function loadStateRepaymentChart(filterParams = null) {
    try {
        let params;
        if (filterParams) {
            params = new URLSearchParams(filterParams);
        } else {
            params = new URLSearchParams(window.location.search);
        }
        const response = await fetch(`/api/state-repayment/?${params}`);
        const data = await response.json();
        
        const ctx = document.getElementById('stateChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.stateChartInstance) {
            window.stateChartInstance.destroy();
        }
        
        window.stateChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.data.map(item => item.state),
                datasets: [{
                    label: 'Collected Amount',
                    data: data.data.map(item => item.collected_amount || 0),
                    backgroundColor: '#10b981',
                    borderColor: '#10b981',
                    borderWidth: 1,
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Collected: ' + formatCurrency(context.parsed.y);
                            }
                        }
                    },
                    datalabels: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
        
        console.log('State chart created successfully');
    } catch (error) {
        console.error('Error loading state chart:', error);
    }
}

async function loadStatePendingChart(filterParams = null) {
    try {
        let params;
        if (filterParams) {
            params = new URLSearchParams(filterParams);
        } else {
            params = new URLSearchParams(window.location.search);
        }
        const response = await fetch(`/api/state-repayment/?${params}`);
        const data = await response.json();
        const ctx = document.getElementById('statePendingChart').getContext('2d');
        if (window.statePendingChartInstance) {
            window.statePendingChartInstance.destroy();
        }
        window.statePendingChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.data.map(item => item.state),
                datasets: [{
                    label: 'Pending Amount',
                    data: data.data.map(item => item.pending_amount),
                    backgroundColor: '#f87171', // red-400
                    borderColor: '#f87171',
                    borderWidth: 1,
                    borderRadius: 4,
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Pending: ' + formatCurrency(context.parsed.y);
                            }
                        }
                    },
                    datalabels: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) { return '₹' + (value / 1000).toFixed(0) + 'K'; }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading pending state chart:', error);
    }
}
// Load Time Series Chart
async function loadTimeSeriesChart(filterParams = null) {
    try {
        let params;
        if (filterParams) {
            params = new URLSearchParams(filterParams);
        } else {
            params = new URLSearchParams(window.location.search);
        }
        const response = await fetch(`/api/time-series/?${params}`);
        const data = await response.json();
        
        console.log('Time series data loaded:', data.data.length, 'points');
        
        // Store data globally for fullscreen chart
        window.timeSeriesData = data;
        
        // Calculate summary values
        const totalRepayment = data.data.reduce((sum, item) => sum + item.repayment_amount, 0);
        const totalCollected = data.data.reduce((sum, item) => sum + item.collected_amount, 0);
        const totalPending = data.data.reduce((sum, item) => sum + item.pending_amount, 0);
        const totalCollectedCases = data.data.reduce((sum, item) => sum + item.collected_cases, 0);
        const totalPendingCases = data.data.reduce((sum, item) => sum + item.pending_cases, 0);
        const averageCollectionRate = data.data.length > 0 ? 
            data.data.reduce((sum, item) => sum + item.collection_percentage, 0) / data.data.length : 0;
        
        console.log('Time Series Indicators:', {
            totalCollected,
            totalCollectedCases,
            totalPending,
            totalPendingCases
        });
        
        // Update indicators
        // Update Total Applications
        const totalApplicationsElement = document.getElementById('timeseriesTotalApplications');
        if (totalApplicationsElement) {
            totalApplicationsElement.textContent = (totalCollectedCases + totalPendingCases).toLocaleString();
        }
        
        // Update Repayment Amount
        const repaymentAmountElement = document.getElementById('timeseriesRepaymentAmount');
        if (repaymentAmountElement) {
            repaymentAmountElement.textContent = formatCurrency(totalRepayment);
        }
        
        const collectedAmountElement = document.getElementById('timeseriesCollectedAmount');
        const collectedCasesElement = document.getElementById('timeseriesCollectedCases');
        const pendingAmountElement = document.getElementById('timeseriesPendingAmount');
        const pendingCasesElement = document.getElementById('timeseriesPendingCases');
        
        if (collectedAmountElement) {
            collectedAmountElement.textContent = formatCurrency(totalCollected);
        }
        if (collectedCasesElement) {
            collectedCasesElement.textContent = totalCollectedCases.toLocaleString();
        }
        
        // Update Collected Cases Percentage
        const collectedCasesPercentElement = document.getElementById('timeseriesCollectedCasesPercent');
        if (collectedCasesPercentElement && totalCollectedCases + totalPendingCases > 0) {
            const collectedPercent = ((totalCollectedCases / (totalCollectedCases + totalPendingCases)) * 100).toFixed(1);
            collectedCasesPercentElement.textContent = collectedPercent + '% of Total';
        }
        
        if (pendingAmountElement) {
            pendingAmountElement.textContent = formatCurrency(totalPending);
        }
        if (pendingCasesElement) {
            pendingCasesElement.textContent = totalPendingCases.toLocaleString();
        }
        
        // Update Pending Cases Percentage
        const pendingCasesPercentElement = document.getElementById('timeseriesPendingCasesPercent');
        if (pendingCasesPercentElement && totalCollectedCases + totalPendingCases > 0) {
            const pendingPercent = ((totalPendingCases / (totalCollectedCases + totalPendingCases)) * 100).toFixed(1);
            pendingCasesPercentElement.textContent = pendingPercent + '% of Total';
        }
        
        const ctx = document.getElementById('timeSeriesChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.timeSeriesChartInstance) {
            window.timeSeriesChartInstance.destroy();
        }
        // Create the actual time series chart with real data
        const chartLabels = data.data.map(item => new Date(item.date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
        const repaymentData = data.data.map(item => item.repayment_amount);
        const collectedData = data.data.map(item => item.collected_amount);
        const collectionPercentageLabels = data.data.map(item => item.collection_percentage.toFixed(1) + '%');
        
        window.timeSeriesChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [
                    {
                        label: 'Repayment Amount',
                        data: repaymentData,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        tension: 0.1,
                        fill: false,
                        datalabels: {
                            display: false
                        }
                    },
                    {
                        label: 'Collected Amount',
                        data: collectedData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.1,
                        fill: false,
                        datalabels: {
                            display: true,
                            color: '#10b981',
                            anchor: 'end',
                            align: 'top',
                            offset: 10,
                            font: {
                                size: 10,
                                weight: 'bold'
                            },
                            formatter: function(value, context) {
                                return data.data[context.dataIndex].collection_percentage.toFixed(1) + '%';
                            }
                        }
                    }
                ]
            },
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        titleColor: '#f8fafc',
                        bodyColor: '#f8fafc',
                        borderColor: '#334155',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                return new Date(data.data[context[0].dataIndex].date).toLocaleDateString('en-IN', { 
                                    weekday: 'short', 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric' 
                                });
                            },
                            label: function(context) {
                                // Only show data for the first dataset to avoid duplication
                                if (context.datasetIndex === 0) {
                                    const dataIndex = context.dataIndex;
                                    const repaymentAmount = data.data[dataIndex].repayment_amount;
                                    const collectedAmount = data.data[dataIndex].collected_amount;
                                    const pendingAmount = data.data[dataIndex].pending_amount;
                                    const collectedCases = data.data[dataIndex].collected_cases;
                                    const pendingCases = data.data[dataIndex].pending_cases;
                                    const totalCases = collectedCases + pendingCases;
                                    const collectionPercentage = data.data[dataIndex].collection_percentage;
                                    const pendingPercentage = ((pendingAmount / repaymentAmount) * 100).toFixed(1);
                                    
                                    return [
                                        'Repayment Amount: ' + formatCurrency(repaymentAmount),
                                        'Collected Amount: ' + formatCurrency(collectedAmount),
                                        'Pending Amount: ' + formatCurrency(pendingAmount),
                                        'Total Cases: ' + totalCases.toLocaleString(),
                                        'Collected Cases: ' + collectedCases.toLocaleString(),
                                        'Pending Cases: ' + pendingCases.toLocaleString(),
                                        'Collection Rate: ' + collectionPercentage.toFixed(1) + '%',
                                        'Pending Rate: ' + pendingPercentage + '%'
                                    ];
                                }
                                return null; // Don't show label for second dataset
                            }
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    }
                }
            }
        });
        
        console.log('Time series chart created successfully');
        
        // Populate Collection % over Time table
        await populateCollectionOverTimeTable(data.data);
        
    } catch (error) {
        console.error('Error loading time series chart:', error);
        // Show error message in the chart container
        const chartContainer = document.getElementById('timeSeriesChart').parentElement;
        chartContainer.innerHTML = '<div class="flex items-center justify-center h-80 text-red-500">Error loading chart: ' + error.message + '</div>';
    }
}

// Function to populate Collection % over Time table
function populateCollectionOverTimeTable(timeSeriesData) {
    const tbody = document.getElementById('collectionOverTimeTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!timeSeriesData || timeSeriesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">No data available</td></tr>';
        return;
    }
    
    // Running totals
    let totalRepayment = 0;
    let totalCollected = 0;
    let totalPendingAmount = 0;
    let totalCollectedCases = 0;
    let totalPendingCases = 0;

    timeSeriesData.forEach(item => {
        const row = document.createElement('tr');
        row.className = 'border-b border-border hover:bg-gray-800/50';
        
        const date = new Date(item.date);
        const formattedDate = date.toLocaleDateString('en-IN', { 
            day: '2-digit', 
            month: 'short', 
            year: 'numeric'
        });
        
        const totalCases = item.collected_cases + item.pending_cases;
        const collectionPercent = item.collection_percentage || 0;
        const pendingPercent = ((item.pending_amount / item.repayment_amount) * 100) || 0;
        
        row.innerHTML = `
            <td class="py-3 px-4 text-foreground">${formattedDate}</td>
            <td class="py-3 px-4 text-right text-foreground font-medium">${formatCurrency(item.repayment_amount)}</td>
            <td class="py-3 px-4 text-right text-green-400 font-medium">${formatCurrency(item.collected_amount)}</td>
            <td class="py-3 px-4 text-right text-red-400 font-medium">${formatCurrency(item.pending_amount)}</td>
            <td class="py-3 px-4 text-right text-foreground">${totalCases.toLocaleString()}</td>
            <td class="py-3 px-4 text-right text-green-400">${item.collected_cases.toLocaleString()}</td>
            <td class="py-3 px-4 text-right text-red-400">${item.pending_cases.toLocaleString()}</td>
            <td class="py-3 px-4 text-right text-green-400 font-medium">${collectionPercent.toFixed(1)}%</td>
            <td class="py-3 px-4 text-right text-red-400 font-medium">${pendingPercent.toFixed(1)}%</td>
        `;
        
        tbody.appendChild(row);

        // Accumulate totals
        totalRepayment += Number(item.repayment_amount) || 0;
        totalCollected += Number(item.collected_amount) || 0;
        totalPendingAmount += Number(item.pending_amount) || 0;
        totalCollectedCases += Number(item.collected_cases) || 0;
        totalPendingCases += Number(item.pending_cases) || 0;
    });

    // Append totals row
    const totalsRow = document.createElement('tr');
    totalsRow.className = 'border-t-2 border-border bg-gray-900/40';
    const grandTotalCases = totalCollectedCases + totalPendingCases;
    const grandCollectionPercent = totalRepayment > 0 ? (totalCollected / totalRepayment) * 100 : 0;
    const grandPendingPercent = totalRepayment > 0 ? (totalPendingAmount / totalRepayment) * 100 : 0;

    totalsRow.innerHTML = `
        <td class="py-3 px-4 font-semibold text-foreground">Total</td>
        <td class="py-3 px-4 text-right font-semibold text-foreground">${formatCurrency(totalRepayment)}</td>
        <td class="py-3 px-4 text-right font-semibold text-green-400">${formatCurrency(totalCollected)}</td>
        <td class="py-3 px-4 text-right font-semibold text-red-400">${formatCurrency(totalPendingAmount)}</td>
        <td class="py-3 px-4 text-right font-semibold text-foreground">${grandTotalCases.toLocaleString()}</td>
        <td class="py-3 px-4 text-right font-semibold text-green-400">${totalCollectedCases.toLocaleString()}</td>
        <td class="py-3 px-4 text-right font-semibold text-red-400">${totalPendingCases.toLocaleString()}</td>
        <td class="py-3 px-4 text-right font-semibold text-green-400">${grandCollectionPercent.toFixed(1)}%</td>
        <td class="py-3 px-4 text-right font-semibold text-red-400">${grandPendingPercent.toFixed(1)}%</td>
    `;

    tbody.appendChild(totalsRow);
}

// ===============================
// LOAN COUNT WISE TAB FUNCTIONALITY
// ===============================

// Set default date range for loan count (last 30 days)
function setDefaultLoanCountDates() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    const startDateInput = document.getElementById('loanCountStartDate');
    const endDateInput = document.getElementById('loanCountEndDate');
    
    if (startDateInput && endDateInput) {
        startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
        endDateInput.value = today.toISOString().split('T')[0];
    }
}

// Load loan count data from API
async function loadLoanCountData() {
    try {
        console.log('=== LOADING LOAN COUNT DATA ===');
        
        const startDate = document.getElementById('loanCountStartDate').value;
        const endDate = document.getElementById('loanCountEndDate').value;
        
        console.log('Date values:', { startDate, endDate });
        
        if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
        }
        
        // Validate date range
        if (new Date(startDate) > new Date(endDate)) {
            alert('Start date must be before end date');
            return;
        }
        
        // Show loading state
        console.log('Showing loading state...');
        showLoanCountLoading();
        
        // Fetch data from backend API
        const apiUrl = `/api/loan-count-wise/?startDate=${startDate}&endDate=${endDate}`;
        console.log('Fetching from:', apiUrl);
        
        const response = await fetch(apiUrl);
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log('Loan count data received:', data);
        
        // Check if data exists
        if (!data.count_wise || data.count_wise.length === 0) {
            console.log('No data found, showing no data state');
            showLoanCountNoData();
            return;
        }
        
        // Update tables with data
        console.log('Updating tables with data...');
        updateCountWiseTable(data.count_wise);
        updateAmountWiseTable(data.amount_wise);

        // Load not closed percent table
        await loadNotClosedPercentTable(startDate, endDate);
        
        // Show tables
        console.log('Showing tables...');
        showLoanCountTables();
        
        console.log('=== LOAN COUNT DATA LOADING COMPLETE ===');
        
    } catch (error) {
        console.error('Error loading loan count data:', error);
        showLoanCountError(error.message);
    }
}

// Update count wise table
function updateCountWiseTable(data) {
    const tbody = document.getElementById('countWiseTableBody');
    const totalElement = document.getElementById('countWiseTotal');
    const badgeElement = document.getElementById('countWiseTotalCases');
    
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="py-8 text-center text-gray-400">No data available</td></tr>';
        if (totalElement) totalElement.textContent = '0';
        if (badgeElement) badgeElement.textContent = '0 Cases';
        return;
    }
    // Calculate total cases and find min/max for color scaling
    const totalCases = data.reduce((sum, item) => sum + parseInt(item.total_case || 0), 0);
    const caseValues = data.map(item => parseInt(item.total_case || 0));
    const minCases = Math.min(...caseValues);
    const maxCases = Math.max(...caseValues);
    const range = maxCases - minCases;
    
    // Update badge and total
    if (badgeElement) badgeElement.textContent = `${formatNumber(totalCases)} Cases`;
    if (totalElement) totalElement.textContent = formatNumber(totalCases);
    
    // Populate table rows
    data.forEach((item) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-700 hover:bg-gray-800/50 transition-colors';
        
        // Badge color based on total cases value (higher cases = redder color)
        const currentCases = parseInt(item.total_case || 0);
        const loanCount = parseInt(item.loan_count);
        let badgeClass = 'bg-gray-600';
        
        if (range === 0) {
            // All values are the same
            badgeClass = 'bg-orange-500';
        } else {
            // Calculate relative position (0 = lowest, 1 = highest)
            const relativePosition = (currentCases - minCases) / range;
            
            if (relativePosition <= 0.25) {
                badgeClass = 'bg-yellow-500'; // Lowest 25% - yellow
            } else if (relativePosition <= 0.5) {
                badgeClass = 'bg-orange-300'; // 25-50% - light orange
            } else if (relativePosition <= 0.75) {
                badgeClass = 'bg-orange-500'; // 50-75% - orange
            } else if (relativePosition <= 0.9) {
                badgeClass = 'bg-red-400'; // 75-90% - light red
            } else {
                badgeClass = 'bg-red-600'; // Top 10% - red
            }
        }
        
        row.innerHTML = `
            <td class="py-3 px-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${badgeClass} text-white">
                    ${loanCount} ${loanCount === 1 ? 'Loan' : 'Loans'}
                </span>
            </td>
            <td class="py-3 px-4 text-right font-medium text-white">${formatNumber(item.total_case)}</td>
            <td class="py-3 px-4 text-right font-medium text-white">${parseFloat(item.percentage_share).toFixed(2)}%</td>
        `;
        
        tbody.appendChild(row);
    });
}
// Update amount wise table
function updateAmountWiseTable(data) {
    const tbody = document.getElementById('amountWiseTableBody');
    const totalElement = document.getElementById('amountWiseTotal');
    const badgeElement = document.getElementById('amountWiseTotalAmount');
    
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="py-8 text-center text-gray-400">No data available</td></tr>';
        if (totalElement) totalElement.textContent = '₹0';
        if (badgeElement) badgeElement.textContent = '₹0';
        return;
    }
    
    // Calculate total due amount and find min/max for color scaling
    const totalDue = data.reduce((sum, item) => sum + parseFloat(item.total_due || 0), 0);
    const dueValues = data.map(item => parseFloat(item.total_due || 0));
    const minDue = Math.min(...dueValues);
    const maxDue = Math.max(...dueValues);
    const range = maxDue - minDue;
    
    // Update badge and total
    if (badgeElement) badgeElement.textContent = formatCurrency(totalDue);
    if (totalElement) totalElement.textContent = formatCurrency(totalDue);
    
    // Populate table rows
    data.forEach((item) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-700 hover:bg-gray-800/50 transition-colors';
        
        // Badge color based on total due amount (higher amount = redder color)
        const currentDue = parseFloat(item.total_due || 0);
        const loanCount = parseInt(item.loan_count);
        let badgeClass = 'bg-gray-600';
        
        if (range === 0) {
            // All values are the same
            badgeClass = 'bg-orange-500';
        } else {
            // Calculate relative position (0 = lowest, 1 = highest)
            const relativePosition = (currentDue - minDue) / range;
            
            if (relativePosition <= 0.25) {
                badgeClass = 'bg-yellow-500'; // Lowest 25% - yellow
            } else if (relativePosition <= 0.5) {
                badgeClass = 'bg-orange-300'; // 25-50% - light orange
            } else if (relativePosition <= 0.75) {
                badgeClass = 'bg-orange-500'; // 50-75% - orange
            } else if (relativePosition <= 0.9) {
                badgeClass = 'bg-red-400'; // 75-90% - light red
            } else {
                badgeClass = 'bg-red-600'; // Top 10% - red
            }
        }
        
        row.innerHTML = `
            <td class="py-3 px-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${badgeClass} text-white">
                    ${loanCount} ${loanCount === 1 ? 'Loan' : 'Loans'}
                </span>
            </td>
            <td class="py-3 px-4 text-right font-medium text-white">${formatCurrency(item.total_due)}</td>
            <td class="py-3 px-4 text-right font-medium text-white">${parseFloat(item.percentage_share).toFixed(2)}%</td>
        `;
        
        tbody.appendChild(row);
    });
}

function getLoanStageLabel(loanCount) {
    if (loanCount === 0) {
        return 'Fresh Loans';
    }

    const suffix = (n) => {
        const s = ['th', 'st', 'nd', 'rd'];
        const v = n % 100;
        return s[(v - 20) % 10] || s[v] || s[0];
    };

    return `${loanCount}${suffix(loanCount)} Reloan`;
}

async function loadNotClosedPercentTable(startDate, endDate) {
    const card = document.getElementById('notClosedPercentCard');
    if (!card) {
        return;
    }

    const loadingEl = document.getElementById('notClosedPercentLoading');
    const errorEl = document.getElementById('notClosedPercentError');
    const emptyEl = document.getElementById('notClosedPercentEmpty');
    const tableWrapper = document.getElementById('notClosedPercentTableWrapper');
    const summaryRow = document.getElementById('notClosedPercentSummaryRow');
    const rangeEl = document.getElementById('notClosedPercentRange');

    card.classList.remove('hidden');
    if (rangeEl) {
        rangeEl.textContent = `${startDate} → ${endDate}`;
    }

    loadingEl?.classList.remove('hidden');
    errorEl?.classList.add('hidden');
    emptyEl?.classList.add('hidden');
    tableWrapper?.classList.add('hidden');
    summaryRow?.classList.add('hidden');

    try {
        const url = `/api/not-closed-percent/?startDate=${startDate}&endDate=${endDate}`;
        const response = await fetch(url);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const payload = await response.json();
        const dataset = Array.isArray(payload.data) ? payload.data : [];

        updateNotClosedPercentTable(dataset);
    } catch (error) {
        console.error('Error loading not closed percent data:', error);
        if (errorEl) {
            errorEl.textContent = error.message || 'Failed to load not closed percentage data.';
            errorEl.classList.remove('hidden');
        }
    } finally {
        loadingEl?.classList.add('hidden');
    }
}

function updateNotClosedPercentTable(data) {
    const card = document.getElementById('notClosedPercentCard');
    const tableWrapper = document.getElementById('notClosedPercentTableWrapper');
    const tbody = document.getElementById('notClosedPercentTableBody');
    const emptyEl = document.getElementById('notClosedPercentEmpty');
    const summaryRow = document.getElementById('notClosedPercentSummaryRow');
    const summaryValueEl = document.getElementById('notClosedPercentSummaryValue');
    const summaryRatioEl = document.getElementById('notClosedPercentSummaryRatio');

    if (!card || !tbody) {
        return;
    }

    card.classList.remove('hidden');
    tbody.innerHTML = '';

    if (!data || data.length === 0) {
        emptyEl?.classList.remove('hidden');
        tableWrapper?.classList.add('hidden');
        summaryRow?.classList.add('hidden');
        return;
    }

    emptyEl?.classList.add('hidden');
    tableWrapper?.classList.remove('hidden');

    let totalLoans = 0;
    let totalNotClosedLoans = 0;
    let totalRepaymentAmount = 0;
    let totalNotClosedRepaymentAmount = 0;

    data.forEach(item => {
        const loanCount = item.loan_count ?? 0;
        const totalLoansValue = parseInt(item.total_loans ?? item.totalLoans ?? 0, 10) || 0;
        const notClosedLoansValue = parseInt(item.total_not_closed_loans ?? item.totalNotClosedLoans ?? 0, 10) || 0;
        const totalLoanAmount = parseFloat(item.total_loan_amount ?? item.totalLoanAmount ?? 0) || 0;
        const totalRepayment = parseFloat(item.total_repayment_amount ?? item.totalRepaymentAmount ?? 0) || 0;
        const notClosedLoanAmount = parseFloat(
            item.total_not_closed_loan_amount ??
            item.total_notclosed_loan_amount ??
            item.totalNotClosedLoanAmount ??
            0
        ) || 0;
        const notClosedRepayment = parseFloat(
            item.total_not_closed_repayment_amount ??
            item.total_notclosed_repayment_amount ??
            item.totalNotClosedRepaymentAmount ??
            0
        ) || 0;
        const rawRatio = item.not_closed_repayment_ratio_percent ??
            item.notclosed_repayment_ratio_percent ??
            item.notClosedRepaymentRatioPercent;
        const ratioPercent = rawRatio !== null && rawRatio !== undefined
            ? parseFloat(rawRatio)
            : null;

        totalLoans += totalLoansValue;
        totalNotClosedLoans += notClosedLoansValue;
        totalRepaymentAmount += totalRepayment;
        totalNotClosedRepaymentAmount += notClosedRepayment;

        const stageLabel = getLoanStageLabel(loanCount);

        const row = document.createElement('tr');
        row.className = 'border-b border-gray-700 hover:bg-gray-800/50 transition-colors';
        row.innerHTML = `
            <td class="py-3 px-4">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-blue-500/20 border border-blue-500/30 text-blue-200">
                    ${stageLabel}
                </span>
            </td>
            <td class="py-3 px-4 text-right font-medium text-white">${formatNumber(totalLoansValue)}</td>
            <td class="py-3 px-4 text-right font-medium text-amber-300">${formatNumber(notClosedLoansValue)}</td>
            <td class="py-3 px-4 text-right font-medium text-white">${formatCurrency(notClosedLoanAmount)}</td>
            <td class="py-3 px-4 text-right font-medium text-white">${formatCurrency(notClosedRepayment)}</td>
            <td class="py-3 px-4 text-right font-medium text-white">${formatCurrency(totalRepayment)}</td>
            <td class="py-3 px-4 text-right font-medium ${ratioPercent !== null ? 'text-red-400' : 'text-gray-400'}">
                ${ratioPercent !== null ? ratioPercent.toFixed(2) + '%' : '--'}
            </td>
        `;

        tbody.appendChild(row);
    });

    if (summaryRow) {
        const overallRatio = totalRepaymentAmount > 0
            ? (totalNotClosedRepaymentAmount / totalRepaymentAmount) * 100
            : 0;

        if (summaryValueEl) {
            summaryValueEl.textContent = `${formatNumber(totalNotClosedLoans)} not closed out of ${formatNumber(totalLoans)} loans`;
        }

        if (summaryRatioEl) {
            summaryRatioEl.textContent = `${overallRatio.toFixed(2)}%`;
        }

        summaryRow.classList.remove('hidden');
    }
}

// UI state management functions
function showLoanCountLoading() {
    document.getElementById('loanCountLoading')?.classList.remove('hidden');
    document.getElementById('loanCountError')?.classList.add('hidden');
    document.getElementById('loanCountTables')?.classList.add('hidden');
    document.getElementById('loanCountNoData')?.classList.add('hidden');
    document.getElementById('notClosedPercentCard')?.classList.add('hidden');
}

function showLoanCountTables() {
    document.getElementById('loanCountLoading')?.classList.add('hidden');
    document.getElementById('loanCountError')?.classList.add('hidden');
    document.getElementById('loanCountTables')?.classList.remove('hidden');
    document.getElementById('loanCountNoData')?.classList.add('hidden');
}

function showLoanCountError(message) {
    document.getElementById('loanCountLoading')?.classList.add('hidden');
    document.getElementById('loanCountError')?.classList.remove('hidden');
    document.getElementById('loanCountTables')?.classList.add('hidden');
    document.getElementById('loanCountNoData')?.classList.add('hidden');
    document.getElementById('notClosedPercentCard')?.classList.add('hidden');
    
    const errorMessageEl = document.getElementById('loanCountErrorMessage');
    if (errorMessageEl) {
        errorMessageEl.textContent = message || 'Failed to load data. Please try again.';
    }
}

function showLoanCountNoData() {
    document.getElementById('loanCountLoading')?.classList.add('hidden');
    document.getElementById('loanCountError')?.classList.add('hidden');
    document.getElementById('loanCountTables')?.classList.add('hidden');
    document.getElementById('loanCountNoData')?.classList.remove('hidden');
    document.getElementById('notClosedPercentCard')?.classList.add('hidden');
}

// Apply filters button handler
function applyLoanCountFilters() {
    console.log('=== APPLY LOAN COUNT FILTERS CLICKED ===');
    console.log('Button click detected');
    
    // Test if elements exist
    const startDateEl = document.getElementById('loanCountStartDate');
    const endDateEl = document.getElementById('loanCountEndDate');
    
    console.log('Elements found:', {
        startDateEl: !!startDateEl,
        endDateEl: !!endDateEl,
        startDate: startDateEl?.value,
        endDate: endDateEl?.value
    });
    
    if (!startDateEl || !endDateEl) {
        console.error('Date elements not found!');
        alert('Date input elements not found. Please refresh the page.');
        return;
    }
    
    loadLoanCountData();
}

// Reset filters button handler
function resetLoanCountFilters() {
    setDefaultLoanCountDates();
    loadLoanCountData();
}

// ===============================
// CREDIT PERSON WISE TAB FUNCTIONALITY
// ===============================

const CREDIT_PERSON_API_BASE = '/api/credit-person-wise/';

function setDefaultCreditPersonDates() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    const startDateInput = document.getElementById('creditPersonStartDate');
    const endDateInput = document.getElementById('creditPersonEndDate');
    
    if (startDateInput && !startDateInput.value) {
        startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
    }
    if (endDateInput && !endDateInput.value) {
        endDateInput.value = today.toISOString().split('T')[0];
    }
}

function getCreditPersonDateRange() {
    const startInput = document.getElementById('creditPersonStartDate');
    const endInput = document.getElementById('creditPersonEndDate');
    return {
        startDate: startInput?.value,
        endDate: endInput?.value
    };
}

function getCreditPersonLoanType() {
    const loanTypeInput = document.getElementById('creditPersonLoanType');
    return loanTypeInput?.value || 'all';
}

async function loadCreditPersonData() {
    const loadingEl = document.getElementById('creditPersonLoading');
    const errorEl = document.getElementById('creditPersonError');
    const errorMessageEl = document.getElementById('creditPersonErrorMessage');
    const noDataEl = document.getElementById('creditPersonNoData');
    const dataSectionEl = document.getElementById('creditPersonDataSection');

    const { startDate, endDate } = getCreditPersonDateRange();
    const loanType = getCreditPersonLoanType();

    loadingEl?.classList.remove('hidden');
    errorEl?.classList.add('hidden');
    noDataEl?.classList.add('hidden');
    dataSectionEl?.classList.add('hidden');

    if (!startDate || !endDate) {
        loadingEl?.classList.add('hidden');
        alert('Please select both start and end dates for Credit Person Wise data.');
        return;
    }

    if (new Date(startDate) > new Date(endDate)) {
        loadingEl?.classList.add('hidden');
        alert('Start date must be before end date for Credit Person Wise data.');
        return;
    }

    try {
        const params = new URLSearchParams({
            start_date: startDate,
            end_date: endDate
        });

        const response = await fetch(`${CREDIT_PERSON_API_BASE}?${params.toString()}`);
        if (!response.ok) {
            throw new Error(`API responded with status ${response.status}`);
        }

        const apiData = await response.json();
        let records = Array.isArray(apiData?.data) ? apiData.data : [];

        if (!records.length) {
            noDataEl?.classList.remove('hidden');
            return;
        }

        records = records.filter(record => {
            const isReloan = record.is_reloan_case === true || record.is_reloan_case === 'true';
            if (loanType === 'fresh') {
                return !isReloan;
            }
            if (loanType === 'reloan') {
                return isReloan;
            }
            return true;
        });

        if (!records.length) {
            noDataEl?.classList.remove('hidden');
            return;
        }

        const aggregated = aggregateCreditPersonData(records);
        if (!aggregated.length) {
            noDataEl?.classList.remove('hidden');
            return;
        }

        renderCreditPersonSummary(aggregated);
        renderCreditPersonChart(aggregated);
        renderCreditPersonTable(aggregated);

        dataSectionEl?.classList.remove('hidden');
    } catch (error) {
        console.error('Error loading credit person data:', error);
        if (errorMessageEl) {
            errorMessageEl.textContent = error.message || 'Failed to load data. Please try again later.';
        }
        errorEl?.classList.remove('hidden');
    } finally {
        loadingEl?.classList.add('hidden');
    }
}

function aggregateCreditPersonData(records) {
    const creditMap = new Map();

    records.forEach(record => {
        const preferredAssignee =
            (record.assigned_at_audit_stage && record.assigned_at_audit_stage.trim() && record.assigned_at_audit_stage.trim() !== 'Not Assigned' ? record.assigned_at_audit_stage.trim() : null) ||
            (record.assigned_at_bre_stage && record.assigned_at_bre_stage.trim() && record.assigned_at_bre_stage.trim() !== 'Not Assigned' ? record.assigned_at_bre_stage.trim() : null) ||
            (record.assigned_at_partial_stage && record.assigned_at_partial_stage.trim() && record.assigned_at_partial_stage.trim() !== 'Not Assigned' ? record.assigned_at_partial_stage.trim() : null) ||
            'Unassigned';

        const key = preferredAssignee;

        if (!creditMap.has(key)) {
            creditMap.set(key, {
                person: key,
                totalLoans: 0,
                recoveredLoans: 0,
                notRecoveredLoans: 0,
                freshLoans: 0,
                reloanLoans: 0,
                loanAmount: 0,
                repaymentAmount: 0,
                receivedAmount: 0,
                pendingAmount: 0,
                freshRepaymentAmount: 0,
                reloanRepaymentAmount: 0,
                freshReceivedAmount: 0,
                reloanReceivedAmount: 0,
                freshPendingAmount: 0,
                reloanPendingAmount: 0
            });
        }

        const entry = creditMap.get(key);
        entry.totalLoans += 1;

        const isReloanCase = record.is_reloan_case === true || record.is_reloan_case === 'true';
        if (isReloanCase) {
            entry.reloanLoans += 1;
        } else {
            entry.freshLoans += 1;
        }

        const rawLoanAmount = record.loan_amount ?? record.net_disbursal ?? record.disbursed_amount;
        const rawRepaymentAmount = record.repayment_amount ?? record.total_repayment ?? record.repaymentAmount;
        const rawReceivedAmount = record.received_amount ?? record.total_received ?? record.collected_amount ?? record.receivedAmount;

        const loanAmount = parseFloat(rawLoanAmount ?? 0) || 0;
        const repaymentAmount = parseFloat(rawRepaymentAmount ?? 0) || 0;
        const receivedAmount = parseFloat(rawReceivedAmount ?? 0) || 0;
        const pendingAmount = Math.max(repaymentAmount - receivedAmount, 0);

        entry.loanAmount += loanAmount;
        entry.repaymentAmount += repaymentAmount;
        entry.receivedAmount += receivedAmount;
        entry.pendingAmount += pendingAmount;
        if (isReloanCase) {
            entry.reloanRepaymentAmount += repaymentAmount;
            entry.reloanReceivedAmount += receivedAmount;
            entry.reloanPendingAmount += pendingAmount;
        } else {
            entry.freshRepaymentAmount += repaymentAmount;
            entry.freshReceivedAmount += receivedAmount;
            entry.freshPendingAmount += pendingAmount;
        }

        const closedStatus = (record.closed_status || record.loan_status || '').toLowerCase();
        if (closedStatus === 'not closed') {
            entry.notRecoveredLoans += 1;
        } else if (closedStatus) {
            entry.recoveredLoans += 1;
        } else {
            entry.recoveredLoans += 1;
        }
    });

    return Array.from(creditMap.values())
        .map(entry => {
            entry.recoveryRate = entry.repaymentAmount > 0 ? (entry.receivedAmount / entry.repaymentAmount) * 100 : 0;
            entry.pendingRate = entry.repaymentAmount > 0 ? (entry.pendingAmount / entry.repaymentAmount) * 100 : 0;
            return entry;
        })
        .sort((a, b) => b.pendingAmount - a.pendingAmount);
}

function renderCreditPersonSummary(data) {
    const totalOfficers = data.length;
    const totals = data.reduce(
        (acc, item) => {
            acc.totalLoans += item.totalLoans;
            acc.freshLoans += item.freshLoans;
            acc.reloanLoans += item.reloanLoans;
            acc.recoveredLoans += item.recoveredLoans;
            acc.repaymentAmount += item.repaymentAmount;
            acc.receivedAmount += item.receivedAmount;
            acc.pendingAmount += item.pendingAmount;
            acc.freshRepaymentAmount += item.freshRepaymentAmount ?? 0;
            acc.freshReceivedAmount += item.freshReceivedAmount ?? 0;
            acc.freshPendingAmount += item.freshPendingAmount ?? 0;
            acc.reloanRepaymentAmount += item.reloanRepaymentAmount ?? 0;
            acc.reloanReceivedAmount += item.reloanReceivedAmount ?? 0;
            acc.reloanPendingAmount += item.reloanPendingAmount ?? 0;
            return acc;
        },
        {
            totalLoans: 0,
            freshLoans: 0,
            reloanLoans: 0,
            recoveredLoans: 0,
            repaymentAmount: 0,
            receivedAmount: 0,
            pendingAmount: 0,
            freshRepaymentAmount: 0,
            freshReceivedAmount: 0,
            freshPendingAmount: 0,
            reloanRepaymentAmount: 0,
            reloanReceivedAmount: 0,
            reloanPendingAmount: 0
        }
    );

    const overallRecoveryRate = totals.repaymentAmount > 0 ? (totals.receivedAmount / totals.repaymentAmount) * 100 : 0;

    const officersEl = document.getElementById('creditPersonTotalOfficers');
    const loansEl = document.getElementById('creditPersonTotalLoans');
    const recoveryRateEl = document.getElementById('creditPersonRecoveryRate');
    const pendingAmountEl = document.getElementById('creditPersonPendingAmount');

    if (officersEl) officersEl.textContent = totalOfficers.toLocaleString('en-IN');
    if (loansEl) {
        loansEl.innerHTML = `
            <span class="text-2xl font-semibold text-white">${totals.totalLoans.toLocaleString('en-IN')}</span>
            <div class="flex items-center gap-2 mt-1">
                <span class="text-xs text-emerald-300 bg-emerald-500/10 border border-emerald-500/20 px-2 py-0.5 rounded-full">
                    Fresh: ${totals.freshLoans.toLocaleString('en-IN')}
                </span>
                <span class="text-xs text-amber-300 bg-amber-500/10 border border-amber-500/20 px-2 py-0.5 rounded-full">
                    Reloan: ${totals.reloanLoans.toLocaleString('en-IN')}
                </span>
            </div>
        `;
    }
    if (recoveryRateEl) {
        const freshRecoveryRate = totals.freshRepaymentAmount > 0
            ? (totals.freshReceivedAmount / totals.freshRepaymentAmount) * 100
            : 0;
        const reloanRecoveryRate = totals.reloanRepaymentAmount > 0
            ? (totals.reloanReceivedAmount / totals.reloanRepaymentAmount) * 100
            : 0;
        recoveryRateEl.innerHTML = `
            <span class="text-2xl font-semibold text-white">${overallRecoveryRate.toFixed(1)}%</span>
            <div class="flex items-center gap-2 mt-1">
                <span class="text-xs text-emerald-300 bg-emerald-500/10 border border-emerald-500/20 px-2 py-0.5 rounded-full">
                    Fresh: ${freshRecoveryRate.toFixed(1)}%
                </span>
                <span class="text-xs text-amber-300 bg-amber-500/10 border border-amber-500/20 px-2 py-0.5 rounded-full">
                    Reloan: ${reloanRecoveryRate.toFixed(1)}%
                </span>
            </div>
        `;
    }
    if (pendingAmountEl) {
        pendingAmountEl.innerHTML = `
            <span class="text-2xl font-semibold text-white">${formatCurrency(totals.pendingAmount)}</span>
            <div class="flex items-center gap-2 mt-1">
                <span class="text-xs text-emerald-300 bg-emerald-500/10 border border-emerald-500/20 px-2 py-0.5 rounded-full">
                    Fresh: ${formatCurrency(totals.freshPendingAmount)}
                </span>
                <span class="text-xs text-amber-300 bg-amber-500/10 border border-amber-500/20 px-2 py-0.5 rounded-full">
                    Reloan: ${formatCurrency(totals.reloanPendingAmount)}
                </span>
            </div>
        `;
    }
}

function renderCreditPersonChart(data) {
    const canvas = document.getElementById('creditPersonChart');
    if (!canvas) {
        return;
    }

    const ctx = canvas.getContext('2d');
    const topData = data.slice(0, 10);
    const labels = topData.map(item => item.person);
    const pendingValues = topData.map(item => Number(item.pendingAmount.toFixed(2)));
    const collectedValues = topData.map(item => Number(item.receivedAmount.toFixed(2)));
    const creditPersonDataMap = {};
    topData.forEach(item => {
        creditPersonDataMap[item.person] = item;
    });

    if (window.creditPersonChartInstance) {
        window.creditPersonChartInstance.destroy();
    }

    const axisFormatter = value => {
        if (value >= 10000000) return '₹' + (value / 10000000).toFixed(1) + ' Cr';
        if (value >= 100000) return '₹' + (value / 100000).toFixed(1) + ' L';
        if (value >= 1000) return '₹' + (value / 1000).toFixed(1) + ' K';
        return '₹' + value.toLocaleString('en-IN');
    };

    window.creditPersonChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                {
                    label: 'Pending Amount (₹)',
                    data: pendingValues,
                    backgroundColor: 'rgba(248, 113, 113, 0.85)',
                    borderColor: 'rgba(248, 113, 113, 1)',
                    borderWidth: 1,
                    order: 2
                },
                {
                    label: 'Collected Amount (₹)',
                    data: collectedValues,
                    backgroundColor: 'rgba(16, 185, 129, 0.85)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 1,
                    order: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#d1d5db',
                        font: {
                            family: 'Inter, sans-serif',
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#1f2937',
                    borderWidth: 1,
                    callbacks: {
                        title: function(context) {
                            return context[0]?.label || '';
                        },
                        label: function(context) {
                            const label = context.dataset.label || '';
                            return `${label}: ${formatCurrency(context.parsed.y)}`;
                        },
                        afterBody: function(context) {
                            const label = context[0]?.label;
                            const info = creditPersonDataMap[label];
                            if (!info) {
                                return [];
                            }
                            const repaymentAmount = info.repaymentAmount || 0;
                            const collectionPercent = repaymentAmount > 0 ? (info.receivedAmount / repaymentAmount) * 100 : 0;
                            return [
                                `Repayment Amount: ${formatCurrency(repaymentAmount)}`,
                                `Collection %: ${collectionPercent.toFixed(1)}%`
                            ];
                        }
                    }
                },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    color: '#d1d5db',
                    font: {
                        weight: '600',
                        size: 10
                    },
                    formatter: value => formatCurrency(value)
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#9ca3af',
                        font: {
                            family: 'Inter, sans-serif'
                        }
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    ticks: {
                        color: '#9ca3af',
                        callback: value => axisFormatter(value)
                    },
                    grid: {
                        color: 'rgba(75, 85, 99, 0.2)'
                    }
                }
            }
        }
    });
}

function renderCreditPersonTable(data) {
    const tbody = document.getElementById('creditPersonTableBody');
    if (!tbody) {
        return;
    }

    tbody.innerHTML = '';

    const totals = {
        totalLoans: 0,
        freshLoans: 0,
        reloanLoans: 0,
        recoveredLoans: 0,
        notRecoveredLoans: 0,
        loanAmount: 0,
        repaymentAmount: 0,
        receivedAmount: 0,
        pendingAmount: 0
    };

    data.forEach(item => {
        totals.totalLoans += item.totalLoans;
        totals.freshLoans += item.freshLoans;
        totals.reloanLoans += item.reloanLoans;
        totals.recoveredLoans += item.recoveredLoans;
        totals.notRecoveredLoans += item.notRecoveredLoans;
        totals.loanAmount += item.loanAmount;
        totals.repaymentAmount += item.repaymentAmount;
        totals.receivedAmount += item.receivedAmount;
        totals.pendingAmount += item.pendingAmount;

        const row = document.createElement('tr');
        row.className = 'border-b border-gray-800 hover:bg-gray-800/30 transition-colors';
        row.innerHTML = `
            <td class="py-3 px-4 text-sm font-medium text-white">${item.person}</td>
            <td class="py-3 px-4 text-right text-gray-300">
                <div class="flex flex-col items-end space-y-1">
                    <span class="text-sm font-semibold text-foreground">${item.totalLoans.toLocaleString('en-IN')} total</span>
                    <span class="text-xs text-emerald-300">Fresh: ${item.freshLoans.toLocaleString('en-IN')}</span>
                    <span class="text-xs text-amber-300">Reloan: ${item.reloanLoans.toLocaleString('en-IN')}</span>
                </div>
            </td>
            <td class="py-3 px-4 text-right text-green-400">${item.recoveredLoans.toLocaleString('en-IN')}</td>
            <td class="py-3 px-4 text-right text-red-400">${item.notRecoveredLoans.toLocaleString('en-IN')}</td>
            <td class="py-3 px-4 text-right text-blue-300">${item.recoveryRate.toFixed(1)}%</td>
            <td class="py-3 px-4 text-right text-gray-300">${formatCurrency(item.loanAmount)}</td>
            <td class="py-3 px-4 text-right text-gray-300">${formatCurrency(item.repaymentAmount)}</td>
            <td class="py-3 px-4 text-right text-green-400">${formatCurrency(item.receivedAmount)}</td>
            <td class="py-3 px-4 text-right text-red-400">${formatCurrency(item.pendingAmount)}</td>
        `;
        tbody.appendChild(row);
    });

    const totalsRow = document.createElement('tr');
    totalsRow.className = 'border-t-2 border-border bg-gray-900/40';
    const recoveryRate = totals.repaymentAmount > 0 ? (totals.receivedAmount / totals.repaymentAmount) * 100 : 0;

    totalsRow.innerHTML = `
        <td class="py-3 px-4 font-semibold text-foreground">Total</td>
        <td class="py-3 px-4 text-right font-semibold text-foreground">
            <div class="flex flex-col items-end space-y-0.5">
                <span>${totals.totalLoans.toLocaleString('en-IN')} total</span>
                <span class="text-xs text-emerald-300 font-normal">Fresh: ${totals.freshLoans.toLocaleString('en-IN')}</span>
                <span class="text-xs text-amber-300 font-normal">Reloan: ${totals.reloanLoans.toLocaleString('en-IN')}</span>
            </div>
        </td>
        <td class="py-3 px-4 text-right font-semibold text-green-400">${totals.recoveredLoans.toLocaleString('en-IN')}</td>
        <td class="py-3 px-4 text-right font-semibold text-red-400">${totals.notRecoveredLoans.toLocaleString('en-IN')}</td>
        <td class="py-3 px-4 text-right font-semibold text-blue-300">${recoveryRate.toFixed(1)}%</td>
        <td class="py-3 px-4 text-right font-semibold text-foreground">${formatCurrency(totals.loanAmount)}</td>
        <td class="py-3 px-4 text-right font-semibold text-foreground">${formatCurrency(totals.repaymentAmount)}</td>
        <td class="py-3 px-4 text-right font-semibold text-green-400">${formatCurrency(totals.receivedAmount)}</td>
        <td class="py-3 px-4 text-right font-semibold text-red-400">${formatCurrency(totals.pendingAmount)}</td>
    `;

    tbody.appendChild(totalsRow);
}

function applyCreditPersonFilters() {
    loadCreditPersonData();
}

function resetCreditPersonFilters() {
    const startInput = document.getElementById('creditPersonStartDate');
    const endInput = document.getElementById('creditPersonEndDate');
    const loanTypeInput = document.getElementById('creditPersonLoanType');
    if (startInput) startInput.value = '';
    if (endInput) endInput.value = '';
    if (loanTypeInput) loanTypeInput.value = 'all';
    setDefaultCreditPersonDates();
    loadCreditPersonData();
}

// ===============================
// DISBURSAL SUMMARY TAB FUNCTIONALITY
// ===============================

// Toggle filter section collapse/expand
function toggleDisbursalFilters() {
    const content = document.getElementById('disbursalFiltersContent');
    const icon = document.getElementById('disbursalFiltersToggleIcon');
    
    if (content && icon) {
        const isHidden = content.classList.contains('hidden');
        
        if (isHidden) {
            // Expand: remove hidden class and rotate icon to 0deg (pointing down)
            content.classList.remove('hidden');
            icon.style.transform = 'rotate(0deg)';
        } else {
            // Collapse: add hidden class and rotate icon to 180deg (pointing up)
            content.classList.add('hidden');
            icon.style.transform = 'rotate(180deg)';
        }
    }
}

// Initialize filter section as collapsed on page load
function initializeDisbursalFilters() {
    const content = document.getElementById('disbursalFiltersContent');
    const icon = document.getElementById('disbursalFiltersToggleIcon');
    
    if (content && icon) {
        // Ensure it's collapsed by default (icon pointing up)
        content.classList.add('hidden');
        icon.style.transform = 'rotate(180deg)';
    }
}

function setDefaultDisbursalDates() {
    const today = new Date();
    // Format as YYYY-MM-DD
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const todayStr = `${year}-${month}-${day}`;
    
    const startDateInput = document.getElementById('disbursalStartDate');
    const endDateInput = document.getElementById('disbursalEndDate');
    
    if (startDateInput && endDateInput) {
        // Always set both dates to today by default
        startDateInput.value = todayStr;
        endDateInput.value = todayStr;
        console.log('Set default disbursal dates to:', todayStr);
    } else {
        console.warn('Disbursal date inputs not found');
    }
    
    return todayStr;
}

// Initialize pagination variable - ensure it's always a number
if (typeof window.disbursalCurrentPage === 'undefined' || 
    typeof window.disbursalCurrentPage !== 'number' ||
    isNaN(window.disbursalCurrentPage) || 
    window.disbursalCurrentPage < 1) {
    window.disbursalCurrentPage = 1;
} else {
    // Ensure it's an integer
    window.disbursalCurrentPage = parseInt(window.disbursalCurrentPage, 10);
}

function handleDisbursalDateChange() {
    // Auto-load data when dates change (if both dates are set)
    const startDate = document.getElementById('disbursalStartDate').value;
    const endDate = document.getElementById('disbursalEndDate').value;
    
    if (startDate && endDate) {
        // Reset to page 1 when dates change
        window.disbursalCurrentPage = 1;
        loadDisbursalData();
    }
}

async function loadDisbursalData() {
    try {
        const startDateInput = document.getElementById('disbursalStartDate');
        const endDateInput = document.getElementById('disbursalEndDate');
        
        if (!startDateInput || !endDateInput) {
            console.error('Date inputs not found');
            return;
        }
        
        let startDate = startDateInput.value;
        let endDate = endDateInput.value;
        
        // If dates are not set, set them to today
        if (!startDate || !endDate) {
            console.log('Dates not set, setting to today');
            setDefaultDisbursalDates();
            startDate = startDateInput.value;
            endDate = endDateInput.value;
        }
        
        console.log('Loading disbursal data for dates:', { startDate, endDate });
        
        if (!startDate || !endDate) {
            console.error('Dates still not set after default');
            alert('Please select both start and end dates');
            return;
        }
        
        // Get filter values
        const stateFilter = document.getElementById('disbursalStateFilter')?.value || '';
        const cityFilter = document.getElementById('disbursalCityFilter')?.value || '';
        const reloanFilter = document.getElementById('disbursalReloanFilter')?.value || '';
        const tenureFilter = document.getElementById('disbursalTenureFilter')?.value || '';
        
        // Get current page (default to 1) - ensure it's a valid integer
        let currentPage = window.disbursalCurrentPage;
        if (!currentPage || isNaN(currentPage) || currentPage < 1) {
            currentPage = 1;
            window.disbursalCurrentPage = 1;
        }
        currentPage = parseInt(currentPage, 10);
        
        // Build query parameters
        const params = new URLSearchParams({
            startDate: startDate,
            endDate: endDate,
            page: currentPage.toString()
        });
        
        if (stateFilter) params.append('state', stateFilter);
        if (cityFilter) params.append('city', cityFilter);
        if (reloanFilter) params.append('reloan', reloanFilter);
        if (tenureFilter) params.append('tenure', tenureFilter);
        
        console.log('Fetching from API with params:', params.toString());
        
        // Show loading state
        document.getElementById('disbursalLoading').classList.remove('hidden');
        document.getElementById('disbursalError').classList.add('hidden');
        document.getElementById('disbursalSummaryCards').classList.add('hidden');
        document.getElementById('disbursalCharts').classList.add('hidden');
        document.getElementById('disbursalTableWrapper').classList.add('hidden');
        document.getElementById('disbursalNoData').classList.add('hidden');
        
        const apiUrl = `/api/disbursal-summary/?${params.toString()}`;
        console.log('Fetching disbursal data from:', apiUrl);
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API error response:', errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        console.log('API response received:', {
            dateRange: `${startDate} to ${endDate}`,
            recordsCount: data.records?.length || 0,
            summary: data.summary,
            hasChartData: !!data.chart_data,
            firstRecordDate: data.records?.[0]?.disbursal_date || 'N/A'
        });
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Hide loading state
        document.getElementById('disbursalLoading').classList.add('hidden');
        
        // Update filter dropdowns with available options
        if (data.filters) {
            updateDisbursalFilterOptions(data.filters);
        }
        
        // Update summary cards
        if (data.summary) {
            updateDisbursalSummaryCards(data.summary);
        }
        
        // Update pie charts
        if (data.chart_data) {
            if (data.chart_data.state && data.chart_data.state.length > 0) {
                updateDisbursalStateChart(data.chart_data.state);
            }
            if (data.chart_data.city && data.chart_data.city.length > 0) {
                updateDisbursalCityChart(data.chart_data.city);
            }
            document.getElementById('disbursalCharts').classList.remove('hidden');
        } else {
            document.getElementById('disbursalCharts').classList.add('hidden');
        }
        
        // Update table
        updateDisbursalTable(data.records, data.pagination);
        
        // Show data sections
        if (data.records && data.records.length > 0) {
            document.getElementById('disbursalSummaryCards').classList.remove('hidden');
            document.getElementById('disbursalTableWrapper').classList.remove('hidden');
            document.getElementById('disbursalNoData').classList.add('hidden');
        } else {
            document.getElementById('disbursalSummaryCards').classList.add('hidden');
            document.getElementById('disbursalTableWrapper').classList.add('hidden');
            document.getElementById('disbursalNoData').classList.remove('hidden');
        }
        
    } catch (error) {
        console.error('Error loading disbursal data:', error);
        document.getElementById('disbursalLoading').classList.add('hidden');
        document.getElementById('disbursalError').classList.remove('hidden');
        document.getElementById('disbursalErrorMessage').textContent = error.message || 'Failed to load disbursal data. Please try again.';
        document.getElementById('disbursalSummaryCards').classList.add('hidden');
        document.getElementById('disbursalCharts').classList.add('hidden');
        document.getElementById('disbursalTableWrapper').classList.add('hidden');
        document.getElementById('disbursalNoData').classList.add('hidden');
    }
}

function updateDisbursalFilterOptions(filters) {
    if (!filters) return;
    
    // Update state dropdown
    const stateSelect = document.getElementById('disbursalStateFilter');
    const currentState = stateSelect.value;
    
    // Clear existing options except "All States"
    stateSelect.innerHTML = '<option value="">All States</option>';
    
    // Add states from filters
    if (filters.unique_states && filters.unique_states.length > 0) {
        filters.unique_states.forEach(state => {
            const option = document.createElement('option');
            option.value = state;
            option.textContent = state;
            if (state === currentState) {
                option.selected = true;
            }
            stateSelect.appendChild(option);
        });
    }
    
    // Update city dropdown - use cities from filters if available, otherwise fetch from API
    const citySelect = document.getElementById('disbursalCityFilter');
    const currentCity = citySelect.value;
    
    if (filters.unique_cities && filters.unique_cities.length > 0) {
        // Use cities from filter results
        citySelect.innerHTML = '<option value="">All Cities</option>';
        filters.unique_cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            if (city === currentCity) {
                option.selected = true;
            }
            citySelect.appendChild(option);
        });
    } else if (currentState) {
        // If state is selected but no cities in filters, fetch from API
        loadDisbursalCities();
    } else {
        // No state selected, clear cities
        citySelect.innerHTML = '<option value="">All Cities</option>';
    }
}

async function loadDisbursalCities() {
    const stateSelect = document.getElementById('disbursalStateFilter');
    const citySelect = document.getElementById('disbursalCityFilter');
    const selectedState = stateSelect.value;
    const currentCity = citySelect.value;
    
    // Clear existing options except "All Cities"
    citySelect.innerHTML = '<option value="">All Cities</option>';
    
    if (!selectedState) {
        return;
    }
    
    // Fetch cities for the selected state
    try {
        const params = new URLSearchParams({ state: selectedState });
        const response = await fetch(`/api/cities-by-state/?${params.toString()}`);
        const data = await response.json();
        
        if (data.cities && data.cities.length > 0) {
            data.cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                if (city === currentCity) {
                    option.selected = true;
                }
                citySelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading cities:', error);
    }
}

function updateDisbursalSummaryCards(summary) {
    if (!summary) return;
    
    // Total Records
    document.getElementById('disbursalTotalRecords').textContent = summary.total_records || 0;
    document.getElementById('disbursalFreshRecords').textContent = summary.fresh_count || 0;
    document.getElementById('disbursalReloanRecords').textContent = summary.reloan_count || 0;
    
    // Total Loan Amount
    document.getElementById('disbursalTotalLoanAmount').textContent = formatCurrency(summary.total_loan_amount || 0);
    document.getElementById('disbursalFreshLoanAmount').textContent = formatCurrency(summary.fresh_loan_amount || 0);
    document.getElementById('disbursalReloanLoanAmount').textContent = formatCurrency(summary.reloan_loan_amount || 0);
    
    // Total Disbursal Amount
    document.getElementById('disbursalTotalDisbursalAmount').textContent = formatCurrency(summary.total_disbursal_amount || 0);
    document.getElementById('disbursalFreshDisbursalAmount').textContent = formatCurrency(summary.fresh_disbursal_amount || 0);
    document.getElementById('disbursalReloanDisbursalAmount').textContent = formatCurrency(summary.reloan_disbursal_amount || 0);
    
    // Processing Fee
    document.getElementById('disbursalProcessingFee').textContent = formatCurrency(summary.total_processing_fee || 0);
    document.getElementById('disbursalFreshProcessingFee').textContent = formatCurrency(summary.fresh_processing_fee || 0);
    document.getElementById('disbursalReloanProcessingFee').textContent = formatCurrency(summary.reloan_processing_fee || 0);
    
    // Interest Amount
    document.getElementById('disbursalInterestAmount').textContent = formatCurrency(summary.total_interest_amount || 0);
    document.getElementById('disbursalFreshInterestAmount').textContent = formatCurrency(summary.fresh_interest_amount || 0);
    document.getElementById('disbursalReloanInterestAmount').textContent = formatCurrency(summary.reloan_interest_amount || 0);
    
    // Repayment Amount
    document.getElementById('disbursalRepaymentAmount').textContent = formatCurrency(summary.total_repayment_amount || 0);
    document.getElementById('disbursalFreshRepaymentAmount').textContent = formatCurrency(summary.fresh_repayment_amount || 0);
    document.getElementById('disbursalReloanRepaymentAmount').textContent = formatCurrency(summary.reloan_repayment_amount || 0);
}

function updateDisbursalTable(records, pagination) {
    const tbody = document.getElementById('disbursalTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!records || records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="py-8 text-center text-gray-400">No data available</td></tr>';
        document.getElementById('disbursalRecordCount').textContent = '0';
        document.getElementById('disbursalPagination').classList.add('hidden');
        return;
    }
    
    // Update pagination info
    if (pagination) {
        const startRecord = ((pagination.current_page - 1) * pagination.per_page) + 1;
        const endRecord = Math.min(startRecord + pagination.per_page - 1, pagination.total_records);
        
        document.getElementById('disbursalPageInfo').textContent = `${startRecord}-${endRecord}`;
        document.getElementById('disbursalTotalRecords').textContent = pagination.total_records.toLocaleString('en-IN');
        document.getElementById('disbursalCurrentPage').textContent = pagination.current_page;
        document.getElementById('disbursalTotalPages').textContent = pagination.total_pages;
        
        // Update pagination buttons
        const prevBtn = document.getElementById('disbursalPrevBtn');
        const nextBtn = document.getElementById('disbursalNextBtn');
        
        if (prevBtn) {
            prevBtn.disabled = !pagination.has_previous;
        }
        if (nextBtn) {
            nextBtn.disabled = !pagination.has_next;
        }
        
        // Show pagination controls
        document.getElementById('disbursalPagination').classList.remove('hidden');
        
        // Store current page (ensure it's a number)
        window.disbursalCurrentPage = parseInt(pagination.current_page, 10) || 1;
    } else {
        document.getElementById('disbursalPagination').classList.add('hidden');
    }
    
    // Update record count display (showing current page records)
    document.getElementById('disbursalRecordCount').textContent = records.length.toLocaleString('en-IN');
    
    records.forEach(record => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-800 hover:bg-gray-800/30 transition-colors';
        
        const disbursalDate = record.disbursal_date ? new Date(record.disbursal_date).toLocaleDateString('en-IN', { 
            day: '2-digit', 
            month: 'short', 
            year: 'numeric' 
        }) : '--';
        
        const repaymentDate = record.repayment_date ? new Date(record.repayment_date).toLocaleDateString('en-IN', { 
            day: '2-digit', 
            month: 'short', 
            year: 'numeric' 
        }) : '--';
        
        row.innerHTML = `
            <td class="py-3 px-4 text-white font-medium">${record.full_name || '--'}</td>
            <td class="py-3 px-4 text-gray-300">${record.pan || '--'}</td>
            <td class="py-3 px-4 text-gray-300">${record.city || '--'}</td>
            <td class="py-3 px-4 text-gray-300">${record.state || '--'}</td>
            <td class="py-3 px-4 text-right text-gray-300">${formatCurrency(record.loan_amount || 0)}</td>
            <td class="py-3 px-4 text-right text-gray-300">${formatCurrency(record.Disbursal_Amt || 0)}</td>
            <td class="py-3 px-4 text-right text-gray-300">${formatCurrency(record.repayment_amount || 0)}</td>
            <td class="py-3 px-4 text-gray-300">${disbursalDate}</td>
            <td class="py-3 px-4 text-gray-300">${repaymentDate}</td>
        `;
        tbody.appendChild(row);
    });
}

function changeDisbursalPage(delta) {
    let currentPage = window.disbursalCurrentPage;
    if (!currentPage || isNaN(currentPage) || currentPage < 1) {
        currentPage = 1;
    }
    currentPage = parseInt(currentPage, 10);
    
    const newPage = currentPage + delta;
    
    if (newPage < 1) return;
    
    window.disbursalCurrentPage = parseInt(newPage, 10);
    loadDisbursalData();
}

function applyDisbursalFilters() {
    // Reset to page 1 when filters are applied
    window.disbursalCurrentPage = 1;
    loadDisbursalData();
    
    // Collapse filter section after applying filters
    const content = document.getElementById('disbursalFiltersContent');
    const icon = document.getElementById('disbursalFiltersToggleIcon');
    if (content && icon) {
        content.classList.add('hidden');
        icon.style.transform = 'rotate(180deg)';
    }
}

function handleDisbursalStateChange() {
    loadDisbursalCities();
    // Reload data if dates are already selected
    const startDate = document.getElementById('disbursalStartDate').value;
    const endDate = document.getElementById('disbursalEndDate').value;
    if (startDate && endDate) {
        loadDisbursalData();
    }
}

function resetDisbursalFilters() {
    setDefaultDisbursalDates();
    // Reset all filters
    document.getElementById('disbursalStateFilter').value = '';
    document.getElementById('disbursalCityFilter').value = '';
    document.getElementById('disbursalCityFilter').innerHTML = '<option value="">All Cities</option>';
    document.getElementById('disbursalReloanFilter').value = '';
    document.getElementById('disbursalTenureFilter').value = '';
    // Reset to page 1
    window.disbursalCurrentPage = 1;
    loadDisbursalData();
}

// Full Screen Chart Functions
function openFullScreenChart(chartType) {
    const modal = document.getElementById('fullScreenChartModal');
    const canvas = document.getElementById('fullScreenChartCanvas');
    const title = document.getElementById('fullScreenChartTitle');
    
    if (!modal || !canvas || !title) return;
    
    // Set title
    if (chartType === 'state') {
        title.textContent = 'Disbursal by State';
    } else if (chartType === 'city') {
        const stateFilter = document.getElementById('disbursalStateFilter').value;
        if (stateFilter) {
            title.textContent = `Disbursal by City (${stateFilter})`;
        } else {
            title.textContent = 'Disbursal by City';
        }
    }
    
    // Show modal
    modal.classList.remove('hidden');
    
    // Get the original chart instance
    let originalChart = null;
    
    if (chartType === 'state') {
        originalChart = window.disbursalStateChartInstance;
    } else if (chartType === 'city') {
        originalChart = window.disbursalCityChartInstance;
    }
    
    if (!originalChart) return;
    
    // Get chart data from original chart
    const chartData = {
        labels: originalChart.data.labels,
        datasets: originalChart.data.datasets.map(dataset => ({
            ...dataset
        }))
    };
    
    // Destroy existing full-screen chart if any
    if (window.fullScreenChartInstance) {
        window.fullScreenChartInstance.destroy();
    }
    
    // Create new chart in full-screen canvas
    window.fullScreenChartInstance = new Chart(canvas, {
        type: 'pie',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: '#ffffff',
                        font: {
                            size: 16
                        },
                        padding: 20
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#ffffff',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

function closeFullScreenChart() {
    const modal = document.getElementById('fullScreenChartModal');
    if (modal) {
        modal.classList.add('hidden');
    }
    
    // Destroy full-screen chart instance
    if (window.fullScreenChartInstance) {
        window.fullScreenChartInstance.destroy();
        window.fullScreenChartInstance = null;
    }
    
    // Restore body scroll
    document.body.style.overflow = '';
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('fullScreenChartModal');
        if (modal && !modal.classList.contains('hidden')) {
            closeFullScreenChart();
        }
    }
});

// Pie Chart Functions
function updateDisbursalStateChart(stateData) {
    if (!stateData || stateData.length === 0) {
        return;
    }
    
    const ctx = document.getElementById('disbursalStateChart');
    if (!ctx) return;
    
    // Destroy existing chart if it exists
    if (window.disbursalStateChartInstance) {
        window.disbursalStateChartInstance.destroy();
    }
    
    // Generate colors for pie chart
    const colors = [
        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
        '#06b6d4', '#ec4899', '#14b8a6', '#f97316', '#84cc16',
        '#6366f1', '#a855f7', '#eab308', '#22c55e', '#06b6d4'
    ];
    
    const labels = stateData.map(item => item.state);
    const loanAmounts = stateData.map(item => item.loan_amount);
    const backgroundColors = colors.slice(0, labels.length);
    
    window.disbursalStateChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Loan Amount',
                data: loanAmounts,
                backgroundColor: backgroundColors,
                borderColor: '#1e293b',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: '#94a3b8',
                        font: {
                            size: 12
                        },
                        padding: 15,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.95)',
                    titleColor: '#f8fafc',
                    bodyColor: '#f8fafc',
                    borderColor: '#334155',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                },
                datalabels: {
                    display: false
                }
            }
        }
    });
}

function updateDisbursalCityChart(cityData) {
    if (!cityData || cityData.length === 0) {
        return;
    }
    
    const ctx = document.getElementById('disbursalCityChart');
    if (!ctx) return;
    
    // Destroy existing chart if it exists
    if (window.disbursalCityChartInstance) {
        window.disbursalCityChartInstance.destroy();
    }
    
    // Update chart title based on state filter
    const stateFilter = document.getElementById('disbursalStateFilter').value;
    const cityChartTitle = document.getElementById('disbursalCityChartTitle');
    const cityChartStateFilter = document.getElementById('disbursalCityChartStateFilter');
    
    if (stateFilter) {
        cityChartTitle.textContent = `Disbursal by City`;
        cityChartStateFilter.textContent = `(${stateFilter})`;
    } else {
        cityChartTitle.textContent = `Disbursal by City`;
        cityChartStateFilter.textContent = '';
    }
    
    // Generate colors for pie chart
    const colors = [
        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
        '#06b6d4', '#ec4899', '#14b8a6', '#f97316', '#84cc16',
        '#6366f1', '#a855f7', '#eab308', '#22c55e', '#06b6d4'
    ];
    
    const labels = cityData.map(item => `${item.city} (${item.state})`);
    const loanAmounts = cityData.map(item => item.loan_amount);
    const backgroundColors = colors.slice(0, labels.length);
    
    window.disbursalCityChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Loan Amount',
                data: loanAmounts,
                backgroundColor: backgroundColors,
                borderColor: '#1e293b',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: '#94a3b8',
                        font: {
                            size: 11
                        },
                        padding: 12,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(30, 41, 59, 0.95)',
                    titleColor: '#f8fafc',
                    bodyColor: '#f8fafc',
                    borderColor: '#334155',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                },
                datalabels: {
                    display: false
                }
            }
        }
    });
}

// Global debug function for testing
window.testLoanCountTab = function() {
    console.log('=== TESTING LOAN COUNT TAB ===');
    
    // Check if elements exist
    const elements = {
        loanCountContent: document.getElementById('loanCountContent'),
        loanCountStartDate: document.getElementById('loanCountStartDate'),
        loanCountEndDate: document.getElementById('loanCountEndDate'),
        countWiseTableBody: document.getElementById('countWiseTableBody'),
        amountWiseTableBody: document.getElementById('amountWiseTableBody')
    };
    
    console.log('Elements check:', elements);
    
    // Check if tab is visible
    const isVisible = !document.getElementById('loanCountContent').classList.contains('hidden');
    console.log('Tab is visible:', isVisible);
    
    // Check date values
    const dates = {
        startDate: document.getElementById('loanCountStartDate')?.value,
        endDate: document.getElementById('loanCountEndDate')?.value
    };
    console.log('Date values:', dates);
    
    // Test API call directly
    if (dates.startDate && dates.endDate) {
        console.log('Testing direct API call...');
        fetch(`/api/loan-count-wise/?startDate=${dates.startDate}&endDate=${dates.endDate}`)
            .then(response => response.json())
            .then(data => {
                console.log('Direct API response:', data);
            })
            .catch(error => {
                console.error('Direct API error:', error);
            });
    }
    
    return elements;
};

// Tab Management
function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + 'Content').classList.remove('hidden');
    
    // Add active class to selected tab
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // Save current active tab to localStorage
    localStorage.setItem('activeTab', tabName);
    console.log('Active tab saved to localStorage:', tabName);
    
    // Initialize collection tab charts if it's being switched to
    if (tabName === 'collection') {
        console.log('Switching to collection tab, loading charts...');
        const params = new URLSearchParams(window.location.search);
        const filterParams = Object.fromEntries(params.entries());
        loadPendingCasesByAmountChart(filterParams);
    }
    
    // Initialize fraud tab if it's being switched to
    if (tabName === 'fraud') {
        console.log('Switching to fraud tab, initializing...');
        initializeFraudTab();
    }
    
    // Initialize daily performance tab if it's being switched to
    if (tabName === 'dailyPerformance') {
        console.log('Switching to daily performance tab - loading data...');
        loadDailyPerformanceData();
    }

    // Initialize credit person tab if it's being switched to
    if (tabName === 'creditPerson') {
        console.log('Switching to credit person tab, loading data...');
        setDefaultCreditPersonDates();
        loadCreditPersonData();
    }
    
    // Initialize loan count tab if it's being switched to
    if (tabName === 'loanCount') {
        console.log('Switching to loan count tab, initializing...');
        setDefaultLoanCountDates();
    }
    
    // Initialize disbursal tab if it's being switched to
    if (tabName === 'disbursal') {
        console.log('Switching to disbursal tab - loading data...');
        // Initialize filter section as collapsed
        initializeDisbursalFilters();
        // Set default dates first
        const todayStr = setDefaultDisbursalDates();
        // Load data immediately - ensure DOM is ready
        setTimeout(() => {
            const startDateInput = document.getElementById('disbursalStartDate');
            const endDateInput = document.getElementById('disbursalEndDate');
            
            if (startDateInput && endDateInput) {
                // Ensure dates are set
                if (!startDateInput.value) {
                    startDateInput.value = todayStr;
                }
                if (!endDateInput.value) {
                    endDateInput.value = todayStr;
                }
                
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                console.log('Disbursal dates after setting:', { startDate, endDate });
                
                if (startDate && endDate) {
                    loadDisbursalData();
                } else {
                    console.error('Dates still not set after initialization');
                    // Force set and load
                    startDateInput.value = todayStr;
                    endDateInput.value = todayStr;
                    setTimeout(() => loadDisbursalData(), 50);
                }
            } else {
                console.error('Date inputs not found when switching to disbursal tab');
                // Retry after a longer delay
                setTimeout(() => {
                    setDefaultDisbursalDates();
                    setTimeout(() => loadDisbursalData(), 100);
                }, 200);
            }
        }, 150);
    }
    
    // Initialize AUM Report tab if it's being switched to
    if (tabName === 'aumReport') {
        console.log('Switching to AUM Report tab, loading data...');
        loadAumDataTillDate(); // Default to till date
        
        // Export button uses inline onclick handler, no need for additional event listener
    }
}

// AUM Report Functions
async function loadAumData(silentRefresh = false, tillDate = null) {
    try {
        // Show loading state only on initial load, not during auto-refresh
        const loadingEl = document.getElementById('aumLoading');
        const tableEl = document.getElementById('aumTableContainer');
        const errorEl = document.getElementById('aumError');
        
        if (!silentRefresh) {
        if (loadingEl) loadingEl.classList.remove('hidden');
        if (tableEl) tableEl.classList.add('hidden');
        }
        if (errorEl) errorEl.classList.add('hidden');
        
        // Build API URL with optional parameters
        let apiUrl = '/api/aum-report/';
        if (tillDate === 'prev_date') {
            // Use till previous date endpoint
            apiUrl += `?till_prev_date=true`;
        } else if (tillDate === 'prev_month') {
            // Use till previous month endpoint
            apiUrl += `?till_prev_month=true`;
        }
        // If tillDate is null, use default endpoint (till current date)
        
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Debug logging
        console.log('AUM Report API Response:', data);
        console.log('Total Data:', data.total_data);
        if (data.total_data) {
            console.log('Total Data keys:', Object.keys(data.total_data));
            console.log('Total Data aum_sum:', data.total_data.aum_sum);
            console.log('Total Data running_sum:', data.total_data.running_sum);
        }
        
        // Hide loading only if it was shown
        if (!silentRefresh && loadingEl) loadingEl.classList.add('hidden');
        
        if (!data.success || !data.monthly_data || data.monthly_data.length === 0) {
            if (!silentRefresh) {
            if (errorEl) {
                errorEl.classList.remove('hidden');
                document.getElementById('aumErrorMessage').textContent = 'No data available';
                }
            }
            return;
        }
        
        // Store data globally for Excel export
        window.aumReportData = {
            monthly_data: data.monthly_data,
            total_data: data.total_data
        };
        
        // Update table
        updateAumTable(data.monthly_data, data.total_data);
        if (tableEl) tableEl.classList.remove('hidden');
        
    } catch (error) {
        console.error('Error loading AUM data:', error);
        const loadingEl = document.getElementById('aumLoading');
        const errorEl = document.getElementById('aumError');
        if (!silentRefresh) {
        if (loadingEl) loadingEl.classList.add('hidden');
        if (errorEl) {
            errorEl.classList.remove('hidden');
            document.getElementById('aumErrorMessage').textContent = error.message;
            }
        }
    }
}

function formatAumNumber(num) {
    if (num === null || num === undefined) return '--';
    return parseFloat(num).toLocaleString('en-IN', { maximumFractionDigits: 0 });
}

function formatAumPercent(num) {
    if (num === null || num === undefined) return '--';
    return parseFloat(num).toFixed(2) + '%';
}

// Function to load AUM data till current date
function loadAumDataTillDate() {
    // Update button states
    updateAumButtonStates('tillDate');
    // Load data without date filter (default behavior - till current date)
    loadAumData(false, null);
}

// Function to load AUM data till previous date
function loadAumDataTillPrevDate() {
    // Update button states
    updateAumButtonStates('tillPrevDate');
    // Load data with till_prev_date flag
    loadAumData(false, 'prev_date');
}

// Function to load AUM data till previous month
function loadAumDataTillPrevMonth() {
    // Update button states
    updateAumButtonStates('tillPrevMonth');
    // Load data with till_prev_month flag (use any non-null value to trigger the flag)
    loadAumData(false, 'prev_month');
}

// Function to update button active states
function updateAumButtonStates(activeButton) {
    const tillDateBtn = document.getElementById('aumTillDateBtn');
    const tillPrevDateBtn = document.getElementById('aumTillPrevDateBtn');
    const tillPrevMonthBtn = document.getElementById('aumTillPrevMonthBtn');
    
    // Reset all buttons
    if (tillDateBtn) {
        tillDateBtn.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-gray-800');
    }
    if (tillPrevDateBtn) {
        tillPrevDateBtn.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-gray-800');
    }
    if (tillPrevMonthBtn) {
        tillPrevMonthBtn.classList.remove('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-gray-800');
    }
    
    // Highlight active button
    if (activeButton === 'tillDate' && tillDateBtn) {
        tillDateBtn.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-gray-800');
    } else if (activeButton === 'tillPrevDate' && tillPrevDateBtn) {
        tillPrevDateBtn.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-gray-800');
    } else if (activeButton === 'tillPrevMonth' && tillPrevMonthBtn) {
        tillPrevMonthBtn.classList.add('ring-2', 'ring-white', 'ring-offset-2', 'ring-offset-gray-800');
    }
}

// Helper function to get current till date for auto-refresh
function getAumCurrentTillDate() {
    const tillDateBtn = document.getElementById('aumTillDateBtn');
    const tillPrevDateBtn = document.getElementById('aumTillPrevDateBtn');
    const tillPrevMonthBtn = document.getElementById('aumTillPrevMonthBtn');
    
    // Check which button is active
    const isTillDateActive = tillDateBtn && tillDateBtn.classList.contains('ring-2');
    const isTillPrevDateActive = tillPrevDateBtn && tillPrevDateBtn.classList.contains('ring-2');
    const isTillPrevMonthActive = tillPrevMonthBtn && tillPrevMonthBtn.classList.contains('ring-2');
    
    if (isTillDateActive) {
        return null; // Till date means no filter (current date)
    } else if (isTillPrevDateActive) {
        // Return flag to indicate previous date endpoint
        return 'prev_date';
    } else if (isTillPrevMonthActive) {
        // Return flag to indicate previous month endpoint
        return 'prev_month';
    } else {
        // Default to till date if no button is active yet
        return null;
    }
}

function getAumMonthLabel(monthStr) {
    if (!monthStr) return '--';
    const date = new Date(monthStr);
    const month = date.toLocaleString('en-US', { month: 'short' });
    const year = date.getFullYear().toString().slice(-2);
    return `${month}-${year}`;
}

function updateAumTable(monthlyData, totalData) {
    const thead = document.getElementById('aumTableHead');
    const tbody = document.getElementById('aumTableBody');
    
    if (!thead || !tbody) return;
    
    // Clear existing content
    thead.innerHTML = '';
    tbody.innerHTML = '';
    
    // Create header row
    const headerRow = document.createElement('tr');
    headerRow.className = 'border-b-2 border-blue-600/50';
    headerRow.innerHTML = '<th class="py-4 px-5 text-left text-white font-bold text-sm uppercase tracking-wider border-r border-blue-500/30 bg-gradient-to-br from-blue-600/80 to-blue-700/80 shadow-inner">Category</th>';
    
    // Add month columns with alternating colors
    monthlyData.forEach((item, index) => {
        const monthLabel = getAumMonthLabel(item.month);
        const isLast = index === monthlyData.length - 1;
        const bgColor = index % 2 === 0 ? 'from-blue-600/80 to-indigo-600/80' : 'from-indigo-600/80 to-purple-600/80';
        headerRow.innerHTML += `
            <th colspan="2" class="py-4 px-5 text-center text-white font-bold text-sm uppercase tracking-wider ${isLast ? '' : 'border-r border-blue-500/30'} bg-gradient-to-br ${bgColor} shadow-inner">${monthLabel}</th>
        `;
    });
    
    thead.appendChild(headerRow);
    
    // Create sub-header row for Units/Sum
    const subHeaderRow = document.createElement('tr');
    subHeaderRow.className = 'border-b border-blue-500/30';
    subHeaderRow.innerHTML = '<th class="py-3 px-5 text-left text-blue-100 font-semibold text-xs uppercase tracking-wider border-r border-blue-500/30 bg-blue-700/50"></th>';
    
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        const bgColor = index % 2 === 0 ? 'bg-blue-700/50' : 'bg-indigo-700/50';
        subHeaderRow.innerHTML += `
            <th class="py-3 px-4 text-center text-blue-100 font-semibold text-xs uppercase tracking-wider ${isLast ? '' : 'border-r border-blue-500/30'} ${bgColor}">Units</th>
            <th class="py-3 px-4 text-center text-blue-100 font-semibold text-xs uppercase tracking-wider ${isLast ? '' : 'border-r border-blue-500/30'} ${bgColor}">Sum</th>
        `;
    });
    
    thead.appendChild(subHeaderRow);
    
    // Helper function to create a data cell with alternating column colors
    function createCell(units, sum, isBold = false, isHighlight = false, isLast = false, colIndex = 0) {
        const boldClass = isBold ? 'font-bold text-gray-900' : 'text-gray-800';
        const highlightClass = isHighlight ? 'bg-gradient-to-r from-yellow-400/25 via-yellow-500/20 to-yellow-400/25 border-l-2 border-yellow-400' : '';
        const borderClass = isLast ? '' : 'border-r border-gray-300';
        const colBg = colIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        const cellBg = highlightClass || colBg;
        return `
            <td class="py-3 px-4 text-center ${boldClass} ${borderClass} ${cellBg} font-mono text-sm">${formatAumNumber(units)}</td>
            <td class="py-3 px-4 text-center ${boldClass} ${borderClass} ${cellBg} font-mono text-sm">${formatAumNumber(sum)}</td>
        `;
    }
    
    // Helper function to create a single value cell (for ATS, percentages, etc.)
    function createSingleCell(value, isBold = false, isHighlight = false, formatter = formatAumNumber, isLast = false, colIndex = 0) {
        const boldClass = isBold ? 'font-bold text-gray-900' : 'text-gray-800';
        const highlightClass = isHighlight ? 'bg-gradient-to-r from-yellow-400/25 via-yellow-500/20 to-yellow-400/25 border-l-2 border-yellow-400' : '';
        const borderClass = isLast ? '' : 'border-r border-gray-300';
        const colBg = colIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';
        const cellBg = highlightClass || colBg;
        return `
            <td colspan="2" class="py-3 px-4 text-center ${boldClass} ${borderClass} ${cellBg} font-mono text-sm">${formatter(value)}</td>
        `;
    }
    
    // STPL (SHORT TERM PERSONAL LOAN) - Loan Disbursed - NEW
    let row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 font-semibold border-r border-gray-300 bg-white">STPL (SHORT TERM PERSONAL LOAN)</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createCell(item.new_units, item.new_sum, false, false, isLast, index);
    });
    tbody.appendChild(row);
    
    // STPL (SHORT TERM PERSONAL LOAN) - Loan Disbursed - REPEAT
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 border-r border-gray-300 bg-white pl-8">Loan Disbursed - REPEAT</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createCell(item.repeat_units, item.repeat_sum, false, false, isLast, index);
    });
    tbody.appendChild(row);
    
    // STPL (SHORT TERM PERSONAL LOAN) - Loan Disbursed - Total
    row = document.createElement('tr');
    row.className = 'border-b-2 border-blue-500/40 hover:bg-blue-50/20 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 font-bold border-r border-gray-300 bg-white pl-8">Loan Disbursed - Total</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createCell(item.total_units, item.total_sum, true, false, isLast, index);
    });
    tbody.appendChild(row);
    
    // ATS
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 font-semibold border-r border-gray-300 bg-white">ATS</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createSingleCell(item.ats, false, false, formatAumNumber, isLast, index);
    });
    tbody.appendChild(row);
    
    // Overdue Cases - Running Cases
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 font-semibold border-r border-gray-300 bg-white">Overdue Cases</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createCell(item.running_units, item.running_sum, false, false, isLast, index);
    });
    tbody.appendChild(row);
    
    // Over Due +1-30 Day
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 border-r border-gray-300 bg-white pl-8">Over Due +1-30 Day</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createCell(item.od_1_30_units || 0, item.od_1_30_sum || 0, false, false, isLast, index);
    });
    tbody.appendChild(row);
    
    // Over Due +31-90 Day
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 border-r border-gray-300 bg-white pl-8">Over Due +31-90 Day</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createCell(item.od_31_90_units || 0, item.od_31_90_sum || 0, false, false, isLast, index);
    });
    tbody.appendChild(row);
    
    // Over Due 90+ Day
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 border-r border-gray-300 bg-white pl-8">Over Due 90+ Day</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createCell(item.od_90p_units || 0, item.od_90p_sum || 0, false, false, isLast, index);
    });
    tbody.appendChild(row);
    
    // Loan Book(AUM) - Highlighted with blue gradient like header
    row = document.createElement('tr');
    row.className = 'border-b-2 border-blue-500/50 hover:bg-blue-500/10 transition-colors duration-150';
    row.innerHTML = '<td class="py-4 px-5 text-left text-white font-bold text-base border-r border-blue-500/30 bg-gradient-to-br from-blue-600/80 to-blue-700/80 shadow-inner">Loan Book(AUM)</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        const aumUnits = item.running_units || 0;
        const aumSum = item.aum_sum || item.running_sum || 0;
        const bgColor = index % 2 === 0 ? 'from-blue-600/80 to-indigo-600/80' : 'from-indigo-600/80 to-purple-600/80';
        row.innerHTML += `
            <td class="py-4 px-4 text-center text-white font-bold border-r border-blue-500/30 bg-gradient-to-br ${bgColor} shadow-inner font-mono text-sm">${formatAumNumber(aumUnits)}</td>
            <td class="py-4 px-4 text-center text-white font-bold border-r border-blue-500/30 bg-gradient-to-br ${bgColor} shadow-inner font-mono text-sm">${formatAumNumber(aumSum)}</td>
        `;
    });
    tbody.appendChild(row);
    
    // DPD Percentages - 1+DPD%
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 font-semibold border-r border-gray-300 bg-white">DPD Percentages</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        const dpd1 = item.dpd_1_30_count_percent || 0;
        row.innerHTML += createSingleCell(dpd1, false, false, formatAumPercent, isLast, index);
    });
    tbody.appendChild(row);
    
    // 30+DPD%
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 border-r border-gray-300 bg-white pl-8">30+DPD%</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        const dpd30 = item.dpd_31_90_count_percent || 0;
        row.innerHTML += createSingleCell(dpd30, false, false, formatAumPercent, isLast, index);
    });
    tbody.appendChild(row);
    
    // 90+DPD%
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 border-r border-gray-300 bg-white pl-8">90+DPD%</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        const dpd90 = item.dpd_90p_count_percent || 0;
        row.innerHTML += createSingleCell(dpd90, false, false, formatAumPercent, isLast, index);
    });
    tbody.appendChild(row);
    
    // Income/Financials - PF Income (Incl. GST)
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 font-semibold border-r border-gray-300 bg-white">Income/Financials</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createSingleCell(item.total_pf, false, false, formatAumNumber, isLast, index);
    });
    tbody.appendChild(row);
    
    // Interest Income
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 border-r border-gray-300 bg-white pl-8">Interest Income</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createSingleCell(item.interest_amount, false, false, formatAumNumber, isLast, index);
    });
    tbody.appendChild(row);
    
    // Avg PF (Incl. GST)
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 border-r border-gray-300 bg-white pl-8">Avg PF (Incl. GST)</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createSingleCell(item.avg_pf, false, false, formatAumNumber, isLast, index);
    });
    tbody.appendChild(row);
    
    // Avg ROI
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 border-r border-gray-300 bg-white pl-8">Avg ROI</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createSingleCell(item.avg_roi, false, false, formatAumPercent, isLast, index);
    });
    tbody.appendChild(row);
    
    // Avg Tenure
    row = document.createElement('tr');
    row.className = 'border-b border-gray-700/40 hover:bg-white/10 transition-colors duration-150 bg-white/5';
    row.innerHTML = '<td class="py-3 px-5 text-left text-gray-900 border-r border-gray-300 bg-white pl-8">Avg Tenure</td>';
    monthlyData.forEach((item, index) => {
        const isLast = index === monthlyData.length - 1;
        row.innerHTML += createSingleCell(item.avg_tenure, false, false, formatAumNumber, isLast, index);
    });
    tbody.appendChild(row);
    
    // Total Loan Book Aum - Highlighted with blue gradient like header
    if (totalData) {
        // Check for aum_sum first, then running_sum as fallback
        const totalValue = totalData.aum_sum || totalData.running_sum || null;
        if (totalValue !== null && totalValue !== undefined) {
        const totalRow = document.createElement('tr');
        totalRow.className = 'border-t-2 border-blue-500/60 hover:bg-blue-500/10 transition-colors duration-150';
            totalRow.innerHTML = `<td class="py-4 px-5 text-left text-white font-bold text-base border-r border-blue-500/30 bg-gradient-to-br from-blue-600/80 to-blue-700/80 shadow-inner">Total Loan Book Aum</td><td colspan="${monthlyData.length * 2}" class="py-4 px-5 text-center text-white font-bold text-lg font-mono bg-gradient-to-br from-blue-600/80 via-indigo-600/80 to-purple-600/80 shadow-inner">${formatAumNumber(totalValue)}</td>`;
        tbody.appendChild(totalRow);
        } else {
            console.warn('AUM total_data exists but no aum_sum or running_sum found:', totalData);
        }
    } else {
        console.warn('AUM total_data is missing from API response');
    }
}

// Update fraud filter options when filters change
async function updateFraudFilterOptions(form) {
    try {
        console.log('Updating fraud filter options...');
        
        // Get current filter values from the fraud form
        const dateFrom = form.querySelector('input[name="date_from"]')?.value;
        const dateTo = form.querySelector('input[name="date_to"]')?.value;
        const dateType = form.querySelector('select[name="date_type"]')?.value;
        const closingStatus = form.querySelector('select[name="closing_status"]')?.value;
        const dpd = form.querySelector('select[name="dpd"]')?.value;
        
        console.log('Current fraud filters:', { dateFrom, dateTo, dateType, closingStatus, dpd });
        
        // Build URL with current filters
        const params = new URLSearchParams();
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (dateType) params.append('date_type', dateType);
        if (closingStatus) params.append('closing_status', closingStatus);
        if (dpd) params.append('dpd', dpd);
        console.log('Fetching fraud filter options with params:', params.toString());
        const response = await fetch(`/api/fraud/kpi-data/?${params.toString()}`);
        const data = await response.json();
        
        console.log('Received fraud filter options:', data.filter_options);
        
        if (data && data.filter_options) {
            const options = data.filter_options;
            
            // Update fraud states dropdown
            const fraudStateSelect = document.getElementById('fraudState');
            if (fraudStateSelect) {
                const currentState = fraudStateSelect.value;
                fraudStateSelect.innerHTML = '<option value="">All States</option>';
                options.states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    if (state === currentState) option.selected = true;
                    fraudStateSelect.appendChild(option);
                });
            }
            
            // Update fraud cities dropdown
            const fraudCitySelect = document.getElementById('fraudCity');
            if (fraudCitySelect) {
                const currentCity = fraudCitySelect.value;
                fraudCitySelect.innerHTML = '<option value="">All Cities</option>';
                
                // If a state is selected, update cities for that state
                const selectedState = fraudStateSelect?.value;
                if (selectedState) {
                    try {
                        const cityParams = new URLSearchParams(params);
                        cityParams.append('state', selectedState);
                        const cityResponse = await fetch(`/api/cities-by-state/?${cityParams.toString()}`);
                        const cityData = await cityResponse.json();
                        
                        cityData.cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city;
                            option.textContent = city;
                            if (city === currentCity) option.selected = true;
                            fraudCitySelect.appendChild(option);
                        });
                    } catch (error) {
                        console.error('Error fetching cities for state:', error);
                    }
                }
            }
            
            // Update fraud closing status dropdown
            const fraudClosingStatusSelect = document.getElementById('fraudClosingStatus');
            if (fraudClosingStatusSelect) {
                const currentStatus = fraudClosingStatusSelect.value;
                fraudClosingStatusSelect.innerHTML = '<option value="">All Status</option>';
                options.closing_statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === currentStatus) option.selected = true;
                    fraudClosingStatusSelect.appendChild(option);
                });
            }
            
            // Update fraud DPD buckets dropdown
            const fraudDpdBucketSelect = document.getElementById('fraudDpdBucket');
            if (fraudDpdBucketSelect) {
                const currentDpd = fraudDpdBucketSelect.value;
                fraudDpdBucketSelect.innerHTML = '<option value="">All DPD</option>';
                options.dpd_buckets.forEach(bucket => {
                    const option = document.createElement('option');
                    option.value = bucket;
                    option.textContent = bucket;
                    if (bucket === currentDpd) option.selected = true;
                    fraudDpdBucketSelect.appendChild(option);
                });
            }
            
            console.log('Updated fraud filter options with current filters:', {
                states: options.states.length,
                cities: fraudCitySelect?.options.length || 0,
                closing_statuses: options.closing_statuses.length,
                dpd_buckets: options.dpd_buckets.length
            });
        }
    } catch (error) {
        console.error('Error updating fraud filter options:', error);
    }
}

// Populate fraud filter dropdowns with data (initial load)
async function populateFraudFilterDropdowns() {
    try {
        // Get current filter values from the fraud form
        const form = document.getElementById('fraudFilterForm');
        if (!form) return;
        
        const dateFrom = form.querySelector('input[name="date_from"]')?.value;
        const dateTo = form.querySelector('input[name="date_to"]')?.value;
        const dateType = form.querySelector('select[name="date_type"]')?.value;
        const closingStatus = form.querySelector('select[name="closing_status"]')?.value;
        const dpd = form.querySelector('select[name="dpd"]')?.value;
        
        // Build URL with current filters
        const params = new URLSearchParams();
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        if (dateType) params.append('date_type', dateType);
        if (closingStatus) params.append('closing_status', closingStatus);
        if (dpd) params.append('dpd', dpd);
        
        // Fetch filter options from the fraud API with current filters
        const response = await fetch(`/api/fraud/kpi-data/?${params.toString()}`);
        const data = await response.json();
        
        if (data && data.filter_options) {
            const options = data.filter_options;
            
            // Populate states dropdown
            const fraudStateSelect = document.getElementById('fraudState');
            if (fraudStateSelect && options.states) {
                const currentState = fraudStateSelect.value;
                fraudStateSelect.innerHTML = '<option value="">All States</option>';
                options.states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    if (state === currentState) option.selected = true;
                    fraudStateSelect.appendChild(option);
                });
            }
            
            // Populate cities dropdown (will be updated based on selected state)
            const fraudCitySelect = document.getElementById('fraudCity');
            if (fraudCitySelect) {
                const currentCity = fraudCitySelect.value;
                fraudCitySelect.innerHTML = '<option value="">All Cities</option>';
                
                // If a state is selected, update cities for that state
                const selectedState = fraudStateSelect?.value;
                if (selectedState) {
                    try {
                        const cityParams = new URLSearchParams(params);
                        cityParams.append('state', selectedState);
                        const cityResponse = await fetch(`/api/cities-by-state/?${cityParams.toString()}`);
                        const cityData = await cityResponse.json();
                        
                        cityData.cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city;
                            option.textContent = city;
                            if (city === currentCity) option.selected = true;
                            fraudCitySelect.appendChild(option);
                        });
                    } catch (error) {
                        console.error('Error fetching cities for state:', error);
                    }
                }
            }
            
            // Populate closing status dropdown
            const fraudClosingStatusSelect = document.getElementById('fraudClosingStatus');
            if (fraudClosingStatusSelect && options.closing_statuses) {
                const currentStatus = fraudClosingStatusSelect.value;
                fraudClosingStatusSelect.innerHTML = '<option value="">All Status</option>';
                options.closing_statuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = status;
                    if (status === currentStatus) option.selected = true;
                    fraudClosingStatusSelect.appendChild(option);
                });
            }
            
            // Populate DPD buckets dropdown
            const fraudDpdBucketSelect = document.getElementById('fraudDpdBucket');
            if (fraudDpdBucketSelect && options.dpd_buckets) {
                const currentDpd = fraudDpdBucketSelect.value;
                fraudDpdBucketSelect.innerHTML = '<option value="">All DPD</option>';
                options.dpd_buckets.forEach(bucket => {
                    const option = document.createElement('option');
                    option.value = bucket;
                    option.textContent = bucket;
                    if (bucket === currentDpd) option.selected = true;
                    fraudDpdBucketSelect.appendChild(option);
                });
            }
            
            console.log('Fraud filter dropdowns populated successfully with filtered data:', {
                states: options.states.length,
                cities: fraudCitySelect?.options.length || 0,
                closing_statuses: options.closing_statuses.length,
                dpd_buckets: options.dpd_buckets.length
            });
        }
    } catch (error) {
        console.error('Error populating fraud filter dropdowns:', error);
    }
}

// Initialize fraud tab when it becomes active
function initializeFraudTab() {
    console.log('Initializing fraud tab...');
    
    // Populate filter dropdowns first
    populateFraudFilterDropdowns();
    
    // Restore saved filter values after populating dropdowns
    restoreFraudFilters();
    
    // Get current filter values from the fraud form
    const form = document.getElementById('fraudFilterForm');
    const filters = {};
    
    if (form) {
        // Date filters
        const dateFrom = form.querySelector('input[name="date_from"]').value;
        const dateTo = form.querySelector('input[name="date_to"]').value;
        const dateType = form.querySelector('select[name="date_type"]').value;
        if (dateFrom) filters.date_from = dateFrom;
        if (dateTo) filters.date_to = dateTo;
        if (dateType) filters.date_type = dateType;
        
        // Other filters
        const closingStatus = form.querySelector('select[name="closing_status"]').value;
        const dpd = form.querySelector('select[name="dpd"]').value;
        const state = form.querySelector('select[name="state"]').value;
        const city = form.querySelector('select[name="city"]').value;
        
        if (closingStatus) filters.closing_status = closingStatus;
        if (dpd) filters.dpd = dpd;
        if (state) filters.state = state;
        if (city) filters.city = city;
    }
    
    console.log('Initializing fraud tab with filters:', filters);
    
    // Load initial data with current filters
    loadFraudKpiData(filters);
    loadFraudDpdTable(filters);
    loadFraudStateChart(filters);
    loadFraudTimeSeriesChart(filters);
    loadFraudCityCollectedChart(filters);
    loadFraudCityUncollectedChart(filters);
    console.log('Fraud tab initialization completed');
}
// Fraud-specific data loading functions (using fraud API endpoints)
function loadFraudKpiData(filters = {}) {
    console.log('Loading fraud KPI data...');
    const params = new URLSearchParams(filters);
    // Add cache-busting parameter
    params.append('_t', Date.now());
    fetch(`/api/fraud/kpi-data/?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Fraud KPI data received:', data);
            // Update KPI cards
            document.getElementById('fraudTotalApplications').textContent = data.total_applications?.toLocaleString() || '0';
            
            // Update fresh and reloan cases
            document.getElementById('fraudFreshCases').textContent = data.fresh_cases?.toLocaleString() || '0';
            document.getElementById('fraudFreshPercentage').textContent = data.fresh_percentage?.toFixed(1) || '0.0';
            document.getElementById('fraudReloanCases').textContent = data.reloan_cases?.toLocaleString() || '0';
            document.getElementById('fraudReloanPercentage').textContent = data.reloan_percentage?.toFixed(1) || '0.0';
            
            // Format currency amounts
            const sanctionAmount = formatCurrency(data.sanction_amount || 0);
            const disbursedAmount = formatCurrency(data.disbursed_amount || 0);
            const repaymentAmount = formatCurrency(data.repayment_amount || 0);
            const collectedAmount = formatCurrency(data.collected_amount || 0);
            const pendingCollection = formatCurrency(data.pending_collection || 0);
            const principalOutstandingAmount = formatCurrency(data.principal_outstanding || 0);
            
            document.getElementById('fraudSanctionAmount').textContent = sanctionAmount;
            document.getElementById('fraudDisbursedAmount').textContent = disbursedAmount;
            document.getElementById('fraudRepaymentAmount').textContent = repaymentAmount;
            document.getElementById('fraudCollectedAmount').textContent = collectedAmount;
            document.getElementById('fraudPendingCollection').textContent = pendingCollection;
            document.getElementById('fraudPrincipalOutstandingAmount').textContent = principalOutstandingAmount;
            
            // Update fresh and reloan amounts
            document.getElementById('fraudFreshSanctionAmount').textContent = formatCurrency(data.fresh_sanction_amount || 0);
            document.getElementById('fraudReloanSanctionAmount').textContent = formatCurrency(data.reloan_sanction_amount || 0);
            document.getElementById('fraudFreshDisbursedAmount').textContent = formatCurrency(data.fresh_disbursed_amount || 0);
            document.getElementById('fraudReloanDisbursedAmount').textContent = formatCurrency(data.reloan_disbursed_amount || 0);
            document.getElementById('fraudFreshRepaymentAmount').textContent = formatCurrency(data.fresh_repayment_amount || 0);
            document.getElementById('fraudReloanRepaymentAmount').textContent = formatCurrency(data.reloan_repayment_amount || 0);
            document.getElementById('fraudFreshCollectedAmount').textContent = formatCurrency(data.fresh_collected_amount || 0);
            document.getElementById('fraudReloanCollectedAmount').textContent = formatCurrency(data.reloan_collected_amount || 0);
            document.getElementById('fraudFreshPendingAmount').textContent = formatCurrency(data.fresh_pending_amount || 0);
            document.getElementById('fraudReloanPendingAmount').textContent = formatCurrency(data.reloan_pending_amount || 0);
            document.getElementById('fraudFreshPrincipalOutstanding').textContent = formatCurrency(data.fresh_principal_outstanding || 0);
            document.getElementById('fraudReloanPrincipalOutstanding').textContent = formatCurrency(data.reloan_principal_outstanding || 0);
            
            // Update percentages
            const collectionRate = data.collection_rate || 0;
            const pendingRate = 100 - collectionRate;
            document.getElementById('fraudCollectedPercentage').textContent = `${collectionRate.toFixed(2)}% of Repayment`;
            document.getElementById('fraudPendingPercentage').textContent = `${pendingRate.toFixed(2)}% of Repayment`;
        })
        .catch(error => {
            console.error('Error loading fraud KPI data:', error);
        });
}
function loadFraudDpdTable(filters = {}) {
    const params = new URLSearchParams(filters);
    fetch(`/api/fraud/dpd-buckets/?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Fraud DPD data received:', data);
            const buckets = data.buckets || [];
            
            const tbody = document.getElementById('fraudDpdTableBody');
            tbody.innerHTML = '';
            
            let totalCount = 0;
            buckets.forEach(item => totalCount += item.count);
            
            buckets.forEach((item, index) => {
                const percentage = totalCount > 0 ? (item.count / totalCount) * 100 : 0;
                const row = document.createElement('tr');
                
                // Add styling for table rows with click functionality
                row.className = 'border-b border-border/50 hover:bg-secondary/50 transition-colors cursor-pointer';
                
                // Add click handler to open DPD details modal
                row.onclick = () => openDPDDetailsModal(item.bucket, item.count);
                
                // Format bucket name
                const bucketName = item.bucket === '0' ? '0 days' : 
                                 item.bucket === 'No DPD' ? 'No DPD' : 
                                 `${item.bucket} days`;
                
                row.innerHTML = `
                    <td class="py-3 px-4 font-medium">${bucketName}</td>
                    <td class="py-3 px-4 text-right">${formatNumber(item.count)}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            console.log('Fraud DPD table populated successfully');
        })
        .catch(error => {
            console.error('Error loading fraud DPD data:', error);
            // Show error message in the table container
            const tableContainer = document.getElementById('fraudDpdTableBody').parentElement.parentElement;
            tableContainer.innerHTML = '<div class="flex items-center justify-center h-80 text-red-500">Error loading table: ' + error.message + '</div>';
        });
}

function loadFraudStateChart(filters = {}) {
    const params = new URLSearchParams(filters);
    fetch(`/api/fraud/state-repayment/?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Fraud state data received:', data);
            const states = data.states || [];
            
            // Create canvas element if it doesn't exist
            const container = document.getElementById('fraudStateChart');
            let canvas = container.querySelector('canvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                container.appendChild(canvas);
            }
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.fraudStateChartInstance) {
                window.fraudStateChartInstance.destroy();
            }
            
            window.fraudStateChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: states.slice(0, 10).map(state => state.state),
                    datasets: [{
                        label: 'Repayment Amount',
                        data: states.slice(0, 10).map(state => state.repayment_amount),
                        backgroundColor: '#10b981',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return '₹' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
            
            console.log('Fraud state chart created successfully');
        })
        .catch(error => {
            console.error('Error loading fraud state data:', error);
            // Show error message in the chart container
            const chartContainer = document.getElementById('fraudStateChart').parentElement;
            chartContainer.innerHTML = '<div class="flex items-center justify-center h-80 text-red-500">Error loading chart: ' + error.message + '</div>';
        });
}

function loadFraudTimeSeriesChart(filters = {}) {
    const params = new URLSearchParams(filters);
    fetch(`/api/fraud/time-series/?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Fraud time series data received:', data);
            const timeData = data.data || [];
            
            // Create canvas element if it doesn't exist
            const container = document.getElementById('fraudTimeSeriesChart');
            let canvas = container.querySelector('canvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                container.appendChild(canvas);
            }
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.fraudTimeSeriesChartInstance) {
                window.fraudTimeSeriesChartInstance.destroy();
            }
            
            // Create the actual time series chart with real data
            const chartLabels = timeData.map(item => new Date(item.date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' }));
            const repaymentData = timeData.map(item => item.repayment_amount);
            const collectedData = timeData.map(item => item.collected_amount);
            
            window.fraudTimeSeriesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: 'Repayment Amount',
                            data: repaymentData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        },
                        {
                            label: 'Collected Amount',
                            data: collectedData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#f8fafc',
                            bodyColor: '#f8fafc',
                            borderColor: '#334155',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: false,
                            callbacks: {
                                title: function(context) {
                                    return new Date(timeData[context[0].dataIndex].date).toLocaleDateString('en-IN', { 
                                        weekday: 'short', 
                                        year: 'numeric', 
                                        month: 'short', 
                                        day: 'numeric' 
                                    });
                                },
                                label: function(context) {
                                    // Only show data for the first dataset to avoid duplication
                                    if (context.datasetIndex === 0) {
                                        const dataIndex = context.dataIndex;
                                        const repaymentAmount = timeData[dataIndex].repayment_amount;
                                        const collectedAmount = timeData[dataIndex].collected_amount;
                                        const collectionPercentage = timeData[dataIndex].collection_rate;
                                        
                                        return [
                                            'Repayment Amount: ' + formatCurrency(repaymentAmount),
                                            'Collected Amount: ' + formatCurrency(collectedAmount),
                                            'Collection Rate: ' + collectionPercentage.toFixed(1) + '%'
                                        ];
                                    }
                                    return null; // Don't show label for second dataset
                                }
                            }
                        },
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return '₹' + (value / 1000).toFixed(0) + 'K';
                                }
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
            
            console.log('Fraud time series chart created successfully');
        })
        .catch(error => {
            console.error('Error loading fraud time series data:', error);
            // Show error message in the chart container
            const chartContainer = document.getElementById('fraudTimeSeriesChart').parentElement;
            chartContainer.innerHTML = '<div class="flex items-center justify-center h-80 text-red-500">Error loading chart: ' + error.message + '</div>';
        });
}

function loadFraudCityCollectedChart(filters = {}) {
    const params = new URLSearchParams(filters);
    fetch(`/api/fraud/city-collected/?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Fraud city collected data received:', data);
            const cities = data.cities || [];
            
            // Create canvas element if it doesn't exist
            const container = document.getElementById('fraudCityCollectedChart');
            let canvas = container.querySelector('canvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                container.appendChild(canvas);
            }
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.fraudCityCollectedChartInstance) {
                window.fraudCityCollectedChartInstance.destroy();
            }
            
            // Create horizontal bar chart
            window.fraudCityCollectedChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cities.slice(0, 10).map(city => city.city),
                    datasets: [{
                        label: 'Collection Rate (%)',
                        data: cities.slice(0, 10).map(city => city.collection_percentage),
                        backgroundColor: '#10b981',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                plugins: [ChartDataLabels],
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            callbacks: {
                                label: function(context) {
                                    const city = cities[context.dataIndex];
                                    return [
                                        'City: ' + city.city,
                                        'Collection Rate: ' + city.collection_percentage.toFixed(1) + '%',
                                        'Collected Amount: ' + formatCurrency(city.collected_amount),
                                        'Repayment Amount: ' + formatCurrency(city.repayment_amount),
                                        'Applications: ' + city.total_applications
                                    ];
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: '#ffffff',
                            anchor: 'end',
                            align: 'right',
                            offset: 10,
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            formatter: function(value) {
                                return value.toFixed(2) + '%';
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
            
            console.log('Fraud city collected chart created successfully');
        })
        .catch(error => {
            console.error('Error loading fraud city collected data:', error);
            // Show error message in the chart container
            const chartContainer = document.getElementById('fraudCityCollectedChart').parentElement;
            chartContainer.innerHTML = '<div class="flex items-center justify-center h-80 text-red-500">Error loading chart: ' + error.message + '</div>';
        });
}
function loadFraudCityUncollectedChart(filters = {}) {
    const params = new URLSearchParams(filters);
    fetch(`/api/fraud/city-uncollected/?${params}`)
        .then(response => response.json())
        .then(data => {
            console.log('Fraud city uncollected data received:', data);
            const cities = data.cities || [];
            
            // Create canvas element if it doesn't exist
            const container = document.getElementById('fraudCityUncollectedChart');
            let canvas = container.querySelector('canvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                container.appendChild(canvas);
            }
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.fraudCityUncollectedChartInstance) {
                window.fraudCityUncollectedChartInstance.destroy();
            }
            
            // Create horizontal bar chart
            window.fraudCityUncollectedChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cities.slice(0, 10).map(city => city.city),
                    datasets: [{
                        label: 'Collection Rate (%)',
                        data: cities.slice(0, 10).map(city => city.collection_percentage),
                        backgroundColor: '#ef4444',
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                plugins: [ChartDataLabels],
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            callbacks: {
                                label: function(context) {
                                    const city = cities[context.dataIndex];
                                    return [
                                        'City: ' + city.city,
                                        'Collection Rate: ' + city.collection_percentage.toFixed(1) + '%',
                                        'Uncollected Amount: ' + formatCurrency(city.uncollected_amount),
                                        'Collected Amount: ' + formatCurrency(city.collected_amount),
                                        'Repayment Amount: ' + formatCurrency(city.repayment_amount),
                                        'Applications: ' + city.total_applications
                                    ];
                                }
                            }
                        },
                        datalabels: {
                            display: true,
                            color: '#ffffff',
                            anchor: 'end',
                            align: 'right',
                            offset: 10,
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            formatter: function(value) {
                                return value.toFixed(2) + '%';
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            },
                            grid: {
                                color: '#374151'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: '#374151'
                            }
                        }
                    }
                }
            });
            
            console.log('Fraud city uncollected chart created successfully');
        })
        .catch(error => {
            console.error('Error loading fraud city uncollected data:', error);
            // Show error message in the chart container
            const chartContainer = document.getElementById('fraudCityUncollectedChart').parentElement;
            chartContainer.innerHTML = '<div class="flex items-center justify-center h-80 text-red-500">Error loading chart: ' + error.message + '</div>';
        });
}

// Initialize tab styles
document.addEventListener('DOMContentLoaded', function() {
    // Add CSS for tab styling
    const style = document.createElement('style');
    style.textContent = `
        .tab-button {
            color: #9ca3af;
            background: transparent;
        }
        .tab-button:hover {
            color: #f3f4f6;
            background: rgba(75, 85, 99, 0.2);
        }
        .tab-button.active {
            color: #ffffff;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .tab-content {
            display: block;
            margin-top: 0 !important;
            padding-top: 0 !important;
        }
        .tab-content.hidden {
            display: none;
        }
    `;
    document.head.appendChild(style);
});
</script>

        </div> <!-- End Collection Without Fraud Tab -->

        <!-- Collection With Fraud Tab -->
        <div id="fraudContent" class="tab-content hidden"><!-- Collapsible Filters -->
        <div class="card mb-8">
            <div class="p-6 cursor-pointer" onclick="toggleFraudFilters()">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-medium text-white">Filters</h2>
                    <svg id="fraudFilterToggleIcon" class="h-5 w-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </div>
            
            <div id="fraudFilterContent" class="px-6 pb-6 hidden">
                <form method="GET" id="fraudFilterForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                <!-- Date Range -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        Date Range
                        <span class="text-xs text-muted-foreground">(Both dates required)</span>
                    </label>
                    <div class="space-y-2">
                        <select name="date_type" id="fraudDateType" class="w-full input-field filter-input">
                            <option value="repayment_date">Repayment Date</option>
                            <option value="disbursal_date">Disbursal Date</option>
                        </select>
                    <div class="flex gap-3">
                        <input type="date" name="date_from" id="fraudDateFrom" class="flex-1 input-field filter-input" placeholder="From Date">
                        <input type="date" name="date_to" id="fraudDateTo" class="flex-1 input-field filter-input" placeholder="To Date">
                        </div>
                    </div>
                </div>

                <!-- Closing Status -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Closing Status
                    </label>
                        <select name="closing_status" id="fraudClosingStatus" class="w-full input-field filter-input">
                            <option value="">All Status</option>
                        </select>
                </div>

                <!-- DPD Bucket -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        DPD Bucket
                    </label>
                        <select name="dpd" id="fraudDpdBucket" class="w-full input-field filter-input">
                            <option value="">All DPD</option>
                        </select>
                </div>

                <!-- State -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        State
                    </label>
                    <select name="state" id="fraudState" class="w-full input-field filter-input">
                        <option value="">All States</option>
                    </select>
                </div>

                <!-- City -->
                <div class="space-y-3">
                    <label class="text-sm font-semibold text-foreground flex items-center gap-2">
                        <svg class="h-4 w-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        City
                    </label>
                    <select name="city" id="fraudCity" class="w-full input-field filter-input">
                        <option value="">All Cities</option>
                    </select>
                </div>

            </form>
            </div>
        </div>

        <!-- Minimal KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-blue-500/10 border border-blue-500/20">
                        <svg class="h-4 w-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Total Applications</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="fraudTotalApplications">-</div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshCases">-</span>
                            <span class="text-gray-400 ml-1">(<span id="fraudFreshPercentage">-</span>%)</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanCases">-</span>
                            <span class="text-gray-400 ml-1">(<span id="fraudReloanPercentage">-</span>%)</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-green-500/10 border border-green-500/20">
                        <svg class="h-4 w-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Sanction Amount</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="fraudSanctionAmount" data-amount="0">-</div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshSanctionAmount" data-amount="0">-</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanSanctionAmount" data-amount="0">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-purple-500/10 border border-purple-500/20">
                        <svg class="h-4 w-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Net Disbursed</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="fraudDisbursedAmount" data-amount="0">-</div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshDisbursedAmount" data-amount="0">-</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanDisbursedAmount" data-amount="0">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-orange-500/10 border border-orange-500/20">
                        <svg class="h-4 w-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-gray-400">Repayment Amount</div>
                </div>
                <div class="text-2xl font-semibold text-white" id="fraudRepaymentAmount" data-amount="0">-</div>
                <div class="mt-3 space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshRepaymentAmount" data-amount="0">-</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanRepaymentAmount" data-amount="0">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Mobile Responsive Collection Status and Principal Outstanding -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6 mb-6 sm:mb-8">
            <!-- Collected Amount Card -->
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-emerald-500/10 border border-emerald-500/20">
                        <svg class="h-4 w-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-emerald-400">Collected Amount</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-emerald-400" id="fraudCollectedAmount" data-amount="0">-</div>
                    <div class="text-sm text-emerald-300" id="fraudCollectedPercentage">-</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshCollectedAmount" data-amount="0">-</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanCollectedAmount" data-amount="0">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Collection Card -->
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-red-500/10 border border-red-500/20">
                        <svg class="h-4 w-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-red-400">Pending Collection</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-red-400" id="fraudPendingCollection" data-amount="0">-</div>
                    <div class="text-sm text-red-300" id="fraudPendingPercentage">-</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshPendingAmount" data-amount="0">-</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanPendingAmount" data-amount="0">-</span>
                        </div>
                    </div>
            </div>
        </div>

            <!-- Principal Outstanding Card -->
            <div class="kpi-card">
                <div class="flex items-center gap-2 mb-2">
                    <div class="p-1.5 rounded-md bg-yellow-500/10 border border-yellow-500/20">
                        <svg class="h-4 w-4 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                    <div class="text-sm text-yellow-400">Principal Outstanding</div>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <div class="text-3xl font-semibold text-yellow-400" id="fraudPrincipalOutstandingAmount" data-amount="0">-</div>
                    <div class="text-sm text-yellow-300">No Collections Yet</div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-gray-300">Fresh</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudFreshPrincipalOutstanding" data-amount="0">-</span>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                            <span class="text-gray-300">Reloan</span>
                        </div>
                        <div class="text-right">
                            <span class="font-medium text-white" id="fraudReloanPrincipalOutstanding" data-amount="0">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Mobile Responsive Enhanced Analytics Charts -->
        <div class="mb-6 sm:mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
            <!-- Enhanced State Repayment Chart -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-info/20 to-primary/20 border border-info/30 shadow-lg">
                            <svg class="h-6 w-6 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Received Amount by State</h3>
                            <p class="text-sm text-muted-foreground font-medium">Geographic distribution of collections</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('fraudStateChart', 'Received Amount by State', 'Geographic distribution of collections')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div id="fraudStateChart" class="h-80"></div>
            </div>

            <!-- Enhanced DPD Buckets Chart -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-warning/20 to-orange-500/20 border border-warning/30 shadow-lg">
                            <svg class="h-6 w-6 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">DPD Buckets Distribution</h3>
                            <p class="text-sm text-muted-foreground font-medium">Days Past Due analysis</p>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="border-b border-border/50">
                            <tr>
                                <th class="text-left py-3 px-4 font-medium text-muted-foreground">DPD Bucket</th>
                                <th class="text-right py-3 px-4 font-medium text-muted-foreground">Loans (#)</th>
                            </tr>
                        </thead>
                        <tbody id="fraudDpdTableBody">
                            <!-- Fraud DPD data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>

        <!-- Time Series Chart -->
        <div class="mb-8">
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-success/20 to-emerald-500/20 border border-success/30 shadow-lg">
                            <svg class="h-6 w-6 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Collection Trend Over Time</h3>
                            <p class="text-sm text-muted-foreground font-medium">Historical collection performance</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('fraudTimeSeriesChart', 'Collection Trend Over Time', 'Historical collection performance')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div id="fraudTimeSeriesChart" class="h-80"></div>
            </div>
        </div>

        <!-- City Analysis Charts -->
        <div class="mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Top Cities by Collection -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-green-500/20 border border-emerald-500/30 shadow-lg">
                            <svg class="h-6 w-6 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Top Cities by Collection Rate</h3>
                            <p class="text-sm text-muted-foreground font-medium">Cities with highest collection percentage (%)</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('fraudCityCollectedChart', 'Top Cities by Collection Rate', 'Cities with highest collection percentage (%)')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div id="fraudCityCollectedChart" class="h-80"></div>
            </div>

            <!-- Cities with Uncollected Amount -->
            <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                <div class="flex items-center justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl bg-gradient-to-br from-red-500/20 to-rose-500/20 border border-red-500/30 shadow-lg">
                            <svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-foreground">Cities with Lowest Collection Rate</h3>
                            <p class="text-sm text-muted-foreground font-medium">Cities with lowest collection percentage (%)</p>
                        </div>
                    </div>
                    <button onclick="openFullscreenChart('fraudCityUncollectedChart', 'Cities with Lowest Collection Rate', 'Cities with lowest collection percentage (%)')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                        </svg>
                    </button>
                </div>
                <div id="fraudCityUncollectedChart" class="h-80"></div>
            </div>
            </div>
        </div>

        </div> <!-- End Collection With Fraud Tab -->
        <!-- Loan Count Wise Tab -->
        <div id="loanCountContent" class="tab-content hidden">
            <!-- Header with Date Filters -->
            <div class="card mb-6">
                <div class="p-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-1">Loan Count Wise Analysis</h2>
                            <p class="text-sm text-gray-400">Track loan performance by count and amount distribution</p>
                        </div>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400 whitespace-nowrap">Start Date:</label>
                                <input type="date" id="loanCountStartDate" class="input-field text-sm px-3 py-2">
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400 whitespace-nowrap">End Date:</label>
                                <input type="date" id="loanCountEndDate" class="input-field text-sm px-3 py-2">
                            </div>
                            <button onclick="applyLoanCountFilters()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition-colors whitespace-nowrap">
                                <svg class="inline h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Apply
                            </button>
                            <button onclick="resetLoanCountFilters()" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-md transition-colors whitespace-nowrap">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loanCountLoading" class="hidden">
                <div class="card p-12">
                    <div class="flex flex-col items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
                        <p class="text-gray-400">Loading loan count data...</p>
                    </div>
                </div>
            </div>

            <!-- Error State -->
            <div id="loanCountError" class="hidden">
                <div class="card p-6">
                    <div class="flex items-center gap-3 text-red-400">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="loanCountErrorMessage">Failed to load data. Please try again.</span>
                    </div>
                </div>
            </div>

            <!-- Data Tables -->
            <div id="loanCountTables" class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                
                <!-- Count Wise Distribution Table -->
            <div class="card">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">Count Wise Distribution</h3>
                            <div class="px-3 py-1 bg-blue-500/10 border border-blue-500/20 rounded-full">
                                <span class="text-sm text-blue-400 font-medium" id="countWiseTotalCases">0 Cases</span>
                </div>
            </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-600">
                                        <th class="text-left py-3 px-4 text-gray-300 font-semibold">Loan Count</th>
                                        <th class="text-right py-3 px-4 text-gray-300 font-semibold">Total Cases</th>
                                        <th class="text-right py-3 px-4 text-gray-300 font-semibold">Share %</th>
                                    </tr>
                                </thead>
                                <tbody id="countWiseTableBody">
                                    <tr>
                                        <td colspan="3" class="py-8 text-center text-gray-400">Select date range and click Apply to load data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Summary -->
                        <div class="mt-4 pt-4 border-t border-gray-600">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-400">Total Cases:</span>
                                <span class="text-lg font-bold text-white" id="countWiseTotal">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Amount Wise Distribution Table -->
                <div class="card">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">Amount Wise Distribution</h3>
                            <div class="px-3 py-1 bg-green-500/10 border border-green-500/20 rounded-full">
                                <span class="text-sm text-green-400 font-medium" id="amountWiseTotalAmount">₹0</span>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-600">
                                        <th class="text-left py-3 px-4 text-gray-300 font-semibold">Loan Count</th>
                                        <th class="text-right py-3 px-4 text-gray-300 font-semibold">Total Due</th>
                                        <th class="text-right py-3 px-4 text-gray-300 font-semibold">Share %</th>
                                    </tr>
                                </thead>
                                <tbody id="amountWiseTableBody">
                                    <tr>
                                        <td colspan="3" class="py-8 text-center text-gray-400">Select date range and click Apply to load data</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Summary -->
                        <div class="mt-4 pt-4 border-t border-gray-600">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-400">Total Due Amount:</span>
                                <span class="text-lg font-bold text-white" id="amountWiseTotal">₹0</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Not Closed Percentage Table -->
            <div class="card mt-6 hidden" id="notClosedPercentCard">
                <div class="p-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                        <div>
                            <div class="flex items-center gap-3">
                                <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-red-500/10 text-red-400 border border-red-500/20">
                                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 8c-3.866 0-7 3.134-7 7a7 7 0 0014 0c0-3.866-3.134-7-7-7z" />
                                    </svg>
                                </span>
                                <div>
                                    <h3 class="text-lg font-semibold text-white">Not Closed Percentage by Loan Count</h3>
                                </div>
                            </div>
                        </div>
                        <div class="text-sm text-gray-400">
                            Date Range: <span class="text-white font-medium" id="notClosedPercentRange">--</span>
                        </div>
                    </div>

                    <div id="notClosedPercentLoading" class="py-12 text-center text-gray-400">
                        Loading not closed percentage...
                    </div>
                    <div id="notClosedPercentError" class="hidden py-4 text-center text-red-400 text-sm"></div>
                    <div id="notClosedPercentEmpty" class="hidden py-4 text-center text-gray-400 text-sm"></div>

                    <div id="notClosedPercentTableWrapper" class="overflow-x-auto hidden">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-600 text-gray-300 font-semibold">
                                    <th class="text-left py-3 px-4">Loan Count</th>
                                    <th class="text-right py-3 px-4">Total Loans</th>
                                    <th class="text-right py-3 px-4">Not Closed Loans</th>
                                    <th class="text-right py-3 px-4">Not Closed Loan Amount</th>
                                    <th class="text-right py-3 px-4">Not Closed Repayment</th>
                                    <th class="text-right py-3 px-4">Total Repayment</th>
                                    <th class="text-right py-3 px-4">Not Closed %</th>
                                </tr>
                            </thead>
                            <tbody id="notClosedPercentTableBody">
                                <tr>
                                    <td colspan="7" class="py-8 text-center text-gray-400">Loading data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-600 hidden flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2" id="notClosedPercentSummaryRow">
                        <div class="text-sm text-gray-400" id="notClosedPercentSummaryValue">--</div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs uppercase tracking-wide text-gray-400">Overall Not Closed %</span>
                            <span class="text-lg font-bold text-red-400" id="notClosedPercentSummaryRatio">--%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Data State -->
            <div id="loanCountNoData" class="hidden">
                <div class="card p-12">
                    <div class="flex flex-col items-center justify-center">
                        <svg class="h-16 w-16 text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-white mb-2">No Data Found</h3>
                        <p class="text-gray-400 text-center">No loan count data available for the selected date range.<br>Please try adjusting your filters.</p>
                    </div>
                </div>
            </div>

        </div> <!-- End Loan Count Wise Tab -->

        <!-- Daily Performance Metrics Tab -->
        <div id="dailyPerformanceContent" class="tab-content hidden" style="margin-left: 3.5rem; margin-right: 3.5rem; margin-top: 2rem; margin-bottom: 2rem;">
            <!-- Loading State -->
            <div id="dailyPerformanceLoading" class="hidden">
                <div class="card p-12">
                    <div class="flex flex-col items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
                        <p class="text-gray-400">Loading daily performance data...</p>
                </div>
                </div>
            </div>

            <!-- Main Content -->
            <div id="dailyPerformanceMainContent">
            <!-- Performance Report Header -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <h1 class="text-2xl font-bold text-white">Performance Report - BlinkR Loan</h1>
                    <div class="flex items-center gap-3">
                        <button 
                            onclick="exportPerformanceReport()"
                            class="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors"
                            title="Export to Excel"
                        >
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                            Export to Excel
                        </button>
                    </div>
                </div>
                <div class="flex gap-6 text-sm text-gray-300">
                    <div>Position as on: <span id="positionDate" class="text-white font-medium">--</span></div>
                </div>
            </div>

            <!-- Sanction Performance Section -->
            <div class="card mb-6">
                <div class="p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <h2 class="text-xl font-semibold text-white">Sanction Performance</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Target of Sanction for the current Month:</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-white font-semibold">₹</span>
                                    <input 
                                        type="text" 
                                        id="monthlyTargetInput" 
                                        class="bg-gray-700 border border-gray-600 rounded px-3 py-1 text-white font-semibold text-right w-40 focus:outline-none focus:border-blue-500"
                                        placeholder="12,00,00,000"
                                        value=""
                                    />
                                    <button 
                                        id="saveMonthlyTargetBtn"
                                        onclick="saveMonthlyTarget()"
                                        class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition-colors"
                                        title="Save monthly target"
                                    >
                                        Save
                                    </button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Today's Disbursement:</span>
                                <span class="text-white font-semibold">₹ <span id="todayDisbursement">0</span></span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Figures Achieved (till today):</span>
                                <span class="text-white font-semibold">₹ <span id="totalAchieved">0</span></span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Achievement %:</span>
                                <span class="text-white font-semibold"><span id="achievementPercentage">0</span>%</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Yet to be Achieved:</span>
                                <span class="text-white font-semibold">₹ <span id="yetToAchieve">0</span></span>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Yet to be Achieved %:</span>
                                <span class="text-white font-semibold"><span id="yetToAchievePercentage">0</span>%</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Days Completed:</span>
                                <span class="text-white font-semibold"><span id="daysCompleted">0</span></span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Remaining Days:</span>
                                <span class="text-white font-semibold"><span id="remainingDays">0</span></span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Current Daily Performance:</span>
                                <span class="text-white font-semibold">₹ <span id="currentDailyPerformance">0</span></span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-gray-700">
                                <span class="text-gray-300">Required Daily Performance:</span>
                                <span class="text-white font-semibold">₹ <span id="requiredDailyPerformance">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collection Efficiency Section -->
            <div class="card mb-6">
                <div class="p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <h2 class="text-xl font-semibold text-white">Collection Efficiency</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-gray-300">Collection Efficiency (Current Month):</span>
                            <span id="currentCollectionEfficiency" class="text-white font-semibold px-3 py-1 rounded bg-green-600">0%</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-gray-300">Benchmark Collection Efficiency (till 25th of month):</span>
                            <span class="text-white font-semibold"><span id="benchmarkEfficiency">0</span>%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical Collection Efficiency Section -->
            <div class="card">
                <div class="p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <svg class="h-6 w-6 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <h2 class="text-xl font-semibold text-white">Historical Collection Efficiency</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left py-3 px-4 text-gray-300 font-medium">Month</th>
                                    <th class="text-right py-3 px-4 text-gray-300 font-medium">Actual</th>
                                    <th class="text-right py-3 px-4 text-gray-300 font-medium">Benchmark</th>
                                </tr>
                            </thead>
                            <tbody id="historicalDataTable">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            </div> <!-- End Main Content -->
        </div> <!-- End Daily Performance Metrics Tab -->

        <!-- Credit Person Wise Tab -->
        <div id="creditPersonContent" class="tab-content hidden">
            <!-- Filters -->
            <div class="card mb-6">
                <div class="p-6">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-white mb-1">Credit Person Wise Performance</h2>
                            <p class="text-sm text-gray-400">Track recovery progress and pending exposure by assigned credit officers.</p>
                        </div>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400 whitespace-nowrap">Start Date:</label>
                                <input type="date" id="creditPersonStartDate" class="input-field text-sm px-3 py-2">
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400 whitespace-nowrap">End Date:</label>
                                <input type="date" id="creditPersonEndDate" class="input-field text-sm px-3 py-2">
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-400 whitespace-nowrap">Loan Type:</label>
                                <select id="creditPersonLoanType" class="input-field text-sm px-3 py-2">
                                    <option value="all">All</option>
                                    <option value="fresh">Fresh</option>
                                    <option value="reloan">Reloan</option>
                                </select>
                            </div>
                            <button onclick="applyCreditPersonFilters()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium rounded-md transition-colors whitespace-nowrap">
                                <svg class="inline h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                Apply
                            </button>
                            <button onclick="resetCreditPersonFilters()" class="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-md transition-colors whitespace-nowrap">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <p class="mt-4 text-xs text-gray-500">Assignments prioritise the audit stage. When unavailable, BRE or partial-stage ownership is used; otherwise cases are marked as <span class="text-emerald-300">Unassigned</span>.</p>
                </div>
            </div>

            <!-- Loading State -->
            <div id="creditPersonLoading" class="hidden">
                <div class="card p-12">
                    <div class="flex flex-col items-center justify-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-500 mb-4"></div>
                        <p class="text-gray-400">Loading credit person data...</p>
                    </div>
                </div>
            </div>

            <!-- Error State -->
            <div id="creditPersonError" class="hidden">
                <div class="card p-6">
                    <div class="flex items-center gap-3 text-red-400">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <h3 class="text-lg font-semibold text-white">Unable to load credit person data</h3>
                            <p class="text-gray-400 text-sm" id="creditPersonErrorMessage">Please try again in a few minutes.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Data State -->
            <div id="creditPersonNoData" class="hidden">
                <div class="card p-12">
                    <div class="flex flex-col items-center justify-center">
                        <svg class="h-16 w-16 text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-white mb-2">No Data Found</h3>
                        <p class="text-gray-400 text-center">No credit person assignments found for the selected range.<br>Adjust the dates to widen your search.</p>
                    </div>
                </div>
            </div>

            <!-- Data Section -->
            <div id="creditPersonDataSection" class="hidden space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                    <div class="card bg-gradient-to-br from-emerald-500/10 via-emerald-500/5 to-emerald-500/10 border border-emerald-500/20">
                        <div class="p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">Credit Officers</p>
                                    <p class="text-2xl font-semibold text-white" id="creditPersonTotalOfficers">-</p>
                                </div>
                                <div class="p-2 rounded-lg bg-emerald-500/20 border border-emerald-500/30">
                                    <svg class="h-6 w-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 11a3 3 0 11-6 0 3 3 0 016 0zm6 1a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card bg-gradient-to-br from-sky-500/10 via-sky-500/5 to-sky-500/10 border border-sky-500/20">
                        <div class="p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">Loans Monitored</p>
                                    <p class="text-2xl font-semibold text-white" id="creditPersonTotalLoans">-</p>
                                </div>
                                <div class="p-2 rounded-lg bg-sky-500/20 border border-sky-500/30">
                                    <svg class="h-6 w-6 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 17a4 4 0 004 4h10a4 4 0 004-4V7a4 4 0 00-4-4H7a4 4 0 00-4 4v10z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card bg-gradient-to-br from-blue-500/10 via-blue-500/5 to-blue-500/10 border border-blue-500/20">
                        <div class="p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">Overall Recovery Rate</p>
                                    <p class="text-2xl font-semibold text-white" id="creditPersonRecoveryRate">-</p>
                                </div>
                                <div class="p-2 rounded-lg bg-blue-500/20 border border-blue-500/30">
                                    <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 11V7a4 4 0 018 0v4m-9 4v-1a3 3 0 013-3h2a3 3 0 013 3v1m-9 4h10a2 2 0 002-2v-5a2 2 0 00-2-2h-1l-1.447-2.894A2 2 0 0016.764 7H7.236a2 2 0 00-1.789 1.106L4 11H3a2 2 0 00-2 2v5a2 2 0 002 2h2z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card bg-gradient-to-br from-rose-500/10 via-rose-500/5 to-rose-500/10 border border-rose-500/20">
                        <div class="p-5">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-400">Total Pending Amount</p>
                                    <p class="text-2xl font-semibold text-white" id="creditPersonPendingAmount">-</p>
                                </div>
                                <div class="p-2 rounded-lg bg-rose-500/20 border border-rose-500/30">
                                    <svg class="h-6 w-6 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="chart-container rounded-2xl p-4 sm:p-8 shadow-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <div class="p-3 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-blue-500/20 border border-emerald-500/30 shadow-lg">
                                <svg class="h-6 w-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 012-2h2a2 2 0 012 2v6m-6 0h6m5 0V9a2 2 0 00-.879-1.664l-7-4.667a2 2 0 00-2.242 0l-7 4.667A2 2 0 003 9v10a2 2 0 002 2h1"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-foreground">Pending vs Collected Amount (Top 10)</h3>
                                <p class="text-sm text-muted-foreground font-medium">Visualise exposure handled by the busiest credit officers</p>
                            </div>
                        </div>
                        <button onclick="openFullscreenChart('creditPersonChart', 'Pending vs Collected Amount', 'Top credit officers by outstanding exposure')" class="p-2 rounded-lg bg-gray-600/20 hover:bg-gray-600/30 border border-gray-500/20 transition-colors" title="Open in Fullscreen">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="h-96">
                        <canvas id="creditPersonChart"></canvas>
                    </div>
                </div>

                <!-- Table -->
                <div class="card">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <svg class="h-6 w-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <h3 class="text-xl font-semibold text-white">Credit Person Portfolio Overview</h3>
                            </div>
                            <p class="text-xs text-gray-500">Pending = Repayment Amount − Received Amount (never negative).</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b border-gray-800 text-gray-300 text-sm">
                                        <th class="py-3 px-4 text-left font-medium">Credit Person</th>
                                        <th class="py-3 px-4 text-right font-medium">Loans</th>
                                        <th class="py-3 px-4 text-right font-medium">Recovered</th>
                                        <th class="py-3 px-4 text-right font-medium">Not Recovered</th>
                                        <th class="py-3 px-4 text-right font-medium">Recovery %</th>
                                        <th class="py-3 px-4 text-right font-medium">Loan Amount</th>
                                        <th class="py-3 px-4 text-right font-medium">Repayment Amount</th>
                                        <th class="py-3 px-4 text-right font-medium">Collected Amount</th>
                                        <th class="py-3 px-4 text-right font-medium">Pending Amount</th>
                                    </tr>
                                </thead>
                                <tbody id="creditPersonTableBody">
                                    <!-- Rows injected via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- End Credit Person Wise Tab -->

        <!-- AUM Report Tab -->
        <div id="aumReportContent" class="tab-content hidden">
            <div class="card border border-gray-700/30 shadow-xl bg-gradient-to-br from-gray-900/50 to-gray-800/30">
                <div class="p-6 sm:p-8">
                    <div class="mb-6 pb-4 border-b border-gray-700/50">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <div class="p-2 rounded-lg bg-gradient-to-br from-blue-500/20 to-purple-500/20 border border-blue-500/30">
                                    <svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h2 class="text-2xl sm:text-3xl font-bold text-white mb-1">AUM Report</h2>
                                    <p class="text-sm text-gray-400">Assets Under Management Report</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 flex-nowrap">
                                <button
                                    id="aumTillDateBtn"
                                    onclick="loadAumDataTillDate()"
                                    class="flex items-center gap-1.5 px-3 py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white text-sm font-semibold rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105 whitespace-nowrap"
                                    title="AUM Report Till Date"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    AUM Report Till Date
                                </button>
                                <button
                                    id="aumTillPrevDateBtn"
                                    onclick="loadAumDataTillPrevDate()"
                                    class="flex items-center gap-1.5 px-3 py-2 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-700 hover:to-amber-700 text-white text-sm font-semibold rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105 whitespace-nowrap"
                                    title="AUM Till Previous Date"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    AUM Till Previous Date
                                </button>
                                <button
                                    id="aumTillPrevMonthBtn"
                                    onclick="loadAumDataTillPrevMonth()"
                                    class="flex items-center gap-1.5 px-3 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white text-sm font-semibold rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105 whitespace-nowrap"
                                    title="AUM Report Till Previous Month"
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    AUM Report Till Previous Month
                                </button>
                            <button
                                id="aumExportBtn"
                                    onclick="exportAumReport()"
                                    class="flex items-center gap-1.5 px-3 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white text-sm font-semibold rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105 whitespace-nowrap"
                                title="Export to Excel"
                            >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export to Excel
                            </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="aumLoading" class="text-center py-16">
                        <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-blue-500/30 border-t-blue-500"></div>
                        <p class="mt-4 text-gray-400 font-medium">Loading AUM data...</p>
                    </div>
                    
                    <!-- AUM Report Table -->
                    <div id="aumTableContainer" class="hidden overflow-x-auto rounded-lg border-2 border-gray-700/60 shadow-2xl bg-gradient-to-br from-gray-900/60 to-gray-800/40">
                        <div class="overflow-x-auto">
                            <table class="min-w-full border-collapse">
                                <thead id="aumTableHead" class="sticky top-0 z-10 shadow-lg">
                                    <!-- Headers will be populated by JavaScript -->
                                </thead>
                                <tbody id="aumTableBody" class="divide-y divide-gray-700/40">
                                    <!-- Rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Error State -->
                    <div id="aumError" class="hidden text-center py-16">
                        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-500/10 border border-red-500/20 mb-4">
                            <svg class="h-8 w-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <p class="text-red-400 text-lg font-semibold mb-2">Error loading AUM data</p>
                        <p class="text-gray-400 text-sm" id="aumErrorMessage"></p>
                    </div>
                </div>
            </div>
        </div> <!-- End AUM Report Tab -->

    </div>
</div>
{% endblock %}

<script>
// Dashboard initialization is handled in the main DOMContentLoaded event listener above

// Debug function to test localStorage functionality
window.debugLocalStorage = function() {
    console.log('=== LocalStorage Debug ===');
    
    const mainFilters = localStorage.getItem('mainFilters');
    const fraudFilters = localStorage.getItem('fraudFilters');
    
    console.log('mainFilters:', mainFilters ? JSON.parse(mainFilters) : 'Not set');
    console.log('fraudFilters:', fraudFilters ? JSON.parse(fraudFilters) : 'Not set');
    
    const form = document.getElementById('filterForm');
    if (form) {
        const dateTypeSelect = form.querySelector('select[name="date_type"]');
        console.log('Current date_type value in form:', dateTypeSelect ? dateTypeSelect.value : 'Not found');
    }
    
    console.log('=== End Debug ===');
};

// Debug function to manually save test filters
window.saveTestFilters = function() {
    const testFilters = {
        date_from: '2025-10-01',
        date_to: '2025-10-02',
        date_type: 'disbursal_date',
        closing_status: '',
        dpd: '',
        state: '',
        city: ''
    };
    
    localStorage.setItem('mainFilters', JSON.stringify(testFilters));
    console.log('Test filters saved:', testFilters);
};

// Debug function to manually restore filters
window.restoreTestFilters = function() {
    restoreMainFilters();
};
// Debug function to check saved tab
window.debugActiveTab = function() {
    console.log('=== Active Tab Debug ===');
    const savedTab = localStorage.getItem('activeTab');
    console.log('Saved tab:', savedTab);
    
    if (savedTab) {
        const tabButton = document.getElementById(savedTab + 'Tab');
        const tabContent = document.getElementById(savedTab + 'Content');
        console.log('Tab button exists:', !!tabButton);
        console.log('Tab content exists:', !!tabContent);
    }
    console.log('=== End Debug ===');
};

// Debug function to clear saved tab (reset to default)
window.clearSavedTab = function() {
    localStorage.removeItem('activeTab');
    console.log('Saved tab cleared. Refresh the page to see the default tab.');
};

// ===============================
// DISBURSAL TAB FUNCTIONALITY
// ===============================

// Disbursal tab is ready for fresh implementation

// ===============================
// AUM REPORT TAB FUNCTIONALITY
// ===============================

function toggleAumFilters() {
    const content = document.getElementById('aumFiltersContent');
    const icon = document.getElementById('aumFiltersToggleIcon');
    
    if (content && icon) {
        const isHidden = content.classList.contains('hidden');
        
        if (isHidden) {
            content.classList.remove('hidden');
            icon.style.transform = 'rotate(0deg)';
        } else {
            content.classList.add('hidden');
            icon.style.transform = 'rotate(180deg)';
        }
    }
}

function initializeAumFilters() {
    const content = document.getElementById('aumFiltersContent');
    const icon = document.getElementById('aumFiltersToggleIcon');
    
    if (content && icon) {
        content.classList.add('hidden');
        icon.style.transform = 'rotate(180deg)';
    }
}

function setDefaultAumDates() {
    const today = new Date();
    const sixMonthsAgo = new Date();
    sixMonthsAgo.setMonth(today.getMonth() - 6);
    
    const startDateInput = document.getElementById('aumStartDate');
    const endDateInput = document.getElementById('aumEndDate');
    
    if (startDateInput && endDateInput) {
        const startDateStr = sixMonthsAgo.toISOString().split('T')[0];
        const endDateStr = today.toISOString().split('T')[0];
        
        startDateInput.value = startDateStr;
        endDateInput.value = endDateStr;
    }
}

function applyAumFilters() {
    const startDate = document.getElementById('aumStartDate').value;
    const endDate = document.getElementById('aumEndDate').value;
    
    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert('Start date must be before end date');
        return;
    }
    
    loadAumData();
    
    // Collapse filter section
    const content = document.getElementById('aumFiltersContent');
    const icon = document.getElementById('aumFiltersToggleIcon');
    if (content && icon) {
        content.classList.add('hidden');
        icon.style.transform = 'rotate(180deg)';
    }
}

function resetAumFilters() {
    setDefaultAumDates();
}

// AUM Report functions are now defined in the main script block above
// AUM Report export function is now defined in the main script block above






</script>